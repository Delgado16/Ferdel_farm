{% extends "layout.html" %}
{% block title %}Dashboard de Inventario{% endblock %}

{% block head %}
    {{ super() }}
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome (CSS solo) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
    
    <style>
        :root {
            --color-critico: #dc3545;
            --color-bajo: #ffc107;
            --color-optimo: #28a745;
            --color-exceso: #17a2b8;
            --color-sin-stock: #6c757d;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .stat-card {
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .card-title {
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
            margin-bottom: 15px;
            color: #495057;
        }
        
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .badge-nivel {
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .badge-sin-stock { background-color: var(--color-sin-stock); color: white; }
        .badge-critico { background-color: var(--color-critico); color: white; }
        .badge-bajo { background-color: var(--color-bajo); color: #212529; }
        .badge-optimo { background-color: var(--color-optimo); color: white; }
        .badge-exceso { background-color: var(--color-exceso); color: white; }
        
        .progress {
            height: 10px;
            margin-bottom: 5px;
        }
        
        .progress-bar-critico { background-color: var(--color-critico); }
        .progress-bar-bajo { background-color: var(--color-bajo); }
        .progress-bar-optimo { background-color: var(--color-optimo); }
        .progress-bar-exceso { background-color: var(--color-exceso); }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        
        .filter-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .action-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .btn-action {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-bottom: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .dataTables_wrapper {
            padding: 10px;
        }
        
        /* Evitar conflictos con Bootstrap Icons */
        .fa, .fas, .far, .fal, .fab {
            font-family: 'Font Awesome 6 Free' !important;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1><i class="fas fa-boxes"></i> Dashboard de Inventario</h1>
                <p class="mb-0">Resumen completo del inventario y bodegas</p>
                <small class="text-light">Última actualización: {{ fecha_actual }}</small>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-light me-2" onclick="exportarReporte()">
                    <i class="fas fa-download"></i> Exportar
                </button>
                <button class="btn btn-light" onclick="actualizarDashboard()">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filter-section">
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Bodega</label>
                <select class="form-select" id="filtro-bodega">
                    <option value="">Todas las bodegas</option>
                    {% for bodega in inventario_bodegas %}
                    <option value="{{ bodega.ID_Bodega }}">{{ bodega.Bodega }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Categoría</label>
                <select class="form-select" id="filtro-categoria">
                    <option value="">Todas las categorías</option>
                    {% for cat in distribucion_categorias %}
                    <option value="{{ cat.Categoria }}">{{ cat.Categoria }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Nivel de Stock</label>
                <select class="form-select" id="filtro-nivel">
                    <option value="">Todos los niveles</option>
                    <option value="SIN_STOCK">Sin Stock</option>
                    <option value="CRITICO">Crítico</option>
                    <option value="BAJO">Bajo</option>
                    <option value="OPTIMO">Óptimo</option>
                    <option value="EXCESO">Exceso</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-primary w-100" onclick="aplicarFiltros()">
                    <i class="fas fa-filter"></i> Aplicar Filtros
                </button>
            </div>
        </div>
    </div>

    <!-- Estadísticas Rápidas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-value text-primary">
                            {{ estadisticas.Total_Productos|default(0) }}
                        </div>
                        <div class="stat-label">Productos Activos</div>
                    </div>
                    <i class="fas fa-boxes fa-2x text-primary"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-value text-success">
                            {{ estadisticas.Productos_Optimos|default(0) }}
                        </div>
                        <div class="stat-label">Stock Óptimo</div>
                    </div>
                    <i class="fas fa-check-circle fa-2x text-success"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-value text-danger">
                            {{ (estadisticas.Productos_Sin_Stock|default(0)) + (estadisticas.Productos_Bajos|default(0)) }}
                        </div>
                        <div class="stat-label">Productos con Alerta</div>
                    </div>
                    <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-value text-info">
                            C${{ "{:,.2f}".format(estadisticas.Valor_Total_Inventario|default(0)) }}
                        </div>
                        <div class="stat-label">Valor Total Inventario</div>
                    </div>
                    <i class="fas fa-dollar-sign fa-2x text-info"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-chart-pie"></i> Distribución por Categoría
                    </h5>
                    <div class="chart-container">
                        <canvas id="graficoCategorias"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-chart-bar"></i> Niveles de Stock
                    </h5>
                    <div class="chart-container">
                        <canvas id="graficoNivelesStock"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Productos por Nivel de Stock -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-exclamation-circle"></i> Productos por Nivel de Stock
                    </h5>
                    <div class="table-responsive">
                        <table id="tablaProductos" class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Descripción</th>
                                    <th>Categoría</th>
                                    <th>Stock Actual</th>
                                    <th>Stock Mínimo</th>
                                    <th>Nivel</th>
                                    <th>Valor en Inventario</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for producto in productos_nivel %}
                                <tr>
                                    <td>{{ producto.COD_Producto }}</td>
                                    <td>{{ producto.Descripcion }}</td>
                                    <td>{{ producto.Categoria }}</td>
                                    <td>{{ producto.Stock_Actual }}</td>
                                    <td>{{ producto.Stock_Minimo }}</td>
                                    <td>
                                        {% if producto.Nivel_Stock == 'SIN_STOCK' %}
                                            <span class="badge badge-sin-stock">Sin Stock</span>
                                        {% elif producto.Nivel_Stock == 'CRITICO' %}
                                            <span class="badge badge-critico">Crítico</span>
                                        {% elif producto.Nivel_Stock == 'BAJO' %}
                                            <span class="badge badge-bajo">Bajo</span>
                                        {% elif producto.Nivel_Stock == 'OPTIMO' %}
                                            <span class="badge badge-optimo">Óptimo</span>
                                        {% elif producto.Nivel_Stock == 'EXCESO' %}
                                            <span class="badge badge-exceso">Exceso</span>
                                        {% endif %}
                                    </td>
                                    <td>C${{ "{:,.2f}".format(producto.Valor_Inventario) }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="verDetalleProducto({{ producto.ID_Producto }})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" 
                                                onclick="realizarMovimiento({{ producto.ID_Producto }})">
                                            <i class="fas fa-exchange-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Bodegas y Sugerencias -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-warehouse"></i> Inventario por Bodega
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Bodega</th>
                                    <th>Productos</th>
                                    <th>Existencias</th>
                                    <th>Valor</th>
                                    <th>% Stock</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bodega in inventario_bodegas %}
                                <tr>
                                    <td>{{ bodega.Bodega }}</td>
                                    <td>{{ bodega.Productos_Diferentes }}</td>
                                    <td>{{ bodega.Total_Existencias }}</td>
                                    <td>C${{ "{:,.2f}".format(bodega.Valor_Total) }}</td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar {% if bodega.Porcentaje_Stock_Promedio < 50 %}bg-danger{% elif bodega.Porcentaje_Stock_Promedio < 80 %}bg-warning{% else %}bg-success{% endif %}" 
                                                 style="width: {{ bodega.Porcentaje_Stock_Promedio }}%">
                                            </div>
                                        </div>
                                        {{ "%.1f"|format(bodega.Porcentaje_Stock_Promedio) }}%
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-shopping-cart"></i> Sugerencias de Reorden
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Stock Actual</th>
                                    <th>Requerido</th>
                                    <th>Valor</th>
                                    <th>Prioridad</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sugerencia in sugerencias_reorden %}
                                <tr>
                                    <td>{{ sugerencia.Descripcion[:30] }}...</td>
                                    <td>{{ sugerencia.Stock_Actual }}</td>
                                    <td>{{ sugerencia.Cantidad_Requerida }}</td>
                                    <td>C${{ "{:,.2f}".format(sugerencia.Valor_Reorden) }}</td>
                                    <td>
                                        {% if sugerencia.Prioridad == 'URGENTE' %}
                                            <span class="badge bg-danger">URGENTE</span>
                                        {% elif sugerencia.Prioridad == 'ALTA' %}
                                            <span class="badge bg-warning">ALTA</span>
                                        {% elif sugerencia.Prioridad == 'MEDIA' %}
                                            <span class="badge bg-info">MEDIA</span>
                                        {% else %}
                                            <span class="badge bg-secondary">BAJA</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Productos y Movimientos -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-trophy"></i> Top 10 Productos Más Valiosos
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Categoría</th>
                                    <th>Stock</th>
                                    <th>Valor Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for producto in top_productos_valiosos %}
                                <tr>
                                    <td>{{ producto.Descripcion[:25] }}...</td>
                                    <td>{{ producto.Categoria }}</td>
                                    <td>{{ producto.Stock_Total }}</td>
                                    <td class="fw-bold">${{ "{:,.2f}".format(producto.Valor_Total) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-history"></i> Últimos Movimientos
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Cantidad</th>
                                    <th>Valor</th>
                                    <th>Productos</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for movimiento in movimientos_diarios %}
                                <tr>
                                    <td>{{ movimiento.Fecha.strftime('%d/%m') if movimiento.Fecha else '' }}</td>
                                    <td>
                                        {% if movimiento.Direccion == 'ENTRADA' %}
                                            <span class="badge bg-success">{{ movimiento.Tipo_Movimiento[:20] }}</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ movimiento.Tipo_Movimiento[:20] }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ movimiento.Total_Cantidad }}</td>
                                    <td>C${{ "{:,.2f}".format(movimiento.Valor_Total) }}</td>
                                    <td>{{ movimiento.Productos_Diferentes }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botones de Acción Flotantes -->
    <div class="action-buttons">
        <button class="btn btn-primary btn-action" onclick="nuevaEntrada()" 
                title="Nueva Entrada">
            <i class="fas fa-plus"></i>
        </button>
        <button class="btn btn-success btn-action" onclick="nuevaSalida()" 
                title="Nueva Salida">
            <i class="fas fa-minus"></i>
        </button>
        <button class="btn btn-warning btn-action" onclick="realizarAjuste()" 
                title="Ajuste de Inventario">
            <i class="fas fa-adjust"></i>
        </button>
        <button class="btn btn-info btn-action" onclick="generarReporte()" 
                title="Generar Reporte">
            <i class="fas fa-file-alt"></i>
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <!-- jQuery para DataTables (debe cargarse antes que DataTables) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables JS -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
    
    <script>
        // Inicializar DataTable cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar que jQuery esté cargado
            if (typeof jQuery === 'undefined') {
                console.error('jQuery no está cargado');
                return;
            }
            
            // Inicializar DataTable
            $('#tablaProductos').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json"
                },
                "pageLength": 25,
                "order": [[5, 'asc']] // Ordenar por nivel
            });
            
            // Inicializar gráficos
            inicializarGraficos();
        });

        // Datos para gráficos desde Flask
        const datosGraficos = {
            categorias: {{ datos_graficos.categorias|tojson }},
            valoresCategorias: {{ datos_graficos.valores_categorias|tojson }},
            productosBajos: {{ datos_graficos.productos_bajos|tojson }},
            nivelesStock: {{ datos_graficos.niveles_stock|tojson }}
        };

        function inicializarGraficos() {
            // Verificar que Chart.js esté cargado
            if (typeof Chart === 'undefined') {
                console.error('Chart.js no está cargado');
                return;
            }
            
            // Gráfico de pastel: Distribución por categoría
            const ctx1 = document.getElementById('graficoCategorias');
            if (ctx1) {
                new Chart(ctx1.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: datosGraficos.categorias,
                        datasets: [{
                            data: datosGraficos.valoresCategorias,
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                                '#9966FF', '#FF9F40', '#C9CBCF', '#7CBF4F',
                                '#E74C3C', '#3498DB'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += '$' + context.parsed.toLocaleString();
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Gráfico de barras: Niveles de stock
            const ctx2 = document.getElementById('graficoNivelesStock');
            if (ctx2) {
                new Chart(ctx2.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: datosGraficos.nivelesStock,
                        datasets: [{
                            label: 'Cantidad de Productos',
                            data: datosGraficos.productosBajos,
                            backgroundColor: [
                                'rgba(108, 117, 125, 0.8)',
                                'rgba(220, 53, 69, 0.8)',
                                'rgba(40, 167, 69, 0.8)',
                                'rgba(23, 162, 184, 0.8)'
                            ],
                            borderColor: [
                                'rgb(108, 117, 125)',
                                'rgb(220, 53, 69)',
                                'rgb(40, 167, 69)',
                                'rgb(23, 162, 184)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Funciones de filtrado
        function aplicarFiltros() {
            const bodega = document.getElementById('filtro-bodega').value;
            const categoria = document.getElementById('filtro-categoria').value;
            const nivel = document.getElementById('filtro-nivel').value;
            
            // Aquí puedes implementar la lógica para filtrar la tabla
            // Por simplicidad, recargamos la página con parámetros
            let url = window.location.pathname;
            let params = [];
            
            if (bodega) params.push(`bodega=${bodega}`);
            if (categoria) params.push(`categoria=${categoria}`);
            if (nivel) params.push(`nivel=${nivel}`);
            
            if (params.length > 0) {
                url += '?' + params.join('&');
            }
            
            window.location.href = url;
        }

        // Funciones de acción
        function verDetalleProducto(idProducto) {
            window.location.href = `/admin/productos/detalle/${idProducto}`;
        }

        function realizarMovimiento(idProducto) {
            // Implementar modal para movimiento rápido
            alert(`Movimiento para producto ID: ${idProducto}`);
        }

        function nuevaEntrada() {
            window.location.href = '/admin/inventario/entrada/nueva';
        }

        function nuevaSalida() {
            window.location.href = '/admin/inventario/salida/nueva';
        }

        function realizarAjuste() {
            window.location.href = '/admin/inventario/ajuste/nuevo';
        }

        function generarReporte() {
            // Implementar generación de reporte
            alert('Generando reporte...');
        }

        function exportarReporte() {
            // Implementar exportación
            alert('Exportando datos...');
        }

        function actualizarDashboard() {
            window.location.reload();
        }

        // Actualizar automáticamente cada 5 minutos
        setInterval(function() {
            console.log('Dashboard actualizado automáticamente');
            // Para una actualización parcial, usar AJAX
            // Para simplicidad, recargamos
            // window.location.reload();
        }, 300000); // 5 minutos
    </script>
{% endblock %}