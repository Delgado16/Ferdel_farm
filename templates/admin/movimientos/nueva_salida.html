{% extends "layout.html" %}

{% block title %}Nueva Salida de Inventario{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-sign-out-alt text-danger me-2"></i>Nueva Salida
        </h1>
        <div>
            <a href="{{ url_for('admin_historial_movimientos') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i> Volver
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Formulario Principal -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-danger text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-info-circle me-1"></i>Información de Salida
                    </h6>
                </div>
                <div class="card-body">
                    <form id="formSalida" method="POST" action="{{ url_for('admin_procesar_salida') }}">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label required">Fecha</label>
                                <input type="date" name="fecha" class="form-control" 
                                       value="{{ fecha_hoy }}" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label required">Tipo de Movimiento</label>
                                <select name="id_tipo_movimiento" class="form-select" required id="tipo-movimiento">
                                    <option value="">Seleccionar...</option>
                                    {% for tipo in tipos_movimiento %}
                                    <option value="{{ tipo.ID_TipoMovimiento }}">
                                        {{ tipo.Descripcion }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label required">Bodega</label>
                                <select name="id_bodega" id="select-bodega" class="form-select" required>
                                    <option value="">Seleccionar...</option>
                                    {% for bodega in bodegas %}
                                    <option value="{{ bodega.ID_Bodega }}">
                                        {{ bodega.Nombre }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Campos para VENTAS -->
                            <div class="col-md-6" id="factura-container" style="display: none;">
                                <label class="form-label">Factura Asociada (opcional)</label>
                                <select name="id_factura_venta" class="form-select">
                                    <option value="">Crear nueva factura</option>
                                    {% for factura in facturas %}
                                    <option value="{{ factura.ID_Factura }}">
                                        Factura #{{ factura.ID_Factura }} - {{ factura.Cliente }} 
                                        ({{ factura.Fecha.strftime('%Y-%m-%d') if factura.Fecha else '' }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-6" id="cliente-container" style="display: none;">
                                <label class="form-label">Cliente</label>
                                <select name="id_cliente" class="form-select" id="select-cliente">
                                    <option value="">Seleccionar...</option>
                                    {% for cliente in clientes %}
                                    <option value="{{ cliente.ID_Cliente }}">
                                        {{ cliente.Nombre }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-6" id="tipo-pago-container" style="display: none;">
                                <label class="form-label">Tipo de Pago</label>
                                <select name="tipo_pago" class="form-select" id="select-tipo-pago">
                                    <option value="CONTADO">Contado</option>
                                    <option value="CREDITO">Crédito</option>
                                </select>
                            </div>
                            
                            <div class="col-12" id="observacion-factura-container" style="display: none;">
                                <label class="form-label">Observaciones para Factura</label>
                                <textarea name="observacion_factura" class="form-control" rows="2"></textarea>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">Observaciones Generales</label>
                                <textarea name="observacion" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                        
                        <!-- Productos -->
                        <div class="mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">
                                    <i class="fas fa-boxes me-2"></i>Productos a Retirar
                                </h5>
                                <button type="button" class="btn btn-primary btn-sm" 
                                        onclick="agregarProductoSalida()">
                                    <i class="fas fa-plus me-1"></i> Agregar Producto
                                </button>
                            </div>
                            
                            <div class="table-responsive" id="tabla-productos-container" style="display: none;">
                                <table class="table table-sm">
                                    <thead>
                                        <tr class="table-light">
                                            <th>Producto</th>
                                            <th>Stock Disponible</th>
                                            <th>Cantidad</th>
                                            <th>Costo Unitario</th>
                                            <th>Precio Unitario</th>
                                            <th>Subtotal</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productos-tbody">
                                        <!-- Productos se agregarán aquí dinámicamente -->
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-secondary">
                                            <td colspan="5" class="text-end"><strong>Total:</strong></td>
                                            <td><strong id="total-salida">C$0.00</strong></td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            
                            <div class="alert alert-info" id="alerta-sin-productos">
                                <i class="fas fa-info-circle me-2"></i>
                                Seleccione una bodega y agregue productos usando el botón o la lista
                            </div>
                            
                            <input type="hidden" name="productos" id="productos-json" value="[]" required>
                        </div>
                        
                        <div class="mt-4 pt-3 border-top">
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-2" 
                                        onclick="window.history.back()">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-danger" id="btn-guardar" disabled>
                                    <i class="fas fa-save me-1"></i> Guardar Salida
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Productos Disponibles en Bodega -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-box me-1"></i>Productos Disponibles
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info" role="alert" id="alerta-bodega">
                        <i class="fas fa-info-circle me-1"></i>
                        Seleccione una bodega para ver los productos disponibles
                    </div>
                    
                    <div class="input-group mb-3">
                        <input type="text" id="buscar-producto-bodega" class="form-control" 
                               placeholder="Buscar producto..." disabled>
                        <button class="btn btn-outline-primary" type="button" onclick="filtrarProductos()" disabled>
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <div id="lista-productos-bodega" class="list-group" 
                         style="max-height: 400px; overflow-y: auto;">
                        <div class="text-center text-muted p-3">
                            <i class="fas fa-warehouse fa-2x mb-2"></i><br>
                            Seleccione una bodega primero
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Resumen -->
            <div class="card shadow">
                <div class="card-header py-3 bg-info text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-clipboard-check me-1"></i>Resumen
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Productos:</span>
                            <strong id="resumen-cantidad">0</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Total Unidades:</span>
                            <strong id="resumen-unidades">0.00</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Total Costo:</span>
                            <strong id="resumen-costo">C$0.00</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Total Venta:</span>
                            <strong id="resumen-total">C$0.00</strong>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
let productosSalida = [];
let contadorProductos = 0;
let productosDisponibles = [];
let bodegaSeleccionada = null;
let searchTimeout;

// Configurar campos según tipo de movimiento
function configurarCamposPorTipoSalida() {
    const tipoMovimiento = document.getElementById('tipo-movimiento').value;
    const esVenta = tipoMovimiento === '2'; // TIPO_VENTA = 2
    
    // Mostrar/ocultar campos de facturación
    const mostrar = esVenta ? 'block' : 'none';
    
    document.getElementById('factura-container').style.display = mostrar;
    document.getElementById('cliente-container').style.display = mostrar;
    document.getElementById('tipo-pago-container').style.display = mostrar;
    document.getElementById('observacion-factura-container').style.display = mostrar;
    
    // Configurar campos requeridos
    document.getElementById('select-cliente').required = esVenta;
    document.getElementById('select-tipo-pago').required = esVenta;
    
    // Si no es venta, limpiar campos de facturación
    if (!esVenta) {
        document.getElementById('select-cliente').value = '';
        document.getElementById('select-tipo-pago').value = 'CONTADO';
        document.querySelector('textarea[name="observacion_factura"]').value = '';
    }
    
    habilitarBotonGuardar();
}

// Cargar productos de manera inteligente (con o sin bodega)
function cargarProductosDisponibles() {
    const buscarInput = document.getElementById('buscar-producto-bodega');
    const lista = document.getElementById('lista-productos-bodega');
    const alerta = document.getElementById('alerta-bodega');
    const contador = document.getElementById('contador-productos');
    
    bodegaSeleccionada = document.getElementById('select-bodega').value;
    const terminoBusqueda = buscarInput.value.trim();
    
    // Construir URL
    let url = `/api/productos/stock?limit=150`;
    if (bodegaSeleccionada) {
        url += `&bodega=${bodegaSeleccionada}`;
    }
    if (terminoBusqueda) {
        url += `&search=${encodeURIComponent(terminoBusqueda)}`;
    }
    
    // Mostrar loading
    alerta.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-spinner fa-spin me-2"></i>
            <span>Cargando productos...</span>
        </div>
    `;
    alerta.style.display = 'block';
    lista.innerHTML = '';
    
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Error desconocido');
            }
            
            productosDisponibles = data.productos;
            
            // Actualizar contador
            if (contador) {
                contador.textContent = productosDisponibles.length;
            }
            
            if (productosDisponibles.length === 0) {
                let mensaje = 'No se encontraron productos';
                if (terminoBusqueda) {
                    mensaje += ` que coincidan con "${terminoBusqueda}"`;
                }
                if (bodegaSeleccionada) {
                    mensaje += ' en esta bodega';
                }
                
                lista.innerHTML = `
                    <div class="alert alert-warning m-0">
                        <i class="fas fa-search me-2"></i>
                        ${mensaje}
                    </div>
                `;
                alerta.style.display = 'none';
            } else {
                alerta.style.display = 'none';
                mostrarProductosEnLista();
            }
            
            // Actualizar información del filtro
            actualizarInfoFiltro();
        })
        .catch(error => {
            console.error('Error:', error);
            lista.innerHTML = `
                <div class="alert alert-danger m-0">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error al cargar productos: ${error.message}
                </div>
            `;
            alerta.style.display = 'none';
            
            // Resetear contador
            if (contador) {
                contador.textContent = '0';
            }
        });
}

// Mostrar productos en la lista con información contextual
function mostrarProductosEnLista() {
    const lista = document.getElementById('lista-productos-bodega');
    const bodegaSelect = document.getElementById('select-bodega');
    const bodegaNombre = bodegaSelect.options[bodegaSelect.selectedIndex]?.text || '';
    
    lista.innerHTML = '';
    
    productosDisponibles.forEach(producto => {
        const item = document.createElement('div');
        item.className = 'list-group-item list-group-item-action producto-item';
        item.dataset.id = producto.ID_Producto;
        
        // Calcular stock a mostrar
        const stockMostrar = bodegaSeleccionada ? 
            producto.Stock_Relevante : 
            producto.Stock_Total;
        
        // Determinar color del badge según stock
        let badgeClass = 'bg-secondary';
        if (stockMostrar > 0) {
            badgeClass = stockMostrar > (producto.Stock_Minimo || 0) ? 'bg-success' : 'bg-warning';
        }
        
        // Construir información de stock
        let stockInfo = '';
        if (bodegaSeleccionada) {
            stockInfo = `<small class="text-muted d-block">Stock en ${bodegaNombre}</small>`;
        } else if (Object.keys(producto.Stock_por_Bodega || {}).length > 0) {
            const bodegasConStock = Object.keys(producto.Stock_por_Bodega);
            stockInfo = `<small class="text-muted d-block">Disponible en ${bodegasConStock.length} bodega(s)</small>`;
        }
        
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1 me-3">
                    <h6 class="mb-1 text-primary">${producto.Descripcion}</h6>
                    <div class="small text-muted mb-1">
                        <span class="me-2"><i class="fas fa-barcode me-1"></i>${producto.COD_Producto || 'Sin código'}</span>
                        <span><i class="fas fa-tag me-1"></i>${producto.Categoria_Descripcion || 'Sin categoría'}</span>
                    </div>
                    ${stockInfo}
                </div>
                <div class="text-end">
                    <div class="mb-1">
                        <span class="badge ${badgeClass}">
                            ${stockMostrar.toFixed(2)} ${bodegaSeleccionada ? 'disp.' : 'total'}
                        </span>
                    </div>
                    <div class="text-primary fw-bold">C$${producto.Precio_Venta.toFixed(2)}</div>
                    <small class="text-muted">${producto.Unidad_Descripcion || 'Unidad'}</small>
                </div>
            </div>
        `;
        
        // Agregar evento click
        item.addEventListener('click', (e) => {
            if (!e.target.closest('.btn')) {
                seleccionarProductoParaSalida(producto);
            }
        });
        lista.appendChild(item);
    });
}

// Actualizar información del filtro aplicado
function actualizarInfoFiltro() {
    const alertaTexto = document.getElementById('alerta-texto');
    const bodegaSelect = document.getElementById('select-bodega');
    
    if (!alertaTexto) return;
    
    if (bodegaSeleccionada) {
        const bodegaNombre = bodegaSelect.options[bodegaSelect.selectedIndex].text;
        alertaTexto.innerHTML = `
            <i class="fas fa-warehouse me-1"></i>
            Mostrando productos con stock en: <strong>${bodegaNombre}</strong>
            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="limpiarFiltroBodega()">
                <i class="fas fa-times me-1"></i>Ver todos
            </button>
        `;
    } else {
        alertaTexto.innerHTML = `
            <i class="fas fa-boxes me-1"></i>
            Mostrando todos los productos con stock en cualquier bodega.
            <small class="d-block mt-1">Seleccione una bodega para ver disponibilidad específica.</small>
        `;
    }
}

// Limpiar filtro de bodega
function limpiarFiltroBodega() {
    document.getElementById('select-bodega').value = '';
    bodegaSeleccionada = null;
    cargarProductosDisponibles();
    habilitarBotonGuardar();
}

// Filtrar productos por búsqueda (función alternativa para compatibilidad)
function filtrarProductos() {
    cargarProductosDisponibles();
}

// Agregar producto a salida
function agregarProductoSalida(producto = null) {
    const tbody = document.getElementById('productos-tbody');
    const index = contadorProductos++;
    
    const fila = document.createElement('tr');
    fila.id = `producto-salida-${index}`;
    fila.dataset.productoId = producto ? producto.ID_Producto : '';
    
    if (producto) {
        // Calcular stock disponible para esta bodega
        const stockDisponible = bodegaSeleccionada ? 
            producto.Stock_Relevante : 
            producto.Stock_Total;
        
        // Precio de venta por defecto
        const precioVenta = producto.Precio_Venta || 0;
        
        // Sugerir costo (60% del precio de venta para ventas)
        const tipoMovimiento = document.getElementById('tipo-movimiento').value;
        const costoCalculado = tipoMovimiento === '2' ? (precioVenta * 0.6).toFixed(2) : '0.00';
        
        fila.innerHTML = `
            <td>
                <input type="hidden" name="productos[${index}][id_producto]" 
                       value="${producto.ID_Producto}" class="id-producto">
                <div>
                    <strong>${producto.Descripcion}</strong><br>
                    <small class="text-muted">${producto.COD_Producto || 'Sin código'}</small>
                </div>
            </td>
            <td class="text-center">
                <span class="badge bg-success stock-disponible">${stockDisponible.toFixed(2)}</span>
            </td>
            <td>
                <input type="number" step="0.001" min="0.001" max="${stockDisponible}"
                       name="productos[${index}][cantidad]" 
                       class="form-control form-control-sm cantidad" 
                       value="1" 
                       onchange="validarCantidad(${index})" 
                       oninput="validarCantidad(${index})" 
                       required>
                <small class="text-danger d-block error-cantidad" style="font-size: 0.7em;"></small>
            </td>
            <td>
                <input type="number" step="0.01" min="0" 
                       name="productos[${index}][costo_unitario]" 
                       class="form-control form-control-sm costo" 
                       value="${costoCalculado}"
                       onchange="calcularSubtotalSalida(${index})" 
                       oninput="calcularSubtotalSalida(${index})" 
                       required>
            </td>
            <td>
                <input type="number" step="0.01" min="0" 
                       name="productos[${index}][precio_unitario]" 
                       class="form-control form-control-sm precio" 
                       value="${precioVenta.toFixed(2)}"
                       onchange="calcularSubtotalSalida(${index})" 
                       oninput="calcularSubtotalSalida(${index})">
            </td>
            <td>
                <input type="text" class="form-control form-control-sm subtotal" 
                       value="C$0.00" readonly>
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-danger btn-sm btn-eliminar" 
                        onclick="eliminarProductoSalida(${index})" 
                        title="Eliminar">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
    } else {
        // Opción para agregar producto manualmente
        fila.innerHTML = `
            <td colspan="7">
                <div class="alert alert-warning p-2 m-0 text-center">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    <small>Seleccione un producto de la lista</small>
                </div>
                <input type="hidden" name="productos[${index}][id_producto]" class="id-producto">
            </td>
        `;
    }
    
    tbody.appendChild(fila);
    
    // Mostrar tabla y ocultar alerta
    document.getElementById('tabla-productos-container').style.display = 'block';
    document.getElementById('alerta-sin-productos').style.display = 'none';
    
    if (producto) {
        calcularSubtotalSalida(index);
    }
    
    actualizarResumenSalida();
    habilitarBotonGuardar();
}

// Validar cantidad no exceda stock
function validarCantidad(index) {
    const fila = document.getElementById(`producto-salida-${index}`);
    if (!fila) return;
    
    const cantidadInput = fila.querySelector('.cantidad');
    const errorElement = fila.querySelector('.error-cantidad');
    const stockBadge = fila.querySelector('.stock-disponible');
    
    if (!cantidadInput || !errorElement || !stockBadge) return;
    
    // Obtener stock máximo
    let maxStock = 0;
    const stockText = stockBadge.textContent.trim();
    const match = stockText.match(/[\d.]+/);
    if (match) {
        maxStock = parseFloat(match[0]) || 0;
    }
    
    const cantidad = parseFloat(cantidadInput.value) || 0;
    
    // Validar
    if (cantidad <= 0) {
        cantidadInput.value = 1;
        errorElement.textContent = 'Mínimo: 0.001';
        errorElement.classList.remove('d-none');
        errorElement.classList.add('d-block');
    } else if (maxStock > 0 && cantidad > maxStock) {
        cantidadInput.value = maxStock;
        errorElement.textContent = `Máximo: ${maxStock.toFixed(2)}`;
        errorElement.classList.remove('d-none');
        errorElement.classList.add('d-block');
    } else {
        errorElement.classList.remove('d-block');
        errorElement.classList.add('d-none');
    }
    
    calcularSubtotalSalida(index);
}

// Calcular subtotal para salida
function calcularSubtotalSalida(index) {
    const fila = document.getElementById(`producto-salida-${index}`);
    if (!fila) return;
    
    const cantidadInput = fila.querySelector('.cantidad');
    const costoInput = fila.querySelector('.costo');
    const subtotalInput = fila.querySelector('.subtotal');
    
    if (!cantidadInput || !costoInput || !subtotalInput) return;
    
    const cantidad = parseFloat(cantidadInput.value) || 0;
    const costo = parseFloat(costoInput.value) || 0;
    const subtotal = cantidad * costo;
    
    subtotalInput.value = `C$${subtotal.toFixed(2)}`;
    actualizarResumenSalida();
}

// Eliminar producto de salida
function eliminarProductoSalida(index) {
    const fila = document.getElementById(`producto-salida-${index}`);
    if (fila) {
        fila.remove();
        actualizarResumenSalida();
        
        // Si no quedan productos, mostrar alerta
        const tbody = document.getElementById('productos-tbody');
        if (tbody.children.length === 0) {
            document.getElementById('tabla-productos-container').style.display = 'none';
            document.getElementById('alerta-sin-productos').style.display = 'block';
        }
    }
    
    habilitarBotonGuardar();
}

// Actualizar stock de productos ya agregados cuando cambia la bodega
function actualizarStockProductosAgregados() {
    if (!bodegaSeleccionada || productosDisponibles.length === 0) return;
    
    document.querySelectorAll('#productos-tbody tr').forEach(fila => {
        const idProducto = fila.dataset.productoId;
        if (!idProducto) return;
        
        // Buscar el producto en la lista de disponibles
        const producto = productosDisponibles.find(p => p.ID_Producto == idProducto);
        if (!producto) return;
        
        const stockBadge = fila.querySelector('.stock-disponible');
        const cantidadInput = fila.querySelector('.cantidad');
        
        if (stockBadge && cantidadInput) {
            const stockDisponible = bodegaSeleccionada ? 
                producto.Stock_Relevante : 
                producto.Stock_Total;
            
            // Actualizar badge
            stockBadge.textContent = stockDisponible.toFixed(2);
            stockBadge.className = 'badge ' + (stockDisponible > 0 ? 'bg-success' : 'bg-danger');
            
            // Actualizar máximo del input
            cantidadInput.max = stockDisponible;
            
            // Si la cantidad actual excede el nuevo stock, ajustar
            const cantidadActual = parseFloat(cantidadInput.value) || 0;
            if (cantidadActual > stockDisponible) {
                cantidadInput.value = stockDisponible;
                validarCantidad(Array.from(fila.parentNode.children).indexOf(fila));
            }
        }
    });
}

// Actualizar resumen de salida
function actualizarResumenSalida() {
    let totalCosto = 0;
    let totalVenta = 0;
    let unidades = 0;
    let cantidadProductos = 0;
    
    document.querySelectorAll('#productos-tbody tr').forEach(fila => {
        const cantidadInput = fila.querySelector('.cantidad');
        const costoInput = fila.querySelector('.costo');
        const precioInput = fila.querySelector('.precio');
        const idProductoInput = fila.querySelector('.id-producto');
        
        if (!cantidadInput || !costoInput || !idProductoInput || !idProductoInput.value) return;
        
        const cantidad = parseFloat(cantidadInput.value) || 0;
        const costo = parseFloat(costoInput.value) || 0;
        const precio = precioInput ? parseFloat(precioInput.value) || 0 : 0;
        
        if (cantidad > 0 && costo >= 0) {
            unidades += cantidad;
            totalCosto += cantidad * costo;
            totalVenta += cantidad * precio;
            cantidadProductos++;
        }
    });
    
    // Actualizar UI
    document.getElementById('resumen-cantidad').textContent = cantidadProductos;
    document.getElementById('resumen-unidades').textContent = unidades.toFixed(3);
    document.getElementById('resumen-costo').textContent = `C$${totalCosto.toFixed(2)}`;
    document.getElementById('resumen-total').textContent = `C$${totalVenta.toFixed(2)}`;
    document.getElementById('total-salida').textContent = `C$${totalCosto.toFixed(2)}`;
    
    // Actualizar JSON oculto
    const productosData = [];
    document.querySelectorAll('#productos-tbody tr').forEach(fila => {
        const idProductoInput = fila.querySelector('.id-producto');
        const cantidadInput = fila.querySelector('.cantidad');
        const costoInput = fila.querySelector('.costo');
        const precioInput = fila.querySelector('.precio');
        
        if (idProductoInput && idProductoInput.value && 
            cantidadInput && costoInput) {
            const producto = {
                id_producto: idProductoInput.value,
                cantidad: cantidadInput.value,
                costo_unitario: costoInput.value,
                precio_unitario: precioInput ? precioInput.value : '0.00'
            };
            productosData.push(producto);
        }
    });
    
    document.getElementById('productos-json').value = JSON.stringify(productosData);
    habilitarBotonGuardar();
}

// Habilitar o deshabilitar botón guardar
function habilitarBotonGuardar() {
    const productosData = JSON.parse(document.getElementById('productos-json').value || '[]');
    const btnGuardar = document.getElementById('btn-guardar');
    const bodegaSeleccionada = document.getElementById('select-bodega').value;
    const tipoMovimiento = document.getElementById('tipo-movimiento').value;
    
    let habilitar = false;
    
    if (productosData.length > 0 && bodegaSeleccionada && tipoMovimiento) {
        // Verificar que todos los productos tengan datos válidos
        const todosValidos = productosData.every(p => 
            p.id_producto && 
            p.cantidad && parseFloat(p.cantidad) > 0 &&
            p.costo_unitario && parseFloat(p.costo_unitario) >= 0
        );
        
        // Si es venta, verificar cliente seleccionado
        if (tipoMovimiento === '2') {
            const clienteSeleccionado = document.getElementById('select-cliente').value;
            const tipoPagoSeleccionado = document.getElementById('select-tipo-pago').value;
            const facturaExistente = document.querySelector('select[name="id_factura_venta"]').value;
            
            // Para ventas, necesita cliente o factura existente
            habilitar = todosValidos && (clienteSeleccionado || facturaExistente) && tipoPagoSeleccionado;
        } else {
            habilitar = todosValidos;
        }
    }
    
    btnGuardar.disabled = !habilitar;
    
    // Cambiar estilo del botón
    if (!btnGuardar.disabled) {
        btnGuardar.classList.remove('btn-secondary');
        btnGuardar.classList.add('btn-danger');
    } else {
        btnGuardar.classList.remove('btn-danger');
        btnGuardar.classList.add('btn-secondary');
    }
}

// Seleccionar producto para salida (desde la lista)
function seleccionarProductoParaSalida(producto) {
    // Verificar si ya existe en la tabla
    const existente = Array.from(document.querySelectorAll('.id-producto'))
        .find(input => input.value == producto.ID_Producto);
    
    if (existente) {
        // Encontrar la fila y resaltarla
        const filaExistente = existente.closest('tr');
        if (filaExistente) {
            filaExistente.classList.add('table-warning');
            setTimeout(() => filaExistente.classList.remove('table-warning'), 1000);
            
            // Hacer scroll a la fila
            filaExistente.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // Mostrar alerta suave
        const alerta = document.createElement('div');
        alerta.className = 'alert alert-warning alert-dismissible fade show position-fixed top-0 end-0 m-3';
        alerta.style.zIndex = '1050';
        alerta.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            Este producto ya está en la lista
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alerta);
        setTimeout(() => alerta.remove(), 3000);
        return;
    }
    
    // Agregar el producto
    agregarProductoSalida(producto);
    
    // Resaltar la fila nueva
    const nuevaFila = document.querySelector(`#productos-tbody tr:last-child`);
    if (nuevaFila) {
        nuevaFila.classList.add('table-success');
        setTimeout(() => nuevaFila.classList.remove('table-success'), 1000);
    }
}

// Validar formulario antes de enviar
function validarFormularioSalida() {
    const bodegaId = document.getElementById('select-bodega').value;
    if (!bodegaId) {
        mostrarAlerta('Debe seleccionar una bodega', 'error');
        return false;
    }
    
    const tipoMovimiento = document.getElementById('tipo-movimiento').value;
    if (!tipoMovimiento) {
        mostrarAlerta('Debe seleccionar un tipo de movimiento', 'error');
        return false;
    }
    
    // Validaciones específicas para ventas
    if (tipoMovimiento === '2') {
        const clienteId = document.getElementById('select-cliente').value;
        const facturaExistente = document.querySelector('select[name="id_factura_venta"]').value;
        
        if (!clienteId && !facturaExistente) {
            mostrarAlerta('Para ventas debe seleccionar un cliente o una factura existente', 'error');
            return false;
        }
        
        const tipoPago = document.getElementById('select-tipo-pago').value;
        if (!tipoPago) {
            mostrarAlerta('Debe seleccionar un tipo de pago', 'error');
            return false;
        }
    }
    
    const productosData = JSON.parse(document.getElementById('productos-json').value || '[]');
    
    if (productosData.length === 0) {
        mostrarAlerta('Debe agregar al menos un producto', 'error');
        return false;
    }
    
    // Verificar stock antes de enviar
    let stockValido = true;
    let mensajeError = '';
    
    document.querySelectorAll('#productos-tbody tr').forEach(fila => {
        const idProductoInput = fila.querySelector('.id-producto');
        const cantidadInput = fila.querySelector('.cantidad');
        const stockBadge = fila.querySelector('.stock-disponible');
        
        if (!idProductoInput || !idProductoInput.value || !cantidadInput) return;
        
        const productoNombre = fila.querySelector('strong') ? fila.querySelector('strong').textContent : 'Producto';
        const cantidad = parseFloat(cantidadInput.value) || 0;
        
        let stockDisponible = 0;
        if (stockBadge && stockBadge.textContent !== '-') {
            const match = stockBadge.textContent.match(/[\d.]+/);
            if (match) {
                stockDisponible = parseFloat(match[0]) || 0;
            }
        }
        
        if (cantidad > stockDisponible) {
            stockValido = false;
            mensajeError += `• ${productoNombre}: Solicitado ${cantidad.toFixed(2)}, Disponible ${stockDisponible.toFixed(2)}<br>`;
        }
    });
    
    if (!stockValido) {
        mostrarAlerta(`<strong>Stock insuficiente:</strong><br>${mensajeError}`, 'error', true);
        return false;
    }
    
    return true;
}

// Mostrar alerta personalizada
function mostrarAlerta(mensaje, tipo = 'info', html = false) {
    const alerta = document.createElement('div');
    alerta.className = `alert alert-${tipo} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    alerta.style.zIndex = '1050';
    alerta.style.maxWidth = '500px';
    
    if (html) {
        alerta.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
    } else {
        alerta.textContent = mensaje;
        alerta.innerHTML += '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
    }
    
    document.body.appendChild(alerta);
    setTimeout(() => alerta.remove(), 5000);
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Configurar fecha actual
    const fechaInput = document.querySelector('input[name="fecha"]');
    if (!fechaInput.value) {
        const hoy = new Date().toISOString().split('T')[0];
        fechaInput.value = hoy;
    }
    
    // Configurar cambios en tipo de movimiento
    document.getElementById('tipo-movimiento').addEventListener('change', configurarCamposPorTipoSalida);
    
    // Configurar cambios en bodega
    document.getElementById('select-bodega').addEventListener('change', function() {
        bodegaSeleccionada = this.value;
        cargarProductosDisponibles();
        actualizarStockProductosAgregados();
        habilitarBotonGuardar();
    });
    
    // Configurar cambios en cliente y tipo pago
    document.getElementById('select-cliente').addEventListener('change', habilitarBotonGuardar);
    document.getElementById('select-tipo-pago').addEventListener('change', habilitarBotonGuardar);
    document.querySelector('select[name="id_factura_venta"]').addEventListener('change', habilitarBotonGuardar);
    
    // Configurar búsqueda por Enter
    document.getElementById('buscar-producto-bodega').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            cargarProductosDisponibles();
        }
    });
    
    // Búsqueda en tiempo real (con debounce)
    document.getElementById('buscar-producto-bodega').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(cargarProductosDisponibles, 500);
    });
    
    // Botón de búsqueda
    const buscarBtn = document.querySelector('#buscar-producto-bodega + button');
    if (buscarBtn) {
        buscarBtn.addEventListener('click', cargarProductosDisponibles);
    }
    
    // Botón de agregar producto
    document.querySelector('button[onclick*="agregarProductoSalida"]').addEventListener('click', function(e) {
        e.preventDefault();
        agregarProductoSalida();
    });
    
    // Interceptar envío del formulario
    document.getElementById('formSalida').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!validarFormularioSalida()) {
            return false;
        }
        
        // Confirmar según tipo de movimiento
        const tipoMovimiento = document.getElementById('tipo-movimiento').value;
        const tipoMovimientoTexto = document.querySelector('#tipo-movimiento option:checked').textContent;
        const productosData = JSON.parse(document.getElementById('productos-json').value || '[]');
        
        let mensajeConfirmacion = '';
        
        if (tipoMovimiento === '2') {
            const tipoPago = document.getElementById('select-tipo-pago').value;
            const clienteSelect = document.getElementById('select-cliente');
            const cliente = clienteSelect.options[clienteSelect.selectedIndex]?.text || 'Cliente';
            const facturaExistente = document.querySelector('select[name="id_factura_venta"]').value;
            
            mensajeConfirmacion = `¿Está seguro de guardar esta VENTA?\n\n`;
            if (facturaExistente) {
                mensajeConfirmacion += `Factura existente: #${facturaExistente}\n`;
            } else {
                mensajeConfirmacion += `Cliente: ${cliente}\n`;
                mensajeConfirmacion += `Tipo de pago: ${tipoPago}\n`;
            }
            mensajeConfirmacion += `Productos: ${productosData.length}\n`;
            mensajeConfirmacion += `Total: ${document.getElementById('total-salida').textContent}\n\n`;
            mensajeConfirmacion += `Esta acción:\n`;
            mensajeConfirmacion += `1. Descontará productos del inventario\n`;
            mensajeConfirmacion += `2. ${facturaExistente ? 'Actualizará' : 'Creará'} una factura\n`;
            if (tipoPago === 'CREDITO' && !facturaExistente) {
                mensajeConfirmacion += '3. Creará una cuenta por cobrar';
            }
        } else {
            mensajeConfirmacion = `¿Está seguro de guardar esta ${tipoMovimientoTexto.toUpperCase()}?\n\n`;
            mensajeConfirmacion += `Bodega: ${document.querySelector('#select-bodega option:checked').text}\n`;
            mensajeConfirmacion += `Productos: ${productosData.length}\n`;
            mensajeConfirmacion += `Total: ${document.getElementById('total-salida').textContent}`;
        }
        
        if (confirm(mensajeConfirmacion)) {
            this.submit();
        }
    });
    
    // Inicializar
    configurarCamposPorTipoSalida();
    cargarProductosDisponibles();
    
    // Configurar tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Configurar auto-habilitación de búsqueda
    document.getElementById('buscar-producto-bodega').disabled = false;
    const buscarButton = document.querySelector('#buscar-producto-bodega + button');
    if (buscarButton) {
        buscarButton.disabled = false;
    }
});
</script>

<style>
.required:after {
    content: " *";
    color: #dc3545;
}

#productos-tbody tr td {
    vertical-align: middle;
}

.badge {
    min-width: 65px;
    font-size: 0.75rem;
    padding: 0.25em 0.4em;
}

.form-control-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    height: calc(1.5em + 0.5rem + 2px);
}

.list-group-item:hover {
    background-color: #f8f9fa;
    cursor: pointer;
    border-left: 3px solid #0d6efd;
}

#tabla-productos-container table th {
    white-space: nowrap;
    font-size: 0.875rem;
    background-color: #f8f9fa;
}

#tabla-productos-container table td {
    padding: 0.5rem;
}

.input-group .btn {
    padding-left: 0.75rem;
    padding-right: 0.75rem;
}

.text-primary {
    color: #0d6efd !important;
}

.text-success {
    color: #198754 !important;
}

.bg-success {
    background-color: #198754 !important;
}

.bg-info {
    background-color: #0dcaf0 !important;
}

.bg-danger {
    background-color: #dc3545 !important;
}

.bg-primary {
    background-color: #0d6efd !important;
}

.btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
}

.btn-danger:hover {
    background-color: #bb2d3b;
    border-color: #b02a37;
}

.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.btn-primary:hover {
    background-color: #0b5ed7;
    border-color: #0a58ca;
}
</style>
{% endblock %}