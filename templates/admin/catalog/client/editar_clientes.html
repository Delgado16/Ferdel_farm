{% extends "layout.html" %}

{% block title %}Editar Cliente - FerDel{% endblock %}

{% block head %}
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
<style>
    .client-card {
        border-left: 4px solid #0d6efd;
    }
    .form-label.required::after {
        content: " *";
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Encabezado con botón de volver -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="bi bi-pencil-square"></i> Editar Cliente
        </h1>
        <a href="{{ url_for('admin_clientes') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Volver a Clientes
        </a>
    </div>

    <!-- Información del cliente -->
    <div class="card client-card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h5 class="card-title">
                        Cliente #{{ cliente.ID_Cliente }}
                        <span class="badge bg-{% if cliente.Estado == 'ACTIVO' %}success{% else %}danger{% endif %}">
                            {{ cliente.Estado }}
                        </span>
                    </h5>
                    <p class="card-text">
                        <strong>Nombre:</strong> {{ cliente.Nombre }}<br>
                        <strong>Identificación:</strong> {{ cliente.RUC_CEDULA or 'No especificada' }}<br>
                        <strong>Ruta actual:</strong> {{ cliente.Nombre_Ruta or 'Sin ruta asignada' }}<br>
                        <strong>Fecha de creación:</strong> {{ cliente.Fecha_Creacion|default('No disponible', true) }}
                    </p>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-info mb-0">
                        <small>
                            <i class="bi bi-info-circle"></i> <strong>Notas importantes:</strong><br>
                            1. Los clientes inactivos no aparecerán en las listas de selección<br>
                            2. El RUC/Cédula debe ser único solo entre clientes activos<br>
                            3. Puedes reactivar un cliente cambiando su estado a "Activo"<br>
                            4. La ruta es opcional y ayuda en la organización de entregas
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario de edición -->
    <div class="card shadow">
        <div class="card-body">
            <form method="post" action="{{ url_for('admin_editar_cliente', id=cliente.ID_Cliente) }}" 
                  id="editarClienteForm" class="row g-3" novalidate>
                
                <!-- Nombre Completo -->
                <div class="col-md-6">
                    <label for="nombre" class="form-label required">Nombre Completo</label>
                    <input type="text" name="nombre" id="nombre" class="form-control" 
                           value="{{ cliente.Nombre }}" 
                           required minlength="2" maxlength="255"
                           placeholder="Ingrese el nombre completo">
                    <div class="invalid-feedback">El nombre es obligatorio (mínimo 2 caracteres).</div>
                </div>

                <!-- RUC/Cédula -->
                <div class="col-md-6">
                    <label for="ruc_cedula" class="form-label">RUC/Cédula</label>
                    <input type="text" name="ruc_cedula" id="ruc_cedula" class="form-control" 
                           value="{{ cliente.RUC_CEDULA or '' }}"
                           maxlength="13" pattern="\d*"
                           placeholder="Ej: 1234567890123 o 1234567890"
                           oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    <div class="form-text">
                        Solo números. Cédula: 10 dígitos | RUC: 13 dígitos
                    </div>
                    <div class="invalid-feedback" id="rucErrorEditar">
                        El RUC/Cédula debe tener 10 (cédula) o 13 (RUC) dígitos numéricos.
                    </div>
                </div>

                <!-- Teléfono -->
                <div class="col-md-6">
                    <label for="telefono" class="form-label required">Teléfono</label>
                    <input type="tel" name="telefono" id="telefono" class="form-control" 
                           value="{{ cliente.Telefono or '' }}"
                           required maxlength="20"
                           placeholder="Ej: 0991234567"
                           oninput="this.value = this.value.replace(/[^0-9+\-()\s]/g, '')">
                    <div class="invalid-feedback">Por favor ingrese un número de teléfono válido.</div>
                </div>

                <!-- Tipo de Cliente -->
                <div class="col-md-6">
                    <label for="tipo_cliente" class="form-label required">Tipo de Cliente</label>
                    <select name="tipo_cliente" id="tipo_cliente" class="form-select" required>
                        <option value="" disabled {% if not cliente.tipo_cliente %}selected{% endif %}>Seleccione...</option>
                        <option value="Comun" {% if cliente.tipo_cliente == 'Comun' %}selected{% endif %}>Cliente Común</option>
                        <option value="Especial" {% if cliente.tipo_cliente == 'Especial' %}selected{% endif %}>Cliente Especial</option>
                    </select>
                    <div class="form-text">
                        Los clientes especiales pueden tener condiciones diferentes
                    </div>
                    <div class="invalid-feedback">Por favor seleccione el tipo de cliente.</div>
                </div>

                <!-- Dirección -->
                <div class="col-md-8">
                    <label for="direccion" class="form-label">Dirección</label>
                    <textarea name="direccion" id="direccion" class="form-control" 
                              rows="2" maxlength="200"
                              placeholder="Ingrese la dirección completa">{{ cliente.Direccion or '' }}</textarea>
                    <div class="form-text">Máximo 200 caracteres</div>
                </div>

                <!-- Estado -->
                <div class="col-md-4">
                    <label for="estado" class="form-label required">Estado</label>
                    <select name="estado" id="estado" class="form-select" required>
                        <option value="ACTIVO" {% if cliente.Estado == 'ACTIVO' %}selected{% endif %}>Activo</option>
                        <option value="INACTIVO" {% if cliente.Estado == 'INACTIVO' %}selected{% endif %}>Inactivo</option>
                    </select>
                    <div class="form-text">
                        Los clientes inactivos no aparecerán en listas
                    </div>
                    <div class="invalid-feedback">Por favor seleccione el estado del cliente.</div>
                </div>
                
                <!-- Ruta de Entrega (Nuevo campo) -->
                <div class="col-md-6">
                    <label for="id_ruta" class="form-label">Ruta de Entrega</label>
                    <select name="id_ruta" id="id_ruta" class="form-select">
                        <option value="">Sin ruta asignada</option>
                        {% for ruta in rutas %}
                        <option value="{{ ruta.ID_Ruta }}" 
                                {% if cliente.ID_Ruta == ruta.ID_Ruta %}selected{% endif %}>
                            {{ ruta.Nombre_Ruta }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Seleccione una ruta para la entrega de productos (opcional)</div>
                </div>

                <!-- Botones -->
                <div class="col-12 mt-4 pt-3 border-top">
                    <div class="d-flex justify-content-between">
                        <div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Guardar Cambios
                            </button>
                            <a href="{{ url_for('admin_clientes') }}" class="btn btn-outline-secondary ms-2">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                        </div>
                        {% if cliente.Estado == 'ACTIVO' %}
                        <button type="button" class="btn btn-outline-danger" 
                                data-bs-toggle="modal" data-bs-target="#eliminarClienteModal">
                            <i class="bi bi-trash"></i> Eliminar Cliente
                        </button>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de confirmación para eliminar -->
<div class="modal fade" id="eliminarClienteModal" tabindex="-1" aria-labelledby="eliminarClienteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="eliminarClienteModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro que desea eliminar al cliente <strong>{{ cliente.Nombre }}</strong>?</p>
                <p class="text-danger small">
                    <i class="bi bi-info-circle"></i> Esta acción cambiará el estado del cliente a INACTIVO y no podrá ser seleccionado en nuevas operaciones.
                </p>
                <div class="alert alert-warning">
                    <small>
                        <i class="bi bi-exclamation-triangle"></i> 
                        <strong>Advertencia:</strong> Si el cliente tiene facturas o transacciones pendientes, 
                        es recomendable cambiar el estado a "Inactivo" en lugar de eliminar.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <form method="POST" action="{{ url_for('admin_eliminar_cliente', id=cliente.ID_Cliente) }}" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Sí, Eliminar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const editarForm = document.getElementById('editarClienteForm');
    const telefonoInput = document.getElementById('telefono');
    const rucCedulaInput = document.getElementById('ruc_cedula');
    const estadoSelect = document.getElementById('estado');
    
    // Validación de RUC/Cédula
    function validateRucCedula() {
        if (!rucCedulaInput.value) {
            rucCedulaInput.setCustomValidity('');
            rucCedulaInput.classList.remove('is-invalid');
            return true;
        }
        
        const value = rucCedulaInput.value.replace(/\D/g, '');
        if (value.length !== 10 && value.length !== 13) {
            rucCedulaInput.setCustomValidity('Debe tener 10 (cédula) o 13 (RUC) dígitos');
            rucCedulaInput.classList.add('is-invalid');
            return false;
        } else {
            rucCedulaInput.setCustomValidity('');
            rucCedulaInput.classList.remove('is-invalid');
            return true;
        }
    }
    
    // Validación de Teléfono
    function validateTelefono() {
        if (!telefonoInput.value.trim()) {
            telefonoInput.setCustomValidity('El teléfono es obligatorio');
            telefonoInput.classList.add('is-invalid');
            return false;
        }
        
        const value = telefonoInput.value.trim();
        if (value.length < 7) {
            telefonoInput.setCustomValidity('El teléfono debe tener al menos 7 dígitos');
            telefonoInput.classList.add('is-invalid');
            return false;
        } else {
            telefonoInput.setCustomValidity('');
            telefonoInput.classList.remove('is-invalid');
            return true;
        }
    }
    
    // Validar RUC solo si el estado es ACTIVO
    function validateRucForEstado() {
        if (estadoSelect.value === 'ACTIVO' && rucCedulaInput.value) {
            return validateRucCedula();
        }
        return true;
    }
    
    // Event listeners para validación en tiempo real
    telefonoInput.addEventListener('input', validateTelefono);
    rucCedulaInput.addEventListener('input', validateRucCedula);
    estadoSelect.addEventListener('change', validateRucForEstado);
    
    // Validación del formulario de edición
    editarForm.addEventListener('submit', function(event) {
        const isTelefonoValid = validateTelefono();
        const isRucCedulaValid = validateRucForEstado();
        
        if (!isTelefonoValid || !isRucCedulaValid || !editarForm.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        editarForm.classList.add('was-validated');
    });
    
    // Auto-focus en el campo nombre
    document.getElementById('nombre').focus();
    // Mover cursor al final del texto
    const nombreInput = document.getElementById('nombre');
    nombreInput.selectionStart = nombreInput.selectionEnd = nombreInput.value.length;
    
    // Validar RUC al cargar la página si está presente y activo
    if (rucCedulaInput.value && estadoSelect.value === 'ACTIVO') {
        validateRucCedula();
    }
    
    // Mostrar advertencia si el RUC ya existe para otro cliente activo
    {% if cliente.Estado == 'ACTIVO' and cliente.RUC_CEDULA %}
    // Esta validación se haría en el servidor, pero podemos agregar una nota visual
    const rucNote = document.createElement('div');
    rucNote.className = 'form-text text-warning';
    rucNote.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Si cambias este RUC/Cédula, asegúrate que no exista en otro cliente activo.';
    rucCedulaInput.parentNode.insertBefore(rucNote, rucCedulaInput.nextSibling);
    {% endif %}
    
    // Mostrar mensajes flash con toast
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                showToast('{{ category }}', '{{ message }}');
            {% endfor %}
        {% endif %}
    {% endwith %}
});

// Función para mostrar toasts de notificación
function showToast(category, message) {
    const toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    
    const toastId = 'toast-' + Date.now();
    const bgColor = category === 'success' ? 'bg-success' : 
                    category === 'danger' ? 'bg-danger' : 
                    category === 'warning' ? 'bg-warning' : 'bg-info';
    
    const toastHTML = `
        <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header ${bgColor} text-white">
                <strong class="me-auto">Notificación</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    toastContainer.innerHTML = toastHTML;
    document.body.appendChild(toastContainer);
    
    const toastEl = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
    toast.show();
    
    // Remover del DOM después de que se oculte
    toastEl.addEventListener('hidden.bs.toast', function () {
        toastContainer.remove();
    });
}
</script>
{% endblock %}