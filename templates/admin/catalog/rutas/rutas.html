{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid">
    <h2 class="mt-4">Gestión de Rutas</h2>
    
    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <span><i class="bi bi-signpost-split me-1"></i> Lista de Rutas</span>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#crearRutaModal">
                    <i class="bi bi-plus-circle"></i> Nueva Ruta
                </button>
            </div>
        </div>
            
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="tablaRutas" width="100%" cellspacing="0">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Descripción</th>
                        <th>Empresa</th>
                        <th>Estado</th>
                        <th>Fecha Creación</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ruta in rutas %}
                    <tr>
                        <td>{{ ruta.ID_Ruta }}</td>
                        <td>{{ ruta.Nombre_Ruta }}</td>
                        <td>{{ ruta.Descripcion or 'Sin descripción' }}</td>
                        <td>{{ ruta.Nombre_Empresa or 'Sin empresa' }}</td>
                        <td>
                            <span class="badge bg-{{ 'success' if ruta.Estado == 'Activa' else 'secondary' }}">
                                {{ ruta.Estado }}
                            </span>
                        </td>
                        <td>{{ ruta.Fecha_Creacion or 'N/A' }}</td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <!-- BOTÓN EDITAR - AHORA ES UN ENLACE A PÁGINA SEPARADA -->
                                <a href="{{ url_for('editar_ruta', id_ruta=ruta.ID_Ruta) }}" 
                                   class="btn btn-outline-warning me-1"
                                   title="Editar Ruta">
                                    <i class="bi bi-pencil-square"></i>
                                </a>
                                
                                <!-- Botón Cambiar Estado -->
                                <form action="{{ url_for('cambiar_estado_ruta', id_ruta=ruta.ID_Ruta) }}" 
                                      method="POST" class="d-inline me-1">
                                    <button type="submit" class="btn btn-{{ 'outline-warning' if ruta.Estado == 'Activa' else 'outline-success' }}"
                                            title="{{ 'Desactivar' if ruta.Estado == 'Activa' else 'Activar' }}">
                                        <i class="bi bi-{{ 'slash-circle' if ruta.Estado == 'Activa' else 'check-circle' }}"></i>
                                    </button>
                                </form>
                                
                                <!-- Botón Eliminar -->
                                <button type="button" class="btn btn-outline-danger btn-eliminar"
                                        data-ruta-id="{{ ruta.ID_Ruta }}"
                                        data-ruta-nombre="{{ ruta.Nombre_Ruta }}"
                                        title="Eliminar Ruta">
                                    <i class="bi bi-trash"></i>
                                </button>
                                
                                <!-- Botón Detalles -->
                                <button type="button" class="btn btn-outline-info btn-detalles"
                                        data-ruta-id="{{ ruta.ID_Ruta }}"
                                        data-ruta-nombre="{{ ruta.Nombre_Ruta }}"
                                        data-ruta-descripcion="{{ ruta.Descripcion or 'Sin descripción' }}"
                                        data-ruta-empresa="{{ ruta.Nombre_Empresa or 'Sin empresa' }}"
                                        data-ruta-estado="{{ ruta.Estado }}"
                                        data-ruta-fecha="{{ ruta.Fecha_Creacion or 'No disponible' }}"
                                        title="Ver Detalles">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            No hay rutas registradas. Crea una nueva ruta para comenzar.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ========== MODALES ========== -->

<!-- 1. MODAL PARA CREAR RUTA -->
<div class="modal fade" id="crearRutaModal" tabindex="-1" aria-labelledby="crearRutaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('crear_ruta') }}" id="formCrearRuta">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="crearRutaModalLabel">
                        <i class="bi bi-plus-circle"></i> Crear Nueva Ruta
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Mensajes Flash -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                {% if category == 'success' or category == 'danger' or category == 'warning' %}
                                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                    
                    <div class="row">
                        <!-- Columna izquierda -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nombre_ruta" class="form-label fw-bold">Nombre de la Ruta *</label>
                                <input type="text" class="form-control" id="nombre_ruta" name="nombre_ruta" 
                                       placeholder="Ej: Ruta Norte, Ruta Centro, etc." required
                                       maxlength="255" autocomplete="off">
                                <div class="form-text">Nombre único para identificar la ruta</div>
                            </div>
                        </div>
                        
                        <!-- Columna derecha -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_empresa" class="form-label fw-bold">Empresa Asignada *</label>
                                <select class="form-select" id="id_empresa" name="id_empresa" required>
                                    <option value="" selected disabled>-- Seleccione una empresa --</option>
                                    {% for empresa in empresas %}
                                    <option value="{{ empresa.ID_Empresa }}">{{ empresa.Nombre_Empresa }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Seleccione la empresa responsable de esta ruta</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Descripción en fila completa -->
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="descripcion" class="form-label fw-bold">Descripción</label>
                                <textarea class="form-control" id="descripcion" name="descripcion" 
                                          rows="3" placeholder="Descripción detallada de la ruta..."></textarea>
                                <div class="form-text">Opcional: Detalles sobre municipios cubiertos, características, etc.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <small>
                            <i class="bi bi-info-circle"></i> 
                            Los campos marcados con (*) son obligatorios. 
                            La ruta se creará con estado "Activa" por defecto.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary" id="btnCrearRuta">
                        <i class="bi bi-save"></i> Guardar Ruta
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 2. MODAL PARA ELIMINAR RUTA -->
<div class="modal fade" id="eliminarRutaModal" tabindex="-1" aria-labelledby="eliminarRutaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('eliminar_ruta') }}" id="formEliminarRuta">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="eliminarRutaModalLabel">
                        <i class="bi bi-exclamation-triangle"></i> Confirmar Eliminación
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Campo oculto para el ID de la ruta -->
                    <input type="hidden" name="id_ruta" id="delete_id_ruta">
                    
                    <div class="text-center mb-3">
                        <i class="bi bi-trash text-danger" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">¿Está seguro de eliminar esta ruta?</h5>
                    </div>
                    
                    <div class="alert alert-warning">
                        <h6>Ruta a eliminar:</h6>
                        <p class="mb-1"><strong>ID:</strong> <span id="delete_ruta_id"></span></p>
                        <p class="mb-1"><strong>Nombre:</strong> <span id="delete_ruta_nombre"></span></p>
                        <p class="mb-0"><strong>Esta acción no se puede deshacer.</strong></p>
                    </div>
                    
                    <div class="alert alert-danger">
                        <small>
                            <i class="bi bi-exclamation-circle"></i>
                            <strong>Advertencia:</strong> Si esta ruta está siendo utilizada en otros módulos del sistema, 
                            podría afectar su funcionamiento.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-danger" id="btnEliminarRuta">
                        <i class="bi bi-trash"></i> Sí, Eliminar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 3. MODAL PARA VER DETALLES -->
<div class="modal fade" id="detallesRutaModal" tabindex="-1" aria-labelledby="detallesRutaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="detallesRutaModalLabel">
                    <i class="bi bi-info-circle"></i> Detalles de la Ruta
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <dl class="row">
                    <dt class="col-sm-4">ID Ruta:</dt>
                    <dd class="col-sm-8" id="detalle_id">-</dd>
                    
                    <dt class="col-sm-4">Nombre:</dt>
                    <dd class="col-sm-8" id="detalle_nombre">-</dd>
                    
                    <dt class="col-sm-4">Descripción:</dt>
                    <dd class="col-sm-8" id="detalle_descripcion">-</dd>
                    
                    <dt class="col-sm-4">Empresa:</dt>
                    <dd class="col-sm-8" id="detalle_empresa">-</dd>
                    
                    <dt class="col-sm-4">Estado:</dt>
                    <dd class="col-sm-8">
                        <span class="badge" id="detalle_estado_badge">-</span>
                    </dd>
                    
                    <dt class="col-sm-4">Fecha Creación:</dt>
                    <dd class="col-sm-8" id="detalle_fecha">-</dd>
                </dl>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Estilos adicionales */
.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    border-radius: 0.25rem !important;
    margin-right: 2px;
}

.btn-group .btn:last-child {
    margin-right: 0;
}

.btn-outline-warning:hover {
    background-color: #ffc107;
    color: #000;
    border-color: #ffc107;
}

.btn-outline-danger:hover {
    background-color: #dc3545;
    color: #fff;
    border-color: #dc3545;
}

.btn-outline-success:hover {
    background-color: #198754;
    color: #fff;
    border-color: #198754;
}

.btn-outline-info:hover {
    background-color: #0dcaf0;
    color: #000;
    border-color: #0dcaf0;
}

#tablaRutas td, #tablaRutas th {
    padding: 0.5rem 0.75rem;
    vertical-align: middle;
}

#tablaRutas tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

/* Estilos para enlaces en la tabla */
#tablaRutas a.btn {
    text-decoration: none;
    transition: all 0.2s ease;
}

#tablaRutas a.btn:hover, #tablaRutas button.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Badges mejorados */
.badge {
    font-size: 0.85em;
    padding: 0.4em 0.8em;
    font-weight: 500;
    letter-spacing: 0.3px;
}

.bg-success {
    background-color: #198754 !important;
}

.bg-secondary {
    background-color: #6c757d !important;
}

/* Ajustar altura del textarea de descripción */
textarea#descripcion {
    min-height: 100px;
    resize: vertical;
}

/* Estilos para lista de detalles */
dl.row {
    margin-bottom: 0;
}

dl.row dt {
    font-weight: 600;
    color: #495057;
}

dl.row dd {
    color: #212529;
    word-break: break-word;
}

/* Responsive para la tabla */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.85rem;
    }
    
    .btn-group-sm .btn {
        padding: 0.2rem 0.4rem;
        font-size: 0.75rem;
    }
    
    .badge {
        font-size: 0.75em;
        padding: 0.3em 0.6em;
    }
    
    .modal-dialog {
        margin: 0.5rem;
    }
    
    dl.row dt, dl.row dd {
        padding: 0.25rem 0;
        font-size: 0.9rem;
    }
}

/* Mejorar visualización de modales en móviles */
@media (max-width: 576px) {
    .modal-body .row {
        flex-direction: column;
    }
    
    .modal-body .col-md-6 {
        width: 100%;
        margin-bottom: 1rem;
    }
}

/* Ajustes específicos para la tabla */
#tablaRutas th:nth-child(1) { width: 5%; }  /* ID */
#tablaRutas th:nth-child(2) { width: 20%; } /* Nombre */
#tablaRutas th:nth-child(3) { width: 25%; } /* Descripción */
#tablaRutas th:nth-child(4) { width: 20%; } /* Empresa */
#tablaRutas th:nth-child(5) { width: 10%; }  /* Estado */
#tablaRutas th:nth-child(6) { width: 15%; } /* Fecha Creación */
#tablaRutas th:nth-child(7) { width: 5%; }  /* Acciones */
</style>
{% endblock %}

{% block scripts %}
<!-- jQuery (necesario para DataTables) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables CSS y JS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    // Inicializar DataTable
    var table = $('#tablaRutas').DataTable({
        "order": [[0, "desc"]],
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json",
            "search": "Buscar:",
            "lengthMenu": "Mostrar _MENU_ registros por página",
            "zeroRecords": "No se encontraron registros",
            "info": "Mostrando página _PAGE_ de _PAGES_",
            "infoEmpty": "No hay registros disponibles",
            "infoFiltered": "(filtrado de _MAX_ registros totales)",
            "paginate": {
                "first": "Primera",
                "last": "Última",
                "next": "Siguiente",
                "previous": "Anterior"
            }
        },
        "responsive": true,
        "pageLength": 10,
        "lengthMenu": [10, 25, 50, 100],
        "columnDefs": [
            { 
                "orderable": false, 
                "targets": [5, 6], // Deshabilitar orden en columna Estado y Acciones
                "className": "text-center"
            },
            { 
                "width": "5%", 
                "targets": 0, // ID
                "className": "text-center"
            },
            { "width": "20%", "targets": 1 }, // Nombre
            { "width": "25%", "targets": 2 }, // Descripción
            { "width": "20%", "targets": 3 }, // Empresa
            { 
                "width": "10%", 
                "targets": 4, // Estado
                "className": "text-center"
            },
            { "width": "15%", "targets": 5 }, // Fecha Creación
            { 
                "width": "5%", 
                "targets": 6, // Acciones
                "className": "text-center"
            }
        ],
        "dom": '<"row mb-3"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6 d-flex justify-content-md-end"f>>rt<"row"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6"p>>',
        "initComplete": function(settings, json) {
            console.log('✅ DataTable de rutas inicializado');
        }
    });
    
    // ========== EVENTO PARA BOTONES ELIMINAR ==========
    $(document).on('click', '.btn-eliminar', function() {
        var rutaId = $(this).data('ruta-id');
        var nombre = $(this).data('ruta-nombre');
        
        console.log('Solicitando eliminación de ruta:', {rutaId, nombre});
        
        // Llenar el modal de eliminar con los datos
        $('#delete_id_ruta').val(rutaId);
        $('#delete_ruta_id').text(rutaId);
        $('#delete_ruta_nombre').text(nombre);
        
        // Mostrar el modal
        var eliminarModal = new bootstrap.Modal(document.getElementById('eliminarRutaModal'));
        eliminarModal.show();
    });
    
    // ========== EVENTO PARA BOTONES DETALLES ==========
    $(document).on('click', '.btn-detalles', function() {
        var rutaId = $(this).data('ruta-id');
        var nombre = $(this).data('ruta-nombre');
        var descripcion = $(this).data('ruta-descripcion');
        var empresa = $(this).data('ruta-empresa');
        var estado = $(this).data('ruta-estado');
        var fecha = $(this).data('ruta-fecha');
        
        // Llenar el modal de detalles
        $('#detalle_id').text(rutaId);
        $('#detalle_nombre').text(nombre);
        $('#detalle_descripcion').text(descripcion);
        $('#detalle_empresa').text(empresa);
        $('#detalle_estado_badge').text(estado);
        $('#detalle_fecha').text(fecha);
        
        // Establecer color del badge según el estado
        var badge = $('#detalle_estado_badge');
        badge.removeClass('bg-success bg-secondary');
        if (estado === 'Activa') {
            badge.addClass('bg-success');
        } else {
            badge.addClass('bg-secondary');
        }
        
        // Mostrar el modal
        var detallesModal = new bootstrap.Modal(document.getElementById('detallesRutaModal'));
        detallesModal.show();
    });
    
    // ========== VALIDACIONES PARA CREAR RUTA ==========
    $('#formCrearRuta').on('submit', function(e) {
        var nombre = $('#nombre_ruta').val().trim();
        var empresa = $('#id_empresa').val();
        
        // Validar nombre
        if (!nombre) {
            e.preventDefault();
            mostrarErrorModal('crear', 'El nombre de la ruta es obligatorio', '#nombre_ruta');
            return false;
        }
        
        if (nombre.length < 3) {
            e.preventDefault();
            mostrarErrorModal('crear', 'El nombre debe tener al menos 3 caracteres', '#nombre_ruta');
            return false;
        }
        
        // Validar empresa
        if (!empresa) {
            e.preventDefault();
            mostrarErrorModal('crear', 'Debe seleccionar una empresa', '#id_empresa');
            return false;
        }
        
        // Mostrar indicador de carga
        $('#btnCrearRuta').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...').prop('disabled', true);
        
        console.log('Creando nueva ruta:', {
            nombre: nombre,
            empresa: empresa,
            descripcion: $('#descripcion').val().trim()
        });
        
        return true;
    });
    
    // Confirmación para eliminar
    $('#formEliminarRuta').on('submit', function(e) {
        var nombre = $('#delete_ruta_nombre').text();
        var id = $('#delete_ruta_id').text();
        
        var confirmMessage = `¿Está completamente seguro de eliminar la ruta #${id} "${nombre}"?\n\n` +
                            `Esta acción es permanente y no se puede deshacer.\n` +
                            `Si la ruta está siendo utilizada en el sistema, podría causar problemas.`;
        
        if (!confirm(confirmMessage)) {
            e.preventDefault();
            return false;
        }
        
        // Mostrar indicador de carga
        $('#btnEliminarRuta').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Eliminando...').prop('disabled', true);
        
        console.log('Eliminando ruta:', {id, nombre});
        
        return true;
    });
    
    // Confirmación para cambiar estado
    $('form[action*="cambiar_estado"]').on('submit', function(e) {
        var accion = $(this).find('button[type="submit"]').attr('title');
        var nombreRuta = $(this).closest('tr').find('td:nth-child(2)').text().trim();
        var idRuta = $(this).closest('tr').find('td:nth-child(1)').text().trim();
        
        var confirmMessage = `¿Está seguro de ${accion.toLowerCase()} la ruta #${idRuta} "${nombreRuta}"?`;
        
        if (!confirm(confirmMessage)) {
            e.preventDefault();
            return false;
        }
        
        // Mostrar indicador de carga
        var btn = $(this).find('button[type="submit"]');
        var iconOriginal = btn.html();
        btn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>').prop('disabled', true);
        
        console.log(`${accion} ruta:`, {idRuta, nombreRuta});
        
        // Restaurar botón después de 3 segundos por si falla
        setTimeout(function() {
            btn.html(iconOriginal).prop('disabled', false);
        }, 3000);
    });
    
    // Limpiar formularios al cerrar modales
    $('#crearRutaModal').on('hidden.bs.modal', function() {
        $(this).find('form')[0].reset();
        $('#btnCrearRuta').html('<i class="bi bi-save"></i> Guardar Ruta').prop('disabled', false);
        limpiarErroresModal('crear');
        // Limpiar mensajes flash
        $(this).find('.alert').remove();
    });
    
    $('#eliminarRutaModal').on('hidden.bs.modal', function() {
        $('#btnEliminarRuta').html('<i class="bi bi-trash"></i> Sí, Eliminar').prop('disabled', false);
    });
    
    // Función para mostrar errores en modales
    function mostrarErrorModal(tipo, mensaje, selector) {
        // Remover errores anteriores
        limpiarErroresModal(tipo);
        
        // Agregar clase de error al campo
        $(selector).addClass('is-invalid');
        
        // Crear mensaje de error
        var errorDiv = $('<div>', {
            class: 'invalid-feedback d-block',
            html: '<i class="bi bi-exclamation-circle"></i> ' + mensaje
        });
        
        $(selector).after(errorDiv);
        $(selector).focus();
        
        // Remover error después de 5 segundos
        setTimeout(function() {
            limpiarErroresModal(tipo);
        }, 5000);
    }
    
    // Función para limpiar errores de modales
    function limpiarErroresModal(tipo) {
        if (tipo === 'crear') {
            $('#crearRutaModal .is-invalid').removeClass('is-invalid');
            $('#crearRutaModal .invalid-feedback').remove();
        }
    }
    
    // Auto-focus en el campo de nombre cuando se abre el modal de crear
    $('#crearRutaModal').on('shown.bs.modal', function() {
        $('#nombre_ruta').focus();
    });
    
    // Búsqueda rápida con DataTables
    $('#tablaRutas_filter input').addClass('form-control form-control-sm');
    $('#tablaRutas_length select').addClass('form-select form-select-sm');
    
    console.log('✅ Sistema de gestión de rutas cargado correctamente');
    console.log('Total de rutas cargadas:', {{ rutas|length }});
    
    // Mostrar mensajes flash en consola para debugging
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                console.log('Flash message ({{ category }}):', '{{ message }}');
            {% endfor %}
        {% endif %}
    {% endwith %}
});
</script>
{% endblock %}