{% extends "layout.html" %}

{% block title %}Gestión de Compras - Entradas{% endblock %}

{% block content %}
<div class="container-fluid px-lg-4 px-md-3 px-2">
    <!-- Header -->
    <div class="d-flex flex-column flex-md-row align-items-center justify-content-between mb-4 pt-3">
        <div class="mb-3 mb-md-0">
            <h1 class="h2 fw-bold text-gradient-primary mb-2">Gestión de Compras</h1>
            <p class="text-muted mb-0 d-flex align-items-center">
                <i class="fas fa-shopping-bag me-2 text-primary"></i>
                Control de entradas e inventario en tiempo real
            </p>
        </div>
        <a href="{{ url_for('admin_crear_compra') }}" class="btn btn-primary btn-lg shadow-lg hover-lift">
            <i class="fas fa-plus-circle me-2"></i>
            Nueva Compra
        </a>
    </div>

    <!-- Estadísticas -->
    <div class="row mb-4 g-3">
        {% set stats = [
        {
        'title': 'Total Compras',
        'value': total_compras,
        'desc': 'Registros totales',
        'icon': 'shopping-bag',
        'class': 'gradient-primary'
        },
        {
        'title': 'Compras Contado',
        'value': contado_activas,
        'desc': 'Transacciones pagadas',
        'icon': 'money-bill-wave',
        'class': 'gradient-success'
        },
        {
        'title': 'Compras Crédito',
        'value': credito_activas,
        'desc': 'Deudas pendientes',
        'icon': 'credit-card',
        'class': 'gradient-warning'
        },
        {
        'title': 'Capital Invertido',
        'value': "C${:,.2f}".format(capital_contado or 0),
        'desc': 'Solo compras al contado',
        'icon': 'chart-line',
        'class': 'gradient-info'
        }
        ] %}

        {% for stat in stats %}
        <div class="col-xl-3 col-md-6">
            <div class="card card-statistic {{ stat.class }} shadow-sm border-0 rounded-3 h-100">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-80 mb-1">{{ stat.title }}</h6>
                            <h2 class="fw-bold text-black mb-0">{{ stat.value }}</h2>
                            <p class="text-white-60 mb-0 small">{{ stat.desc }}</p>
                        </div>
                        <div class="statistic-icon">
                            <i class="fas fa-{{ stat.icon }} fa-2x text-white-60"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Panel de resumen financiero -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h6 class="fw-bold mb-0">
                        <i class="fas fa-chart-pie me-2 text-primary"></i>
                        Resumen Financiero de Compras
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <!-- Valor total del inventario -->
                        <div class="col-md-4">
                            <div class="border-start border-4 border-primary ps-3 py-2">
                                <small class="text-muted d-block">Valor Total del Inventario</small>
                                <h4 class="fw-bold mb-0">C${{ "{:,.2f}".format(capital_total or 0) }}</h4>
                                <small class="text-muted">Contado + Crédito (todas las compras activas)</small>
                            </div>
                        </div>
                        
                        <!-- Capital realmente invertido -->
                        <div class="col-md-4">
                            <div class="border-start border-4 border-success ps-3 py-2">
                                <small class="text-muted d-block">Capital Realmente Invertido</small>
                                <h4 class="fw-bold mb-0 text-success">C${{ "{:,.2f}".format(capital_contado or 0) }}</h4>
                                <small class="text-muted">Dinero efectivo desembolsado</small>
                            </div>
                        </div>
                        
                        <!-- Deudas pendientes -->
                        <div class="col-md-4">
                            <div class="border-start border-4 border-warning ps-3 py-2">
                                <small class="text-muted d-block">Deudas Pendientes</small>
                                <h4 class="fw-bold mb-0 text-warning">C${{ "{:,.2f}".format(capital_credito or 0) }}</h4>
                                <small class="text-muted">Por pagar a proveedores</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Porcentajes -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="progress" style="height: 25px;">
                                {% if capital_total > 0 %}
                                {% set porcentaje_contado = (capital_contado / capital_total * 100)|round(1) %}
                                {% set porcentaje_credito = (capital_credito / capital_total * 100)|round(1) %}
                                <div class="progress-bar bg-success" role="progressbar" 
                                     style="width: {{ porcentaje_contado }}%">
                                    {{ porcentaje_contado }}% Contado
                                </div>
                                <div class="progress-bar bg-warning" role="progressbar" 
                                     style="width: {{ porcentaje_credito }}%">
                                    {{ porcentaje_credito }}% Crédito
                                </div>
                                {% else %}
                                <div class="progress-bar bg-secondary w-100">Sin datos</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mensajes Flash PERSISTENTES -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div id="flash-messages-container">
        {% for category, message in messages %}
        <div class="alert alert-dismissible fade show alert-{{ 'danger' if category == 'error' else 'success' }} 
                    shadow-sm border-0 mb-4 flash-message" 
             role="alert"
             data-category="{{ category }}"
             data-message="{{ message }}">
            <div class="d-flex align-items-center">
                <div class="alert-icon me-3">
                    <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} fa-lg"></i>
                </div>
                <div class="flex-grow-1">{{ message }}</div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- Card Principal -->
    <div class="card shadow-lg border-0 rounded-3 overflow-hidden mb-4">
        <!-- Header -->
        <div class="card-header bg-white border-0 pt-4 pb-3 px-4">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center">
                <div class="mb-3 mb-lg-0">
                    <h5 class="card-title fw-bold mb-1 text-dark">
                        <i class="fas fa-clipboard-list me-2 text-primary"></i>
                        Registro de Compras
                    </h5>
                    <p class="text-muted small mb-0">Gestión completa de transacciones de entrada</p>
                </div>

                <div class="d-flex flex-wrap gap-2">
                    <!-- Búsqueda -->
                    <div class="search-box">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light border-0">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-0 bg-light" id="searchInput"
                                placeholder="Buscar compras...">
                        </div>
                    </div>

                    <!-- Exportación -->
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-download me-1"></i> Exportar
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow">
                            <li><a class="dropdown-item" href="#" id="exportExcel">
                                    <i class="fas fa-file-excel text-success me-2"></i> Excel
                                </a></li>
                            <li><a class="dropdown-item" href="#" id="printTableBtn">
                                    <i class="fas fa-print text-info me-2"></i> Imprimir
                                </a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="row g-2 mt-3">
                <div class="col-md-4">
                    <select class="form-select form-select-sm" id="estadoFilter">
                        <option value="">Todos los estados</option>
                        <option value="Activa">Activas</option>
                        <option value="Anulada">Anuladas</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <select class="form-select form-select-sm" id="tipoCompraFilter">
                        <option value="">Todos los tipos</option>
                        <option value="CONTADO">Contado</option>
                        <option value="CREDITO">Crédito</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-sm btn-outline-secondary w-100" id="clearFiltersBtn">
                        <i class="fas fa-filter-circle-xmark me-1"></i> Limpiar filtros
                    </button>
                </div>
            </div>
        </div>

        <div class="card-body p-0">
            <!-- Tabla -->
            <div class="table-responsive-lg">
                <table class="table table-hover align-middle mb-0" id="dataTable">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Factura</th>
                            <th>Proveedor</th>
                            <th class="text-center">Tipo</th>
                            <th class="d-none d-lg-table-cell">Bodega</th>
                            <th class="text-center">Productos</th>
                            <th class="text-end">Total</th>
                            <th class="d-none d-xl-table-cell">Usuario</th>
                            <th class="text-center">Estado</th>
                            <th class="text-end pe-4">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entrada in entradas %}
                        <tr class="{% if entrada.Estado == 'Anulada' %}table-inactive{% endif %}">
                            <td data-label="ID" class="fw-bold">
                                <small class="text-muted">#</small>{{ entrada.ID_Movimiento }}
                            </td>
                            <td data-label="Fecha">
                                <div class="date-cell">
                                    <div class="fw-medium">{{ entrada.Fecha.strftime('%d/%m/%Y') if entrada.Fecha else
                                        'N/A' }}</div>
                                    <small class="text-muted">{{ entrada.Fecha_Creacion.strftime('%H:%M') if
                                        entrada.Fecha_Creacion else '' }}</small>
                                </div>
                            </td>
                            <td data-label="Factura">
                                {% if entrada.N_Factura_Externa %}
                                <span class="badge bg-light text-dark border border-secondary py-2">
                                    <i class="fas fa-file-invoice me-1"></i>
                                    {{ entrada.N_Factura_Externa }}
                                </span>
                                {% else %}
                                <span class="text-muted">Sin factura</span>
                                {% endif %}
                            </td>
                            <td data-label="Proveedor">
                                <div class="d-flex align-items-center">
                                    <div
                                        class="avatar-sm bg-warning bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3">
                                        <i class="fas fa-truck text-warning fs-6"></i>
                                    </div>
                                    <div>
                                        <div class="fw-semibold">{{ entrada.Proveedor or 'Proveedor General' }}</div>
                                        <small class="text-muted d-lg-none">{{ entrada.Bodega or 'N/A' }}</small>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center" data-label="Tipo">
                                {% set tipo_badge_class = 'bg-success bg-opacity-10 text-success border-success' if
                                entrada.Tipo_Compra == 'CONTADO' else 'bg-warning bg-opacity-10 text-warning
                                border-warning' %}
                                <span class="badge badge-pill {{ tipo_badge_class }} border-opacity-25 py-2 px-3">
                                    <i
                                        class="fas fa-{{ 'money-bill-wave' if entrada.Tipo_Compra == 'CONTADO' else 'credit-card' }} me-1"></i>
                                    {{ entrada.Tipo_Compra or 'CONTADO' }}
                                </span>
                            </td>
                            <td class="d-none d-lg-table-cell" data-label="Bodega">
                                <span
                                    class="badge bg-secondary bg-opacity-10 text-dark border border-secondary border-opacity-25 py-2">
                                    {{ entrada.Bodega or 'N/A' }}
                                </span>
                            </td>
                            <td class="text-center" data-label="Productos">
                                <div class="product-count">
                                    <span
                                        class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 py-2 px-3">
                                        <i class="fas fa-boxes me-1"></i>
                                        {{ entrada.Total_Productos or 0 }}
                                    </span>
                                </div>
                            </td>
                            <td class="text-end fw-bold text-success" data-label="Total">
                                C${{ "{:,.2f}".format(entrada.Total_Compra or 0) }}
                            </td>
                            <td class="d-none d-xl-table-cell" data-label="Usuario">
                                <div class="d-flex align-items-center">
                                    <div
                                        class="avatar-xs bg-light rounded-circle d-flex align-items-center justify-content-center me-2">
                                        <i class="fas fa-user-tie text-muted fs-7"></i>
                                    </div>
                                    <span class="text-muted">{{ entrada.Usuario_Creacion or 'Sistema' }}</span>
                                </div>
                            </td>
                            <td class="text-center" data-label="Estado">
                                {% set estado_badge_class = 'bg-success bg-opacity-10 text-success border-success' if
                                entrada.Estado == 'Activa' else 'bg-danger bg-opacity-10 text-danger border-danger' %}
                                <span class="badge badge-pill {{ estado_badge_class }} border-opacity-25 py-2 px-3">
                                    <i
                                        class="fas fa-{{ 'check-circle' if entrada.Estado == 'Activa' else 'ban' }} me-1"></i>
                                    {{ entrada.Estado or 'Activa' }}
                                </span>
                            </td>
                            <td class="text-end pe-4" data-label="Acciones">
                                <!-- Botones móviles -->
                                <div class="btn-group-vertical btn-group-sm d-lg-none">
                                    <a href="{{ url_for('admin_detalle_compra_completo', id_movimiento=entrada.ID_Movimiento) }}"
                                        class="btn btn-outline-info btn-action-mobile">
                                        <i class="fas fa-eye"></i>
                                        <span class="ms-1">Ver</span>
                                    </a>

                                    {% if entrada.Estado == 'Activa' %}
                                    <a href="{{ url_for('admin_editar_compra', id_movimiento=entrada.ID_Movimiento) }}"
                                        class="btn btn-outline-primary btn-action-mobile">
                                        <i class="fas fa-edit"></i>
                                        <span class="ms-1">Editar</span>
                                    </a>

                                    <button type="button"
                                        class="btn btn-outline-danger btn-action-mobile btn-anular-compra"
                                        data-bs-toggle="modal" data-bs-target="#anularCompraModal"
                                        data-id="{{ entrada.ID_Movimiento }}">
                                        <i class="fas fa-ban"></i>
                                        <span class="ms-1">Anular</span>
                                    </button>
                                    {% else %}
                                    <button class="btn btn-outline-secondary btn-action-mobile" disabled>
                                        <i class="fas fa-lock"></i>
                                        <span class="ms-1">Bloqueado</span>
                                    </button>
                                    {% endif %}
                                </div>

                                <!-- Botones desktop -->
                                <div class="btn-group btn-group-sm d-none d-lg-flex">
                                    <a href="{{ url_for('admin_detalle_compra_completo', id_movimiento=entrada.ID_Movimiento) }}"
                                        class="btn btn-outline-info btn-action">
                                        <i class="fas fa-eye"></i>
                                        <span class="d-none d-xl-inline ms-1">Ver</span>
                                    </a>

                                    {% if entrada.Estado == 'Activa' %}
                                    <a href="{{ url_for('admin_editar_compra', id_movimiento=entrada.ID_Movimiento) }}"
                                        class="btn btn-outline-primary btn-action">
                                        <i class="fas fa-edit"></i>
                                        <span class="d-none d-xl-inline ms-1">Editar</span>
                                    </a>

                                    <button type="button" class="btn btn-outline-danger btn-action btn-anular-compra"
                                        data-bs-toggle="modal" data-bs-target="#anularCompraModal"
                                        data-id="{{ entrada.ID_Movimiento }}">
                                        <i class="fas fa-ban"></i>
                                        <span class="d-none d-xl-inline ms-1">Anular</span>
                                    </button>
                                    {% else %}
                                    <button class="btn btn-outline-secondary btn-action" disabled>
                                        <i class="fas fa-lock"></i>
                                        <span class="d-none d-xl-inline ms-1">Bloqueado</span>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="12" class="text-center py-5">
                                <div class="empty-state">
                                    <div class="empty-state-icon mb-3">
                                        <i class="fas fa-inbox fa-3x text-muted opacity-50"></i>
                                    </div>
                                    <h5 class="text-muted mb-2">No hay compras registradas</h5>
                                    <p class="text-muted small mb-4">Comience creando su primera compra</p>
                                    <a href="{{ url_for('admin_crear_compra') }}" class="btn btn-primary">
                                        <i class="fas fa-plus me-2"></i> Crear Compra
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <td colspan="6" class="text-end fw-bold d-none d-md-table-cell">
                                <small>Resumen de las {{ entradas|length }} compras mostradas:</small>
                            </td>
                            <td colspan="2" class="text-end fw-bold d-md-none">
                                <small>Resumen:</small>
                            </td>
                            <td class="text-center fw-bold text-primary">
                                <small>{{ total_productos_activos or 0 }}</small>
                            </td>
                            <td class="text-end fw-bold text-success">
                                <small>C${{ "{:,.2f}".format(total_invertido or 0) }}</small>
                            </td>
                            <td colspan="3" class="text-end">
                                <small class="text-muted">{{ contado_activas }} contado / {{ credito_activas }} crédito</small>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Paginación -->
            {% if entradas and entradas|length > 0 %}
            <div class="card-footer bg-white border-0 px-4 py-3">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
                    <div class="text-muted mb-2 mb-md-0">
                        <small>
                            Mostrando {{ entradas|length }} compra(s) - 
                            {{ contado_activas + credito_activas }} activas - 
                            Total valor: C${{ "{:,.2f}".format(total_invertido or 0) }}
                        </small>
                    </div>
                    <div class="text-muted">
                        <small>
                            Sistema total: 
                            <span class="fw-bold">C${{ "{:,.2f}".format(capital_total or 0) }}</span>
                            | Contado: 
                            <span class="fw-bold text-success">C${{ "{:,.2f}".format(capital_contado or 0) }}</span>
                            | Crédito: 
                            <span class="fw-bold text-warning">C${{ "{:,.2f}".format(capital_credito or 0) }}</span>
                        </small>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Anulación -->
<div class="modal fade" id="anularCompraModal" tabindex="-1" aria-labelledby="anularCompraModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="anularCompraModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirmar Anulación de Compra
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>

            <!-- Loading State -->
            <div id="modalLoading" class="modal-body text-center py-5">
                <div class="spinner-border text-danger mb-3" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <h6 class="text-muted">Cargando información detallada de la compra...</h6>
                <p class="text-muted small mt-2">Por favor espere un momento</p>
            </div>

            <!-- Error State -->
            <div id="modalError" class="modal-body text-center py-5" style="display: none;">
                <div class="mb-3">
                    <i class="fas fa-times-circle fa-3x text-danger"></i>
                </div>
                <h6 class="text-danger" id="errorTitle">Error al cargar la compra</h6>
                <p class="text-muted small mt-2" id="errorMessage">Ha ocurrido un error</p>
                <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cerrar
                </button>
            </div>

            <!-- Content Container -->
            <div id="modalContent" style="display: none;">
                <form id="formAnularCompra" method="POST" action="">
                    <div class="modal-body">
                        <!-- Alerta de advertencia -->
                        <div class="alert alert-warning border-warning mb-4">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-circle fa-2x text-warning"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="alert-heading fw-bold mb-1">
                                        ¿Está seguro de anular la compra <span id="modalCompraId"
                                            class="text-danger fw-bold">#</span>?
                                    </h6>
                                    <p class="mb-0 small">Esta acción es irreversible y reversará las existencias en
                                        inventario.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Detalles de la compra -->
                        <div class="card border-0 bg-light mb-4">
                            <div class="card-body">
                                <h6 class="fw-bold text-dark mb-3">
                                    <i class="fas fa-info-circle me-2 text-primary"></i>
                                    Detalles de la Compra
                                    <span id="compraStatusBadge" class="badge bg-success ms-2">Activa</span>
                                    <span id="stockStatusBadge" class="badge bg-success ms-1">Stock OK</span>
                                </h6>

                                <div class="row mb-3" id="compraBasicDetails">
                                    <!-- Se llenará con JavaScript -->
                                </div>

                                <!-- Tabla de productos -->
                                <div class="mt-4">
                                    <h6 class="fw-bold text-dark mb-2">
                                        <i class="fas fa-boxes me-2 text-primary"></i>
                                        Productos <small class="text-muted" id="totalProductos">(0 productos)</small>
                                    </h6>

                                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                        <table class="table table-sm table-hover mb-0" id="productosTable">
                                            <thead class="table-light sticky-top">
                                                <tr>
                                                    <th>#</th>
                                                    <th>Código</th>
                                                    <th>Descripción</th>
                                                    <th class="text-center">Cantidad</th>
                                                    <th class="text-center">Stock Actual</th>
                                                    <th class="text-end">Costo Unitario</th>
                                                    <th class="text-end">Subtotal</th>
                                                    <th class="text-center">Estado</th>
                                                </tr>
                                            </thead>
                                            <tbody id="productosTableBody">
                                                <!-- Se llenará con JavaScript -->
                                            </tbody>
                                            <tfoot class="table-light">
                                                <tr>
                                                    <td colspan="3" class="text-end fw-bold">Totales:</td>
                                                    <td class="text-center fw-bold" id="totalCantidad">0</td>
                                                    <td colspan="2"></td>
                                                    <td class="text-end fw-bold text-success" id="totalCompraModal">
                                                        C$0.00</td>
                                                    <td></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Alerta de stock insuficiente -->
                        <div id="stockWarning" class="alert alert-danger border-danger mb-4" style="display: none;">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="alert-heading fw-bold mb-1">¡Stock Insuficiente!</h6>
                                    <p class="mb-2">No hay suficiente stock para anular esta compra. Los siguientes
                                        productos no tienen existencias suficientes:</p>
                                    <ul class="mb-0 small" id="productosSinStockList">
                                        <!-- Lista de productos sin stock -->
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Campo de motivo -->
                        <div class="mb-3">
                            <label for="motivoAnulacion" class="form-label fw-semibold">
                                <i class="fas fa-comment-dots me-2 text-primary"></i>
                                Motivo de Anulación <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="motivoAnulacion" name="motivo_anulacion" rows="3"
                                placeholder="Ingrese el motivo de la anulación..." required></textarea>
                            <small class="form-text text-muted">Explique brevemente la razón de esta anulación</small>
                        </div>

                        <!-- Checkbox de confirmación -->
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="confirmarAnulacion" required>
                            <label class="form-check-label fw-semibold" for="confirmarAnulacion">
                                Confirmo que deseo anular esta compra y entiendo que esta acción no se puede deshacer
                            </label>
                        </div>

                        <!-- Campo oculto para ID de usuario -->
                        <input type="hidden" name="id_usuario_anulacion" value="{{ current_user.id }}">
                    </div>

                    <div class="modal-footer border-0 bg-light">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-danger" id="btnConfirmarAnulacion" disabled>
                            <i class="fas fa-ban me-2"></i>Cargando...
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    /* Estilos del modal */
    .table-inactive {
        opacity: 0.6;
        background-color: #f8f9fa;
    }

    .stock-ok {
        color: #28a745;
        font-weight: bold;
    }

    .stock-low {
        color: #dc3545;
        font-weight: bold;
    }

    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    /* Estilos para tarjetas de estadísticas */
    .card-statistic {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card-statistic:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }
    
    .gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .gradient-success {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .gradient-warning {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .gradient-info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    /* Mejoras para la tabla */
    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
        transition: background-color 0.2s ease;
    }

    /* Animaciones para mensajes flash */
    .flash-message {
        animation: slideInDown 0.5s ease forwards;
    }
    
    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Estilos para badges */
    .badge {
        transition: all 0.2s ease;
    }
    
    .badge:hover {
        transform: scale(1.05);
    }

    /* Responsive mejorado */
    @media (max-width: 768px) {
        .btn-action-mobile {
            width: 100%;
            margin-bottom: 5px;
        }
        
        .date-cell {
            min-width: 80px;
        }
        
        .progress {
            height: 20px !important;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Variables globales
        let currentCompraId = null;
        let compraData = null;

        // Función segura para establecer texto
        function safeSetText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            }
        }

        // Función segura para mostrar/ocultar elementos
        function safeDisplay(elementId, displayStyle) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = displayStyle;
            }
        }

        // Función para limpiar y validar la unidad
        function limpiarUnidad(unidad) {
            if (!unidad) return '';
            
            unidad = unidad.toString().trim();
            
            // Lista de valores inválidos comunes
            const valoresInvalidos = ['7', '0', 'null', 'undefined', 'nan'];
            
            if (valoresInvalidos.includes(unidad.toLowerCase())) {
                return '';
            }
            
            // Si es un número, probablemente es un error
            if (!isNaN(unidad) && unidad !== '') {
                console.warn(`Unidad numérica inválida: ${unidad}`);
                return '';
            }
            
            return unidad;
        }

        // Referencias al modal
        const anularModal = document.getElementById('anularCompraModal');

        // Evento cuando se abre el modal
        if (anularModal) {
            anularModal.addEventListener('show.bs.modal', async function (e) {
                const btn = e.relatedTarget;
                currentCompraId = btn.dataset.id;

                // Mostrar loading
                showModalLoading();

                try {
                    // Obtener datos detallados de la compra
                    const response = await fetch(`/admin/compras/compras-entradas/anular/${currentCompraId}?completa=1`);

                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }

                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.error || 'Error al cargar datos de la compra');
                    }

                    compraData = data.compra;

                    // Validar que se cargaron los productos
                    if (!compraData.productos) {
                        throw new Error('No se pudieron cargar los productos de la compra');
                    }

                    // Mostrar contenido con datos
                    showModalContent();
                    loadDetailedCompraData(compraData);

                } catch (error) {
                    console.error('Error al cargar datos detallados:', error);
                    showModalError(error.message || 'Error desconocido al cargar la información');
                }
            });

            // Cuando se cierra el modal
            anularModal.addEventListener('hidden.bs.modal', function () {
                resetModal();
                currentCompraId = null;
                compraData = null;
            });
        }

        // Función para mostrar loading
        function showModalLoading() {
            safeDisplay('modalLoading', 'block');
            safeDisplay('modalContent', 'none');
            safeDisplay('modalError', 'none');
            
            const btn = document.getElementById('btnConfirmarAnulacion');
            if (btn) {
                btn.disabled = true;
            }
        }

        // Función para mostrar contenido
        function showModalContent() {
            safeDisplay('modalLoading', 'none');
            safeDisplay('modalContent', 'block');
            safeDisplay('modalError', 'none');
        }

        // Función para mostrar error
        function showModalError(errorMessage) {
            safeDisplay('modalLoading', 'none');
            safeDisplay('modalContent', 'none');
            safeDisplay('modalError', 'block');
            safeSetText('errorTitle', 'Error al cargar la compra');
            safeSetText('errorMessage', errorMessage || 'Ha ocurrido un error');
        }

        // Función para cargar datos detallados
        function loadDetailedCompraData(compra) {
            // Validación crítica
            if (!compra.productos || !Array.isArray(compra.productos)) {
                showModalError('Error: No se pudieron cargar los productos de la compra');
                return;
            }

            // 1. Actualizar ID
            safeSetText('modalCompraId', `#${compra.id}`);

            // 2. Actualizar estado del stock
            const stockBadge = document.getElementById('stockStatusBadge');
            if (stockBadge) {
                if (compra.stock_suficiente === true) {
                    stockBadge.className = 'badge bg-success ms-1';
                    stockBadge.textContent = 'Stock OK';
                    safeDisplay('stockWarning', 'none');
                } else {
                    stockBadge.className = 'badge bg-danger ms-1';
                    stockBadge.textContent = 'Stock Insuficiente';
                    showStockWarning(compra.productos);
                }
            }

            // 3. Actualizar detalles básicos
            const detailsContainer = document.getElementById('compraBasicDetails');
            if (detailsContainer) {
                const detailsHtml = `
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">Proveedor</label>
                    <div class="form-control-plaintext fw-bold">
                        <i class="fas fa-truck text-warning me-2"></i>
                        ${compra.proveedor || 'N/A'}
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">Factura</label>
                    <div class="form-control-plaintext">
                        <i class="fas fa-file-invoice text-primary me-2"></i>
                        ${compra.factura || 'Sin factura'}
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">Fecha</label>
                    <div class="form-control-plaintext">
                        <i class="fas fa-calendar text-info me-2"></i>
                        ${compra.fecha || 'N/A'}
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">Tipo de Compra</label>
                    <div class="form-control-plaintext">
                        <span class="badge ${compra.tipo_compra === 'CONTADO' ? 'bg-success' : 'bg-warning'}">
                            <i class="fas fa-${compra.tipo_compra === 'CONTADO' ? 'money-bill-wave' : 'credit-card'} me-1"></i>
                            ${compra.tipo_compra || 'CONTADO'}
                        </span>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">Bodega</label>
                    <div class="form-control-plaintext">
                        <i class="fas fa-warehouse text-secondary me-2"></i>
                        ${compra.bodega || 'N/A'}
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">Total</label>
                    <div class="form-control-plaintext fw-bold text-success">
                        <i class="fas fa-dollar-sign me-2"></i>
                        ${compra.total_formateado || 'C$0.00'}
                    </div>
                </div>
            `;
                detailsContainer.innerHTML = detailsHtml;
            }

            // 4. Actualizar contador de productos
            const totalProductos = compra.total_productos || compra.productos.length || 0;
            safeSetText('totalProductos', `(${totalProductos} productos)`);
            safeSetText('totalCantidad', (compra.total_cantidad || 0).toFixed(2));
            safeSetText('totalCompraModal', compra.total_formateado || 'C$0.00');

            // 5. Llenar tabla de productos
            const productosTableBody = document.getElementById('productosTableBody');
            if (productosTableBody) {
                productosTableBody.innerHTML = '';

                compra.productos.forEach((producto, index) => {
                    const cantidad = parseFloat(producto.cantidad) || 0;
                    const stockActual = parseFloat(producto.stock_actual) || 0;
                    const costoUnitario = parseFloat(producto.costo_unitario) || 0;
                    const subtotal = parseFloat(producto.subtotal) || 0;
                    const suficiente = producto.suficiente_stock === true;
                    
                    // Limpiar la unidad para evitar el "7"
                    const unidad = limpiarUnidad(producto.unidad);

                    const stockStatusText = suficiente ? '✓ OK' : '✗ Insuficiente';
                    const stockClass = suficiente ? 'text-success' : 'text-danger';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td class="fw-bold">${index + 1}</td>
                    <td><span class="badge bg-light text-dark">${producto.codigo || 'N/A'}</span></td>
                    <td>${producto.descripcion || 'Producto sin descripción'}</td>
                    <td class="text-center fw-semibold">
                        ${cantidad.toFixed(2)}
                        ${unidad ? `<span class="text-muted small ms-1">${unidad}</span>` : ''}
                    </td>
                    <td class="text-center ${stockClass}">${stockActual.toFixed(2)}</td>
                    <td class="text-end">C$${costoUnitario.toFixed(2)}</td>
                    <td class="text-end fw-semibold">C$${subtotal.toFixed(2)}</td>
                    <td class="text-center ${stockClass}">${stockStatusText}</td>
                `;

                    productosTableBody.appendChild(row);
                });
            }

            // 6. Configurar formulario
            const form = document.getElementById('formAnularCompra');
            if (form && compra.id) {
                form.action = `/admin/compras/compras-entradas/anular/${compra.id}`;
            }

            // 7. Habilitar/deshabilitar botón según stock
            const btn = document.getElementById('btnConfirmarAnulacion');
            if (btn) {
                if (compra.stock_suficiente === true) {
                    btn.disabled = false;
                    btn.innerHTML = `<i class="fas fa-ban me-2"></i> Sí, Anular Compra`;
                    btn.classList.remove('btn-warning');
                    btn.classList.add('btn-danger');
                } else {
                    btn.disabled = true;
                    btn.innerHTML = `<i class="fas fa-ban me-2"></i> Stock Insuficiente`;
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-warning');
                }
            }

            // 8. Limpiar formulario
            const motivoInput = document.getElementById('motivoAnulacion');
            const confirmCheckbox = document.getElementById('confirmarAnulacion');
            
            if (motivoInput) motivoInput.value = '';
            if (confirmCheckbox) confirmCheckbox.checked = false;
        }

        // Función para mostrar advertencia de stock
        function showStockWarning(productos) {
            const warningDiv = document.getElementById('stockWarning');
            const listElement = document.getElementById('productosSinStockList');

            if (!warningDiv || !listElement) return;

            listElement.innerHTML = '';

            if (!productos || !Array.isArray(productos) || productos.length === 0) {
                safeDisplay('stockWarning', 'none');
                return;
            }

            const productosSinStock = productos.filter(p => p.suficiente_stock === false);

            if (productosSinStock.length === 0) {
                safeDisplay('stockWarning', 'none');
                return;
            }

            // Mostrar productos sin stock
            productosSinStock.forEach(producto => {
                const cantidad = parseFloat(producto.cantidad) || 0;
                const stockActual = parseFloat(producto.stock_actual) || 0;
                const faltan = cantidad - stockActual;

                const li = document.createElement('li');
                li.innerHTML = `
                <strong>${producto.codigo || 'N/A'} - ${producto.descripcion || 'Sin descripción'}</strong><br>
                <small class="text-muted">
                    Stock actual: ${stockActual.toFixed(2)} | 
                    Se requiere: ${cantidad.toFixed(2)} | 
                    Faltan: ${faltan.toFixed(2)}
                </small>
            `;
                listElement.appendChild(li);
            });

            safeDisplay('stockWarning', 'block');
        }

        // Función para resetear modal
        function resetModal() {
            safeDisplay('modalLoading', 'block');
            safeDisplay('modalContent', 'none');
            safeDisplay('modalError', 'none');
            
            const compraBasicDetails = document.getElementById('compraBasicDetails');
            if (compraBasicDetails) compraBasicDetails.innerHTML = '';
            
            const productosTableBody = document.getElementById('productosTableBody');
            if (productosTableBody) productosTableBody.innerHTML = '';
            
            safeDisplay('stockWarning', 'none');
            
            const form = document.getElementById('formAnularCompra');
            if (form) form.reset();
            
            safeSetText('modalCompraId', '#');

            const btn = document.getElementById('btnConfirmarAnulacion');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-ban me-2"></i> Cargando...`;
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-danger');
            }
        }

        // Validación del formulario
        const form = document.getElementById('formAnularCompra');
        if (form) {
            form.addEventListener('submit', function (e) {
                // Si no hay stock suficiente, prevenir envío
                if (compraData && compraData.stock_suficiente === false) {
                    e.preventDefault();
                    alert('No se puede anular la compra debido a stock insuficiente.');
                    return;
                }

                // Validar checkbox
                const confirmCheckbox = document.getElementById('confirmarAnulacion');
                if (!confirmCheckbox || !confirmCheckbox.checked) {
                    e.preventDefault();
                    alert('Debe confirmar la anulación marcando la casilla de verificación.');
                    return;
                }

                // Validar motivo
                const motivoInput = document.getElementById('motivoAnulacion');
                const motivo = motivoInput ? motivoInput.value.trim() : '';
                if (!motivo || motivo.length < 5) {
                    e.preventDefault();
                    alert('Debe ingresar un motivo de al menos 5 caracteres.');
                    return;
                }

                // Confirmación final
                if (!confirm(`¿Está seguro de anular la compra #${currentCompraId}? Esta acción no se puede deshacer.`)) {
                    e.preventDefault();
                    return;
                }

                // Deshabilitar botón para evitar doble envío
                const btn = document.getElementById('btnConfirmarAnulacion');
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Procesando...';
                }
            });
        }

        // Búsqueda en tiempo real
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', function () {
                const filter = this.value.toLowerCase();
                const rows = document.querySelectorAll('#dataTable tbody tr');

                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(filter) ? '' : 'none';
                });
            });
        }

        // Filtros
        const estadoFilter = document.getElementById('estadoFilter');
        const tipoCompraFilter = document.getElementById('tipoCompraFilter');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');

        function applyFilters() {
            const estadoValue = estadoFilter.value;
            const tipoValue = tipoCompraFilter.value;
            const rows = document.querySelectorAll('#dataTable tbody tr');

            rows.forEach(row => {
                const estadoCell = row.querySelector('[data-label="Estado"]');
                const tipoCell = row.querySelector('[data-label="Tipo"]');

                if (!estadoCell || !tipoCell) return;

                const showEstado = !estadoValue || estadoCell.textContent.includes(estadoValue);
                const showTipo = !tipoValue || tipoCell.textContent.includes(tipoValue);

                row.style.display = showEstado && showTipo ? '' : 'none';
            });
        }

        if (estadoFilter) estadoFilter.addEventListener('change', applyFilters);
        if (tipoCompraFilter) tipoCompraFilter.addEventListener('change', applyFilters);
        
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', function () {
                if (estadoFilter) estadoFilter.value = '';
                if (tipoCompraFilter) tipoCompraFilter.value = '';
                if (searchInput) searchInput.value = '';
                applyFilters();
                if (searchInput) searchInput.dispatchEvent(new Event('input'));
            });
        }

        // Exportar a Excel
        const exportExcel = document.getElementById('exportExcel');
        if (exportExcel) {
            exportExcel.addEventListener('click', function (e) {
                e.preventDefault();
                
                // Crear tabla para exportación
                let tableHTML = '<table border="1">';
                
                // Encabezados
                tableHTML += '<tr>';
                document.querySelectorAll('#dataTable thead th').forEach(th => {
                    if (th.textContent.trim()) {
                        tableHTML += `<th>${th.textContent}</th>`;
                    }
                });
                tableHTML += '</tr>';
                
                // Datos
                document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                    if (row.style.display !== 'none') {
                        tableHTML += '<tr>';
                        row.querySelectorAll('td').forEach(td => {
                            tableHTML += `<td>${td.textContent.trim()}</td>`;
                        });
                        tableHTML += '</tr>';
                    }
                });
                
                tableHTML += '</table>';
                
                // Crear archivo Excel
                const blob = new Blob([tableHTML], {type: 'application/vnd.ms-excel'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `compras_${new Date().toISOString().split('T')[0]}.xls`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }

        // Imprimir
        const printTableBtn = document.getElementById('printTableBtn');
        if (printTableBtn) {
            printTableBtn.addEventListener('click', function (e) {
                e.preventDefault();
                window.print();
            });
        }

        // Animación para mensajes flash
        setTimeout(() => {
            document.querySelectorAll('.flash-message').forEach(msg => {
                msg.classList.add('show');
            });
        }, 100);

        // Auto-ocultar mensajes flash después de 5 segundos
        setTimeout(() => {
            document.querySelectorAll('.flash-message').forEach(msg => {
                const closeBtn = msg.querySelector('.btn-close');
                if (closeBtn) {
                    closeBtn.click();
                }
            });
        }, 5000);
    });
</script>
{% endblock %}