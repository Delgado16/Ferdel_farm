{% extends "layout.html" %}

{% block title %}Editar Compra - Sistema Inventarios{% endblock %}

{% block content %}
<style>
    :root {
        --primary-color: #2c5aa0;
        --secondary-color: #6c757d;
        --success-color: #198754;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --light-bg: #f8f9fa;
        --border-color: #dee2e6;
    }

    .compra-container {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
        background: #fff;
    }

    .card-header {
        background: linear-gradient(135deg, var(--primary-color), #1e3a6d);
        color: white;
        border-radius: 10px 10px 0 0 !important;
        padding: 1.25rem 1.5rem;
        border-bottom: none;
    }

    .card-header h2 {
        margin: 0;
        font-weight: 600;
        font-size: 1.5rem;
    }

    .card-body {
        padding: 2rem;
    }

    .section-title {
        color: var(--primary-color);
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--light-bg);
        font-size: 1.2rem;
    }

    .form-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #495057;
        font-size: 0.9rem;
    }

    .form-control,
    .form-select {
        border-radius: 6px;
        border: 1px solid var(--border-color);
        padding: 0.65rem;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        height: auto;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(44, 90, 160, 0.25);
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color), #1e3a6d);
        border: none;
        border-radius: 6px;
        padding: 0.65rem 1.5rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(44, 90, 160, 0.3);
    }

    .btn-success {
        background: linear-gradient(135deg, var(--success-color), #146c43);
        border: none;
    }

    .btn-warning {
        background: linear-gradient(135deg, var(--warning-color), #e0a800);
        border: none;
        color: #000;
    }

    .btn-danger {
        background: linear-gradient(135deg, var(--danger-color), #b02a37);
        border: none;
        color: white;
    }

    .btn-sm {
        padding: 0.35rem 0.75rem;
        font-size: 0.85rem;
    }

    .product-card {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.2s ease;
    }

    .product-card:hover {
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px rgba(44, 90, 160, 0.1);
    }

    .product-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #f1f3f4;
    }

    .product-card-title {
        font-weight: 600;
        color: var(--primary-color);
        margin: 0;
        font-size: 1rem;
    }

    .product-card-content {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    /* CORREGIDO: Reducir de 6 a 4 columnas al eliminar Lote y Fecha_Vencimiento */
    .product-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
        gap: 1rem;
        align-items: end;
    }

    .total-summary {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 2rem;
        border: 1px solid var(--border-color);
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
        font-size: 1rem;
    }

    .grand-total {
        font-weight: 700;
        font-size: 1.3rem;
        border-top: 2px solid var(--border-color);
        padding-top: 1rem;
        margin-top: 1rem;
        color: var(--primary-color);
    }

    .required-field::after {
        content: " *";
        color: var(--danger-color);
    }

    .form-section {
        background: #fafbfc;
        border-radius: 8px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
    }

    .quick-actions {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .input-group-sm .form-control,
    .input-group-sm .form-select {
        padding: 0.4rem 0.5rem;
        font-size: 0.85rem;
    }

    .input-group-sm .input-group-text {
        padding: 0.4rem 0.75rem;
        font-size: 0.85rem;
    }

    .compact-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .info-badge {
        background: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 4px;
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
        color: var(--primary-color);
        display: inline-block;
    }

    .form-control-sm {
        padding: 0.4rem 0.5rem;
        font-size: 0.85rem;
        height: calc(1.5em + 0.8rem + 2px);
    }

    .table-sm {
        font-size: 0.9rem;
    }

    .table-sm th,
    .table-sm td {
        padding: 0.5rem;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .compra-container {
            max-width: 100%;
            margin: 1rem auto;
            padding: 0 0.5rem;
        }

        /* CORREGIDO: Ajustar para 4 columnas */
        .product-grid {
            grid-template-columns: 2fr 1fr 1fr;
        }
    }

    @media (max-width: 768px) {
        .compra-container {
            margin: 0.5rem auto;
        }

        .card-body {
            padding: 1rem;
        }

        .form-section {
            padding: 1rem;
        }

        /* CORREGIDO: Ajustar para 2 columnas en m√≥viles */
        .product-grid {
            grid-template-columns: 1fr 1fr;
        }

        .total-summary {
            padding: 1rem;
        }
    }

    @media (max-width: 576px) {
        .card-header h2 {
            font-size: 1.25rem;
        }

        .section-title {
            font-size: 1.1rem;
        }

        .product-grid {
            grid-template-columns: 1fr;
        }

        .quick-actions {
            flex-direction: column;
        }

        .quick-actions .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .d-flex.gap-3 {
            flex-direction: column;
        }

        .d-flex.gap-3 .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }
    }
</style>
<div class="compra-container">
    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-edit me-2"></i>Editar Compra #{{ movimiento.ID_Movimiento }}</h2>
        </div>
        <div class="card-body">
            <form id="formEditarCompra" method="POST" novalidate action="{{ url_for('admin_editar_compra', id_movimiento=movimiento.ID_Movimiento) }}">
                <input type="hidden" name="id_movimiento" value="{{ movimiento.ID_Movimiento }}">
                <input type="hidden" name="id_usuario_modificacion" value="{{ session.get('id_usuario', 1) }}">

                <!-- Informaci√≥n General Compacta -->
                <div class="form-section">
                    <h4 class="section-title"><i class="fas fa-info-circle me-2"></i>Informaci√≥n General</h4>
                    
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="fecha" class="form-label required-field">Fecha</label>
                            <input type="date" class="form-control form-control-sm" id="fecha" name="fecha" 
                                   value="{{ movimiento.Fecha.strftime('%Y-%m-%d') if movimiento.Fecha else '' }}" required>
                        </div>

                        <div class="col-md-3">
                            <label for="id_bodega" class="form-label required-field">Bodega</label>
                            <select class="form-select form-select-sm" id="id_bodega" name="id_bodega" required>
                                <option value="" disabled>Seleccionar...</option>
                                {% for bodega in bodegas %}
                                <option value="{{ bodega.ID_Bodega }}" 
                                        {% if bodega.ID_Bodega == movimiento.ID_Bodega %}selected{% endif %}>
                                    {{ bodega.Nombre }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="id_proveedor" class="form-label">Proveedor</label>
                            <select class="form-select form-select-sm" id="id_proveedor" name="id_proveedor">
                                <option value="" selected>Seleccionar...</option>
                                {% for proveedor in proveedores %}
                                <option value="{{ proveedor.ID_Proveedor }}" 
                                        {% if proveedor.ID_Proveedor == movimiento.ID_Proveedor %}selected{% endif %}>
                                    {{ proveedor.Nombre }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="n_factura_externa" class="form-label">N¬∞ Factura</label>
                            <input type="text" class="form-control form-control-sm" id="n_factura_externa" name="n_factura_externa" 
                                   value="{{ movimiento.N_Factura_Externa or '' }}" placeholder="Opcional">
                        </div>

                        <div class="col-md-3">
                            <label for="tipo_compra" class="form-label required-field">Tipo Compra</label>
                            <select class="form-select form-select-sm" id="tipo_compra" name="tipo_compra" required>
                                <option value="CONTADO" {% if movimiento.Tipo_Compra == 'CONTADO' %}selected{% endif %}>CONTADO</option>
                                <option value="CREDITO" {% if movimiento.Tipo_Compra == 'CREDITO' %}selected{% endif %}>CR√âDITO</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="id_tipo_movimiento" class="form-label required-field">Tipo Movimiento</label>
                            <select class="form-select form-select-sm" id="id_tipo_movimiento" name="id_tipo_movimiento" required>
                                <option value="" disabled>Seleccionar...</option>
                                {% for tipo in tipos_movimiento %}
                                <option value="{{ tipo.ID_TipoMovimiento }}" 
                                        {% if tipo.ID_TipoMovimiento == movimiento.ID_TipoMovimiento %}selected{% endif %}>
                                    {{ tipo.Descripcion }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Fecha Vencimiento para Cr√©dito -->
                        <div class="col-md-6" id="fecha_vencimiento_group" 
                             style="display: {% if movimiento.Tipo_Compra == 'CREDITO' and cuenta_por_pagar %}block{% else %}none{% endif %};">
                            <label for="fecha_vencimiento" class="form-label">Vencimiento (Cr√©dito)</label>
                            <div class="input-group input-group-sm">
                                <input type="date" class="form-control" id="fecha_vencimiento" name="fecha_vencimiento"
                                       value="{% if cuenta_por_pagar and cuenta_por_pagar.Fecha_Vencimiento %}{{ cuenta_por_pagar.Fecha_Vencimiento.strftime('%Y-%m-%d') }}{% endif %}">
                                {% if cuenta_por_pagar %}
                                <span class="input-group-text info-badge">
                                    C${{ "%.2f"|format(cuenta_por_pagar.Saldo_Pendiente) }}
                                </span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-12">
                            <label for="observacion" class="form-label">Observaciones</label>
                            <textarea class="form-control form-control-sm" id="observacion" name="observacion" rows="2" 
                                      placeholder="Observaciones adicionales...">{{ movimiento.Observacion or '' }}</textarea>
                        </div>
                    </div>
                </div>

                <!-- Productos - Versi√≥n Compacta -->
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="section-title mb-0"><i class="fas fa-boxes me-2"></i>Productos</h4>
                        <div class="quick-actions">
                            <button type="button" class="btn btn-primary btn-sm" id="btn-agregar-producto">
                                <i class="fas fa-plus me-1"></i>Agregar
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-duplicar-producto">
                                <i class="fas fa-copy me-1"></i>Duplicar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Mensaje cuando no hay productos -->
                    <div id="no-products-message" class="text-center py-5" style="display: none;">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No hay productos agregados</h5>
                        <p class="text-muted mb-3">Agregue productos para continuar</p>
                        <button type="button" class="btn btn-primary" id="btn-agregar-primer-producto">
                            <i class="fas fa-plus me-1"></i>Agregar Primer Producto
                        </button>
                    </div>
                    
                    <!-- Contenedor de productos -->
                    <div id="productos-container" class="mt-3">
                        {% for detalle in detalles %}
                        <div class="product-card" id="producto-card-{{ loop.index }}">
                            <div class="product-card-header">
                                <h6 class="product-card-title">Producto #{{ loop.index }}</h6>
                                <button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto({{ loop.index }})">
                                    <i class="fas fa-times"></i>Quitar
                                </button>
                            </div>
                            <div class="product-grid">
                                <!-- Producto -->
                                <div>
                                    <label class="form-label required-field">Producto</label>
                                    <select class="form-select form-select-sm producto-select" name="productos[]" required 
                                            data-producto-id="{{ loop.index }}"
                                            onchange="actualizarInfoProducto({{ loop.index }})">
                                        <option value="" disabled>Seleccionar...</option>
                                        {% for producto in productos %}
                                        <option value="{{ producto.ID_Producto }}" 
                                                data-codigo="{{ producto.COD_Producto }}"
                                                data-precio="{{ producto.Precio_Venta or 0 }}"
                                                data-categoria="{{ producto.ID_Categoria }}"
                                                data-unidad="{{ producto.Unidad_Medida }}"
                                                data-simbolo="{{ producto.Simbolo_Medida }}"
                                                {% if producto.ID_Producto == detalle.ID_Producto %}selected{% endif %}>
                                            {{ producto.COD_Producto }} - {{ producto.Descripcion|truncate(30) }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted" id="producto-info-{{ loop.index }}">
                                        {% if detalle.ID_Producto %}
                                            {% for producto in productos %}
                                                {% if producto.ID_Producto == detalle.ID_Producto %}
                                                    <span class="text-primary">{{ producto.COD_Producto }}</span>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    </small>
                                </div>
                                
                                <!-- Cantidad -->
                                <div>
                                    <label class="form-label required-field">Cantidad</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control cantidad" name="cantidades[]"
                                               value="{{ "%.2f"|format(detalle.Cantidad) }}" min="0.01" step="0.01" required 
                                               onchange="calcularSubtotal({{ loop.index }})">
                                        <span class="input-group-text" id="unidad-simbolo-{{ loop.index }}">
                                            {% if detalle.ID_Producto %}
                                                {% for producto in productos %}
                                                    {% if producto.ID_Producto == detalle.ID_Producto %}
                                                        {{ producto.Simbolo_Medida or 'und' }}
                                                    {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                und
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Costo -->
                                <div>
                                    <label class="form-label required-field">Costo</label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">C$</span>
                                        <input type="number" class="form-control costo" name="costos_unitarios[]"
                                               value="{{ "%.2f"|format(detalle.Costo_Unitario) }}" step="0.01" min="0" required 
                                               onchange="calcularSubtotal({{ loop.index }})">
                                    </div>
                                </div>
                                
                                <!-- Precio -->
                                <div>
                                    <label class="form-label required-field">Precio</label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">C$</span>
                                        <input type="number" class="form-control precio" name="precios_unitarios[]"
                                               value="{{ "%.2f"|format(detalle.Precio_Unitario or detalle.Costo_Unitario) }}" step="0.01" min="0" required 
                                               onchange="actualizarPrecio({{ loop.index }})">
                                    </div>
                                </div>
                                
                                <!-- Subtotal -->
                                <div>
                                    <label class="form-label">Subtotal</label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">C$</span>
                                        <input type="text" class="form-control subtotal" 
                                               value="{{ "%.2f"|format(detalle.Subtotal) }}" readonly style="background: #f8f9fa;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Resumen de Totales -->
                <div class="total-summary">
                    <div class="total-row">
                        <span>Total Productos:</span>
                        <span id="total-productos" class="fw-bold">{{ detalles|length }}</span>
                    </div>
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span id="subtotal" class="fw-bold">C$ {{ "%.2f"|format(movimiento.Total_Compra or 0) }}</span>
                    </div>
                    <div class="total-row grand-total">
                        <span>TOTAL COMPRA:</span>
                        <span id="total-compra" class="fw-bold">C$ {{ "%.2f"|format(movimiento.Total_Compra or 0) }}</span>
                    </div>
                </div>

                <!-- Botones de Acci√≥n -->
                <div class="d-flex justify-content-end gap-3 mt-4">
                    <a href="{{ url_for('admin_compras_entradas') }}" class="btn btn-secondary">
                        <i class="fas fa-times me-1"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> Actualizar Compra
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Variables globales
let contadorProductos = {{ detalles|length }};
let productosData = {{ productos|tojson|safe }};

// ========== INICIALIZACI√ìN ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ Inicializando formulario de edici√≥n...');
    console.log('üìä Productos cargados:', productosData.length);
    
    // Asignar eventos
    document.getElementById('btn-agregar-producto')?.addEventListener('click', agregarProducto);
    document.getElementById('btn-agregar-primer-producto')?.addEventListener('click', agregarProducto);
    document.getElementById('btn-duplicar-producto')?.addEventListener('click', duplicarUltimoProducto);
    
    // Controlar visibilidad de fecha de vencimiento
    const tipoCompraSelect = document.getElementById('tipo_compra');
    if (tipoCompraSelect) {
        tipoCompraSelect.addEventListener('change', function() {
            const fechaVencimientoGroup = document.getElementById('fecha_vencimiento_group');
            if (this.value === 'CREDITO') {
                fechaVencimientoGroup.style.display = 'block';
            } else {
                fechaVencimientoGroup.style.display = 'none';
            }
        });
    }
    
    // Precargar informaci√≥n de productos existentes
    precargarProductosExistentes();
    actualizarMensajeProductos();
    actualizarTotales();
    
    console.log('‚úÖ Formulario inicializado correctamente');
});

// ========== PRECARGA DE DATOS ==========

function precargarProductosExistentes() {
    console.log('üîç Precargando datos de productos existentes...');
    
    const productosExistentes = document.querySelectorAll('.product-card');
    console.log('Productos a precargar:', productosExistentes.length);
    
    productosExistentes.forEach((producto, index) => {
        const id = index + 1;
        const select = producto.querySelector('.producto-select');
        
        if (select && select.value) {
            console.log(`  Producto ${id}: ${select.value}`);
            
            // Buscar los datos del producto en productosData
            const productoId = parseInt(select.value);
            const productoInfo = productosData.find(p => p.ID_Producto == productoId);
            
            if (productoInfo) {
                console.log(`  Encontrado: ${productoInfo.COD_Producto} - ${productoInfo.Descripcion}`);
                
                // Actualizar datos en el select
                const option = select.options[select.selectedIndex];
                option.dataset.codigo = productoInfo.COD_Producto;
                option.dataset.precio = productoInfo.Precio_Venta || 0;
                option.dataset.categoria = productoInfo.ID_Categoria || 0;
                option.dataset.unidad = productoInfo.Unidad_Medida || '';
                option.dataset.simbolo = productoInfo.Simbolo_Medida || 'und';
                
                // Actualizar informaci√≥n visual
                actualizarInfoProducto(id);
            } else {
                console.warn(`  No se encontr√≥ informaci√≥n para producto ID: ${productoId}`);
            }
        }
        
        // Agregar event listeners
        const cantidadInput = producto.querySelector('.cantidad');
        const costoInput = producto.querySelector('.costo');
        
        if (cantidadInput) {
            cantidadInput.addEventListener('input', () => calcularSubtotal(id));
        }
        if (costoInput) {
            costoInput.addEventListener('input', () => calcularSubtotal(id));
        }
    });
}

// ========== FUNCIONES DE PRODUCTOS ==========

function agregarProducto() {
    contadorProductos++;
    const productoHTML = `
        <div class="product-card" id="producto-card-${contadorProductos}">
            <div class="product-card-header">
                <h6 class="product-card-title">Producto #${contadorProductos}</h6>
                <button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto(${contadorProductos})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="product-grid">
                <!-- Producto -->
                <div>
                    <label class="form-label required-field">Producto</label>
                    <select class="form-select form-select-sm producto-select" name="productos[]" required 
                            data-producto-id="${contadorProductos}"
                            onchange="actualizarInfoProducto(${contadorProductos})">
                        <option value="" disabled selected>Seleccionar...</option>
                        {% for producto in productos %}
                        <option value="{{ producto.ID_Producto }}" 
                                data-codigo="{{ producto.COD_Producto }}"
                                data-precio="{{ producto.Precio_Venta or 0 }}"
                                data-categoria="{{ producto.ID_Categoria }}"
                                data-unidad="{{ producto.Unidad_Medida }}"
                                data-simbolo="{{ producto.Simbolo_Medida }}">
                            {{ producto.COD_Producto }} - {{ producto.Descripcion|truncate(30) }}
                        </option>
                        {% endfor %}
                    </select>
                    <small class="text-muted" id="producto-info-${contadorProductos}"></small>
                </div>
                
                <!-- Cantidad -->
                <div>
                    <label class="form-label required-field">Cantidad</label>
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control cantidad" name="cantidades[]"
                               min="0.01" step="0.01" value="1" required 
                               onchange="calcularSubtotal(${contadorProductos})">
                        <span class="input-group-text" id="unidad-simbolo-${contadorProductos}">und</span>
                    </div>
                </div>
                
                <!-- Costo -->
                <div>
                    <label class="form-label required-field">Costo</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">C$</span>
                        <input type="number" class="form-control costo" name="costos_unitarios[]"
                               step="0.01" min="0" value="0" required 
                               onchange="calcularSubtotal(${contadorProductos})">
                    </div>
                </div>
                
                <!-- Precio -->
                <div>
                    <label class="form-label required-field">Precio</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">C$</span>
                        <input type="number" class="form-control precio" name="precios_unitarios[]"
                               step="0.01" min="0" value="0" required 
                               onchange="actualizarPrecio(${contadorProductos})">
                    </div>
                </div>
                
                <!-- Subtotal -->
                <div>
                    <label class="form-label">Subtotal</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">C$</span>
                        <input type="text" class="form-control subtotal" value="0.00" readonly style="background: #f8f9fa;">
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const container = document.getElementById('productos-container');
    if (container) {
        container.insertAdjacentHTML('beforeend', productoHTML);
        actualizarMensajeProductos();
        
        // Hacer scroll suave al nuevo producto
        setTimeout(() => {
            const nuevoProducto = document.getElementById(`producto-card-${contadorProductos}`);
            if (nuevoProducto) {
                nuevoProducto.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                nuevoProducto.querySelector('.producto-select')?.focus();
            }
        }, 100);
    }
}

function duplicarUltimoProducto() {
    const productos = document.querySelectorAll('.product-card');
    if (productos.length === 0) {
        mostrarAlerta('warning', '‚ö†Ô∏è Advertencia', 'No hay productos para duplicar');
        return;
    }
    
    const ultimoProducto = productos[productos.length - 1];
    const select = ultimoProducto.querySelector('.producto-select');
    const cantidad = ultimoProducto.querySelector('.cantidad');
    const costo = ultimoProducto.querySelector('.costo');
    const precio = ultimoProducto.querySelector('.precio');
    
    // Primero agregamos un nuevo producto
    agregarProducto();
    
    // Luego copiamos los valores del √∫ltimo producto
    setTimeout(() => {
        const nuevoProducto = document.getElementById(`producto-card-${contadorProductos}`);
        if (nuevoProducto && select.value) {
            const nuevoSelect = nuevoProducto.querySelector('.producto-select');
            const nuevaCantidad = nuevoProducto.querySelector('.cantidad');
            const nuevoCosto = nuevoProducto.querySelector('.costo');
            const nuevoPrecio = nuevoProducto.querySelector('.precio');
            
            if (nuevoSelect) nuevoSelect.value = select.value;
            if (nuevaCantidad) nuevaCantidad.value = cantidad.value;
            if (nuevoCosto) nuevoCosto.value = costo.value;
            if (nuevoPrecio) nuevoPrecio.value = precio.value;
            
            // Actualizar informaci√≥n del producto
            actualizarInfoProducto(contadorProductos);
            calcularSubtotal(contadorProductos);
            
            mostrarAlerta('success', '‚úÖ Producto duplicado', 'El producto ha sido duplicado correctamente');
        }
    }, 150);
}

function eliminarProducto(id) {
    const productoCard = document.getElementById(`producto-card-${id}`);
    if (productoCard) {
        // Verificar que quede al menos un producto
        const totalProductos = document.querySelectorAll('.product-card').length;
        if (totalProductos <= 1) {
            mostrarAlerta('warning', '‚ö†Ô∏è Advertencia', 'Debe haber al menos un producto en la compra');
            return;
        }
        
        productoCard.remove();
        renumerarProductos();
        actualizarTotales();
        actualizarMensajeProductos();
    }
}

function renumerarProductos() {
    const productos = document.querySelectorAll('.product-card');
    let nuevoContador = 0;
    
    productos.forEach((producto, index) => {
        nuevoContador++;
        const nuevoId = nuevoContador;
        
        // Actualizar ID del contenedor
        producto.id = `producto-card-${nuevoId}`;
        
        // Actualizar t√≠tulo
        const titulo = producto.querySelector('.product-card-title');
        if (titulo) {
            titulo.textContent = `Producto #${nuevoId}`;
        }
        
        // Actualizar bot√≥n de eliminar
        const botonEliminar = producto.querySelector('.btn-danger');
        if (botonEliminar) {
            botonEliminar.setAttribute('onclick', `eliminarProducto(${nuevoId})`);
        }
        
        // Actualizar event listeners de inputs
        const select = producto.querySelector('.producto-select');
        const cantidad = producto.querySelector('.cantidad');
        const costo = producto.querySelector('.costo');
        const precio = producto.querySelector('.precio');
        
        if (select) {
            select.setAttribute('data-producto-id', nuevoId);
            select.setAttribute('onchange', `actualizarInfoProducto(${nuevoId})`);
        }
        if (cantidad) {
            cantidad.setAttribute('onchange', `calcularSubtotal(${nuevoId})`);
        }
        if (costo) {
            costo.setAttribute('onchange', `calcularSubtotal(${nuevoId})`);
        }
        if (precio) {
            precio.setAttribute('onchange', `actualizarPrecio(${nuevoId})`);
        }
        
        // Actualizar otros elementos con ID espec√≠fico
        const unidadSimbolo = producto.querySelector(`[id^="unidad-simbolo-"]`);
        if (unidadSimbolo) {
            unidadSimbolo.id = `unidad-simbolo-${nuevoId}`;
        }
        
        const productoInfo = producto.querySelector(`[id^="producto-info-"]`);
        if (productoInfo) {
            productoInfo.id = `producto-info-${nuevoId}`;
        }
    });
    
    contadorProductos = nuevoContador;
}

function actualizarInfoProducto(id) {
    const productoCard = document.getElementById(`producto-card-${id}`);
    if (!productoCard) return;
    
    const select = productoCard.querySelector('.producto-select');
    const productoInfo = document.getElementById(`producto-info-${id}`);
    const unidadSimbolo = document.getElementById(`unidad-simbolo-${id}`);
    
    if (select && select.value && select.selectedOptions[0].dataset) {
        const dataset = select.selectedOptions[0].dataset;
        
        // Actualizar s√≠mbolo de unidad de medida
        if (unidadSimbolo && dataset.simbolo) {
            unidadSimbolo.textContent = dataset.simbolo || 'und';
        }
        
        // Actualizar informaci√≥n del producto
        if (productoInfo) {
            productoInfo.innerHTML = `<span class="text-primary">${dataset.codigo}</span>`;
            productoInfo.style.display = 'block';
        }
        
        // Buscar producto en productosData para obtener precio de venta
        const productoId = parseInt(select.value);
        const productoEncontrado = productosData.find(p => p.ID_Producto == productoId);
        
        // Establecer precio sugerido si est√° vac√≠o
        const precioInput = productoCard.querySelector('.precio');
        const costoInput = productoCard.querySelector('.costo');
        
        if (precioInput && (!precioInput.value || parseFloat(precioInput.value) === 0)) {
            if (productoEncontrado && productoEncontrado.Precio_Venta) {
                precioInput.value = parseFloat(productoEncontrado.Precio_Venta).toFixed(2);
            } else if (dataset.precio) {
                precioInput.value = parseFloat(dataset.precio).toFixed(2);
            }
        }
        
        // Si el costo est√° vac√≠o, establecer en 0
        if (costoInput && (!costoInput.value || parseFloat(costoInput.value) === 0)) {
            costoInput.value = '0.00';
        }
        
        calcularSubtotal(id);
    } else if (productoInfo) {
        productoInfo.style.display = 'none';
    }
}

function actualizarPrecio(id) {
    const productoCard = document.getElementById(`producto-card-${id}`);
    if (!productoCard) return;
    
    const precioInput = productoCard.querySelector('.precio');
    const precioValue = parseFloat(precioInput.value) || 0;
    const costo = parseFloat(productoCard.querySelector('.costo').value) || 0;
    
    if (precioValue > 0 && precioValue < costo) {
        mostrarAlerta('warning', '‚ö†Ô∏è Advertencia', 'El precio de venta es menor al costo');
    }
}

function calcularSubtotal(id) {
    const productoCard = document.getElementById(`producto-card-${id}`);
    if (!productoCard) return;
    
    const cantidad = parseFloat(productoCard.querySelector('.cantidad').value) || 0;
    const costo = parseFloat(productoCard.querySelector('.costo').value) || 0;
    const subtotal = cantidad * costo;
    
    const subtotalInput = productoCard.querySelector('.subtotal');
    if (subtotalInput) {
        subtotalInput.value = subtotal.toFixed(2);
    }
    
    actualizarTotales();
}

function actualizarTotales() {
    let totalCompra = 0;
    let totalProductos = 0;

    document.querySelectorAll('.product-card').forEach(producto => {
        const subtotalInput = producto.querySelector('.subtotal');
        if (subtotalInput) {
            const valor = parseFloat(subtotalInput.value) || 0;
            totalCompra += valor;
            totalProductos++;
        }
    });

    const totalCompraElement = document.getElementById('total-compra');
    const subtotalElement = document.getElementById('subtotal');
    const totalProductosElement = document.getElementById('total-productos');
    
    if (totalCompraElement) {
        totalCompraElement.textContent = `C$ ${totalCompra.toFixed(2)}`;
    }
    if (subtotalElement) {
        subtotalElement.textContent = `C$ ${totalCompra.toFixed(2)}`;
    }
    if (totalProductosElement) {
        totalProductosElement.textContent = totalProductos;
    }
}

function actualizarMensajeProductos() {
    const filas = document.querySelectorAll('.product-card').length;
    const mensaje = document.getElementById('no-products-message');
    const container = document.getElementById('productos-container');
    
    if (mensaje) {
        mensaje.style.display = filas === 0 ? 'block' : 'none';
    }
    if (container) {
        container.style.display = filas === 0 ? 'none' : 'block';
    }
}

// ========== FUNCIONES AUXILIARES ==========

function mostrarAlerta(tipo, titulo, mensaje) {
    // Eliminar alertas existentes
    const alertasExistentes = document.querySelectorAll('.alert-flotante');
    alertasExistentes.forEach(alerta => alerta.remove());
    
    const alerta = document.createElement('div');
    alerta.className = `alert alert-${tipo} alert-dismissible fade show alert-flotante`;
    alerta.innerHTML = `
        <strong>${titulo}</strong> ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alerta);
    
    setTimeout(() => {
        if (alerta.parentNode) {
            alerta.remove();
        }
    }, 5000);
}

// ========== VALIDACI√ìN DEL FORMULARIO ==========

document.getElementById('formEditarCompra').addEventListener('submit', function(e) {
    if (!validarCompra()) {
        e.preventDefault();
        return;
    }

    // Mostrar loading
    const submitBtn = this.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Actualizando...';
        submitBtn.disabled = true;
    }
});

function validarCompra() {
    let valido = true;

    // Validar campos principales
    const camposRequeridos = document.querySelectorAll('#formEditarCompra [required]');
    camposRequeridos.forEach(campo => {
        if (!campo.value || campo.value.trim() === '') {
            campo.classList.add('is-invalid');
            valido = false;
        } else {
            campo.classList.remove('is-invalid');
        }
    });

    // Validar productos
    const productos = document.querySelectorAll('.product-card');
    if (productos.length === 0) {
        mostrarAlerta('danger', '‚ùå Error', 'Debe agregar al menos un producto');
        return false;
    }

    // Validar cada producto
    let productosValidos = false;
    productos.forEach(producto => {
        const select = producto.querySelector('.producto-select');
        const cantidad = producto.querySelector('.cantidad');
        const costo = producto.querySelector('.costo');
        
        if (select && select.value && cantidad && cantidad.value && costo && costo.value) {
            if (parseFloat(cantidad.value) > 0 && parseFloat(costo.value) >= 0) {
                productosValidos = true;
                select.classList.remove('is-invalid');
                cantidad.classList.remove('is-invalid');
                costo.classList.remove('is-invalid');
            } else {
                if (parseFloat(cantidad.value) <= 0) cantidad.classList.add('is-invalid');
                if (parseFloat(costo.value) < 0) costo.classList.add('is-invalid');
                valido = false;
            }
        } else {
            if (select && !select.value) select.classList.add('is-invalid');
            if (cantidad && !cantidad.value) cantidad.classList.add('is-invalid');
            if (costo && !costo.value) costo.classList.add('is-invalid');
            valido = false;
        }
    });

    if (!productosValidos) {
        mostrarAlerta('danger', '‚ùå Error', 'Complete todos los campos de productos correctamente');
        return false;
    }

    return valido;
}

// ========== MEJORAS DE USABILIDAD ==========

// Auto-focus en cantidad cuando se selecciona un producto
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('producto-select') && e.target.value) {
        const productoCard = e.target.closest('.product-card');
        if (productoCard) {
            const cantidadInput = productoCard.querySelector('.cantidad');
            if (cantidadInput) {
                setTimeout(() => {
                    cantidadInput.focus();
                    cantidadInput.select();
                }, 100);
            }
        }
    }
});

// Auto-focus en costo cuando se ingresa cantidad
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('cantidad') && parseFloat(e.target.value) > 0) {
        const productoCard = e.target.closest('.product-card');
        if (productoCard) {
            const costoInput = productoCard.querySelector('.costo');
            if (costoInput && (!costoInput.value || parseFloat(costoInput.value) === 0)) {
                setTimeout(() => {
                    costoInput.focus();
                    costoInput.select();
                }, 100);
            }
        }
    }
});

// Atajos de teclado
document.addEventListener('keydown', function(e) {
    // Ctrl + Enter para enviar el formulario
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        document.querySelector('button[type="submit"]')?.click();
    }
    
    // Ctrl + D para duplicar producto
    if (e.ctrlKey && e.key === 'd') {
        e.preventDefault();
        duplicarUltimoProducto();
    }
    
    // Ctrl + N para nuevo producto
    if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        agregarProducto();
    }
});

// ========== FUNCI√ìN PARA BUSCAR PRODUCTOS ==========

function buscarProducto(idProducto) {
    return productosData.find(producto => producto.ID_Producto == idProducto);
}
</script>
{% endblock %}