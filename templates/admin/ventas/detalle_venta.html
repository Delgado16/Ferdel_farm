{% extends "layout.html" %}

{% block title %}Detalles de Venta #{{ factura.ID_Factura }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-header">
                <h1>Detalles de Venta</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('admin_ventas_salidas') }}">Ventas</a></li>
                        <li class="breadcrumb-item active">Detalles #{{ factura.ID_Factura }}</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Información de la Factura -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-invoice"></i>
                        Factura #{{ factura.ID_Factura }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th width="40%">Fecha:</th>
                                    <td>{{ factura.Fecha.strftime('%d/%m/%Y') if factura.Fecha else 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <th>Cliente:</th>
                                    <td>{{ factura.Cliente or 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <th>RUC/Cédula:</th>
                                    <td>{{ factura.RUC_Cliente or 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <th>Tipo de Venta:</th>
                                    <td>
                                        <span class="badge {% if factura.Credito_Contado == 1 %}bg-warning{% else %}bg-success{% endif %}">
                                            {{ factura.Tipo_Venta_Formateado }}
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th width="40%">Estado:</th>
                                    <td>
                                        <span class="badge {% if factura.Estado_Movimiento == 1 %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ factura.Estado_Formateado }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Bodega:</th>
                                    <td>{{ factura.Bodega or 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <th>Usuario:</th>
                                    <td>{{ factura.Usuario_Creacion or 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <th>Observación:</th>
                                    <td>{{ factura.Observacion or 'Sin observación' }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Productos Vendidos -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-boxes"></i>
                        Productos Vendidos ({{ total_productos }})
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Código</th>
                                    <th>Producto</th>
                                    <th>Categoría</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">Precio Unit.</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for detalle in detalles %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ detalle.COD_Producto or 'N/A' }}</td>
                                    <td>{{ detalle.Producto or 'N/A' }}</td>
                                    <td>{{ detalle.Categoria or 'N/A' }}</td>
                                    <td class="text-center">{{ "%.2f"|format(detalle.Cantidad) }}</td>
                                    <td class="text-end">C$ {{ "%.2f"|format(detalle.Precio_Unitario) }}</td>
                                    <td class="text-end">C$ {{ "%.2f"|format(detalle.Subtotal) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-secondary">
                                <tr>
                                    <th colspan="6" class="text-end">TOTAL VENTA:</th>
                                    <th class="text-end">C$ {{ "%.2f"|format(total_venta) }}</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Acciones -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cog"></i>
                        Acciones
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <!-- Botón Imprimir Ticket -->
                        <a href="{{ url_for('admin_generar_ticket', id_factura=factura.ID_Factura) }}" 
                           target="_blank" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-print"></i> Imprimir Ticket
                        </a>

                        <!-- Botón Editar (solo si es venta del día y activa) -->
                        {% if factura.Estado_Movimiento == 1 and factura.Fecha == hoy.date() %}
                        <a href="{{ url_for('admin_editar_venta', id_factura=factura.ID_Factura) }}" 
                        class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-edit"></i> Editar Venta
                        </a>
                        {% endif %}

                        <!-- Botón Anular (solo si está activa) -->
                        {% if factura.Estado_Movimiento == 1 %}
                        <button type="button" 
                                class="btn btn-outline-danger btn-sm" 
                                onclick="anularVenta({{ factura.ID_Factura }})">
                            <i class="fas fa-ban"></i> Anular Venta
                        </button>
                        {% endif %}

                        <!-- Información de Crédito -->
                        {% if credito_pendiente and factura.Credito_Contado == 1 %}
                        <div class="alert alert-warning mt-3">
                            <small>
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Crédito Pendiente:</strong> Esta venta tiene saldo pendiente por cobrar.
                            </small>
                        </div>
                        {% endif %}

                        <!-- Volver -->
                        <a href="{{ url_for('admin_ventas_salidas') }}" 
                           class="btn btn-outline-secondary btn-sm mt-3">
                            <i class="fas fa-arrow-left"></i> Volver a Ventas
                        </a>
                    </div>
                </div>
            </div>

            <!-- Información de la Empresa -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-building"></i>
                        Información Empresarial
                    </h6>
                </div>
                <div class="card-body">
                    <small>
                        <strong>{{ factura.Nombre_Empresa or 'Empresa' }}</strong><br>
                        RUC: {{ factura.RUC_Empresa or 'N/A' }}<br>
                        Tel: {{ factura.Telefono_Empresa or 'N/A' }}<br>
                        Dir: {{ factura.Direccion_Empresa or 'N/A' }}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function anularVenta(idFactura) {
    if (confirm('¿Está seguro que desea ANULAR esta venta? Esta acción no se puede deshacer y revertirá el inventario.')) {
        fetch(`/admin/ventas/anular/${idFactura}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al anular la venta');
        });
    }
}
</script>
{% endblock %}