{% extends "layout.html" %}

{% block title %}Detalles de Venta #{{ factura.ID_Factura }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-header">
                <h1>Detalles de Venta</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('admin_ventas_salidas') }}">Ventas</a></li>
                        <li class="breadcrumb-item active">Detalles #{{ factura.ID_Factura }}</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Información de la Factura -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-file-invoice"></i>
                            Factura #{{ factura.ID_Factura }}
                        </h5>
                        <span class="badge {% if factura.Estado_Factura == 'Activa' %}bg-success{% else %}bg-danger{% endif %}">
                            {{ factura.Estado_Factura_Formateado }}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th width="40%">Fecha:</th>
                                    <td>{{ factura.Fecha_Formateada or 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <th>Cliente:</th>
                                    <td>{{ factura.Cliente or 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <th>RUC/Cédula:</th>
                                    <td>{{ factura.RUC_Cliente or 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <th>Tipo de Venta:</th>
                                    <td>
                                        <span class="badge {% if factura.Tipo_Venta_Numerico == 1 %}bg-warning{% else %}bg-success{% endif %}">
                                            {{ factura.Tipo_Venta_Formateado }}
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th width="40%">Movimiento:</th>
                                    <td>
                                        {% if factura.ID_Movimiento and factura.ID_Movimiento > 0 %}
                                        <span class="badge {% if factura.Estado_Movimiento == 'Activa' %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ factura.Estado_Movimiento_Formateado }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">SIN MOVIMIENTO</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Bodega:</th>
                                    <td>{{ factura.Bodega or 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <th>Usuario:</th>
                                    <td>{{ factura.Usuario_Creacion or 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <th>Tipo Movimiento:</th>
                                    <td>{{ factura.Tipo_Movimiento or 'VENTA' }}</td>
                                </tr>
                                <tr>
                                    <th>Observación:</th>
                                    <td>{{ factura.Observacion or 'Sin observación' }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Productos Vendidos -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-boxes"></i>
                        Productos Vendidos ({{ total_productos }})
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Código</th>
                                    <th>Producto</th>
                                    <th>Categoría</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-center">Unidad</th>
                                    <th class="text-end">Precio Unit.</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for detalle in detalles %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ detalle.COD_Producto or 'N/A' }}</td>
                                    <td>{{ detalle.Producto or 'N/A' }}</td>
                                    <td>{{ detalle.Categoria or 'N/A' }}</td>
                                    <td class="text-center">{{ "%.2f"|format(detalle.Cantidad) }}</td>
                                    <td class="text-center">{{ detalle.Unidad_Medida or 'UNIDAD' }}</td>
                                    <td class="text-end">C$ {{ "%.2f"|format(detalle.Precio_Unitario) }}</td>
                                    <td class="text-end">C$ {{ "%.2f"|format(detalle.Subtotal) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-secondary">
                                <tr>
                                    <th colspan="7" class="text-end">TOTAL VENTA:</th>
                                    <th class="text-end">C$ {{ "%.2f"|format(total_venta) }}</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Acciones -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cog"></i>
                        Acciones
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <!-- Botón Imprimir Ticket -->
                        <a href="{{ url_for('admin_generar_ticket', id_factura=factura.ID_Factura) }}" 
                           target="_blank" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-print"></i> Imprimir Ticket
                        </a>

                        <!-- Botón Editar (solo si es venta del día y está ACTIVA) -->
                        {% if factura.Estado_Factura == 'Activa' %}
                            {% set fecha_factura = None %}
                            
                            {# Usar la fecha ya formateada directamente #}
                            {% if factura.Fecha_Formateada %}
                                {% set fecha_factura = factura.Fecha_Formateada %}
                            {% elif factura.Fecha_Original %}
                                {# Si necesitamos extraer la fecha del objeto datetime #}
                                {% if factura.Fecha_Original is string %}
                                    {% set fecha_factura = factura.Fecha_Original.split(' ')[0] if ' ' in factura.Fecha_Original else factura.Fecha_Original %}
                                {% else %}
                                    {% set fecha_factura = factura.Fecha_Original.strftime('%d/%m/%Y') %}
                                {% endif %}
                            {% endif %}
                            
                            {# Comparar con la fecha actual #}
                            {% if fecha_factura %}
                                {% set fecha_hoy = hoy.strftime('%d/%m/%Y') %}
                                {% if fecha_factura == fecha_hoy %}
                                <a href="{{ url_for('admin_editar_venta', id_factura=factura.ID_Factura) }}" 
                                   class="btn btn-outline-warning btn-sm">
                                    <i class="fas fa-edit"></i> Editar Venta
                                </a>
                                {% endif %}
                            {% endif %}
                        {% endif %}

                        <!-- Botón Anular (solo si está ACTIVA) -->
                        {% if factura.Estado_Factura == 'Activa' %}
                        <button type="button" 
                                class="btn btn-outline-danger btn-sm" 
                                onclick="anularVenta({{ factura.ID_Factura }})">
                            <i class="fas fa-ban"></i> Anular Venta
                        </button>
                        {% endif %}

                        <!-- Información de Crédito -->
                        {% if tiene_credito_pendiente and factura.Tipo_Venta_Numerico == 1 %}
                        <div class="alert alert-warning mt-3">
                            <small>
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Crédito Pendiente:</strong> 
                                Esta venta tiene saldo pendiente por cobrar.
                                <br>
                                <strong>Saldo:</strong> C$ {{ "%.2f"|format(credito_info.Saldo_Pendiente_Total) }}
                                {% if credito_info.Fecha_Vencimiento_Max %}
                                <br>
                                <strong>Vencimiento:</strong> 
                                {% if credito_info.Fecha_Vencimiento_Max is string %}
                                    {{ credito_info.Fecha_Vencimiento_Max }}
                                {% else %}
                                    {{ credito_info.Fecha_Vencimiento_Max.strftime('%d/%m/%Y') if credito_info.Fecha_Vencimiento_Max else 'N/A' }}
                                {% endif %}
                                {% endif %}
                            </small>
                        </div>
                        {% endif %}

                        <!-- Volver -->
                        <a href="{{ url_for('admin_ventas_salidas') }}" 
                           class="btn btn-outline-secondary btn-sm mt-3">
                            <i class="fas fa-arrow-left"></i> Volver a Ventas
                        </a>
                    </div>
                </div>
            </div>

            <!-- Información de la Empresa -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-building"></i>
                        Información Empresarial
                    </h6>
                </div>
                <div class="card-body">
                    <small>
                        <strong>{{ factura.Nombre_Empresa or 'Empresa' }}</strong><br>
                        RUC: {{ factura.RUC_Empresa or 'N/A' }}<br>
                        Tel: {{ factura.Telefono_Empresa or 'N/A' }}<br>
                        Dir: {{ factura.Direccion_Empresa or 'N/A' }}
                    </small>
                </div>
            </div>

            <!-- Información de Estados -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-info-circle"></i>
                        Información del Documento
                    </h6>
                </div>
                <div class="card-body">
                    <small>
                        <p><strong>Factura #:</strong> {{ factura.ID_Factura }}</p>
                        <p><strong>Estado Factura:</strong> 
                            <span class="badge {% if factura.Estado_Factura == 'Activa' %}bg-success{% else %}bg-danger{% endif %} badge-sm">
                                {{ factura.Estado_Factura_Formateado }}
                            </span>
                        </p>
                        <p><strong>Tipo Venta:</strong> {{ factura.Tipo_Venta_Formateado }}</p>
                        <p><strong>Movimiento #:</strong> {{ factura.ID_Movimiento if factura.ID_Movimiento and factura.ID_Movimiento > 0 else 'N/A' }}</p>
                        <p><strong>Estado Mov.:</strong> 
                            {% if factura.ID_Movimiento and factura.ID_Movimiento > 0 %}
                            <span class="badge {% if factura.Estado_Movimiento == 'Activa' %}bg-success{% else %}bg-danger{% endif %} badge-sm">
                                {{ factura.Estado_Movimiento_Formateado }}
                            </span>
                            {% else %}
                            N/A
                            {% endif %}
                        </p>
                        <p><strong>Total Factura:</strong> C$ {{ "%.2f"|format(factura.Total_Factura) }}</p>
                    </small>
                </div>
            </div>

            <!-- Historial de Pagos (si es crédito y tiene pagos) -->
            {% if tiene_credito_pendiente and pagos and pagos|length > 0 %}
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-history"></i>
                        Historial de Pagos
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Monto</th>
                                    <th>Forma</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pago in pagos %}
                                <tr>
                                    <td>{{ pago.Fecha_Pago or 'N/A' }}</td>
                                    <td>C$ {{ "%.2f"|format(pago.Monto_Pago) if pago.Monto_Pago else '0.00' }}</td>
                                    <td>{{ pago.Forma_Pago or 'N/A' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function anularVenta(idFactura) {
    if (confirm('¿Está seguro que desea ANULAR esta venta? Esta acción no se puede deshacer y revertirá el inventario.')) {
        fetch(`/admin/ventas/anular/${idFactura}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al anular la venta');
        });
    }
}
</script>
{% endblock %}