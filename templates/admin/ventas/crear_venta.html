{% extends "layout.html" %}

{% block title %}Nueva Venta - Sistema Inventarios{% endblock %}

{% block content %}
<style>
    :root {
        --primary-color: #2c5aa0;
        --secondary-color: #6c757d;
        --success-color: #198754;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --light-bg: #f8f9fa;
        --border-color: #dee2e6;
    }

    .venta-container {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
        background: #fff;
    }

    .card-header {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border-radius: 10px 10px 0 0 !important;
        padding: 1.25rem 1.5rem;
        border-bottom: none;
    }

    .card-header h2 {
        margin: 0;
        font-weight: 600;
        font-size: 1.5rem;
    }

    .card-body {
        padding: 2rem;
    }

    .section-title {
        color: var(--primary-color);
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--light-bg);
        font-size: 1.2rem;
    }

    .form-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #495057;
        font-size: 0.9rem;
    }

    .form-control,
    .form-select {
        border-radius: 6px;
        border: 1px solid var(--border-color);
        padding: 0.65rem;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        height: auto;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(44, 90, 160, 0.25);
    }

    .btn-primary {
        background: linear-gradient(135deg, #28a745, #20c997);
        border: none;
        border-radius: 6px;
        padding: 0.65rem 1.5rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }

    .btn-success {
        background: linear-gradient(135deg, var(--success-color), #146c43);
        border: none;
    }

    .btn-warning {
        background: linear-gradient(135deg, var(--warning-color), #e0a800);
        border: none;
        color: #000;
    }

    .btn-danger {
        background: linear-gradient(135deg, var(--danger-color), #b02a37);
        border: none;
        color: white;
    }

    .btn-sm {
        padding: 0.35rem 0.75rem;
        font-size: 0.85rem;
    }

    .product-card {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.2s ease;
    }

    .product-card:hover {
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px rgba(44, 90, 160, 0.1);
    }

    .product-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #f1f3f4;
    }

    .product-card-title {
        font-weight: 600;
        color: var(--primary-color);
        margin: 0;
        font-size: 1rem;
    }

    .product-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr;
        gap: 1rem;
        align-items: end;
    }

    .total-summary {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 2rem;
        border: 1px solid var(--border-color);
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
        font-size: 1rem;
    }

    .grand-total {
        font-weight: 700;
        font-size: 1.3rem;
        border-top: 2px solid var(--border-color);
        padding-top: 1rem;
        margin-top: 1rem;
        color: var(--primary-color);
    }

    .required-field::after {
        content: " *";
        color: var(--danger-color);
    }

    .form-section {
        background: #fafbfc;
        border-radius: 8px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
    }

    .quick-actions {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .input-group-sm .form-control,
    .input-group-sm .form-select {
        padding: 0.4rem 0.5rem;
        font-size: 0.85rem;
    }

    .input-group-sm .input-group-text {
        padding: 0.4rem 0.75rem;
        font-size: 0.85rem;
    }

    .compact-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .info-badge {
        background: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 4px;
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
        color: var(--primary-color);
        display: inline-block;
    }

    .form-control-sm {
        padding: 0.4rem 0.5rem;
        font-size: 0.85rem;
        height: calc(1.5em + 0.8rem + 2px);
    }

    /* Estilo para C$ */
    .input-group-text {
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        font-weight: 600;
        color: #495057;
    }

    /* Stock indicators */
    .stock-danger {
        color: var(--danger-color);
        font-weight: 700;
        background-color: rgba(220, 53, 69, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        display: inline-block;
    }

    .stock-low {
        color: var(--danger-color);
        font-weight: 600;
    }

    .stock-medium {
        color: var(--warning-color);
        font-weight: 600;
    }

    .stock-good {
        color: var(--success-color);
        font-weight: 600;
    }

    /* Alertas flotantes */
    .alert-flotante {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1100;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .filter-section {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid #90caf9;
    }

    .bodega-info {
        background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
        border: 1px solid #a5d6a7;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .credito-info {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        border: 1px solid #ffecb5;
        border-radius: 6px;
        padding: 1rem;
        margin-top: 1rem;
        display: none;
    }

    .invalid-feedback {
        display: none;
        color: var(--danger-color);
        font-size: 0.8rem;
        margin-top: 0.25rem;
        font-weight: 500;
    }

    .is-invalid~.invalid-feedback {
        display: block;
    }

    .is-invalid {
        border-color: var(--danger-color);
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }

    /* Modal de confirmaci√≥n */
    .confirm-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .confirm-modal.show {
        display: flex;
    }

    .confirm-modal-content {
        background-color: white;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        animation: modalFadeIn 0.3s ease;
    }

    @keyframes modalFadeIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .confirm-modal-header {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 1.25rem 1.5rem;
        border-radius: 10px 10px 0 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .confirm-modal-header h4 {
        margin: 0;
        font-weight: 600;
        font-size: 1.25rem;
    }

    .confirm-modal-body {
        padding: 1.5rem;
        max-height: 60vh;
        overflow-y: auto;
    }

    .confirm-modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
    }

    .confirm-summary {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
        border: 1px solid var(--border-color);
    }

    .confirm-summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .confirm-summary-item:last-child {
        margin-bottom: 0;
    }

    .confirm-summary-total {
        border-top: 2px solid var(--border-color);
        padding-top: 0.75rem;
        margin-top: 0.75rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .confirm-product-list {
        max-height: 200px;
        overflow-y: auto;
        margin: 1rem 0;
        border: 1px solid var(--border-color);
        border-radius: 6px;
    }

    .confirm-product-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e9ecef;
    }

    .confirm-product-item:last-child {
        border-bottom: none;
    }

    .confirm-product-name {
        flex: 1;
        font-weight: 500;
    }

    .confirm-product-details {
        display: flex;
        gap: 1rem;
        font-size: 0.9rem;
        color: #6c757d;
    }

    .modal-icon {
        font-size: 2.5rem;
        color: #28a745;
        margin-bottom: 1rem;
        text-align: center;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .venta-container {
            max-width: 100%;
            margin: 1rem auto;
            padding: 0 0.5rem;
        }

        .product-grid {
            grid-template-columns: 2fr 1fr 1fr;
        }
    }

    @media (max-width: 768px) {
        .venta-container {
            margin: 0.5rem auto;
        }

        .card-body {
            padding: 1rem;
        }

        .form-section {
            padding: 1rem;
        }

        .product-grid {
            grid-template-columns: 1fr 1fr;
        }

        .total-summary {
            padding: 1rem;
        }

        .confirm-modal-content {
            width: 95%;
            margin: 1rem;
        }

        .confirm-modal-body {
            max-height: 70vh;
        }
    }

    @media (max-width: 576px) {
        .card-header h2 {
            font-size: 1.25rem;
        }

        .section-title {
            font-size: 1.1rem;
        }

        .product-grid {
            grid-template-columns: 1fr;
        }

        .quick-actions {
            flex-direction: column;
        }

        .quick-actions .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .d-flex.gap-3 {
            flex-direction: column;
        }

        .d-flex.gap-3 .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .confirm-modal-footer {
            flex-direction: column;
        }

        .confirm-modal-footer .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }
    }
</style>

<!-- Modal de Confirmaci√≥n -->
<div class="confirm-modal" id="confirmModal">
    <div class="confirm-modal-content">
        <div class="confirm-modal-header">
            <h4><i class="fas fa-check-circle me-2"></i>Confirmar Venta</h4>
            <button type="button" class="btn-close btn-close-white" id="closeConfirmModal"></button>
        </div>
        <div class="confirm-modal-body">
            <div class="modal-icon">
                <i class="fas fa-cash-register"></i>
            </div>
            <h5 class="text-center mb-3">¬øEst√° seguro de registrar esta venta?</h5>
            <p class="text-center text-muted mb-4">Revise los detalles antes de continuar:</p>

            <!-- Resumen de la venta -->
            <div class="confirm-summary">
                <div class="confirm-summary-item">
                    <span>Cliente:</span>
                    <strong id="confirm-cliente"></strong>
                </div>
                <div class="confirm-summary-item">
                    <span>Tipo de Venta:</span>
                    <strong id="confirm-tipo-venta"></strong>
                </div>
                <div class="confirm-summary-item">
                    <span>Bodega:</span>
                    <strong>{{ bodega_principal.Nombre if bodega_principal else 'Principal' }}</strong>
                </div>
                <div class="confirm-summary-item">
                    <span>Total Productos:</span>
                    <strong id="confirm-total-productos"></strong>
                </div>
                <div class="confirm-summary-item" id="confirm-fecha-vencimiento-container" style="display: none;">
                    <span>Fecha Vencimiento:</span>
                    <strong id="confirm-fecha-vencimiento"></strong>
                </div>
                <div class="confirm-summary-item confirm-summary-total">
                    <span>TOTAL A COBRAR:</span>
                    <strong id="confirm-total-cobrar"></strong>
                </div>
            </div>

            <!-- Lista de productos -->
            <h6 class="mb-2">Productos incluidos:</h6>
            <div class="confirm-product-list" id="confirm-product-list">
                <!-- Los productos se agregar√°n aqu√≠ din√°micamente -->
            </div>

            <div class="alert alert-warning mt-3 mb-0">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <small>Una vez confirmada, la venta se registrar√° en el sistema y el inventario se actualizar√°
                    autom√°ticamente.</small>
            </div>
        </div>
        <div class="confirm-modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelConfirm">
                <i class="fas fa-times me-1"></i> Cancelar
            </button>
            <button type="button" class="btn btn-primary" id="confirmProceed">
                <i class="fas fa-check me-1"></i> S√≠, Registrar Venta
            </button>
        </div>
    </div>
</div>

<div class="venta-container">
    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-cash-register me-2"></i>Registrar Nueva Venta</h2>
        </div>
        <div class="card-body">

            <!-- Informaci√≥n de Bodega -->
            {% if bodega_principal %}
            <div class="bodega-info">
                <div class="d-flex align-items-center">
                    <i class="fas fa-warehouse fa-2x text-success me-3"></i>
                    <div>
                        <h5 class="mb-1">Bodega: {{ bodega_principal.Nombre }}</h5>
                        <p class="mb-0">Todos los productos se vender√°n desde esta bodega</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <form id="formVenta" method="POST" novalidate>
                <!-- Informaci√≥n General de la Venta -->
                <div class="form-section">
                    <h4 class="section-title"><i class="fas fa-info-circle me-2"></i>Informaci√≥n General</h4>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="id_cliente" class="form-label">Cliente</label>
                            <select class="form-select form-select-sm" id="id_cliente" name="id_cliente">
                                <option value="" selected>Seleccionar...</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.ID_Cliente }}">{{ cliente.Nombre }} - {{ cliente.RUC_CEDULA }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="tipo_venta" class="form-label required-field">Tipo de Venta</label>
                            <select class="form-select form-select-sm" id="tipo_venta" name="tipo_venta" required>
                                <option value="contado">CONTADO</option>
                                <option value="credito">CR√âDITO</option>
                            </select>
                            <div class="invalid-feedback">Por favor seleccione el tipo de venta</div>
                        </div>

                        <!-- Campo bodega OCULTO con valor fijo -->
                        <input type="hidden" id="id_bodega" name="id_bodega"
                            value="{{ bodega_principal.ID_Bodega if bodega_principal else 1 }}">

                        <!-- Filtro por Categor√≠a de Producto -->
                        <div class="col-md-8">
                            <label for="filtro_categoria" class="form-label">Filtrar Productos por Categor√≠a</label>
                            <select class="form-select form-select-sm" id="filtro_categoria" name="filtro_categoria">
                                <option value="0">Todas las categor√≠as</option>
                                {% for categoria in categorias %}
                                <option value="{{ categoria.ID_Categoria }}">{{ categoria.Descripcion }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Filtre los productos por categor√≠a para facilitar la
                                b√∫squeda</small>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2 mt-2">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="btn-aplicar-filtro">
                                    <i class="fas fa-filter me-1"></i>Aplicar Filtro
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-limpiar-filtro">
                                    <i class="fas fa-times me-1"></i>Limpiar
                                </button>
                            </div>
                        </div>

                        <!-- Campo de fecha de vencimiento (solo para cr√©dito) -->
                        <div class="col-12" id="fecha_vencimiento_group" style="display: none;">
                            <label for="fecha_vencimiento" class="form-label required-field">Fecha de Vencimiento
                                (Cr√©dito)</label>
                            <input type="date" class="form-control form-control-sm" id="fecha_vencimiento"
                                name="fecha_vencimiento">
                            <div class="credito-info">
                                <small><i class="fas fa-info-circle me-1"></i>Se generar√° autom√°ticamente una cuenta por
                                    cobrar para esta venta a cr√©dito.</small>
                            </div>
                        </div>

                        <div class="col-12">
                            <label for="observacion" class="form-label">Observaciones</label>
                            <textarea class="form-control form-control-sm" id="observacion" name="observacion" rows="2"
                                placeholder="Observaciones adicionales sobre la venta..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Detalles de Productos - Versi√≥n Compacta -->
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="section-title mb-0"><i class="fas fa-boxes me-2"></i>Productos</h4>
                        <div class="quick-actions">
                            <button type="button" class="btn btn-primary btn-sm" id="btn-agregar-producto">
                                <i class="fas fa-plus me-1"></i>Agregar
                            </button>
                        </div>
                    </div>

                    <!-- Informaci√≥n del filtro aplicado -->
                    <div class="filter-section" id="filtro-info" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-filter me-2 text-primary"></i>
                                <strong>Filtro aplicado:</strong>
                                <span id="filtro-actual">Todas las categor√≠as</span>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-quitar-filtro">
                                <i class="fas fa-times me-1"></i>Quitar filtro
                            </button>
                        </div>
                    </div>

                    <!-- Mensaje cuando no hay productos -->
                    <div id="no-products-message" class="text-center py-5" style="display: none;">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No hay productos agregados</h5>
                        <p class="text-muted mb-3">Haga clic en "Agregar Producto" para comenzar</p>
                        <button type="button" class="btn btn-primary" id="btn-agregar-primer-producto">
                            <i class="fas fa-plus me-1"></i>Agregar Primer Producto
                        </button>
                    </div>

                    <!-- Contenedor de productos en tarjetas -->
                    <div id="productos-container" class="mt-3">
                        <!-- Los productos se agregar√°n aqu√≠ din√°micamente -->
                    </div>
                </div>

                <!-- Resumen de Totales -->
                <div class="total-summary">
                    <div class="total-row">
                        <span>Total Productos:</span>
                        <span id="total-productos" class="fw-bold">0</span>
                    </div>
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span id="subtotal" class="fw-bold">C$ 0.00</span>
                    </div>
                    <div class="total-row grand-total">
                        <span>TOTAL VENTA:</span>
                        <span id="total-venta" class="fw-bold">C$ 0.00</span>
                    </div>
                </div>

                <!-- Botones de Acci√≥n -->
                <div class="d-flex justify-content-end gap-3 mt-4">
                    <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                        <i class="fas fa-times me-1"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> Guardar Venta
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Variables globales
    let productos = [];
    let contadorProductos = 0;
    let filtroCategoriaActual = 0;
    let productosEnCache = [];
    let productosBase = [];

    // ============================================
    // FUNCIONES DE INICIALIZACI√ìN
    // ============================================

    // Inicializaci√≥n cuando el DOM est√° listo
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üîÑ Inicializando formulario de venta...');

        // Cargar todos los productos inicialmente
        cargarProductosBase();

        // Asignar eventos
        document.getElementById('btn-agregar-producto').addEventListener('click', agregarProducto);
        document.getElementById('btn-agregar-primer-producto').addEventListener('click', agregarProducto);
        document.getElementById('btn-aplicar-filtro').addEventListener('click', aplicarFiltroCategoria);
        document.getElementById('btn-limpiar-filtro').addEventListener('click', limpiarFiltro);
        document.getElementById('btn-quitar-filtro').addEventListener('click', limpiarFiltro);

        // Controlar visibilidad de fecha de vencimiento para cr√©dito
        document.getElementById('tipo_venta').addEventListener('change', function () {
            const fechaVencimientoGroup = document.getElementById('fecha_vencimiento_group');
            if (this.value === 'credito') {
                fechaVencimientoGroup.style.display = 'block';
                // Establecer fecha de vencimiento por defecto (30 d√≠as)
                const fechaVencimiento = new Date();
                fechaVencimiento.setDate(fechaVencimiento.getDate() + 30);
                document.getElementById('fecha_vencimiento').value = fechaVencimiento.toISOString().split('T')[0];

                // Validar que haya cliente seleccionado
                const cliente = document.getElementById('id_cliente').value;
                if (!cliente) {
                    mostrarAlerta('warning', '‚ö†Ô∏è Advertencia', 'Para ventas a cr√©dito debe seleccionar un cliente');
                }
            } else {
                fechaVencimientoGroup.style.display = 'none';
                document.getElementById('fecha_vencimiento').value = '';
                document.getElementById('id_cliente').classList.remove('is-invalid');
            }
        });

        // Validar cliente cuando se selecciona cr√©dito
        document.getElementById('id_cliente').addEventListener('change', function () {
            if (document.getElementById('tipo_venta').value === 'credito' && !this.value) {
                mostrarAlerta('warning', '‚ö†Ô∏è Advertencia', 'Para ventas a cr√©dito debe seleccionar un cliente');
            }
        });

        // Eventos para el modal de confirmaci√≥n
        document.getElementById('closeConfirmModal').addEventListener('click', cerrarModalConfirmacion);
        document.getElementById('cancelConfirm').addEventListener('click', cerrarModalConfirmacion);
        document.getElementById('confirmProceed').addEventListener('click', confirmarVenta);

        // Agregar primera fila de producto
        agregarProducto();

        console.log('‚úÖ Formulario inicializado correctamente');
    });

    // ============================================
    // FUNCIONES DEL MODAL DE CONFIRMACI√ìN
    // ============================================

    function mostrarModalConfirmacion() {
        console.log('üìã Preparando modal de confirmaci√≥n...');

        // Obtener datos del formulario
        const clienteSelect = document.getElementById('id_cliente');
        const cliente = clienteSelect.options[clienteSelect.selectedIndex]?.text || 'Cliente no seleccionado';
        const tipoVenta = document.getElementById('tipo_venta').value === 'credito' ? 'CR√âDITO' : 'CONTADO';
        const totalProductos = document.getElementById('total-productos').textContent;
        const totalCobrar = document.getElementById('total-venta').textContent;
        const fechaVencimiento = document.getElementById('fecha_vencimiento').value;

        // Actualizar informaci√≥n en el modal
        document.getElementById('confirm-cliente').textContent = cliente;
        document.getElementById('confirm-tipo-venta').textContent = tipoVenta;
        document.getElementById('confirm-total-productos').textContent = totalProductos;
        document.getElementById('confirm-total-cobrar').textContent = totalCobrar;

        // Mostrar/ocultar fecha de vencimiento
        const fechaVencimientoContainer = document.getElementById('confirm-fecha-vencimiento-container');
        const fechaVencimientoElement = document.getElementById('confirm-fecha-vencimiento');

        if (tipoVenta === 'CR√âDITO' && fechaVencimiento) {
            fechaVencimientoContainer.style.display = 'flex';
            fechaVencimientoElement.textContent = new Date(fechaVencimiento).toLocaleDateString('es-ES');
        } else {
            fechaVencimientoContainer.style.display = 'none';
        }

        // Obtener y mostrar productos
        const productList = document.getElementById('confirm-product-list');
        productList.innerHTML = '';

        const productosCards = document.querySelectorAll('.product-card');
        let productosValidos = 0;

        productosCards.forEach((tarjeta, index) => {
            const select = tarjeta.querySelector('.producto-select');
            const cantidad = tarjeta.querySelector('.cantidad');
            const precio = tarjeta.querySelector('.precio');
            const subtotal = tarjeta.querySelector('.subtotal');

            if (select.value && parseFloat(cantidad.value) > 0 && parseFloat(precio.value) > 0) {
                productosValidos++;

                const productoNombre = select.options[select.selectedIndex]?.text || 'Producto no identificado';
                const productoDiv = document.createElement('div');
                productoDiv.className = 'confirm-product-item';

                productoDiv.innerHTML = `
                <div class="confirm-product-name">${productoNombre.split(' - ')[0]}</div>
                <div class="confirm-product-details">
                    <span>${cantidad.value} und</span>
                    <span>C$ ${precio.value}</span>
                    <span class="fw-bold">C$ ${subtotal.value}</span>
                </div>
            `;

                productList.appendChild(productoDiv);
            }
        });

        // Mostrar mensaje si no hay productos v√°lidos
        if (productosValidos === 0) {
            const mensajeDiv = document.createElement('div');
            mensajeDiv.className = 'confirm-product-item text-center text-muted';
            mensajeDiv.textContent = 'No hay productos v√°lidos para mostrar';
            productList.appendChild(mensajeDiv);
        }

        // Mostrar el modal
        document.getElementById('confirmModal').classList.add('show');
        document.body.style.overflow = 'hidden';

        console.log('‚úÖ Modal de confirmaci√≥n mostrado');
    }

    function cerrarModalConfirmacion() {
        document.getElementById('confirmModal').classList.remove('show');
        document.body.style.overflow = 'auto';
        console.log('‚ùå Modal de confirmaci√≥n cerrado');
    }

    function confirmarVenta() {
        console.log('‚úÖ Confirmaci√≥n aceptada, procesando venta...');
        cerrarModalConfirmacion();

        // Validar fecha de vencimiento si es cr√©dito
        if (!validarFechaVencimiento()) {
            return;
        }

        // Procesar la venta
        procesarVenta();
    }

    // ============================================
    // FUNCIONES DE PRODUCTOS BASE
    // ============================================

    async function cargarProductosBase() {
        try {
            console.log('[VENTAS] Cargando productos base...');

            const response = await fetch('/admin/ventas/todos-productos');

            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }

            const productosData = await response.json();

            if (productosData.error) {
                throw new Error(productosData.error);
            }

            productosBase = productosData;
            console.log(`[VENTAS] Productos base cargados: ${productosBase.length} productos`);

        } catch (error) {
            console.error('[VENTAS] Error cargando productos base:', error);
            mostrarAlerta('danger', '‚ùå Error', 'No se pudieron cargar los productos');
        }
    }

    // ============================================
    // FUNCIONES DE FILTRADO DE PRODUCTOS
    // ============================================

    async function aplicarFiltroCategoria() {
        const categoriaSelect = document.getElementById('filtro_categoria');
        const idCategoria = categoriaSelect.value;
        const nombreCategoria = categoriaSelect.options[categoriaSelect.selectedIndex].text;

        console.log('[VENTAS] Aplicando filtro - Categoria:', idCategoria);

        try {
            // Mostrar loading
            const btnFiltro = document.getElementById('btn-aplicar-filtro');
            const originalText = btnFiltro.innerHTML;
            btnFiltro.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Cargando...';
            btnFiltro.disabled = true;

            // Determinar qu√© productos mostrar
            let productosAMostrar;

            if (idCategoria == 0) {
                // Mostrar todos los productos
                productosAMostrar = productosBase;
                productosEnCache = [];
            } else {
                // Cargar productos filtrados por categor√≠a
                const response = await fetch(`/admin/ventas/productos-por-categoria/${idCategoria}`);

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const productosRecibidos = await response.json();

                if (productosRecibidos.error) {
                    throw new Error(productosRecibidos.error);
                }

                productosAMostrar = productosRecibidos;
                productosEnCache = productosRecibidos;
            }

            filtroCategoriaActual = idCategoria;

            // ACTUALIZAR TODOS LOS SELECTS
            const selectsProductos = document.querySelectorAll('.producto-select');
            console.log('[VENTAS] Procesando selects. Total:', selectsProductos.length);

            let selectsActualizados = 0;
            let selectsMantenidos = 0;

            selectsProductos.forEach((select, index) => {
                const tieneProducto = select.value && select.value !== "";

                if (!tieneProducto) {
                    // Select vac√≠o - actualizar con productos filtrados
                    console.log(`[VENTAS] Actualizando select vac√≠o ${index + 1}`);
                    actualizarOpcionesSelect(select, productosAMostrar);
                    selectsActualizados++;
                } else {
                    // Select con producto seleccionado - VERIFICAR SI EST√Å DISPONIBLE CON EL FILTRO
                    const productoId = select.value;
                    const productoEncontrado = productosAMostrar.find(p =>
                        (p.ID_Producto || p.id) == productoId
                    );

                    if (productoEncontrado) {
                        // El producto sigue disponible - MANTENER selecci√≥n
                        console.log(`[VENTAS] Manteniendo select ${index + 1} con producto ${productoId}`);
                        selectsMantenidos++;
                    } else {
                        // El producto ya no est√° disponible con este filtro
                        console.log(`[VENTAS] Producto ${productoId} no disponible con filtro, limpiando select ${index + 1}`);

                        // Limpiar el select
                        select.value = "";
                        actualizarOpcionesSelect(select, productosAMostrar);

                        // Limpiar campos relacionados
                        const tarjeta = select.closest('.product-card');
                        if (tarjeta) {
                            tarjeta.querySelector('.precio').value = '0';
                            tarjeta.querySelector('.cantidad').value = '1';
                            tarjeta.querySelector('.subtotal').value = '0.00';
                        }

                        selectsActualizados++;
                    }
                }
            });

            console.log(`[VENTAS] Resultado: Actualizados=${selectsActualizados}, Mantenidos=${selectsMantenidos}`);

            // Mostrar informaci√≥n del filtro
            const filtroInfo = document.getElementById('filtro-info');
            const filtroActual = document.getElementById('filtro-actual');

            if (idCategoria === '0') {
                filtroInfo.style.display = 'none';
                filtroActual.textContent = 'Todas las categor√≠as';
            } else {
                filtroInfo.style.display = 'block';
                filtroActual.textContent = nombreCategoria;
            }

            // Mostrar mensaje informativo
            let mensaje = `Filtro aplicado: ${nombreCategoria}`;
            if (selectsMantenidos > 0) {
                mensaje += `. Se mantuvieron ${selectsMantenidos} productos seleccionados.`;
            }
            if (selectsActualizados > 0) {
                mensaje += ` ${selectsActualizados} selects actualizados.`;
            }

            mostrarAlerta('success', '‚úÖ Filtro aplicado', mensaje);

        } catch (error) {
            console.error('[VENTAS] Error aplicando filtro:', error);
            mostrarAlerta('danger', '‚ùå Error', `No se pudieron cargar los productos: ${error.message}`);
        } finally {
            // Restaurar bot√≥n
            const btnFiltro = document.getElementById('btn-aplicar-filtro');
            btnFiltro.innerHTML = '<i class="fas fa-filter me-1"></i>Aplicar Filtro';
            btnFiltro.disabled = false;
        }
    }

    function actualizarOpcionesSelect(select, productos) {
        // Guardar valor actual
        const valorActual = select.value;

        // Limpiar TODAS las opciones
        select.innerHTML = '';

        // Agregar opci√≥n por defecto
        const opcionDefault = document.createElement('option');
        opcionDefault.value = "";
        opcionDefault.disabled = true;
        opcionDefault.selected = true;
        opcionDefault.textContent = "Seleccionar producto...";
        select.appendChild(opcionDefault);

        // Agregar nuevos productos como opciones
        productos.forEach(producto => {
            const option = document.createElement('option');
            const productoId = producto.ID_Producto || producto.id;
            option.value = productoId;
            option.textContent = `${producto.Descripcion || producto.descripcion} (${producto.COD_Producto || producto.codigo}) - Stock: ${producto.Existencias || producto.existencias}`;
            option.dataset.codigo = producto.COD_Producto || producto.codigo;
            option.dataset.existencia = producto.Existencias || producto.existencias;
            option.dataset.precio = producto.Precio_Venta || producto.precio_venta || 0;
            option.dataset.categoria = producto.ID_Categoria || producto.id_categoria;

            select.appendChild(option);
        });

        // Intentar restaurar la selecci√≥n anterior si existe
        if (valorActual && valorActual !== "") {
            // Verificar si el valor anterior todav√≠a est√° en las opciones
            const opcionExiste = Array.from(select.options).some(option =>
                option.value == valorActual
            );

            if (opcionExiste) {
                select.value = valorActual;
                console.log(`[SELECT] Selecci√≥n restaurada: ${valorActual}`);
            }
        }
    }

    function limpiarFiltro() {
        console.log('[VENTAS] Limpiando filtro');
        document.getElementById('filtro_categoria').value = '0';
        document.getElementById('filtro-info').style.display = 'none';
        filtroCategoriaActual = 0;
        productosEnCache = [];

        // Actualizar TODOS los selects con productos base
        const selectsProductos = document.querySelectorAll('.producto-select');
        console.log('[VENTAS] Actualizando todos los selects con productos base');

        selectsProductos.forEach((select, index) => {
            actualizarOpcionesSelect(select, productosBase);
        });

        mostrarAlerta('info', '‚ÑπÔ∏è Filtro limpiado', 'Mostrando todos los productos disponibles.');
    }

    // ============================================
    // FUNCIONES DE GESTI√ìN DE PRODUCTOS
    // ============================================

    function agregarProducto() {
        contadorProductos++;
        console.log(` Agregando producto ${contadorProductos}`);

        const productoHTML = `
        <div class="product-card" id="producto-card-${contadorProductos}">
            <div class="product-card-header">
                <h6 class="product-card-title">Producto #${contadorProductos}</h6>
                <button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto(${contadorProductos})" title="Eliminar producto">
                    <i class="fas fa-times"></i> Quitar
                </button>
            </div>
            <div class="product-grid">
                <!-- Producto -->
                <div>
                    <label class="form-label required-field">Producto</label>
                    <select class="form-select form-select-sm producto-select" name="producto_id[]" required 
                            data-producto-id="${contadorProductos}"
                            onchange="actualizarInfoProducto(${contadorProductos})">
                        <option value="" disabled selected>Cargando productos...</option>
                    </select>
                    <div class="invalid-feedback">Seleccione un producto</div>
                    <small class="text-muted" id="producto-info-${contadorProductos}" style="display: none;"></small>
                </div>
                
                <!-- Cantidad -->
                <div>
                    <label class="form-label required-field">Cantidad</label>
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control cantidad" name="cantidad[]" 
                               min="0.01" step="0.01" value="1" required 
                               onchange="calcularSubtotal(${contadorProductos})"
                               oninput="validarStockEnTiempoReal(${contadorProductos})">
                        <span class="input-group-text">und</span>
                    </div>
                    <div class="invalid-feedback">Ingrese una cantidad v√°lida</div>
                </div>
                
                <!-- Precio -->
                <div>
                    <label class="form-label required-field">Precio</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">C$</span>
                        <input type="number" class="form-control precio" name="precio[]" 
                               step="0.01" min="0" value="0" required 
                               onchange="calcularSubtotal(${contadorProductos})">
                    </div>
                    <div class="invalid-feedback">Ingrese un precio v√°lido</div>
                </div>
                
                <!-- Subtotal -->
                <div>
                    <label class="form-label">Subtotal</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">C$</span>
                        <input type="text" class="form-control subtotal" value="0.00" readonly style="background: #f8f9fa;">
                    </div>
                </div>
            </div>
            <!-- Informaci√≥n de stock -->
            <small class="text-muted stock-info" id="stock-info-${contadorProductos}" style="display: none; margin-top: 0.5rem;"></small>
        </div>
    `;

        document.getElementById('productos-container').insertAdjacentHTML('beforeend', productoHTML);

        // Inicializar el select con productos
        const nuevoSelect = document.getElementById(`producto-card-${contadorProductos}`).querySelector('.producto-select');

        // Cargar productos en el select
        cargarProductosEnSelect(nuevoSelect);

        actualizarTotales();
        actualizarMensajeProductos();

        // Desplazarse a la nueva tarjeta en m√≥viles
        if (window.innerWidth <= 768) {
            document.getElementById(`producto-card-${contadorProductos}`).scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }

    async function cargarProductosEnSelect(select) {
        try {
            let productosAMostrar;

            if (filtroCategoriaActual !== 0 && productosEnCache.length > 0) {
                // Usar productos filtrados en cach√©
                productosAMostrar = productosEnCache;
            } else if (filtroCategoriaActual !== 0) {
                // Cargar productos filtrados
                const response = await fetch(`/admin/ventas/productos-por-categoria/${filtroCategoriaActual}`);

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                productosAMostrar = await response.json();
                productosEnCache = productosAMostrar;
            } else {
                // Mostrar todos los productos
                productosAMostrar = productosBase;
            }

            // Actualizar el select
            actualizarOpcionesSelect(select, productosAMostrar);

        } catch (error) {
            console.error('Error cargando productos:', error);
            select.innerHTML = '<option value="" disabled selected>Error cargando productos</option>';
        }
    }

    function eliminarProducto(id) {
        console.log(`üóëÔ∏è Eliminando producto ${id}`);
        const tarjeta = document.getElementById(`producto-card-${id}`);
        if (tarjeta) {
            // Verificar que quede al menos un producto
            const totalProductos = document.querySelectorAll('.product-card').length;
            if (totalProductos <= 1) {
                mostrarAlerta('warning', '‚ö†Ô∏è Advertencia', 'Debe haber al menos un producto en la venta');
                return;
            }

            tarjeta.remove();
            productos = productos.filter(p => p.id !== id);
            actualizarTotales();
            actualizarMensajeProductos();

            mostrarAlerta('info', 'üóëÔ∏è Producto eliminado', 'El producto ha sido removido de la venta');
        }
    }

    async function actualizarInfoProducto(id) {
        const tarjeta = document.getElementById(`producto-card-${id}`);
        if (!tarjeta) return;

        const select = tarjeta.querySelector('.producto-select');
        const productoInfo = document.getElementById(`producto-info-${id}`);
        const stockInfo = document.getElementById(`stock-info-${id}`);
        const precioInput = tarjeta.querySelector('.precio');
        const cantidadInput = tarjeta.querySelector('.cantidad');

        console.log(`üîÑ Actualizando info para producto ${id}: ${select.value}`);

        if (select.value && select.selectedOptions[0].dataset) {
            const dataset = select.selectedOptions[0].dataset;

            try {
                // Actualizar informaci√≥n del producto
                if (productoInfo) {
                    productoInfo.innerHTML = `<span class="text-primary">${dataset.codigo}</span>`;
                    productoInfo.style.display = 'block';
                }

                // Verificar stock actual
                const stockActual = await obtenerStockActual(select.value);
                const precioSugerido = parseFloat(dataset.precio) || 0;

                // Mostrar informaci√≥n de stock
                let stockClass = 'stock-good';
                let stockIcon = '‚úÖ';
                let stockText = `Stock disponible: ${stockActual} unidades`;

                if (stockActual <= 5) {
                    stockClass = 'stock-low';
                    stockIcon = '‚ö†Ô∏è';
                    stockText = `Stock bajo: ${stockActual} unidades`;
                } else if (stockActual <= 15) {
                    stockClass = 'stock-medium';
                    stockIcon = 'üìä';
                    stockText = `Stock medio: ${stockActual} unidades`;
                }

                if (stockInfo) {
                    stockInfo.innerHTML = `<span class="${stockClass}">${stockIcon} ${stockText}</span>`;
                    stockInfo.style.display = 'block';
                }

                // Auto-completar precio unitario si est√° vac√≠o
                if (precioSugerido > 0 && (!precioInput.value || precioInput.value == '0')) {
                    precioInput.value = precioSugerido.toFixed(2);
                    calcularSubtotal(id);
                }

                // VALIDACI√ìN EN TIEMPO REAL: cantidad vs stock
                const cantidadActual = parseFloat(cantidadInput.value) || 0;
                validarCantidadVsStock(cantidadInput, cantidadActual, stockActual, stockInfo);

            } catch (error) {
                console.error('‚ùå Error en actualizaci√≥n tiempo real:', error);
                if (stockInfo) {
                    stockInfo.innerHTML = `<span class="stock-danger">‚ùå Error al verificar stock</span>`;
                    stockInfo.style.display = 'block';
                }
            }
        } else {
            if (productoInfo) productoInfo.style.display = 'none';
            if (stockInfo) stockInfo.style.display = 'none';
        }
    }

    async function validarStockEnTiempoReal(id) {
        const tarjeta = document.getElementById(`producto-card-${id}`);
        if (!tarjeta) return;

        const select = tarjeta.querySelector('.producto-select');
        const cantidadInput = tarjeta.querySelector('.cantidad');
        const stockInfo = document.getElementById(`stock-info-${id}`);

        if (select.value && cantidadInput.value) {
            try {
                const stockActual = await obtenerStockActual(select.value);
                const cantidadRequerida = parseFloat(cantidadInput.value) || 0;

                validarCantidadVsStock(cantidadInput, cantidadRequerida, stockActual, stockInfo);
            } catch (error) {
                console.error('‚ùå Error en validaci√≥n tiempo real:', error);
            }
        }
    }

    function validarCantidadVsStock(cantidadInput, cantidadRequerida, stockActual, stockInfo) {
        if (cantidadRequerida > stockActual) {
            cantidadInput.classList.add('is-invalid');
            if (stockInfo) {
                const currentContent = stockInfo.innerHTML.split('<br>')[0];
                stockInfo.innerHTML = currentContent + `<br><small class="text-danger">‚ö†Ô∏è Cantidad excede stock disponible</small>`;
            }
        } else {
            cantidadInput.classList.remove('is-invalid');
            if (stockInfo) {
                const currentContent = stockInfo.innerHTML.split('<br>')[0];
                stockInfo.innerHTML = currentContent;
            }
        }
    }

    // ============================================
    // FUNCIONES DE C√ÅLCULO
    // ============================================

    function calcularSubtotal(id) {
        const tarjeta = document.getElementById(`producto-card-${id}`);
        if (!tarjeta) return;

        const cantidad = parseFloat(tarjeta.querySelector('.cantidad').value) || 0;
        const precio = parseFloat(tarjeta.querySelector('.precio').value) || 0;
        const subtotal = cantidad * precio;

        const subtotalInput = tarjeta.querySelector('.subtotal');
        if (subtotalInput) {
            subtotalInput.value = subtotal.toFixed(2);
        }

        actualizarTotales();

        console.log(`üßÆ Subtotal producto ${id}: ${cantidad} x ${precio} = ${subtotal.toFixed(2)}`);
    }

    function actualizarTotales() {
        let totalVenta = 0;
        let totalProductos = 0;

        document.querySelectorAll('.product-card').forEach(producto => {
            const subtotalInput = producto.querySelector('.subtotal');
            if (subtotalInput) {
                const valor = parseFloat(subtotalInput.value) || 0;
                if (valor > 0) {
                    totalVenta += valor;
                    totalProductos++;
                }
            }
        });

        document.getElementById('total-venta').textContent = `C$ ${totalVenta.toFixed(2)}`;
        document.getElementById('subtotal').textContent = `C$ ${totalVenta.toFixed(2)}`;
        document.getElementById('total-productos').textContent = totalProductos;

        console.log(`üí∞ Total venta: C$ ${totalVenta.toFixed(2)}, Productos: ${totalProductos}`);
    }

    function actualizarMensajeProductos() {
        const tarjetas = document.querySelectorAll('.product-card').length;
        const mensaje = document.getElementById('no-products-message');
        const container = document.getElementById('productos-container');

        if (mensaje) {
            mensaje.style.display = tarjetas === 0 ? 'block' : 'none';
        }
        if (container) {
            container.style.display = tarjetas === 0 ? 'none' : 'block';
        }
    }

    // ============================================
    // FUNCIONES DE API
    // ============================================

    async function obtenerStockActual(idProducto) {
        try {
            const url = `/admin/ventas/verificar-stock/${idProducto}`;

            const response = await fetch(url);

            if (!response.ok) {
                throw new Error('Error al verificar stock');
            }

            const data = await response.json();

            if (data.error) {
                throw new Error(data.error);
            }

            console.log(`[STOCK] Stock en tiempo real: ${data.existencias} unidades`);
            return data.existencias;
        } catch (error) {
            console.error('‚ùå Error obteniendo stock en tiempo real:', error);
            return 0;
        }
    }

    async function verificarStockProductos() {
        const productosConProblemas = [];
        const tarjetas = document.querySelectorAll(".product-card");

        for (const tarjeta of tarjetas) {
            const select = tarjeta.querySelector(".producto-select");
            const cantidadInput = tarjeta.querySelector(".cantidad");

            if (select.value && cantidadInput.value) {
                const idProducto = select.value;
                const cantidadRequerida = parseFloat(cantidadInput.value);

                try {
                    const stockActual = await obtenerStockActual(idProducto);

                    if (stockActual < cantidadRequerida) {
                        const descripcion = select.options[select.selectedIndex].text;
                        productosConProblemas.push({
                            descripcion: descripcion,
                            stockActual: stockActual,
                            cantidadRequerida: cantidadRequerida
                        });
                    }
                } catch (error) {
                    console.error('‚ùå Error verificando stock final:', error);
                    productosConProblemas.push({
                        descripcion: select.options[select.selectedIndex].text,
                        stockActual: 0,
                        cantidadRequerida: cantidadRequerida,
                        error: true
                    });
                }
            }
        }

        return productosConProblemas;
    }

    // ============================================
    // FUNCIONES DE UTILIDAD
    // ============================================

    function mostrarAlerta(tipo, titulo, mensaje) {
        const alertasExistentes = document.querySelectorAll('.alert-flotante');
        alertasExistentes.forEach(alerta => alerta.remove());

        const alerta = document.createElement('div');
        alerta.className = `alert alert-${tipo} alert-dismissible fade show alert-flotante`;
        alerta.innerHTML = `
        <strong>${titulo}</strong> ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
        document.body.appendChild(alerta);

        setTimeout(() => {
            if (alerta.parentNode) {
                alerta.remove();
            }
        }, 5000);
    }

    function validarFechaVencimiento() {
        const tipoVenta = document.getElementById('tipo_venta').value;

        if (tipoVenta === 'credito') {
            const fechaVencimiento = document.getElementById('fecha_vencimiento').value;
            const hoy = new Date().toISOString().split('T')[0];

            if (!fechaVencimiento) {
                mostrarAlerta('warning', '‚ö†Ô∏è Fecha requerida', 'Para ventas a cr√©dito debe especificar una fecha de vencimiento');
                document.getElementById('fecha_vencimiento').focus();
                return false;
            }

            if (fechaVencimiento <= hoy) {
                mostrarAlerta('warning', '‚ö†Ô∏è Fecha inv√°lida', 'La fecha de vencimiento debe ser posterior a hoy');
                document.getElementById('fecha_vencimiento').focus();
                return false;
            }
        }
        return true;
    }

    // ============================================
    // VALIDACI√ìN Y ENV√çO DE FORMULARIO
    // ============================================

    function validarVentaBasica() {
        console.log('üîç Validando formulario...');
        let valido = true;

        const camposRequeridos = [
            { id: 'tipo_venta', nombre: 'Tipo de venta' }
        ];

        camposRequeridos.forEach(campo => {
            const elemento = document.getElementById(campo.id);
            if (!elemento.value) {
                elemento.classList.add("is-invalid");
                mostrarAlerta('warning', '‚ö†Ô∏è Campo requerido', `${campo.nombre} es obligatorio`);
                valido = false;
                console.log(`‚ùå Campo requerido vac√≠o: ${campo.nombre}`);
            } else {
                elemento.classList.remove("is-invalid");
            }
        });

        // Validar productos
        const tarjetas = document.querySelectorAll(".product-card");
        console.log(`üì¶ Productos en tarjetas: ${tarjetas.length}`);

        if (tarjetas.length === 0) {
            mostrarAlerta('danger', '‚ùå Error!', 'Debe agregar al menos un producto a la venta.');
            return false;
        }

        // Validar que haya al menos un producto con cantidad > 0
        let hayProductosValidos = false;
        tarjetas.forEach((tarjeta, index) => {
            const select = tarjeta.querySelector(".producto-select");
            const cantidad = tarjeta.querySelector(".cantidad");
            const precio = tarjeta.querySelector(".precio");

            const cantidadVal = parseFloat(cantidad.value) || 0;
            const precioVal = parseFloat(precio.value) || 0;

            if (select.value && cantidadVal > 0 && precioVal > 0) {
                hayProductosValidos = true;
                select.classList.remove("is-invalid");
                cantidad.classList.remove("is-invalid");
                precio.classList.remove("is-invalid");
                console.log(`‚úÖ Producto ${index + 1}: v√°lido`);
            } else {
                console.log(`‚ùå Producto ${index + 1}: inv√°lido`, {
                    select: select.value,
                    cantidad: cantidadVal,
                    precio: precioVal
                });
                if (!select.value) select.classList.add("is-invalid");
                if (cantidadVal <= 0) cantidad.classList.add("is-invalid");
                if (precioVal <= 0) precio.classList.add("is-invalid");
            }
        });

        if (!hayProductosValidos) {
            mostrarAlerta('danger', '‚ùå Error!', 'Debe agregar al menos un producto con cantidad y precio v√°lidos.');
            valido = false;
        }

        // Validaci√≥n espec√≠fica para cr√©dito
        const tipoVenta = document.getElementById('tipo_venta').value;
        const idCliente = document.getElementById('id_cliente').value;

        if (tipoVenta === 'credito' && !idCliente) {
            mostrarAlerta('warning', '‚ö†Ô∏è Cliente requerido', 'Para ventas a cr√©dito debe seleccionar un cliente');
            document.getElementById('id_cliente').classList.add('is-invalid');
            valido = false;
        }

        if (!valido) {
            const primerError = document.querySelector(".is-invalid");
            if (primerError) {
                primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        } else {
            console.log('‚úÖ Validaci√≥n exitosa');
        }

        return valido;
    }

    // ENVIAR FORMULARIO CON VALIDACI√ìN
    document.getElementById('formVenta').addEventListener('submit', async function (e) {
        e.preventDefault();
        console.log('üìù Enviando formulario...');

        // Validaci√≥n s√≠ncrona primero
        if (!validarVentaBasica()) {
            console.log('‚ùå Validaci√≥n fallida');
            return;
        }

        console.log('‚úÖ Validaci√≥n b√°sica exitosa, verificando stock...');

        // Luego validaci√≥n as√≠ncrona de stock EN TIEMPO REAL
        const esStockValido = await validarStockVenta();
        if (!esStockValido) {
            console.log('‚ùå Validaci√≥n de stock fallida');
            return;
        }

        console.log('‚úÖ Validaci√≥n de stock exitosa, mostrando confirmaci√≥n...');

        // Mostrar modal de confirmaci√≥n
        mostrarModalConfirmacion();
    });

    async function validarStockVenta() {
        const productosConProblemas = await verificarStockProductos();

        if (productosConProblemas.length > 0) {
            const productosError = productosConProblemas.map(p =>
                `${p.descripcion} (Stock: ${p.stockActual}, Requerido: ${p.cantidadRequerida})`
            ).join(', ');

            mostrarAlerta('danger', '‚ùå Stock Insuficiente!',
                `Los siguientes productos no tienen suficiente stock: ${productosError}`);
            return false;
        }

        return true;
    }

    function procesarVenta() {
        const formData = new FormData();

        // Agregar campos EXACTAMENTE como los espera el backend
        formData.append('id_cliente', document.getElementById('id_cliente').value);
        formData.append('tipo_venta', document.getElementById('tipo_venta').value);
        formData.append('observacion', document.getElementById('observacion').value);

        // Agregar fecha de vencimiento si es cr√©dito
        if (document.getElementById('tipo_venta').value === 'credito') {
            const fechaVencimiento = document.getElementById('fecha_vencimiento').value;
            if (fechaVencimiento) {
                formData.append('fecha_vencimiento', fechaVencimiento);
            }
        }

        // Campos de productos - CORREGIR los nombres exactos que espera el backend
        const productoElements = document.querySelectorAll('.product-card');
        let productosValidos = 0;

        productoElements.forEach((item) => {
            const select = item.querySelector('.producto-select');
            const cantidad = item.querySelector('.cantidad');
            const precio = item.querySelector('.precio');

            if (select.value && cantidad.value && precio.value && parseFloat(cantidad.value) > 0) {
                formData.append('producto_id[]', select.value);
                formData.append('cantidad[]', parseFloat(cantidad.value).toFixed(2));
                formData.append('precio[]', parseFloat(precio.value).toFixed(2));

                productosValidos++;

                console.log(`Producto ${productosValidos}: ID=${select.value}, Cantidad=${cantidad.value}, Precio=${precio.value}`);
            }
        });

        // Validaciones cr√≠ticas
        if (productosValidos === 0) {
            mostrarAlerta('danger', '‚ùå Error!', 'Debe agregar al menos un producto v√°lido');
            return;
        }

        const tipoVenta = document.getElementById('tipo_venta').value;
        const idCliente = document.getElementById('id_cliente').value;

        if (tipoVenta === 'credito' && !idCliente) {
            mostrarAlerta('danger', '‚ùå Error!', 'Para ventas a cr√©dito debe seleccionar un cliente');
            document.getElementById('id_cliente').focus();
            return;
        }

        // Mostrar loading
        const submitBtn = document.querySelector('#formVenta button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Procesando...';
        submitBtn.disabled = true;

        console.log('üì® Enviando datos de venta al servidor...');

        // Enviar datos al endpoint CORRECTO
        fetch("{{ url_for('admin_crear_venta') }}", {
            method: 'POST',
            body: formData
        })
            .then(response => {
                console.log('üì® Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                return response.json();
            })
            .then(resultado => {
                console.log('üìä Resultado del servidor:', resultado);

                if (resultado.success) {
                    // Mostrar mensaje de √©xito
                    mostrarAlerta('success', '‚úÖ Venta Exitosa!', `La venta #${resultado.venta_id || 'N/A'} ha sido registrada correctamente.`);

                    // Limpiar formulario
                    document.getElementById('formVenta').reset();
                    document.getElementById('productos-container').innerHTML = '';
                    document.getElementById('fecha_vencimiento_group').style.display = 'none';
                    document.getElementById('fecha_vencimiento').value = '';

                    // Agregar una nueva fila de producto
                    agregarProducto();

                    // Actualizar totales
                    actualizarTotales();

                    // Redirigir o recargar despu√©s de 2 segundos
                    setTimeout(() => {
                        if (resultado.redirect_url) {
                            window.location.href = resultado.redirect_url;
                        } else {
                            location.reload();
                        }
                    }, 2000);

                } else {
                    throw new Error(resultado.error || 'Error desconocido del servidor');
                }
            })
            .catch(error => {
                console.error('‚ùå Error completo:', error);
                mostrarAlerta('danger', '‚ùå Error!', error.message || 'Error al procesar la venta');
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
    }
</script>
{% endblock %}