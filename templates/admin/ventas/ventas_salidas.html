{% extends "layout.html" %}
{% block title %}Gestión de Ventas - Salidas{% endblock %}
{% block content %}
<div class="container-fluid px-lg-4 px-md-3 px-2">
    <!-- Header -->
    <div class="d-flex flex-column flex-md-row align-items-center justify-content-between mb-4 pt-3">
        <div class="mb-3 mb-md-0">
            <h1 class="h2 fw-bold text-gradient-primary mb-2">Gestión de Ventas</h1>
            <p class="text-muted mb-0"><i class="fas fa-chart-line me-2 text-primary"></i>Control de salidas e inventario</p>
        </div>
        <a href="{{ url_for('admin_crear_venta') }}" class="btn btn-primary btn-lg shadow-lg hover-lift">
            <i class="fas fa-plus-circle me-2"></i>Nueva Venta
        </a>
    </div>

    <!-- Estadísticas -->
    <div class="row mb-4 g-3">
        {% macro stat_card(color, title, value, subtitle, icon) %}
        <div class="col-xl-3 col-md-6">
            <div class="card card-statistic gradient-{{ color }} shadow-sm border-0 rounded-3 h-100">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-80 mb-1">{{ title }}</h6>
                            <h2 class="fw-bold text-black mb-0">{{ value }}</h2>
                            <p class="text-white-60 mb-0 small">{{ subtitle }}</p>
                        </div>
                        <div class="statistic-icon">
                            <i class="fas fa-{{ icon }} fa-2x text-white-60"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endmacro %}
        
        {{ stat_card('primary', 'Total Ventas', total_ventas, 'Registros totales', 'shopping-cart') }}
        {{ stat_card('success', 'Ventas Contado', ventas_contado, 'Transacciones inmediatas', 'money-bill-wave') }}
        {{ stat_card('warning', 'Ventas Crédito', ventas_credito, 'Financiamientos activos', 'credit-card') }}
        {{ stat_card('info', 'Monto Total', 'C$' ~ "{:,.2f}".format(monto_total), 'Capital transado', 'chart-bar') }}
    </div>

    <!-- Mensajes Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-dismissible fade show alert-{{ 'danger' if category == 'error' else 'success' }} shadow-sm border-0 mb-4">
                <div class="d-flex align-items-center">
                    <div class="alert-icon me-3">
                        <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} fa-lg"></i>
                    </div>
                    <div class="flex-grow-1">{{ message|safe }}</div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Tabla de Ventas -->
    <div class="card shadow-lg border-0 rounded-3 overflow-hidden mb-4">
        <div class="card-header bg-white border-0 pt-4 pb-3 px-4">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center">
                <div class="mb-3 mb-lg-0">
                    <h5 class="card-title fw-bold mb-1 text-dark"><i class="fas fa-receipt me-2 text-primary"></i>Registro de Ventas</h5>
                    <p class="text-muted small mb-0">Gestión completa de transacciones</p>
                </div>
                <div class="d-flex flex-wrap gap-2">
                    <div class="search-box">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light border-0"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" class="form-control border-0 bg-light" id="searchInput" placeholder="Buscar...">
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-download me-1"></i> Exportar
                        </button>
                        <ul class="dropdown-menu shadow">
                            <li><a class="dropdown-item" href="#" id="exportExcel"><i class="fas fa-file-excel text-success me-2"></i>Excel</a></li>
                            <li><a class="dropdown-item" href="#" id="printTableBtn"><i class="fas fa-print text-info me-2"></i>Imprimir</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Filtros -->
            <div class="row g-2 mt-3">
                <div class="col-md-4">
                    <select class="form-select form-select-sm" id="estadoFilter">
                        <option value="">Todos los estados</option>
                        <option value="ACTIVA">Activas</option>
                        <option value="ANULADA">Anuladas</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <select class="form-select form-select-sm" id="tipoVentaFilter">
                        <option value="">Todos los tipos</option>
                        <option value="CONTADO">Contado</option>
                        <option value="CRÉDITO">Crédito</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-sm btn-outline-secondary w-100" id="clearFiltersBtn">
                        <i class="fas fa-filter-circle-xmark me-1"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive-lg">
                <table class="table table-hover align-middle mb-0" id="dataTable">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Fecha</th>
                            <th>Cliente</th>
                            <th class="d-none d-md-table-cell">Identificación</th>
                            <th class="text-center">Tipo</th>
                            <th class="d-none d-lg-table-cell">Bodega</th>
                            <th class="text-center">Productos</th>
                            <th class="text-end">Total</th>
                            <th class="d-none d-xl-table-cell">Vendedor</th>
                            <th class="text-center">Estado</th>
                            <th class="text-end pe-2 pe-md-4">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for venta in ventas %}
                        <tr class="{{ 'table-inactive' if venta.Estado_Formateado == 'ANULADA' }}">
                            <td class="ps-4" data-label="Fecha">
                                <div class="date-cell">
                                    <div class="fw-medium">{{ venta.Fecha.strftime('%d/%m/%Y') if venta.Fecha else 'N/A' }}</div>
                                    <small class="text-muted">{{ venta.Fecha.strftime('%H:%M') if venta.Fecha else '' }}</small>
                                </div>
                            </td>
                            <td data-label="Cliente">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3">
                                        <i class="fas fa-user text-primary fs-6"></i>
                                    </div>
                                    <div>
                                        <div class="fw-semibold">{{ venta.Cliente or 'Consumidor Final' }}</div>
                                        <small class="text-muted d-md-none">{{ venta.RUC_Cliente or 'N/A' }}</small>
                                    </div>
                                </div>
                            </td>
                            <td class="d-none d-md-table-cell" data-label="Identificación">
                                <code class="text-muted">{{ venta.RUC_Cliente or 'N/A' }}</code>
                            </td>
                            <td class="text-center" data-label="Tipo">
                                {% set tipo = venta.Tipo_Venta_Formateado or 'CONTADO' %}
                                <span class="badge badge-pill {{ 'bg-success bg-opacity-10 text-success border border-success border-opacity-25' if tipo == 'CONTADO' else 'bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25' }} py-2 px-3">
                                    <i class="fas fa-{{ 'money-bill-wave' if tipo == 'CONTADO' else 'credit-card' }} me-1"></i>{{ tipo }}
                                </span>
                            </td>
                            <td class="d-none d-lg-table-cell" data-label="Bodega">
                                <span class="badge bg-secondary bg-opacity-10 text-dark border border-secondary border-opacity-25 py-2">{{ venta.Bodega or 'N/A' }}</span>
                            </td>
                            <td class="text-center" data-label="Productos">
                                <span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 py-2 px-3">
                                    <i class="fas fa-boxes me-1"></i>{{ venta.Total_Productos or 0 }}
                                </span>
                            </td>
                            <td class="text-end fw-bold text-success" data-label="Total">
                                C${{ "{:,.2f}".format(venta.Total_Venta or 0) }}
                            </td>
                            <td class="d-none d-xl-table-cell" data-label="Vendedor">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-xs bg-light rounded-circle d-flex align-items-center justify-content-center me-2">
                                        <i class="fas fa-user-tie text-muted fs-7"></i>
                                    </div>
                                    <span class="text-muted">{{ venta.Usuario_Creacion or 'Sistema' }}</span>
                                </div>
                            </td>
                            <td class="text-center" data-label="Estado">
                                {% set estado = venta.Estado_Formateado or 'PENDIENTE' %}
                                <span class="badge badge-pill py-2 px-3
                                    {% if estado == 'ACTIVA' %}bg-success bg-opacity-10 text-success border border-success border-opacity-25
                                    {% elif estado == 'ANULADA' %}bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25
                                    {% else %}bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25{% endif %}">
                                    <i class="fas fa-{{ 'check-circle' if estado == 'ACTIVA' else 'ban' if estado == 'ANULADA' else 'clock' }} me-1"></i>{{ estado }}
                                </span>
                            </td>
                            <td class="text-end pe-2 pe-md-4" data-label="Acciones">
                                <!-- Versión Desktop -->
                                <div class="btn-group btn-group-sm d-none d-lg-flex flex-nowrap" role="group">
                                    <a href="{{ url_for('admin_generar_ticket', id_factura=venta.ID_Factura) }}" 
                                       class="btn btn-outline-info btn-action px-3" 
                                       title="Ver ticket" 
                                       target="_blank">
                                        <i class="fas fa-receipt"></i>
                                        <span class="d-none d-xl-inline ms-1">Ticket</span>
                                    </a>
                                    <a href="{{ url_for('admin_detalles_venta', id_factura=venta.ID_Factura) }}" 
                                       class="btn btn-outline-primary btn-action px-3" 
                                       title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                        <span class="d-none d-xl-inline ms-1">Detalles</span>
                                    </a>
                                    {% if venta.Estado_Formateado == 'ACTIVA' %}
                                    <button type="button" 
                                            class="btn btn-outline-danger btn-action px-3 btn-anular-venta" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#anularVentaModal" 
                                            data-id="{{ venta.ID_Factura }}">
                                        <i class="fas fa-ban"></i>
                                        <span class="d-none d-xl-inline ms-1">Anular</span>
                                    </button>
                                    {% else %}
                                    <button class="btn btn-outline-secondary btn-action px-3" disabled title="Anulada">
                                        <i class="fas fa-lock"></i>
                                        <span class="d-none d-xl-inline ms-1">Bloqueado</span>
                                    </button>
                                    {% endif %}
                                </div>
                                
                                <!-- Versión Móvil Mejorada -->
                                <div class="d-flex d-lg-none gap-2" role="group">
                                    <a href="{{ url_for('admin_generar_ticket', id_factura=venta.ID_Factura) }}" 
                                       class="btn btn-outline-info btn-action-mobile flex-fill"
                                       target="_blank">
                                        <i class="fas fa-receipt"></i>
                                        <span class="ms-1">Ticket</span>
                                    </a>
                                    {% if venta.Estado_Formateado == 'ACTIVA' %}
                                    <button type="button" 
                                            class="btn btn-outline-danger btn-action-mobile flex-fill btn-anular-venta" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#anularVentaModal" 
                                            data-id="{{ venta.ID_Factura }}">
                                        <i class="fas fa-ban"></i>
                                        <span class="ms-1">Anular</span>
                                    </button>
                                    {% else %}
                                    <button class="btn btn-outline-secondary btn-action-mobile flex-fill" disabled>
                                        <i class="fas fa-lock"></i>
                                        <span class="ms-1">Bloqueado</span>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="10" class="text-center py-5">
                                <div class="empty-state">
                                    <i class="fas fa-inbox fa-3x text-muted opacity-50 mb-3"></i>
                                    <h5 class="text-muted mb-2">No hay ventas registradas</h5>
                                    <p class="text-muted small mb-4">Comience creando su primera venta</p>
                                    <a href="{{ url_for('admin_crear_venta') }}" class="btn btn-primary">
                                        <i class="fas fa-plus me-2"></i>Crear Venta
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Anulación de Venta -->
<div class="modal fade" id="anularVentaModal" tabindex="-1" aria-labelledby="anularVentaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="anularVentaModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirmar Anulación de Venta
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Loading State -->
            <div id="modalLoading" class="modal-body text-center py-5">
                <div class="spinner-border text-danger mb-3" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <h6 class="text-muted">Cargando información detallada de la venta...</h6>
                <p class="text-muted small mt-2">Por favor espere un momento</p>
            </div>

            <!-- Error State -->
            <div id="modalError" class="modal-body text-center py-5" style="display: none;">
                <div class="mb-3">
                    <i class="fas fa-times-circle fa-3x text-danger"></i>
                </div>
                <h6 class="text-danger" id="errorTitle">Error al cargar la venta</h6>
                <p class="text-muted small mt-2" id="errorMessage">Ha ocurrido un error</p>
                <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cerrar
                </button>
            </div>

            <!-- Content Container -->
            <div id="modalContent" style="display: none;">
                <form id="formAnularVenta" method="POST" action="">
                    {% if csrf_token %}
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    {% endif %}
                    <input type="hidden" id="idFactura" name="id_factura" value="">
                    
                    <div class="modal-body">
                        <!-- Alerta de advertencia -->
                        <div class="alert alert-warning border-warning mb-4">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-circle fa-2x text-warning"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="alert-heading fw-bold mb-1">
                                        ¿Está seguro de anular la venta <span id="modalVentaId" class="text-danger fw-bold">#</span>?
                                    </h6>
                                    <p class="mb-0 small">Esta acción es irreversible y reversará las existencias en inventario.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Detalles de la venta -->
                        <div class="card border-0 bg-light mb-4">
                            <div class="card-body">
                                <h6 class="fw-bold text-dark mb-3">
                                    <i class="fas fa-info-circle me-2 text-primary"></i>
                                    Detalles de la Venta
                                    <span id="ventaStatusBadge" class="badge bg-success ms-2">Activa</span>
                                    <span id="tipoVentaBadge" class="badge bg-success ms-1">CONTADO</span>
                                </h6>

                                <!-- Detalles básicos en formato de grid similar a compras -->
                                <div class="row mb-3" id="ventaBasicDetails">
                                    <!-- Se llenará con JavaScript -->
                                </div>

                                <!-- Información de crédito -->
                                <div id="creditoInfo" class="mb-3 p-3 bg-warning bg-opacity-10 rounded" style="display: none;">
                                    <h6 class="fw-bold text-warning mb-2">
                                        <i class="fas fa-credit-card me-2"></i>Información de Crédito
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <small class="text-muted d-block">Estado de Cuenta:</small>
                                            <span id="estadoCuenta" class="badge bg-warning">Pendiente</span>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted d-block">Saldo Pendiente:</small>
                                            <span id="saldoPendiente" class="fw-bold text-danger">C$0.00</span>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Al anular, esta cuenta por cobrar también será cancelada automáticamente.
                                        </small>
                                    </div>
                                </div>

                                <!-- Tabla de productos -->
                                <div class="mt-4">
                                    <h6 class="fw-bold text-dark mb-2">
                                        <i class="fas fa-boxes me-2 text-primary"></i>
                                        Productos Vendidos <small class="text-muted" id="totalProductosCount">(0 productos)</small>
                                    </h6>

                                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                        <table class="table table-sm table-hover mb-0" id="productosTable">
                                            <thead class="table-light sticky-top">
                                                <tr>
                                                    <th>#</th>
                                                    <th>Código</th>
                                                    <th>Descripción</th>
                                                    <th class="text-center">Cantidad</th>
                                                    <th class="text-center">Unidad</th>
                                                    <th class="text-end">Precio Unitario</th>
                                                    <th class="text-end">Subtotal</th>
                                                </tr>
                                            </thead>
                                            <tbody id="productosTableBody">
                                                <!-- Se llenará con JavaScript -->
                                            </tbody>
                                            <tfoot class="table-light">
                                                <tr>
                                                    <td colspan="3" class="text-end fw-bold">Totales:</td>
                                                    <td class="text-center fw-bold" id="totalCantidad">0</td>
                                                    <td></td>
                                                    <td></td>
                                                    <td class="text-end fw-bold text-success" id="totalVentaModal">C$0.00</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Campo de motivo -->
                        <div class="mb-3">
                            <label for="motivoAnulacion" class="form-label fw-semibold">
                                <i class="fas fa-comment-dots me-2 text-primary"></i>
                                Motivo de Anulación <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="motivoAnulacion" name="motivo_anulacion" rows="3"
                                placeholder="Ingrese el motivo de la anulación..." required maxlength="500"></textarea>
                            <div id="charCounter" class="form-text text-end">
                                <span id="charCount">0</span>/500 caracteres
                            </div>
                        </div>

                        <!-- Checkbox de confirmación -->
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="confirmarAnulacion" required>
                            <label class="form-check-label fw-semibold" for="confirmarAnulacion">
                                Confirmo que deseo anular esta venta y entiendo que esta acción no se puede deshacer
                            </label>
                        </div>
                    </div>

                    <div class="modal-footer border-0 bg-light">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-danger" id="btnConfirmarAnulacion" disabled>
                            <i class="fas fa-ban me-2"></i>Cargando...
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Estilos CSS -->
<style>
:root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    --warning-gradient: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
    --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.gradient-primary { background: var(--primary-gradient) !important; }
.gradient-success { background: var(--success-gradient) !important; }
.gradient-warning { background: var(--warning-gradient) !important; }
.gradient-info { background: var(--info-gradient) !important; }

.text-gradient-primary { 
    background: var(--primary-gradient); 
    -webkit-background-clip: text; 
    -webkit-text-fill-color: transparent; 
    background-clip: text;
}

.card-statistic { 
    transition: transform 0.3s ease, box-shadow 0.3s ease; 
    border: none !important; 
    color: white !important;
}

.card-statistic:hover { 
    transform: translateY(-5px); 
    box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important; 
}

.card-statistic h2,
.card-statistic h6,
.card-statistic p {
    color: white !important;
}

.card-statistic .text-white-80 { opacity: 0.8; }
.card-statistic .text-white-60 { opacity: 0.6; }

.table thead th { 
    border-bottom: 2px solid #e9ecef; 
    font-weight: 600; 
    font-size: 0.8rem; 
    letter-spacing: 0.5px; 
    text-transform: uppercase;
    background-color: #f8f9fa;
}

.table tbody td { 
    border-bottom: 1px solid #f1f3f5; 
    vertical-align: middle;
}

.table-hover tbody tr:hover { 
    background-color: rgba(102, 126, 234, 0.04); 
}

.table-inactive { 
    opacity: 0.6; 
    background-color: #f8f9fa;
}

.table-inactive:hover { 
    opacity: 0.8; 
    background-color: #f1f3f5;
}

.avatar-xs { 
    width: 24px; 
    height: 24px; 
}

.avatar-sm { 
    width: 36px; 
    height: 36px; 
}

.search-box .input-group { 
    border-radius: 8px; 
    overflow: hidden; 
    background: #f8f9fa; 
    border: 1px solid #dee2e6;
}

.search-box .form-control { 
    background: transparent; 
    border: none; 
    min-width: 250px; 
    box-shadow: none !important;
}

.search-box .form-control:focus {
    background: transparent;
}

.hover-lift { 
    transition: transform 0.2s ease, box-shadow 0.2s ease; 
}

.hover-lift:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 5px 15px rgba(0,0,0,0.1) !important;
}

.btn-action, .btn-action-mobile {
    transition: all 0.2s ease;
}

.btn-action:hover, .btn-action-mobile:hover {
    transform: translateY(-1px);
}

.empty-state {
    padding: 2rem;
}

.empty-state i {
    opacity: 0.5;
}

.modal-content {
    border-radius: 12px;
    overflow: hidden;
}

.modal-header {
    border-bottom: none;
    padding: 1.25rem 1.5rem;
}

.modal-body {
    padding: 0;
}

.modal-footer {
    border-top: 1px solid #e9ecef;
}

#productosTable tbody tr:last-child {
    border-bottom: none;
}

#productosTable tbody td {
    padding: 0.5rem 0.75rem;
}

.sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
}

/* Container mejorado para móviles */
.container-fluid {
    padding-left: max(1rem, env(safe-area-inset-left));
    padding-right: max(1rem, env(safe-area-inset-right));
}

/* Mejoras específicas para touch devices */
.touch-device .btn,
.touch-device .btn-action,
.touch-device .btn-action-mobile {
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
}

.touch-device .table-hover tbody tr {
    cursor: pointer;
}

.touch-device .form-control:focus,
.touch-device .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
}

/* Prevenir desbordamientos en móviles */
@media (max-width: 768px) {
    * {
        max-width: 100vw;
        overflow-wrap: break-word;
    }
    
    .modal-open {
        overflow: hidden;
        position: fixed;
        width: 100%;
    }
}

/* Responsive Table - Mejorado */
@media (max-width: 768px) {
    .table-responsive-lg {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -1rem;
        padding: 0 1rem;
    }
    
    .table {
        min-width: 700px;
    }
    
    /* Ocultar columnas menos importantes en móvil */
    .table thead th.d-none,
    .table tbody td.d-none {
        display: none !important;
    }
    
    /* Mejora en visualización de celdas */
    .table tbody td {
        padding: 0.75rem 0.5rem;
        font-size: 0.875rem;
    }
    
    /* Estado más compacto en móvil */
    .badge {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
    
    /* Ajuste en botones de acción móviles */
    .btn-action-mobile {
        font-size: 0.75rem;
        padding: 0.375rem 0.5rem;
        min-height: 44px;
    }
    
    .btn-action-mobile .ms-1 {
        margin-left: 0.25rem !important;
    }
    
    /* Header responsive mejorado */
    .d-flex.flex-column.flex-md-row {
        padding-top: 0.5rem !important;
    }
    
    h1.h2 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem !important;
    }
    
    .btn-lg {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        min-height: 44px;
    }
    
    /* Estadísticas en grid vertical en móvil */
    .row.g-3 {
        gap: 0.75rem !important;
    }
    
    .col-xl-3.col-md-6 {
        width: 100% !important;
    }
    
    .card-statistic .card-body {
        padding: 1rem !important;
    }
    
    /* Filtros en columna única */
    .row.g-2.mt-3 .col-md-4 {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    /* Search box más compacta */
    .search-box .form-control {
        min-width: unset;
        width: 100%;
    }
    
    /* Mejorar legibilidad en móviles */
    body {
        -webkit-text-size-adjust: 100%;
        text-size-adjust: 100%;
    }
    
    .fw-bold, .fw-semibold {
        font-weight: 600 !important;
    }
    
    .text-muted {
        opacity: 0.8;
    }
}

/* Para tablets */
@media (max-width: 992px) and (min-width: 769px) {
    .table tbody td {
        font-size: 0.9rem;
        padding: 0.5rem;
    }
    
    /* Ocultar columnas menos críticas en tablet */
    .d-xl-table-cell {
        display: none !important;
    }
    
    /* Ajustes para botones en tablet */
    .btn-action {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }
}

/* Modal Responsive */
@media (max-width: 768px) {
    .modal-dialog {
        margin: 0.5rem;
        max-width: calc(100vw - 1rem);
    }
    
    .modal-dialog.modal-lg {
        max-height: 85vh;
    }
    
    .modal-content {
        border-radius: 8px;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal-body {
        padding: 1rem !important;
    }
    
    /* Tabla de productos en modal móvil */
    #productosTable {
        font-size: 0.75rem;
    }
    
    #productosTable th,
    #productosTable td {
        padding: 0.25rem 0.375rem;
    }
    
    /* Grid responsive en detalles */
    #ventaBasicDetails .col-md-6 {
        margin-bottom: 0.5rem !important;
    }
    
    /* Textarea más compacta */
    #motivoAnulacion {
        font-size: 0.875rem;
        min-height: 80px;
    }
    
    /* Botones del footer */
    .modal-footer {
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0.75rem !important;
    }
    
    .modal-footer .btn {
        flex: 1;
        min-width: 120px;
        font-size: 0.875rem;
        padding: 0.5rem;
        min-height: 44px;
    }
    
    .modal-header {
        padding: 1rem !important;
    }
    
    .modal-title {
        font-size: 1rem;
    }
}

/* Para tablets medianas */
@media (max-width: 992px) and (min-width: 769px) {
    .modal-dialog.modal-lg {
        max-width: 90%;
        margin: 1rem auto;
    }
}
</style>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // ==================== VARIABLES GLOBALES ====================
    let currentVentaId = null;
    let ventaData = null;

    // ==================== MEJORAS PARA TOUCH DEVICES ====================
    
    // Inicializar mejoras para dispositivos táctiles
    function inicializarMejorasTouch() {
        // Detectar dispositivos táctiles
        if ('ontouchstart' in window || navigator.maxTouchPoints) {
            document.body.classList.add('touch-device');
            
            // Mejorar feedback táctil en botones
            document.querySelectorAll('.btn, .btn-action, .btn-action-mobile').forEach(btn => {
                btn.style.minHeight = '44px';
                btn.style.minWidth = '44px';
            });
            
            // Aumentar área táctil en elementos pequeños
            document.querySelectorAll('.form-check-input, .btn-close').forEach(el => {
                el.style.minHeight = '44px';
                el.style.minWidth = '44px';
                el.style.padding = '12px';
            });
        }
        
        // Prevenir zoom en inputs (solo móviles)
        if ('ontouchstart' in window) {
            document.querySelectorAll('input, select, textarea').forEach(input => {
                input.addEventListener('focus', function() {
                    this.style.fontSize = '16px'; // Prevenir zoom en iOS
                });
                
                input.addEventListener('blur', function() {
                    this.style.fontSize = '';
                });
            });
        }
        
        // Scroll suave para móviles
        if ('ontouchstart' in window) {
            document.querySelectorAll('.table-responsive-lg').forEach(container => {
                container.style.webkitOverflowScrolling = 'touch';
            });
        }
    }
    
    // Optimizar modal para teclado virtual
    function optimizarModalParaTecladoVirtual() {
        const modal = document.getElementById('anularVentaModal');
        if (modal && 'ontouchstart' in window) {
            modal.addEventListener('shown.bs.modal', function() {
                const textarea = document.getElementById('motivoAnulacion');
                if (textarea) {
                    setTimeout(() => {
                        textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                }
            });
        }
    }
    
    // Detectar orientación y ajustar
    function ajustarPorOrientacion() {
        const esVertical = window.innerHeight > window.innerWidth;
        
        if (esVertical && window.innerWidth < 768) {
            // Optimizar para vertical en móviles
            document.querySelectorAll('.modal-dialog').forEach(dialog => {
                dialog.style.maxHeight = '80vh';
            });
        }
    }
    
    // Optimizar modal para móviles
    function optimizarModalMovil() {
        const modal = document.getElementById('anularVentaModal');
        
        if (!modal) return;
        
        modal.addEventListener('show.bs.modal', function() {
            if (window.innerWidth < 768) {
                // Ajustar altura máxima
                const dialog = this.querySelector('.modal-dialog');
                if (dialog) dialog.style.maxHeight = '85vh';
                
                // Forzar redibujado para evitar problemas de renderizado
                setTimeout(() => {
                    const content = this.querySelector('.modal-content');
                    if (content) content.style.transform = 'translateZ(0)';
                }, 10);
            }
        });
        
        // Ajustar scroll cuando se abre el modal
        modal.addEventListener('shown.bs.modal', function() {
            if (window.innerWidth < 768) {
                // Enfocar el primer campo si es posible
                const textarea = this.querySelector('#motivoAnulacion');
                if (textarea && !document.querySelector('.modal-backdrop')) {
                    setTimeout(() => {
                        textarea.focus();
                    }, 500);
                }
            }
        });
    }

    // ==================== FUNCIONES AUXILIARES ====================
    
    // Función segura para establecer texto
    function safeSetText(elementId, text) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = text;
        }
    }

    // Función segura para mostrar/ocultar elementos
    function safeDisplay(elementId, displayStyle) {
        const element = document.getElementById(elementId);
        if (element) {
            element.style.display = displayStyle;
        }
    }

    // Función para formatear números
    function formatNumber(num, decimals = 2) {
        return parseFloat(num || 0).toLocaleString('es-NI', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }

    // Función para formatear moneda
    function formatCurrency(amount) {
        return `C$${formatNumber(amount)}`;
    }

    // Función para obtener clase CSS según estado
    function getBadgeClassForEstado(estado) {
        switch(estado) {
            case 'Activa': return 'badge bg-success';
            case 'Anulada': return 'badge bg-danger';
            case 'Pagada': return 'badge bg-success';
            case 'Pendiente': return 'badge bg-warning';
            default: return 'badge bg-secondary';
        }
    }

    // Función para limpiar y validar la unidad
    function limpiarUnidad(unidad) {
        if (!unidad) return '';
        
        unidad = unidad.toString().trim();
        
        // Lista de valores inválidos comunes
        const valoresInvalidos = ['7', '0', 'null', 'undefined', 'nan'];
        
        if (valoresInvalidos.includes(unidad.toLowerCase())) {
            return '';
        }
        
        // Si es un número, probablemente es un error
        if (!isNaN(unidad) && unidad !== '') {
            console.warn(`Unidad numérica inválida: ${unidad}`);
            return '';
        }
        
        return unidad;
    }

    // ==================== MANEJO DEL MODAL ====================
    
    // Referencias al modal
    const anularModal = document.getElementById('anularVentaModal');

    // Evento cuando se abre el modal
    if (anularModal) {
        anularModal.addEventListener('show.bs.modal', async function (e) {
            const btn = e.relatedTarget;
            currentVentaId = btn.dataset.id;

            // Mostrar loading
            showModalLoading();

            try {
                // Obtener datos detallados de la venta
                const response = await fetch(`/admin/ventas/anular/${currentVentaId}`);

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Error al cargar datos de la venta');
                }

                ventaData = data.venta;

                // Validar que se cargaron los productos
                if (!ventaData.productos) {
                    throw new Error('No se pudieron cargar los productos de la venta');
                }

                // Validar que la venta esté activa
                if (ventaData.estado !== 'Activa') {
                    throw new Error(`Esta venta ya está ${ventaData.estado.toLowerCase()}. No se puede anular.`);
                }

                // Mostrar contenido con datos
                showModalContent();
                loadDetailedVentaData(ventaData);

            } catch (error) {
                console.error('Error al cargar datos detallados:', error);
                showModalError(error.message || 'Error desconocido al cargar la información');
            }
        });

        // Cuando se cierra el modal
        anularModal.addEventListener('hidden.bs.modal', function () {
            resetModal();
            currentVentaId = null;
            ventaData = null;
        });
    }

    // ==================== FUNCIONES DEL MODAL ====================
    
    // Función para mostrar loading
    function showModalLoading() {
        safeDisplay('modalLoading', 'block');
        safeDisplay('modalContent', 'none');
        safeDisplay('modalError', 'none');
        
        const btn = document.getElementById('btnConfirmarAnulacion');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-ban me-2"></i> Cargando...`;
        }
    }

    // Función para mostrar contenido
    function showModalContent() {
        safeDisplay('modalLoading', 'none');
        safeDisplay('modalContent', 'block');
        safeDisplay('modalError', 'none');
    }

    // Función para mostrar error
    function showModalError(errorMessage) {
        safeDisplay('modalLoading', 'none');
        safeDisplay('modalContent', 'none');
        safeDisplay('modalError', 'block');
        safeSetText('errorTitle', 'Error al cargar la venta');
        safeSetText('errorMessage', errorMessage || 'Ha ocurrido un error');
    }

    // Función para cargar datos detallados de la venta
    function loadDetailedVentaData(venta) {
        // Validación crítica
        if (!venta.productos || !Array.isArray(venta.productos)) {
            showModalError('Error: No se pudieron cargar los productos de la venta');
            return;
        }

        // 1. Actualizar ID
        safeSetText('modalVentaId', `#${venta.id_factura}`);

        // 2. Actualizar estado
        const estadoBadge = document.getElementById('ventaStatusBadge');
        if (estadoBadge) {
            estadoBadge.textContent = venta.estado || 'Activa';
            estadoBadge.className = getBadgeClassForEstado(venta.estado) + ' ms-2';
        }

        // 3. Actualizar tipo de venta
        const tipoBadge = document.getElementById('tipoVentaBadge');
        if (tipoBadge) {
            tipoBadge.textContent = venta.tipo_venta || 'CONTADO';
            if (venta.tipo_venta === 'CONTADO') {
                tipoBadge.className = 'badge bg-success ms-1';
            } else if (venta.tipo_venta === 'CRÉDITO') {
                tipoBadge.className = 'badge bg-warning ms-1';
            }
        }

        // 4. Actualizar detalles básicos en formato grid
        const detailsContainer = document.getElementById('ventaBasicDetails');
        if (detailsContainer) {
            // Obtener fecha y hora formateadas
            const fechaMostrar = venta.fecha_corta || '--/--/--';
            const horaMostrar = venta.hora || '--:--';
            
            const detailsHtml = `
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">Cliente</label>
                    <div class="form-control-plaintext fw-bold">
                        <i class="fas fa-user text-primary me-2"></i>
                        ${venta.cliente || 'Consumidor Final'}
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">RUC/Cédula</label>
                    <div class="form-control-plaintext">
                        <i class="fas fa-id-card text-secondary me-2"></i>
                        ${venta.cliente_ruc || 'N/A'}
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">Fecha</label>
                    <div class="form-control-plaintext">
                        <i class="fas fa-calendar text-info me-2"></i>
                        ${fechaMostrar}
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">Hora</label>
                    <div class="form-control-plaintext">
                        <i class="fas fa-clock text-info me-2"></i>
                        ${horaMostrar}
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">Vendedor</label>
                    <div class="form-control-plaintext">
                        <i class="fas fa-user-tie text-success me-2"></i>
                        ${venta.vendedor || 'Sistema'}
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">Bodega</label>
                    <div class="form-control-plaintext">
                        <i class="fas fa-warehouse text-warning me-2"></i>
                        ${venta.bodega || 'No especificada'}
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">Total Productos</label>
                    <div class="form-control-plaintext fw-bold text-primary">
                        <i class="fas fa-boxes me-2"></i>
                        ${venta.total_productos || 0}
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">Total Venta</label>
                    <div class="form-control-plaintext fw-bold text-success">
                        <i class="fas fa-dollar-sign me-2"></i>
                        ${venta.total_venta_formateado || 'C$0.00'}
                    </div>
                </div>
            `;
            detailsContainer.innerHTML = detailsHtml;
        }

        // 5. Actualizar información de crédito si aplica
        const creditoInfo = document.getElementById('creditoInfo');
        if (venta.tipo_venta === 'CRÉDITO' && venta.tiene_cuenta_cobrar) {
            safeDisplay('creditoInfo', 'block');
            safeSetText('estadoCuenta', venta.estado_cuenta || 'Pendiente');
            
            const estadoCuentaElem = document.getElementById('estadoCuenta');
            if (estadoCuentaElem) {
                estadoCuentaElem.className = getBadgeClassForEstado(venta.estado_cuenta);
            }
            
            safeSetText('saldoPendiente', formatCurrency(venta.saldo_pendiente || 0));
        } else {
            safeDisplay('creditoInfo', 'none');
        }

        // 6. Actualizar contador de productos
        const totalProductos = venta.total_productos || venta.productos.length || 0;
        safeSetText('totalProductosCount', `(${totalProductos} productos)`);
        safeSetText('totalCantidad', formatNumber(venta.total_cantidad || 0));
        safeSetText('totalVentaModal', venta.total_venta_formateado || formatCurrency(0));

        // 7. Llenar tabla de productos
        const productosTableBody = document.getElementById('productosTableBody');
        if (productosTableBody) {
            productosTableBody.innerHTML = '';

            venta.productos.forEach((producto, index) => {
                const cantidad = parseFloat(producto.cantidad) || 0;
                const precioUnitario = parseFloat(producto.precio_unitario) || 0;
                const subtotal = parseFloat(producto.subtotal) || 0;
                
                // Limpiar la unidad para evitar el "7"
                const unidad = limpiarUnidad(producto.unidad_medida);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="fw-bold">${index + 1}</td>
                    <td><span class="badge bg-light text-dark">${producto.codigo || 'N/A'}</span></td>
                    <td>${producto.descripcion || 'Producto sin descripción'}</td>
                    <td class="text-center fw-semibold">
                        ${cantidad.toFixed(2)}
                        ${unidad ? `<span class="text-muted small ms-1">${unidad}</span>` : ''}
                    </td>
                    <td class="text-center">${unidad || '-'}</td>
                    <td class="text-end">${formatCurrency(precioUnitario)}</td>
                    <td class="text-end fw-semibold">${formatCurrency(subtotal)}</td>
                `;

                productosTableBody.appendChild(row);
            });
        }

        // 8. Configurar formulario
        const form = document.getElementById('formAnularVenta');
        if (form && venta.id_factura) {
            form.action = `/admin/ventas/anular/${venta.id_factura}`;
            document.getElementById('idFactura').value = venta.id_factura;
        }

        // 9. Habilitar/deshabilitar botón según validaciones
        const btn = document.getElementById('btnConfirmarAnulacion');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-ban me-2"></i> Confirmar Anulación`;
            btn.classList.remove('btn-warning');
            btn.classList.add('btn-danger');
        }

        // 10. Limpiar formulario
        const motivoInput = document.getElementById('motivoAnulacion');
        const confirmCheckbox = document.getElementById('confirmarAnulacion');
        
        if (motivoInput) motivoInput.value = '';
        if (confirmCheckbox) confirmCheckbox.checked = false;
        
        // Resetear contador de caracteres
        safeSetText('charCount', '0');
        const charCounter = document.getElementById('charCounter');
        if (charCounter) {
            charCounter.className = 'form-text text-end text-muted';
        }
        
        // Inicializar validación del formulario
        setTimeout(() => {
            validateForm();
        }, 100);
    }

    // Función para resetear modal
    function resetModal() {
        safeDisplay('modalLoading', 'block');
        safeDisplay('modalContent', 'none');
        safeDisplay('modalError', 'none');
        
        // Resetear detalles básicos
        const detailsContainer = document.getElementById('ventaBasicDetails');
        if (detailsContainer) detailsContainer.innerHTML = '';
        
        // Resetear tabla de productos
        const productosTableBody = document.getElementById('productosTableBody');
        if (productosTableBody) productosTableBody.innerHTML = '';
        
        // Resetear contador de caracteres
        safeSetText('charCount', '0');
        const charCounter = document.getElementById('charCounter');
        if (charCounter) {
            charCounter.className = 'form-text text-end text-muted';
        }
        
        // Resetear formulario
        const form = document.getElementById('formAnularVenta');
        if (form) form.reset();
        
        // Resetear ID
        safeSetText('modalVentaId', '#');
        
        // Resetear botón
        const btn = document.getElementById('btnConfirmarAnulacion');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-ban me-2"></i> Cargando...`;
            btn.classList.remove('btn-warning');
            btn.classList.add('btn-danger');
        }
    }

    // ==================== VALIDACIÓN DEL FORMULARIO ====================
    
    const motivoTextarea = document.getElementById('motivoAnulacion');
    const confirmCheckbox = document.getElementById('confirmarAnulacion');
    const btnConfirmar = document.getElementById('btnConfirmarAnulacion');
    const charCount = document.getElementById('charCount');

    // Función para validar el formulario
    function validateForm() {
        const motivo = motivoTextarea ? motivoTextarea.value.trim() : '';
        const confirmado = confirmCheckbox ? confirmCheckbox.checked : false;
        const motivoValido = motivo.length >= 1 && motivo.length <= 500;
        
        const isValid = motivoValido && confirmado;
        
        if (btnConfirmar) {
            btnConfirmar.disabled = !isValid;
            btnConfirmar.innerHTML = isValid ? 
                `<i class="fas fa-ban me-2"></i> Confirmar Anulación` : 
                `<i class="fas fa-ban me-2"></i> Confirmar Anulación`;
        }
        
        // Actualizar contador
        if (charCount) {
            charCount.textContent = motivo.length;
        }
        
        // Cambiar color según longitud
        const counter = document.getElementById('charCounter');
        if (counter) {
            if (motivo.length === 0) {
                counter.className = 'form-text text-end text-muted';
            } else if (motivo.length > 500) {
                counter.className = 'form-text text-end text-danger';
            } else if (motivo.length < 10) {
                counter.className = 'form-text text-end text-warning';
            } else {
                counter.className = 'form-text text-end text-success';
            }
        }
        
        return isValid;
    }

    // Event listeners para validación en tiempo real
    if (motivoTextarea) {
        motivoTextarea.addEventListener('input', validateForm);
    }
    
    if (confirmCheckbox) {
        confirmCheckbox.addEventListener('change', validateForm);
    }

    // ==================== ENVÍO DEL FORMULARIO ====================
    
    const form = document.getElementById('formAnularVenta');
    if (form) {
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            
            if (!validateForm()) {
                // Mostrar alerta simple de Bootstrap
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-warning alert-dismissible fade show position-fixed top-0 end-0 m-3';
                alertDiv.style.zIndex = '9999';
                alertDiv.innerHTML = `
                    <strong><i class="fas fa-exclamation-triangle me-2"></i>Validación requerida</strong>
                    <p class="mb-0 small">Por favor complete todos los campos correctamente antes de continuar.</p>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alertDiv);
                
                // Auto-eliminar después de 5 segundos
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
                return;
            }

            const motivo = motivoTextarea ? motivoTextarea.value.trim() : '';
            
            // Confirmación final
            if (!confirm(`¿Está seguro de anular la venta #${currentVentaId}? Esta acción no se puede deshacer.`)) {
                return;
            }

            // Deshabilitar botón para evitar doble envío
            if (btnConfirmar) {
                btnConfirmar.disabled = true;
                btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Procesando...';
            }

            // Enviar formulario
            form.submit();
        });
    }

    // ==================== FILTROS DE TABLA ====================
    
    function aplicarFiltros() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const estado = document.getElementById('estadoFilter').value;
        const tipo = document.getElementById('tipoVentaFilter').value;
        
        let visibleCount = 0;
        
        document.querySelectorAll('#dataTable tbody tr').forEach(row => {
            const text = row.textContent.toLowerCase();
            const estadoCell = row.querySelector('[data-label="Estado"] .badge');
            const tipoCell = row.querySelector('[data-label="Tipo"] .badge');
            
            const estadoText = estadoCell?.textContent || '';
            const tipoText = tipoCell?.textContent || '';
            
            const mostrar = 
                (!search || text.includes(search)) &&
                (!estado || estadoText.includes(estado.toUpperCase()) || estadoText.includes(estado.toLowerCase())) &&
                (!tipo || tipoText.includes(tipo.toUpperCase()) || tipoText.includes(tipo.toLowerCase()));
            
            row.style.display = mostrar ? '' : 'none';
            if (mostrar) visibleCount++;
        });
    }
    
    // Aplicar filtros en tiempo real
    ['searchInput', 'estadoFilter', 'tipoVentaFilter'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', aplicarFiltros);
        document.getElementById(id)?.addEventListener('change', aplicarFiltros);
    });
    
    // Limpiar filtros
    document.getElementById('clearFiltersBtn')?.addEventListener('click', () => {
        document.getElementById('searchInput').value = '';
        document.getElementById('estadoFilter').value = '';
        document.getElementById('tipoVentaFilter').value = '';
        aplicarFiltros();
    });
    
    // ==================== EXPORTACIÓN ====================
    
    document.getElementById('exportExcel')?.addEventListener('click', function(e) {
        e.preventDefault();
        
        const table = document.getElementById('dataTable');
        const html = table.outerHTML;
        const blob = new Blob([`<html><head><meta charset="UTF-8"></head><body>${html}</body></html>`], {
            type: 'application/vnd.ms-excel'
        });
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ventas_${new Date().toISOString().slice(0,10)}.xls`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Mostrar notificación simple
        const toast = document.createElement('div');
        toast.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
        toast.style.zIndex = '9999';
        toast.innerHTML = `
            <strong><i class="fas fa-check-circle me-2"></i>Exportación iniciada</strong>
            <p class="mb-0 small">El archivo se descargará automáticamente.</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 5000);
    });
    
    document.getElementById('printTableBtn')?.addEventListener('click', function(e) {
        e.preventDefault();
        
        const originalContents = document.body.innerHTML;
        const printContents = document.getElementById('dataTable').outerHTML;
        
        document.body.innerHTML = `
            <html>
                <head>
                    <title>Reporte de Ventas</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .text-end { text-align: right; }
                        .text-center { text-align: center; }
                        .badge { padding: 2px 6px; border-radius: 3px; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <h2>Reporte de Ventas</h2>
                    <p>Generado: ${new Date().toLocaleString()}</p>
                    ${printContents}
                </body>
            </html>
        `;
        
        window.print();
        document.body.innerHTML = originalContents;
        window.location.reload();
    });
    
    // ==================== INICIALIZACIÓN ====================
    
    // Inicializar mejoras para touch
    inicializarMejorasTouch();
    optimizarModalParaTecladoVirtual();
    optimizarModalMovil();
    
    // Escuchar cambios de orientación
    window.addEventListener('orientationchange', ajustarPorOrientacion);
    window.addEventListener('resize', ajustarPorOrientacion);
    
    // Ajustar inicial
    ajustarPorOrientacion();
    
    // Aplicar filtros iniciales
    aplicarFiltros();
    
    // Ajustar tabla al cargar en móviles
    if (window.innerWidth < 768) {
        setTimeout(() => {
            document.querySelectorAll('.table-responsive-lg').forEach(el => {
                el.scrollLeft = 0;
            });
        }, 100);
    }
    
    // Auto-ocultar mensajes flash después de 5 segundos
    setTimeout(() => {
        document.querySelectorAll('.alert').forEach(alert => {
            const closeBtn = alert.querySelector('.btn-close');
            if (closeBtn) {
                closeBtn.click();
            }
        });
    }, 5000);
});
</script>
{% endblock %}