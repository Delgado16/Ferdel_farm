{% extends "layout.html" %}

{% block title %}Gestión de Ventas - FerDel{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Encabezado con botón de volver -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-chart-line"></i> Gestión de Ventas
        </h1>
        <div class="d-flex gap-2">
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Volver al Dashboard
            </a>
            <a href="{{ url_for('admin_crear_venta') }}" class="btn btn-primary">
                <i class="fas fa-plus-circle"></i> Nueva Venta
            </a>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Total Ventas</h6>
                            <h2 class="fw-bold text-dark mb-0">{{ total_ventas }}</h2>
                        </div>
                        <div class="text-primary">
                            <i class="fas fa-shopping-cart fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Ventas Contado</h6>
                            <h2 class="fw-bold text-dark mb-0">{{ ventas_contado }}</h2>
                        </div>
                        <div class="text-success">
                            <i class="fas fa-money-bill-wave fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Ventas Crédito</h6>
                            <h2 class="fw-bold text-dark mb-0">{{ ventas_credito }}</h2>
                        </div>
                        <div class="text-warning">
                            <i class="fas fa-credit-card fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Monto Total</h6>
                            <h2 class="fw-bold text-dark mb-0">C$ {{ "{:,.2f}".format(monto_total) }}</h2>
                        </div>
                        <div class="text-info">
                            <i class="fas fa-chart-bar fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Tabla de Ventas -->
    <div class="card shadow-sm">
        <!-- Header con búsqueda y filtros -->
        <div class="card-header bg-white">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h5 class="card-title fw-bold mb-0">
                        <i class="fas fa-receipt me-2 text-primary"></i>Registro de Ventas
                    </h5>
                    <p class="text-muted small mb-0">Gestión completa de transacciones</p>
                </div>
                <div class="d-flex gap-2">
                    <div class="input-group input-group-sm" style="width: 250px;">
                        <span class="input-group-text bg-light border-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control border-0 bg-light" id="searchInput"
                            placeholder="Buscar...">
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="row g-2">
                <div class="col-md-4">
                    <form id="filtrosForm" method="GET" class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="estadoFilter" name="estado" onchange="this.form.submit()">
                            <option value="">Todos los estados</option>
                            <option value="ACTIVAS" {% if estado_filtro == 'ACTIVAS' %}selected{% endif %}>Activas</option>
                            <option value="ANULADAS" {% if estado_filtro == 'ANULADAS' %}selected{% endif %}>Anuladas</option>
                        </select>
                    </form>
                </div>
                <div class="col-md-4">
                    <select class="form-select form-select-sm" id="tipoVentaFilter" name="tipo" onchange="aplicarFiltroTipo(this.value)">
                        <option value="">Todos los tipos</option>
                        <option value="CONTADO" {% if tipo_filtro == 'CONTADO' %}selected{% endif %}>Contado</option>
                        <option value="CREDITO" {% if tipo_filtro == 'CREDITO' %}selected{% endif %}>Crédito</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <a href="{{ url_for('admin_ventas_salidas') }}" class="btn btn-outline-secondary btn-sm w-100" id="clearFiltersBtn">
                        <i class="fas fa-filter-circle-xmark me-1"></i> Limpiar Filtros
                    </a>
                </div>
            </div>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0" id="dataTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Identificación</th>
                            <th class="text-center">Tipo</th>
                            <th>Bodega</th>
                            <th class="text-center">Productos</th>
                            <th class="text-end">Total</th>
                            <th>Vendedor</th>
                            <th class="text-center">Estado</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for venta in ventas %}
                        <tr>
                            <td>
                                <div>
                                    <div>{{ venta.Fecha.strftime('%d/%m/%Y') if venta.Fecha else 'N/A' }}</div>
                                    <small class="text-muted">{{ venta.Fecha.strftime('%H:%M') if venta.Fecha else ''
                                        }}</small>
                                </div>
                            </td>
                            <td>
                                <div class="fw-bold">{{ venta.Cliente or 'Consumidor Final' }}</div>
                            </td>
                            <td>
                                {{ venta.RUC_Cliente or 'N/A' }}
                            </td>
                            <td class="text-center">
                                {% set tipo = venta.Tipo_Venta_Formateado or 'CONTADO' %}
                                <span class="badge bg-{% if tipo == 'CONTADO' %}success{% else %}warning{% endif %}">
                                    <i
                                        class="fas fa-{% if tipo == 'CONTADO' %}money-bill-wave{% else %}credit-card{% endif %} me-1"></i>{{
                                    tipo }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ venta.Bodega or 'N/A' }}</span>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-info">
                                    <i class="fas fa-boxes me-1"></i>{{ venta.Total_Productos or 0 }}
                                </span>
                            </td>
                            <td class="text-end fw-bold text-success">
                                C$ {{ "{:,.2f}".format(venta.Total_Venta or 0) }}
                            </td>
                            <td>
                                {{ venta.Usuario_Creacion or 'Sistema' }}
                            </td>
                            <td class="text-center">
                                {% set estado = venta.Estado_Formateado or 'PENDIENTE' %}
                                <span
                                    class="badge bg-{% if estado == 'ACTIVA' %}success{% elif estado == 'ANULADA' %}danger{% else %}secondary{% endif %}">
                                    <i
                                        class="fas fa-{% if estado == 'ACTIVA' %}check-circle{% elif estado == 'ANULADA' %}ban{% else %}clock{% endif %} me-1"></i>{{
                                    estado }}
                                </span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{ url_for('admin_generar_ticket', id_factura=venta.ID_Factura) }}"
                                        class="btn btn-outline-info" title="Ver ticket" target="_blank">
                                        <i class="fas fa-receipt"></i>
                                        <span class="ms-1">Ticket</span>
                                    </a>
                                    <a href="{{ url_for('admin_detalles_venta', id_factura=venta.ID_Factura) }}"
                                        class="btn btn-outline-primary" title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                        <span class="ms-1">Detalles</span>
                                    </a>
                                    {% if venta.Estado_Formateado == 'ACTIVA' %}
                                    <button type="button" class="btn btn-outline-danger btn-anular-venta"
                                        data-bs-toggle="modal" data-bs-target="#anularVentaModal"
                                        data-id="{{ venta.ID_Factura }}">
                                        <i class="fas fa-ban"></i>
                                        <span class="ms-1">Anular</span>
                                    </button>
                                    {% else %}
                                    <button class="btn btn-outline-secondary" disabled title="Anulada">
                                        <i class="fas fa-lock"></i>
                                        <span class="ms-1">Bloqueado</span>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="10" class="text-center py-5">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted mb-2">No hay ventas registradas</h5>
                                <p class="text-muted small mb-4">Comience creando su primera venta</p>
                                <a href="{{ url_for('admin_crear_venta') }}" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Crear Venta
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Anulación de Venta -->
<div class="modal fade" id="anularVentaModal" tabindex="-1" aria-labelledby="anularVentaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="anularVentaModalLabel">
                    <i class="fas fa-exclamation-triangle me-2 text-danger"></i>
                    Confirmar Anulación de Venta
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Loading State -->
            <div id="modalLoading" class="modal-body text-center py-5">
                <div class="spinner-border text-danger mb-3" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <h6 class="text-muted">Cargando información detallada de la venta...</h6>
                <p class="text-muted small mt-2">Por favor espere un momento</p>
            </div>

            <!-- Error State -->
            <div id="modalError" class="modal-body text-center py-5" style="display: none;">
                <div class="mb-3">
                    <i class="fas fa-times-circle fa-3x text-danger"></i>
                </div>
                <h6 class="text-danger" id="errorTitle">Error al cargar la venta</h6>
                <p class="text-muted small mt-2" id="errorMessage">Ha ocurrido un error</p>
                <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>

            <!-- Content Container -->
            <div id="modalContent" style="display: none;">
                <form id="formAnularVenta" method="POST" action="">
                    {% if csrf_token %}
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    {% endif %}
                    <input type="hidden" id="idFactura" name="id_factura" value="">

                    <div class="modal-body">
                        <!-- Alerta de advertencia -->
                        <div class="alert alert-warning mb-4">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-circle fa-2x text-warning"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="alert-heading fw-bold mb-1">
                                        ¿Está seguro de anular la venta <span id="modalVentaId"
                                            class="text-danger fw-bold">#</span>?
                                    </h6>
                                    <p class="mb-0 small">Esta acción es irreversible y reversará las existencias en
                                        inventario.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Detalles de la venta -->
                        <div class="card border mb-4">
                            <div class="card-body">
                                <h6 class="fw-bold text-dark mb-3">
                                    <i class="fas fa-info-circle me-2 text-primary"></i>
                                    Detalles de la Venta
                                    <span id="ventaStatusBadge" class="badge bg-success ms-2">Activa</span>
                                    <span id="tipoVentaBadge" class="badge bg-success ms-1">CONTADO</span>
                                </h6>

                                <!-- Detalles básicos -->
                                <div class="row mb-3" id="ventaBasicDetails">
                                    <!-- Se llenará con JavaScript -->
                                </div>

                                <!-- Información de crédito -->
                                <div id="creditoInfo" class="mb-3 p-3 bg-warning rounded" style="display: none;">
                                    <h6 class="fw-bold text-white mb-2">
                                        <i class="fas fa-credit-card me-2"></i>Información de Crédito
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <small class="text-white d-block">Estado de Cuenta:</small>
                                            <span id="estadoCuenta" class="badge bg-light text-dark">Pendiente</span>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-white d-block">Saldo Pendiente:</small>
                                            <span id="saldoPendiente" class="fw-bold text-white">C$ 0.00</span>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-white">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Al anular, esta cuenta por cobrar también será cancelada automáticamente.
                                        </small>
                                    </div>
                                </div>

                                <!-- Tabla de productos -->
                                <div class="mt-4">
                                    <h6 class="fw-bold text-dark mb-2">
                                        <i class="fas fa-boxes me-2 text-primary"></i>
                                        Productos Vendidos <small class="text-muted" id="totalProductosCount">(0
                                            productos)</small>
                                    </h6>

                                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                        <table class="table table-sm table-hover mb-0" id="productosTable">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>#</th>
                                                    <th>Código</th>
                                                    <th>Descripción</th>
                                                    <th class="text-center">Cantidad</th>
                                                    <th class="text-center">Unidad</th>
                                                    <th class="text-end">Precio Unitario</th>
                                                    <th class="text-end">Subtotal</th>
                                                </tr>
                                            </thead>
                                            <tbody id="productosTableBody">
                                                <!-- Se llenará con JavaScript -->
                                            </tbody>
                                            <tfoot class="table-light">
                                                <tr>
                                                    <td colspan="3" class="text-end fw-bold">Totales:</td>
                                                    <td class="text-center fw-bold" id="totalCantidad">0</td>
                                                    <td></td>
                                                    <td></td>
                                                    <td class="text-end fw-bold text-success" id="totalVentaModal">
                                                        C$ 0.00</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Campo de motivo -->
                        <div class="mb-3">
                            <label for="motivoAnulacion" class="form-label fw-semibold">
                                <i class="fas fa-comment-dots me-2 text-primary"></i>
                                Motivo de Anulación <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="motivoAnulacion" name="motivo_anulacion" rows="3"
                                placeholder="Ingrese el motivo de la anulación..." required maxlength="500"></textarea>
                            <div id="charCounter" class="form-text text-end">
                                <span id="charCount">0</span>/500 caracteres
                            </div>
                        </div>

                        <!-- Checkbox de confirmación -->
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="confirmarAnulacion" required>
                            <label class="form-check-label fw-semibold" for="confirmarAnulacion">
                                Confirmo que deseo anular esta venta y entiendo que esta acción no se puede deshacer
                            </label>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-danger" id="btnConfirmarAnulacion" disabled>
                            <i class="fas fa-ban"></i> Confirmar Anulación
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ==================== VARIABLES GLOBALES ====================
        let currentVentaId = null;
        let ventaData = null;

        // ==================== FUNCIONES DE FILTRADO ====================

        function aplicarFiltroTipo(tipo) {
            // Obtener parámetros actuales de la URL
            const urlParams = new URLSearchParams(window.location.search);
            
            // Actualizar o eliminar el parámetro de tipo
            if (tipo) {
                urlParams.set('tipo', tipo);
            } else {
                urlParams.delete('tipo');
            }
            
            // Mantener el filtro de estado si existe
            const estadoFilter = document.getElementById('estadoFilter');
            if (estadoFilter && estadoFilter.value) {
                urlParams.set('estado', estadoFilter.value);
            }
            
            // Redirigir con los nuevos parámetros
            window.location.href = `${window.location.pathname}?${urlParams.toString()}`;
        }

        function aplicarBusquedaLocal() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            let visibleCount = 0;

            document.querySelectorAll('#dataTable tbody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                const mostrar = !search || text.includes(search);
                
                row.style.display = mostrar ? '' : 'none';
                if (mostrar) visibleCount++;
            });
            
            // Mostrar mensaje si no hay resultados
            const noResultsRow = document.querySelector('#dataTable tbody tr[data-empty="true"]');
            if (visibleCount === 0 && !noResultsRow) {
                const tbody = document.querySelector('#dataTable tbody');
                const noResults = document.createElement('tr');
                noResults.setAttribute('data-empty', 'true');
                noResults.innerHTML = `
                    <td colspan="10" class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted mb-2">No se encontraron resultados</h5>
                        <p class="text-muted small">Intente con otros términos de búsqueda</p>
                    </td>
                `;
                tbody.appendChild(noResults);
            } else if (noResultsRow && visibleCount > 0) {
                noResultsRow.remove();
            }
        }

        // ==================== FUNCIONES AUXILIARES ====================

        function safeSetText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            }
        }

        function safeDisplay(elementId, displayStyle) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = displayStyle;
            }
        }

        function formatNumber(num, decimals = 2) {
            return parseFloat(num || 0).toLocaleString('es-NI', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        function formatCurrency(amount) {
            return `C$ ${formatNumber(amount)}`;
        }

        function getBadgeClassForEstado(estado) {
            switch (estado) {
                case 'Activa': return 'badge bg-success';
                case 'Anulada': return 'badge bg-danger';
                case 'Pagada': return 'badge bg-success';
                case 'Pendiente': return 'badge bg-warning';
                default: return 'badge bg-secondary';
            }
        }

        function limpiarUnidad(unidad) {
            if (!unidad) return '';
            unidad = unidad.toString().trim();
            const valoresInvalidos = ['7', '0', 'null', 'undefined', 'nan'];
            if (valoresInvalidos.includes(unidad.toLowerCase())) {
                return '';
            }
            if (!isNaN(unidad) && unidad !== '') {
                return '';
            }
            return unidad;
        }

        // ==================== MANEJO DEL MODAL ====================

        const anularModal = document.getElementById('anularVentaModal');

        if (anularModal) {
            anularModal.addEventListener('show.bs.modal', async function (e) {
                const btn = e.relatedTarget;
                currentVentaId = btn.dataset.id;

                showModalLoading();

                try {
                    const response = await fetch(`/admin/ventas/anular/${currentVentaId}`);
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }

                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.error || 'Error al cargar datos de la venta');
                    }

                    ventaData = data.venta;

                    if (!ventaData.productos) {
                        throw new Error('No se pudieron cargar los productos de la venta');
                    }

                    if (ventaData.estado !== 'Activa') {
                        throw new Error(`Esta venta ya está ${ventaData.estado.toLowerCase()}. No se puede anular.`);
                    }

                    showModalContent();
                    loadDetailedVentaData(ventaData);

                } catch (error) {
                    console.error('Error al cargar datos detallados:', error);
                    showModalError(error.message || 'Error desconocido al cargar la información');
                }
            });

            anularModal.addEventListener('hidden.bs.modal', function () {
                resetModal();
                currentVentaId = null;
                ventaData = null;
            });
        }

        // ==================== FUNCIONES DEL MODAL ====================

        function showModalLoading() {
            safeDisplay('modalLoading', 'block');
            safeDisplay('modalContent', 'none');
            safeDisplay('modalError', 'none');

            const btn = document.getElementById('btnConfirmarAnulacion');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-ban me-2"></i> Cargando...`;
            }
        }

        function showModalContent() {
            safeDisplay('modalLoading', 'none');
            safeDisplay('modalContent', 'block');
            safeDisplay('modalError', 'none');
        }

        function showModalError(errorMessage) {
            safeDisplay('modalLoading', 'none');
            safeDisplay('modalContent', 'none');
            safeDisplay('modalError', 'block');
            safeSetText('errorTitle', 'Error al cargar la venta');
            safeSetText('errorMessage', errorMessage || 'Ha ocurrido un error');
        }

        function loadDetailedVentaData(venta) {
            if (!venta.productos || !Array.isArray(venta.productos)) {
                showModalError('Error: No se pudieron cargar los productos de la venta');
                return;
            }

            // Actualizar ID
            safeSetText('modalVentaId', `#${venta.id_factura}`);

            // Actualizar estado
            const estadoBadge = document.getElementById('ventaStatusBadge');
            if (estadoBadge) {
                estadoBadge.textContent = venta.estado || 'Activa';
                estadoBadge.className = getBadgeClassForEstado(venta.estado) + ' ms-2';
            }

            // Actualizar tipo de venta
            const tipoBadge = document.getElementById('tipoVentaBadge');
            if (tipoBadge) {
                tipoBadge.textContent = venta.tipo_venta || 'CONTADO';
                tipoBadge.className = venta.tipo_venta === 'CONTADO' ? 'badge bg-success ms-1' : 'badge bg-warning ms-1';
            }

            // Actualizar detalles básicos
            const detailsContainer = document.getElementById('ventaBasicDetails');
            if (detailsContainer) {
                const fechaMostrar = venta.fecha_corta || '--/--/--';
                const horaMostrar = venta.hora || '--:--';

                const detailsHtml = `
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">Cliente</label>
                    <div class="form-control-plaintext fw-bold">
                        <i class="fas fa-user text-primary me-2"></i>
                        ${venta.cliente || 'Consumidor Final'}
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">RUC/Cédula</label>
                    <div class="form-control-plaintext">
                        <i class="fas fa-id-card text-secondary me-2"></i>
                        ${venta.cliente_ruc || 'N/A'}
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">Fecha</label>
                    <div class="form-control-plaintext">
                        <i class="fas fa-calendar text-info me-2"></i>
                        ${fechaMostrar}
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">Hora</label>
                    <div class="form-control-plaintext">
                        <i class="fas fa-clock text-info me-2"></i>
                        ${horaMostrar}
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">Vendedor</label>
                    <div class="form-control-plaintext">
                        <i class="fas fa-user-tie text-success me-2"></i>
                        ${venta.vendedor || 'Sistema'}
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">Bodega</label>
                    <div class="form-control-plaintext">
                        <i class="fas fa-warehouse text-warning me-2"></i>
                        ${venta.bodega || 'No especificada'}
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">Total Productos</label>
                    <div class="form-control-plaintext fw-bold text-primary">
                        <i class="fas fa-boxes me-2"></i>
                        ${venta.total_productos || 0}
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label small text-muted">Total Venta</label>
                    <div class="form-control-plaintext fw-bold text-success">
                        <i class="fas fa-dollar-sign me-2"></i>
                        ${venta.total_venta_formateado || 'C$ 0.00'}
                    </div>
                </div>
            `;
                detailsContainer.innerHTML = detailsHtml;
            }

            // Actualizar información de crédito si aplica
            const creditoInfo = document.getElementById('creditoInfo');
            if (venta.tipo_venta === 'CRÉDITO' && venta.tiene_cuenta_cobrar) {
                safeDisplay('creditoInfo', 'block');
                safeSetText('estadoCuenta', venta.estado_cuenta || 'Pendiente');

                const estadoCuentaElem = document.getElementById('estadoCuenta');
                if (estadoCuentaElem) {
                    estadoCuentaElem.className = getBadgeClassForEstado(venta.estado_cuenta);
                }

                safeSetText('saldoPendiente', formatCurrency(venta.saldo_pendiente || 0));
            } else {
                safeDisplay('creditoInfo', 'none');
            }

            // Actualizar contador de productos
            const totalProductos = venta.total_productos || venta.productos.length || 0;
            safeSetText('totalProductosCount', `(${totalProductos} productos)`);
            safeSetText('totalCantidad', formatNumber(venta.total_cantidad || 0));
            safeSetText('totalVentaModal', venta.total_venta_formateado || formatCurrency(0));

            // Llenar tabla de productos
            const productosTableBody = document.getElementById('productosTableBody');
            if (productosTableBody) {
                productosTableBody.innerHTML = '';

                venta.productos.forEach((producto, index) => {
                    const cantidad = parseFloat(producto.cantidad) || 0;
                    const precioUnitario = parseFloat(producto.precio_unitario) || 0;
                    const subtotal = parseFloat(producto.subtotal) || 0;
                    const unidad = limpiarUnidad(producto.unidad_medida);

                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td class="fw-bold">${index + 1}</td>
                    <td><span class="badge bg-light text-dark">${producto.codigo || 'N/A'}</span></td>
                    <td>${producto.descripcion || 'Producto sin descripción'}</td>
                    <td class="text-center fw-semibold">
                        ${cantidad.toFixed(2)}
                        ${unidad ? `<span class="text-muted small ms-1">${unidad}</span>` : ''}
                    </td>
                    <td class="text-center">${unidad || '-'}</td>
                    <td class="text-end">${formatCurrency(precioUnitario)}</td>
                    <td class="text-end fw-semibold">${formatCurrency(subtotal)}</td>
                `;

                    productosTableBody.appendChild(row);
                });
            }

            // Configurar formulario
            const form = document.getElementById('formAnularVenta');
            if (form && venta.id_factura) {
                form.action = `/admin/ventas/anular/${venta.id_factura}`;
                document.getElementById('idFactura').value = venta.id_factura;
            }

            // Habilitar/deshabilitar botón
            const btn = document.getElementById('btnConfirmarAnulacion');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-ban me-2"></i> Confirmar Anulación`;
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-danger');
            }

            // Limpiar formulario
            const motivoInput = document.getElementById('motivoAnulacion');
            const confirmCheckbox = document.getElementById('confirmarAnulacion');

            if (motivoInput) motivoInput.value = '';
            if (confirmCheckbox) confirmCheckbox.checked = false;

            safeSetText('charCount', '0');
            const charCounter = document.getElementById('charCounter');
            if (charCounter) {
                charCounter.className = 'form-text text-end text-muted';
            }

            setTimeout(() => {
                validateForm();
            }, 100);
        }

        function resetModal() {
            safeDisplay('modalLoading', 'block');
            safeDisplay('modalContent', 'none');
            safeDisplay('modalError', 'none');

            const detailsContainer = document.getElementById('ventaBasicDetails');
            if (detailsContainer) detailsContainer.innerHTML = '';

            const productosTableBody = document.getElementById('productosTableBody');
            if (productosTableBody) productosTableBody.innerHTML = '';

            safeSetText('charCount', '0');
            const charCounter = document.getElementById('charCounter');
            if (charCounter) {
                charCounter.className = 'form-text text-end text-muted';
            }

            const form = document.getElementById('formAnularVenta');
            if (form) form.reset();

            safeSetText('modalVentaId', '#');

            const btn = document.getElementById('btnConfirmarAnulacion');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-ban me-2"></i> Cargando...`;
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-danger');
            }
        }

        // ==================== VALIDACIÓN DEL FORMULARIO ====================

        const motivoTextarea = document.getElementById('motivoAnulacion');
        const confirmCheckbox = document.getElementById('confirmarAnulacion');
        const btnConfirmar = document.getElementById('btnConfirmarAnulacion');
        const charCount = document.getElementById('charCount');

        function validateForm() {
            const motivo = motivoTextarea ? motivoTextarea.value.trim() : '';
            const confirmado = confirmCheckbox ? confirmCheckbox.checked : false;
            const motivoValido = motivo.length >= 1 && motivo.length <= 500;

            const isValid = motivoValido && confirmado;

            if (btnConfirmar) {
                btnConfirmar.disabled = !isValid;
            }

            if (charCount) {
                charCount.textContent = motivo.length;
            }

            const counter = document.getElementById('charCounter');
            if (counter) {
                if (motivo.length === 0) {
                    counter.className = 'form-text text-end text-muted';
                } else if (motivo.length > 500) {
                    counter.className = 'form-text text-end text-danger';
                } else if (motivo.length < 10) {
                    counter.className = 'form-text text-end text-warning';
                } else {
                    counter.className = 'form-text text-end text-success';
                }
            }

            return isValid;
        }

        if (motivoTextarea) {
            motivoTextarea.addEventListener('input', validateForm);
        }

        if (confirmCheckbox) {
            confirmCheckbox.addEventListener('change', validateForm);
        }

        // ==================== ENVÍO DEL FORMULARIO ====================

        const form = document.getElementById('formAnularVenta');
        if (form) {
            form.addEventListener('submit', function (e) {
                e.preventDefault();

                if (!validateForm()) {
                    alert('Por favor complete todos los campos correctamente antes de continuar.');
                    return;
                }

                const motivo = motivoTextarea ? motivoTextarea.value.trim() : '';

                if (!confirm(`¿Está seguro de anular la venta #${currentVentaId}? Esta acción no se puede deshacer.`)) {
                    return;
                }

                if (btnConfirmar) {
                    btnConfirmar.disabled = true;
                    btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Procesando...';
                }

                form.submit();
            });
        }

        // ==================== EVENTOS DE FILTROS ====================

        // Búsqueda local
        document.getElementById('searchInput')?.addEventListener('input', aplicarBusquedaLocal);

        // Auto-ocultar mensajes flash después de 5 segundos
        setTimeout(() => {
            document.querySelectorAll('.alert').forEach(alert => {
                const closeBtn = alert.querySelector('.btn-close');
                if (closeBtn) {
                    closeBtn.click();
                }
            });
        }, 5000);
    });
</script>
{% endblock %}