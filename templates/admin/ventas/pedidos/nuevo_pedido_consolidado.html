{% extends "layout.html" %}

{% block title %}Nuevo Pedido Consolidado{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-layer-group me-2"></i>Nuevo Pedido Consolidado</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_pedidos_venta') }}">Pedidos</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Nuevo Pedido Consolidado</li>
                </ol>
            </nav>
            <div class="alert alert-info mt-2 mb-0">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Pedido Consolidado:</strong> Agrupa productos para entrega por ruta, sin asignar a un cliente específico. 
                <span class="badge bg-primary ms-2">SIEMPRE usa Precio Ruta</span>
            </div>
        </div>
        <div>
            <a href="{{ url_for('admin_pedidos_venta') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Cancelar
            </a>
        </div>
    </div>
    
    <!-- Formulario de Pedido Consolidado -->
    <div class="card">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>Datos del Pedido Consolidado</h5>
        </div>
        <div class="card-body">
            <form id="formPedidoConsolidado">
                <div class="row g-3">
                    <!-- Datos del Pedido Consolidado -->
                    <div class="col-md-6">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-info-circle me-2"></i>Información General
                        </h5>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Fecha:</label>
                                <input type="date" id="fechaPedido" class="form-control" required 
                                       value="{{ now.strftime('%Y-%m-%d') }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Empresa:</label>
                                <select id="selectEmpresa" class="form-select" required>
                                    <option value="">Seleccione empresa...</option>
                                    {% for empresa in empresas %}
                                    <option value="{{ empresa.ID_Empresa }}">
                                        {{ empresa.Nombre_Empresa }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Prioridad:</label>
                                <select id="selectPrioridad" class="form-select" required>
                                    {% for prioridad in prioridades %}
                                    <option value="{{ prioridad }}" {% if prioridad == 'Normal' %}selected{% endif %}>
                                        {{ prioridad }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Ruta: <span class="text-danger">*</span></label>
                                <select id="selectRuta" class="form-select" required>
                                    <option value="">Seleccione una ruta...</option>
                                    {% for ruta in rutas %}
                                    <option value="{{ ruta.ID_Ruta }}" 
                                            data-descripcion="{{ ruta.Descripcion or 'Sin descripción' }}"
                                            data-total-clientes="{{ ruta.Total_Clientes }}">
                                        {{ ruta.Nombre_Ruta }}
                                        {% if ruta.Descripcion %} - {{ ruta.Descripcion }}{% endif %}
                                        <span class="badge bg-info">{{ ruta.Total_Clientes }} clientes</span>
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    <i class="fas fa-route me-1"></i>
                                    Ruta obligatoria para pedidos consolidados
                                </small>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">Observaciones:</label>
                                <textarea id="observacionPedido" class="form-control" rows="2" 
                                          placeholder="Agregue observaciones o notas adicionales para este pedido consolidado..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información de Ruta y Precios -->
                    <div class="col-md-6">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-truck me-2"></i>Información de Entrega
                        </h5>
                        
                        <div id="infoRutaContainer" class="p-3 bg-light rounded" style="display: none;">
                            <div id="infoRutaContent"></div>
                        </div>
                        
                        <div id="noRutaContainer" class="p-3 bg-light rounded">
                            <div class="text-center py-4">
                                <i class="fas fa-route fa-3x text-muted mb-3"></i>
                                <p class="mb-0">Seleccione una ruta para ver su información</p>
                            </div>
                        </div>
                        
                        <!-- Información de Precios - SIEMPRE RUTA -->
                        <div class="mt-3">
                            <div class="alert alert-primary">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-tag fa-2x me-3"></i>
                                    <div>
                                        <h6 class="alert-heading mb-1">Tipo de Precio Aplicado</h6>
                                        <p class="mb-0">
                                            <span class="badge bg-primary fs-6">PRECIO RUTA</span>
                                            <small class="d-block mt-2">
                                                Los pedidos consolidados SIEMPRE utilizan el precio de ruta de los productos, 
                                                independientemente del perfil del cliente.
                                            </small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Indicador de prioridad -->
                        <div class="mt-3" id="indicadorPrioridad" style="display: none;">
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-3">
                                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="alert-heading mb-1">Pedido Urgente</h6>
                                        <p class="mb-0 small">
                                            Este pedido consolidado será marcado como <strong>URGENTE</strong> y tendrá prioridad 
                                            máxima en el procesamiento y entrega.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Selección de Productos -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-boxes me-2"></i>Productos del Pedido Consolidado
                        </h5>
                        
                        <!-- Badge informativo de Precio Ruta -->
                        <div class="alert alert-primary mb-3 py-2">
                            <i class="fas fa-info-circle me-2"></i>
                            Todos los productos se muestran con <strong>PRECIO RUTA</strong>
                        </div>
                        
                        <!-- Búsqueda rápida de productos -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Búsqueda rápida de productos:</label>
                            <div class="input-group">
                                <input type="text" id="buscarProducto" class="form-control" 
                                       placeholder="Buscar producto por nombre o código...">
                                <button class="btn btn-outline-secondary" type="button" id="btnBuscarProducto">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div id="resultadosBusqueda" class="mt-2" style="display: none;"></div>
                        </div>
                        
                        <!-- Categorías -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Categorías de productos:</label>
                            <div id="categoriasContainer" class="d-flex flex-wrap gap-2">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Productos por Categoría -->
                        <div id="productosContainer" style="display: none;">
                            <h6 class="mb-3">Seleccione productos por categoría:</h6>
                            <div id="productosCategoriaContainer">
                                <!-- Aquí se cargan los productos dinámicamente -->
                            </div>
                        </div>
                        
                        <!-- Tabla de Productos Seleccionados -->
                        <div class="mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Productos seleccionados para consolidado:</h6>
                                <div>
                                    <span id="contadorProductos" class="badge bg-primary me-2">0 productos</span>
                                    <span id="indicadorTotal" class="badge bg-success">Total: C$ 0.00</span>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-bordered" id="tablaProductosSeleccionados">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="50">#</th>
                                            <th>Producto</th>
                                            <th width="120">Tipo Precio</th> <!-- NUEVA COLUMNA -->
                                            <th width="150">Precio Unitario</th>
                                            <th width="150">Cantidad Total</th>
                                            <th width="150">Subtotal</th>
                                            <th width="100">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyProductos">
                                        <tr id="filaVacia">
                                            <td colspan="7" class="text-center text-muted py-4">
                                                <i class="fas fa-box-open fa-2x mb-2 d-block"></i>
                                                No hay productos seleccionados para el consolidado
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot id="tfootTotales" style="display: none;">
                                        <tr class="table-active">
                                            <td colspan="5" class="text-end fw-bold">TOTAL CONSOLIDADO:</td>
                                            <td class="fw-bold text-success fs-5" id="totalPedido">C$ 0.00</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Botones de Acción -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                                <i class="fas fa-times me-1"></i> Cancelar
                            </button>
                            <button type="submit" class="btn btn-info" id="btnGuardar" disabled>
                                <i class="fas fa-save me-1"></i> Guardar Pedido Consolidado
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para ver stock detallado -->
<div class="modal fade" id="modalStockDetalle" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Stock Disponible por Bodega</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 id="modalProductoNombre" class="mb-3"></h6>
                <div id="contenidoStock" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para confirmar -->
<div class="modal fade" id="modalConfirmacion" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-layer-group me-2"></i>Confirmar Pedido Consolidado
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-3">
                            <i class="fas fa-info-circle fa-2x"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="alert-heading mb-1">Resumen del pedido consolidado</h6>
                            <p class="mb-0">
                                El pedido se creará con estado "Pendiente" y tipo "Consolidado".
                                <span class="badge bg-primary ms-2">PRECIO RUTA</span>
                            </p>
                        </div>
                    </div>
                </div>
                <div id="resumenPedido"></div>
                
                <!-- Resumen de productos -->
                <div class="mt-3">
                    <h6 class="mb-3">Detalle de productos consolidados:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered" id="tablaResumenProductos">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-center">Cantidad Total</th>
                                    <th class="text-end">Precio Unit.</th>
                                    <th class="text-center">Tipo Precio</th> <!-- NUEVA COLUMNA -->
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyResumenProductos">
                                <!-- Aquí se cargarán los productos -->
                            </tbody>
                            <tfoot>
                                <tr class="table-active">
                                    <td colspan="4" class="text-end fw-bold">TOTAL CONSOLIDADO:</td>
                                    <td class="text-end fw-bold text-success" id="totalResumen">C$ 0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnConfirmarGuardar">
                    <i class="fas fa-save me-1"></i> Confirmar y Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales
let productosSeleccionados = [];
// Para consolidados, siempre usar tipo_cliente 'Comun' y perfil 'Ruta'
const tipoClienteActual = 'Comun';
const perfilClienteActual = 'Ruta';

// Funciones de formato
function formatCurrency(amount) {
    return new Intl.NumberFormat('es-NI', {
        style: 'currency',
        currency: 'NIO',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount).replace('NIO', 'C$');
}

function formatNumber(number) {
    return new Intl.NumberFormat('es-NI').format(number);
}

function getBadgeClassPrioridad(prioridad) {
    switch(prioridad) {
        case 'Urgente': return 'bg-danger';
        case 'Normal': return 'bg-primary';
        case 'Bajo': return 'bg-secondary';
        default: return 'bg-info';
    }
}

function getIconoPrioridad(prioridad) {
    switch(prioridad) {
        case 'Urgente': return 'fas fa-exclamation-triangle';
        case 'Normal': return 'fas fa-bars';
        case 'Bajo': return 'fas fa-angle-down';
        default: return 'fas fa-info-circle';
    }
}

// Función para badge de precio (siempre Ruta para consolidados)
function getPrecioRutaBadge() {
    return {
        clase: 'bg-primary',
        texto: 'Precio Ruta'
    };
}

document.addEventListener('DOMContentLoaded', function() {
    // Configurar fecha actual
    const fechaInput = document.getElementById('fechaPedido');
    if (fechaInput && !fechaInput.value) {
        fechaInput.value = new Date().toISOString().split('T')[0];
    }
    
    // Cargar categorías (siempre con perfil Ruta)
    cargarCategoriasConsolidado();
    
    // Evento para cambio de prioridad
    document.getElementById('selectPrioridad').addEventListener('change', function() {
        const prioridad = this.value;
        mostrarIndicadorPrioridad(prioridad);
    });
    
    // Evento para cambio de ruta - OBLIGATORIO
    document.getElementById('selectRuta').addEventListener('change', function() {
        mostrarInfoRuta();
        validarFormulario();
    });
    
    // Evento para cambios en empresa y fecha
    document.getElementById('selectEmpresa').addEventListener('change', validarFormulario);
    document.getElementById('fechaPedido').addEventListener('change', validarFormulario);
    document.getElementById('selectPrioridad').addEventListener('change', validarFormulario);
    
    // Búsqueda de productos
    document.getElementById('btnBuscarProducto').addEventListener('click', buscarProductos);
    document.getElementById('buscarProducto').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            buscarProductos();
        }
    });
    
    // Modal de stock
    document.getElementById('modalStockDetalle').addEventListener('hidden.bs.modal', function() {
        document.getElementById('contenidoStock').innerHTML = 
            '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div>';
    });
    
    // Modal de confirmación
    document.getElementById('modalConfirmacion').addEventListener('hidden.bs.modal', function () {
        const btnGuardar = document.getElementById('btnConfirmarGuardar');
        if (btnGuardar) {
            btnGuardar.disabled = false;
            btnGuardar.innerHTML = '<i class="fas fa-save me-1"></i> Confirmar y Guardar';
        }
    });
    
    // Verificar prioridad inicial
    mostrarIndicadorPrioridad(document.getElementById('selectPrioridad').value);
    
    // Prevenir envío del formulario
    document.getElementById('formPedidoConsolidado').addEventListener('submit', function(e) {
        e.preventDefault();
        validarYConfirmarPedido();
    });
    
    // Botón de confirmar
    document.getElementById('btnConfirmarGuardar').addEventListener('click', function() {
        guardarPedido();
    });
    
    // Inicializar
    actualizarContadorProductos();
    validarFormulario();
});

// ============================================
// FUNCIONES DE RUTA
// ============================================
function mostrarInfoRuta() {
    const select = document.getElementById('selectRuta');
    const option = select.options[select.selectedIndex];
    const infoContainer = document.getElementById('infoRutaContainer');
    const noRutaContainer = document.getElementById('noRutaContainer');
    
    if (select.value) {
        const descripcion = option.getAttribute('data-descripcion') || 'Sin descripción';
        const totalClientes = option.getAttribute('data-total-clientes') || '0';
        const nombreRuta = option.text.split(' - ')[0];
        
        let html = `
            <h6 class="mb-3">
                <i class="fas fa-route text-info me-2"></i>
                ${nombreRuta}
            </h6>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-2">
                        <small class="text-muted d-block">Descripción:</small>
                        <span>${descripcion}</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-2">
                        <small class="text-muted d-block">Clientes en ruta:</small>
                        <span class="badge bg-primary">${totalClientes} clientes</span>
                    </div>
                </div>
            </div>
            <div class="alert alert-success mt-2 mb-0 py-2">
                <i class="fas fa-check-circle me-2"></i>
                Este pedido consolidado será asignado a la ruta seleccionada
            </div>`;
        
        document.getElementById('infoRutaContent').innerHTML = html;
        infoContainer.style.display = 'block';
        noRutaContainer.style.display = 'none';
    } else {
        infoContainer.style.display = 'none';
        noRutaContainer.style.display = 'block';
    }
}

// ============================================
// FUNCIONES DE CATEGORÍAS Y PRODUCTOS (SIEMPRE RUTA)
// ============================================
function cargarCategoriasConsolidado() {
    const container = document.getElementById('categoriasContainer');
    container.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div>';
    
    fetch(`/admin/ventas/obtener-categorias-visibles?tipo_cliente=${tipoClienteActual}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }
            
            if (data.categorias.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning w-100">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No hay categorías disponibles
                    </div>`;
                document.getElementById('productosContainer').style.display = 'none';
                return;
            }
            
            container.innerHTML = '';
            data.categorias.forEach(categoria => {
                const boton = document.createElement('button');
                boton.type = 'button';
                boton.className = 'btn btn-outline-info mb-2';
                boton.innerHTML = `<i class="fas fa-folder me-2"></i>${categoria.nombre}`;
                boton.onclick = () => cargarProductosCategoria(categoria.id, categoria.nombre);
                container.appendChild(boton);
            });
            
            document.getElementById('productosContainer').style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            container.innerHTML = `<div class="alert alert-danger">Error al cargar categorías</div>`;
        });
}

function cargarProductosCategoria(categoriaId, categoriaNombre) {
    const container = document.getElementById('productosCategoriaContainer');
    container.innerHTML = `
        <div class="card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="fas fa-folder me-2"></i>${categoriaNombre}
                    <span class="badge bg-light text-dark float-end">Precio Ruta</span>
                    <button type="button" class="btn btn-sm btn-outline-light float-end me-2" 
                            onclick="cerrarProductosCategoria()">
                        <i class="fas fa-times"></i>
                    </button>
                </h6>
            </div>
            <div class="card-body">
                <div class="row" id="productosGrid-${categoriaId}">
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando productos...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    
    // Para consolidados, forzar perfil_cliente = 'Ruta'
    fetch(`/admin/ventas/obtener-productos-categoria?categoria_id=${categoriaId}&tipo_cliente=${tipoClienteActual}&perfil_cliente=${perfilClienteActual}`)
        .then(response => response.json())
        .then(data => {
            const grid = document.getElementById(`productosGrid-${categoriaId}`);
            
            if (data.error) {
                grid.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }
            
            if (data.productos.length === 0) {
                grid.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No hay productos disponibles en esta categoría
                        </div>
                    </div>`;
                return;
            }
            
            grid.innerHTML = '';
            data.productos.forEach(producto => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4 mb-3';
                
                // Para consolidados, siempre mostrar precio de ruta con badge
                col.innerHTML = `
                    <div class="card h-100 border-primary">
                        <div class="card-header bg-light py-2">
                            <span class="badge bg-primary">Precio Ruta</span>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title">${producto.nombre}</h6>
                            <div class="card-text small text-muted mb-2">
                                <span class="badge bg-dark">${producto.codigo || 'N/A'}</span>
                                <span class="badge bg-info">${producto.unidad_abreviatura || producto.unidad_descripcion || 'Unidad'}</span>
                            </div>
                            <p class="card-text small mb-2">
                                <i class="fas fa-box me-1"></i> Stock total: <span class="badge bg-success">${formatNumber(producto.stock)}</span>
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="fw-bold text-success">${formatCurrency(producto.precio)}</span>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-info me-1" 
                                            onclick="verStockProducto(${producto.id}, '${producto.nombre.replace(/'/g, "\\'")}')"
                                            title="Ver stock por bodega">
                                        <i class="fas fa-warehouse"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-primary" 
                                            onclick="agregarProducto(${JSON.stringify(producto).replace(/"/g, '&quot;')})">
                                        <i class="fas fa-plus me-1"></i> Agregar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                grid.appendChild(col);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            const grid = document.getElementById(`productosGrid-${categoriaId}`);
            grid.innerHTML = `<div class="alert alert-danger">Error al cargar productos</div>`;
        });
}

function cerrarProductosCategoria() {
    document.getElementById('productosCategoriaContainer').innerHTML = '';
}

// ============================================
// BÚSQUEDA DE PRODUCTOS (SIEMPRE RUTA)
// ============================================
function buscarProductos() {
    const termino = document.getElementById('buscarProducto').value.trim();
    if (termino.length < 2) {
        showAlert('warning', 'Ingrese al menos 2 caracteres para buscar');
        return;
    }
    
    const resultadosDiv = document.getElementById('resultadosBusqueda');
    resultadosDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Buscando...</span></div>';
    resultadosDiv.style.display = 'block';
    
    // Para consolidados, siempre enviar perfil_cliente = 'Ruta'
    fetch(`/admin/ventas/buscar-productos?q=${encodeURIComponent(termino)}&tipo_cliente=${tipoClienteActual}&perfil_cliente=${perfilClienteActual}`)
        .then(response => response.json())
        .then(productos => {
            if (productos.length === 0) {
                resultadosDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-search me-2"></i>
                        No se encontraron productos
                    </div>`;
                return;
            }
            
            let html = '<div class="list-group">';
            productos.forEach(producto => {
                html += `
                    <div class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${producto.nombre}</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted">
                                            Código: ${producto.codigo || 'N/A'} | 
                                            Stock total: <span class="badge bg-info">${formatNumber(producto.stock)}</span> |
                                            Categoría: ${producto.categoria || 'N/A'}
                                        </small>
                                    </div>
                                    <div>
                                        <span class="fw-bold text-success me-3">${formatCurrency(producto.precio)}</span>
                                        <span class="badge bg-primary me-2">Precio Ruta</span>
                                        <button type="button" class="btn btn-sm btn-outline-info" 
                                                onclick="verStockProducto(${producto.id}, '${producto.nombre.replace(/'/g, "\\'")}')"
                                                title="Ver stock por bodega">
                                            <i class="fas fa-warehouse"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-primary ms-1" 
                                                onclick="agregarProductoDesdeBusqueda(${JSON.stringify(producto).replace(/"/g, '&quot;')})">
                                            <i class="fas fa-plus me-1"></i> Agregar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            });
            html += '</div>';
            resultadosDiv.innerHTML = html;
        })
        .catch(error => {
            console.error('Error:', error);
            resultadosDiv.innerHTML = '<div class="alert alert-danger">Error al buscar productos</div>';
        });
}

function agregarProductoDesdeBusqueda(producto) {
    agregarProducto(producto);
    document.getElementById('resultadosBusqueda').style.display = 'none';
    document.getElementById('buscarProducto').value = '';
}

// ============================================
// STOCK
// ============================================
function verStockProducto(productoId, productoNombre) {
    const modal = new bootstrap.Modal(document.getElementById('modalStockDetalle'));
    document.getElementById('modalProductoNombre').textContent = productoNombre;
    
    fetch(`/admin/ventas/obtener-stock-producto/${productoId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('contenidoStock').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${data.error}
                    </div>`;
                return;
            }
            
            // Mostrar también el precio de ruta en el modal
            let html = `
                <div class="mb-3">
                    <p><strong>Código:</strong> ${data.codigo || 'N/A'}</p>
                    <p><strong>Stock Total:</strong> <span class="badge bg-success fs-6">${formatNumber(data.stock_total)}</span></p>
                    <p><strong>Precio Ruta:</strong> <span class="badge bg-primary fs-6">${formatCurrency(data.precios?.ruta || 0)}</span></p>
                </div>`;
            
            if (data.bodegas && data.bodegas.length > 0) {
                html += `
                    <h6 class="mb-3">Stock por Bodega:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Bodega</th>
                                    <th class="text-end">Existencias</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                data.bodegas.forEach(bodega => {
                    html += `
                        <tr>
                            <td>${bodega.Nombre_Bodega || `Bodega ${bodega.ID_Bodega}`}</td>
                            <td class="text-end"><span class="badge bg-primary">${formatNumber(bodega.Existencias)}</span></td>
                        </tr>`;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>`;
            } else {
                html += `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No hay stock registrado en bodegas para este producto
                    </div>`;
            }
            
            document.getElementById('contenidoStock').innerHTML = html;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('contenidoStock').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error al cargar el stock del producto
                </div>`;
        });
    
    modal.show();
}

// ============================================
// GESTIÓN DE PRODUCTOS SELECCIONADOS
// ============================================
function mostrarIndicadorPrioridad(prioridad) {
    const indicador = document.getElementById('indicadorPrioridad');
    if (prioridad === 'Urgente') {
        indicador.style.display = 'block';
        const alert = indicador.querySelector('.alert');
        const icono = alert.querySelector('i');
        const titulo = alert.querySelector('.alert-heading');
        const descripcion = alert.querySelector('p');
        
        icono.className = getIconoPrioridad(prioridad) + ' fa-2x';
        alert.className = 'alert alert-danger alert-dismissible fade show';
        titulo.textContent = 'Pedido Urgente';
        descripcion.innerHTML = `Este pedido consolidado será marcado como <strong class="text-uppercase">${prioridad}</strong> y tendrá prioridad máxima en el procesamiento y entrega.`;
    } else {
        indicador.style.display = 'none';
    }
}

// MODIFICADA: Agregar producto con badge de Precio Ruta
function agregarProducto(producto) {
    const index = productosSeleccionados.findIndex(p => p.id === producto.id);
    
    if (index !== -1) {
        const cantidadActual = productosSeleccionados[index].cantidad;
        const nuevaCantidad = cantidadActual + 1;
        
        if (nuevaCantidad > producto.stock) {
            showAlert('warning', `Stock insuficiente para "${producto.nombre}". Disponible: ${formatNumber(producto.stock)}`);
            return;
        }
        
        productosSeleccionados[index].cantidad = nuevaCantidad;
        productosSeleccionados[index].subtotal = producto.precio * nuevaCantidad;
        actualizarTablaProductos();
        showToast('info', 'Cantidad actualizada', `Cantidad de "${producto.nombre}" aumentada a ${formatNumber(nuevaCantidad)}`);
        return;
    }
    
    if (1 > producto.stock) {
        showAlert('warning', `Stock insuficiente para "${producto.nombre}". Disponible: ${formatNumber(producto.stock)}`);
        return;
    }
    
    productosSeleccionados.push({
        id: producto.id,
        nombre: producto.nombre,
        codigo: producto.codigo,
        precio: producto.precio,
        cantidad: 1,
        stock: producto.stock,
        unidad: producto.unidad_abreviatura || producto.unidad_descripcion || 'Unidad',
        subtotal: producto.precio * 1,
        tipoPrecio: 'Precio Ruta',
        tipoPrecioClase: 'bg-primary'
    });
    
    actualizarTablaProductos();
    showToast('success', 'Producto agregado', `${producto.nombre} agregado al pedido consolidado`);
}

function actualizarTablaProductos() {
    const tbody = document.getElementById('tbodyProductos');
    const tfoot = document.getElementById('tfootTotales');
    const filaVacia = document.getElementById('filaVacia');
    
    if (productosSeleccionados.length === 0) {
        if (filaVacia) filaVacia.style.display = '';
        tfoot.style.display = 'none';
        return;
    }
    
    if (filaVacia) filaVacia.style.display = 'none';
    
    productosSeleccionados.sort((a, b) => a.nombre.localeCompare(b.nombre));
    
    tbody.innerHTML = '';
    let total = 0;
    
    productosSeleccionados.forEach((producto, index) => {
        total += producto.subtotal;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>
                <div class="fw-bold">${producto.nombre}</div>
                <small class="text-muted">
                    Código: ${producto.codigo || 'N/A'} | 
                    Unidad: ${producto.unidad} |
                    Stock: <span class="badge bg-secondary">${formatNumber(producto.stock)}</span>
                </small>
            </td>
            <td>
                <span class="badge ${producto.tipoPrecioClase}">${producto.tipoPrecio}</span>
            </td>
            <td>
                <div class="input-group input-group-sm">
                    <span class="input-group-text">C$</span>
                    <input type="number" class="form-control precio-input" 
                           value="${producto.precio.toFixed(2)}" step="0.01" min="0.01"
                           data-index="${index}" onchange="actualizarPrecio(${index}, this.value)">
                </div>
            </td>
            <td>
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control cantidad-input" 
                           value="${producto.cantidad}" step="0.01" min="0.01" max="${producto.stock}"
                           data-index="${index}" onchange="actualizarCantidad(${index}, this.value)">
                    <button class="btn btn-outline-secondary" type="button" 
                            onclick="modificarCantidad(${index}, 1)">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-outline-secondary" type="button" 
                            onclick="modificarCantidad(${index}, -1)">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                <small class="text-muted">Disponible: ${formatNumber(producto.stock)}</small>
            </td>
            <td class="fw-bold text-success">${formatCurrency(producto.subtotal)}</td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-info me-1" 
                        onclick="verStockProducto(${producto.id}, '${producto.nombre.replace(/'/g, "\\'")}')"
                        title="Ver stock por bodega">
                    <i class="fas fa-warehouse"></i>
                </button>
                <button type="button" class="btn btn-sm btn-danger" 
                        onclick="eliminarProducto(${index})" title="Eliminar">
                    <i class="fas fa-trash"></i>
                </button>
            </td>`;
        tbody.appendChild(row);
    });
    
    const totalFormateado = formatCurrency(total);
    document.getElementById('totalPedido').textContent = totalFormateado;
    document.getElementById('indicadorTotal').textContent = `Total: ${totalFormateado}`;
    tfoot.style.display = '';
    
    actualizarContadorProductos();
    validarFormulario();
}

function actualizarContadorProductos() {
    const contador = document.getElementById('contadorProductos');
    contador.textContent = `${productosSeleccionados.length} producto${productosSeleccionados.length !== 1 ? 's' : ''}`;
    contador.className = `badge ${productosSeleccionados.length > 0 ? 'bg-success' : 'bg-primary'}`;
}

function modificarCantidad(index, cambio) {
    const producto = productosSeleccionados[index];
    const nuevaCantidad = producto.cantidad + cambio;
    
    if (nuevaCantidad < 0.01) return;
    if (nuevaCantidad > producto.stock) {
        showAlert('warning', `Stock insuficiente. Disponible: ${formatNumber(producto.stock)}`);
        return;
    }
    
    productosSeleccionados[index].cantidad = nuevaCantidad;
    productosSeleccionados[index].subtotal = producto.precio * nuevaCantidad;
    actualizarTablaProductos();
}

function actualizarPrecio(index, nuevoPrecio) {
    nuevoPrecio = parseFloat(nuevoPrecio);
    if (isNaN(nuevoPrecio) || nuevoPrecio < 0.01) {
        nuevoPrecio = productosSeleccionados[index].precio;
    }
    
    productosSeleccionados[index].precio = nuevoPrecio;
    productosSeleccionados[index].subtotal = nuevoPrecio * productosSeleccionados[index].cantidad;
    actualizarTablaProductos();
}

function actualizarCantidad(index, nuevaCantidad) {
    nuevaCantidad = parseFloat(nuevaCantidad);
    if (isNaN(nuevaCantidad) || nuevaCantidad < 0.01) {
        nuevaCantidad = productosSeleccionados[index].cantidad;
    }
    
    if (nuevaCantidad > productosSeleccionados[index].stock) {
        showAlert('warning', `Stock insuficiente. Disponible: ${formatNumber(productosSeleccionados[index].stock)}`);
        nuevaCantidad = productosSeleccionados[index].cantidad;
    }
    
    productosSeleccionados[index].cantidad = nuevaCantidad;
    productosSeleccionados[index].subtotal = productosSeleccionados[index].precio * nuevaCantidad;
    actualizarTablaProductos();
}

function eliminarProducto(index) {
    if (confirm(`¿Eliminar "${productosSeleccionados[index].nombre}" del pedido consolidado?`)) {
        productosSeleccionados.splice(index, 1);
        actualizarTablaProductos();
        showToast('info', 'Producto eliminado', 'El producto ha sido removido del pedido consolidado');
    }
}

// ============================================
// VALIDACIÓN Y CONFIRMACIÓN
// ============================================
function validarFormulario() {
    const empresaValido = document.getElementById('selectEmpresa').value !== '';
    const fechaValido = document.getElementById('fechaPedido').value !== '';
    const prioridadValido = document.getElementById('selectPrioridad').value !== '';
    const rutaValido = document.getElementById('selectRuta').value !== '';
    const productosValido = productosSeleccionados.length > 0;
    
    const formularioValido = empresaValido && fechaValido && prioridadValido && rutaValido && productosValido;
    document.getElementById('btnGuardar').disabled = !formularioValido;
    
    return formularioValido;
}

function validarYConfirmarPedido() {
    if (!validarFormulario()) {
        let mensaje = 'Complete todos los campos obligatorios:\n';
        if (!document.getElementById('selectEmpresa').value) mensaje += '• Seleccione una empresa\n';
        if (!document.getElementById('selectRuta').value) mensaje += '• Seleccione una ruta\n';
        if (!document.getElementById('fechaPedido').value) mensaje += '• Seleccione una fecha\n';
        if (!document.getElementById('selectPrioridad').value) mensaje += '• Seleccione una prioridad\n';
        if (productosSeleccionados.length === 0) mensaje += '• Agregue al menos un producto\n';
        
        showAlert('warning', mensaje);
        return;
    }
    
    const prioridad = document.getElementById('selectPrioridad').value;
    const prioridadBadgeClass = getBadgeClassPrioridad(prioridad);
    const prioridadIcono = getIconoPrioridad(prioridad);
    
    const selectRuta = document.getElementById('selectRuta');
    const rutaNombre = selectRuta.options[selectRuta.selectedIndex].text.split(' - ')[0];
    const totalClientes = selectRuta.options[selectRuta.selectedIndex].getAttribute('data-total-clientes') || '0';
    const descripcion = selectRuta.options[selectRuta.selectedIndex].getAttribute('data-descripcion') || '';
    
    const resumen = document.getElementById('resumenPedido');
    let html = `
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title border-bottom pb-2 mb-3">
                            <i class="fas fa-layer-group me-2"></i>Información del Consolidado
                        </h6>
                        <p><strong>Empresa:</strong> ${document.getElementById('selectEmpresa').options[document.getElementById('selectEmpresa').selectedIndex].text}</p>
                        <p><strong>Ruta:</strong> ${rutaNombre} ${descripcion ? '- ' + descripcion : ''}</p>
                        <p><strong>Clientes en ruta:</strong> <span class="badge bg-primary">${totalClientes}</span></p>
                        <p><strong>Observaciones:</strong> ${document.getElementById('observacionPedido').value || 'Ninguna'}</p>
                        <p><strong>Tipo Precio:</strong> <span class="badge bg-primary">PRECIO RUTA</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title border-bottom pb-2 mb-3">
                            <i class="fas fa-info-circle me-2"></i>Detalles del Pedido
                        </h6>
                        <p><strong>Fecha:</strong> ${document.getElementById('fechaPedido').value}</p>
                        <p><strong>Prioridad:</strong> <span class="badge ${prioridadBadgeClass}"><i class="${prioridadIcono} me-1"></i>${prioridad}</span></p>
                        <p><strong>Total productos:</strong> <span class="badge bg-success">${productosSeleccionados.length}</span></p>
                    </div>
                </div>
            </div>
        </div>`;
    resumen.innerHTML = html;
    
    const tbodyResumen = document.getElementById('tbodyResumenProductos');
    const totalResumen = document.getElementById('totalResumen');
    
    let htmlResumen = '';
    let total = 0;
    
    productosSeleccionados.forEach((producto, index) => {
        total += producto.subtotal;
        htmlResumen += `
            <tr>
                <td>${index + 1}. ${producto.nombre}<br><small class="text-muted">Código: ${producto.codigo || 'N/A'} | Unidad: ${producto.unidad}</small></td>
                <td class="text-center">${formatNumber(producto.cantidad)}</td>
                <td class="text-end">${formatCurrency(producto.precio)}</td>
                <td class="text-center"><span class="badge ${producto.tipoPrecioClase}">${producto.tipoPrecio}</span></td>
                <td class="text-end fw-bold">${formatCurrency(producto.subtotal)}</td>
            </tr>`;
    });
    
    tbodyResumen.innerHTML = htmlResumen;
    totalResumen.textContent = formatCurrency(total);
    
    const modal = new bootstrap.Modal(document.getElementById('modalConfirmacion'));
    modal.show();
}

// ============================================
// GUARDAR PEDIDO
// ============================================
function guardarPedido() {
    const btnGuardar = document.getElementById('btnConfirmarGuardar');
    const modalElement = document.getElementById('modalConfirmacion');
    const modal = bootstrap.Modal.getInstance(modalElement);
    
    btnGuardar.disabled = true;
    btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';
    
    const datosPedido = {
        empresa_id: document.getElementById('selectEmpresa').value,
        fecha: document.getElementById('fechaPedido').value,
        prioridad: document.getElementById('selectPrioridad').value,
        observacion: document.getElementById('observacionPedido').value,
        id_ruta: document.getElementById('selectRuta').value,
        productos: productosSeleccionados.map(p => ({
            id: p.id,
            nombre: p.nombre,
            precio: p.precio,
            cantidad: p.cantidad
        }))
    };
    
    fetch('/admin/ventas/nuevo-pedido-consolidado', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(datosPedido)
    })
    .then(response => response.json())
    .then(data => {
        modal.hide();
        
        if (data.success) {
            showToast('success', 'Pedido consolidado creado', `Pedido consolidado #${data.pedido_id} creado exitosamente`);
            setTimeout(() => {
                window.location.href = `/admin/ventas/pedido-venta/${data.pedido_id}`;
            }, 1500);
        } else {
            showAlert('error', data.message || 'Error al crear el pedido consolidado');
            btnGuardar.disabled = false;
            btnGuardar.innerHTML = '<i class="fas fa-save me-1"></i> Confirmar y Guardar';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        modal.hide();
        showAlert('error', 'Error al conectar con el servidor');
        btnGuardar.disabled = false;
        btnGuardar.innerHTML = '<i class="fas fa-save me-1"></i> Confirmar y Guardar';
    });
}

// ============================================
// NOTIFICACIONES
// ============================================
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1055; max-width: 400px;';
    alertDiv.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-exclamation-circle'} me-2"></i>
        ${message.replace(/\n/g, '<br>')}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    setTimeout(() => { if (alertDiv.parentNode) alertDiv.remove(); }, 5000);
}

function showToast(type, title, message) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed`;
    toast.style.cssText = 'bottom: 20px; right: 20px; z-index: 1055;';
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <strong>${title}:</strong> ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    toast.addEventListener('hidden.bs.toast', function() { if (toast.parentNode) toast.remove(); });
}
</script>

<style>
.precio-input, .cantidad-input {
    text-align: right;
}
.table th {
    background-color: #f8f9fa;
    font-weight: 600;
}
.badge {
    font-size: 0.85em;
}
.card-header {
    font-weight: 600;
}
#productosCategoriaContainer .card {
    max-height: 500px;
    overflow-y: auto;
}
#resultadosBusqueda {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 10px;
    background-color: #f8f9fa;
}
.btn-group-sm > .btn {
    padding: 0.25rem 0.5rem;
}
.table-hover tbody tr:hover {
    background-color: rgba(0,123,255,0.05);
}
.input-group-sm .form-control {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}
.input-group-text {
    background-color: #f8f9fa;
    border-color: #dee2e6;
    font-weight: 600;
}
.text-success {
    color: #198754 !important;
}
.bg-danger { 
    background-color: #dc3545 !important; 
    color: white !important;
}
.bg-primary { 
    background-color: #0d6efd !important; 
    color: white !important;
}
.bg-secondary { 
    background-color: #6c757d !important; 
    color: white !important;
}
.bg-info { 
    background-color: #0dcaf0 !important; 
    color: white !important;
}
.bg-warning { 
    background-color: #ffc107 !important; 
    color: black !important;
}
#indicadorPrioridad .alert {
    border-left: 4px solid #dc3545;
}
#indicadorPrioridad .alert-danger {
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}
#tablaResumenProductos th {
    background-color: #e9ecef;
    font-weight: 600;
}

/* Estilos específicos para consolidados */
.border-primary {
    border-color: #0d6efd !important;
}
.card-header.bg-info {
    background-color: #0dcaf0 !important;
}
.alert-primary {
    background-color: #cfe2ff;
    border-color: #b6d4fe;
    color: #084298;
}
</style>
{% endblock %}