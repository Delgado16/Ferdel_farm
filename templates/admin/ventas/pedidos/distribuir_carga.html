{% extends "layout.html" %}

{% block title %}Distribuir Carga - Pedido #{{ pedido.ID_Pedido }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- ============================================ -->
    <!-- ENCABEZADO                                   -->
    <!-- ============================================ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>
                <i class="fas fa-truck-loading me-2 text-warning"></i>
                Distribuir Carga Consolidada
            </h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_pedidos_venta') }}">Pedidos</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('ver_pedido', id_pedido=pedido.ID_Pedido) }}">Pedido #{{ pedido.ID_Pedido }}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Distribuir Carga</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="{{ url_for('ver_pedido', id_pedido=pedido.ID_Pedido) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Volver al Pedido
            </a>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- INFORMACIN DEL PEDIDO CONSOLIDADO          -->
    <!-- ============================================ -->
    <div class="card mb-4 border-warning">
        <div class="card-header bg-warning text-white">
            <h5 class="mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Informaci贸n de la Carga Consolidada
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="text-muted small mb-1">N煤mero de Pedido</label>
                        <h4>#{{ pedido.ID_Pedido }}</h4>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="text-muted small mb-1">Ruta de Destino</label>
                        <h4 class="text-warning">
                            <i class="fas fa-route me-2"></i>
                            {{ pedido.Nombre_Ruta }}
                        </h4>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="text-muted small mb-1">Fecha de Carga</label>
                        <h4>
                            <i class="fas fa-calendar me-2"></i>
                            {{ pedido.Fecha.strftime('%d/%m/%Y') }}
                        </h4>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info mt-2 mb-0">
                <div class="d-flex">
                    <div class="flex-shrink-0 me-3">
                        <i class="fas fa-info-circle fa-2x"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="alert-heading mb-1"> 驴Qu茅 va a suceder?</h6>
                        <p class="mb-0">
                            Esta acci贸n <strong>DESCONTAR EL INVENTARIO</strong> de la bodega local y 
                            <strong>ACREDITAR</strong> los productos a los vendedores seleccionados de la ruta 
                            <strong class="text-warning">{{ pedido.Nombre_Ruta }}</strong>.
                        </p>
                        <hr class="my-2">
                        <div class="row">
                            <div class="col-md-6">
                                <span class="badge bg-danger me-2">猬锔 SALIDA</span>
                                <span class="small">Bodega Local</span>
                            </div>
                            <div class="col-md-6">
                                <span class="badge bg-success me-2">猬锔 ENTRADA</span>
                                <span class="small">Inventario de Vendedores (Ruta)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- FORMULARIO DE DISTRIBUCIN                  -->
    <!-- ============================================ -->
    <form id="formDistribucion" method="POST" action="{{ url_for('procesar_carga_consolidada', id_pedido=pedido.ID_Pedido) }}">
        
        <!-- ============================================ -->
        <!-- CONTENEDOR DE INPUTS OCULTOS (DINMICOS)    -->
        <!-- ============================================ -->
        <div id="distribucionInputs"></div>
        
        <!-- ============================================ -->
        <!-- TABLA DE DISTRIBUCIN                       -->
        <!-- ============================================ -->
        <div class="card mb-4">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-people-arrows me-2"></i>
                    Distribuci贸n por Vendedor
                </h5>
                <div>
                    <span class="badge bg-light text-dark me-2" id="totalVendedoresBadge">
                        <i class="fas fa-users me-1"></i> Cargando...
                    </span>
                    <span class="badge bg-info" id="totalProductosBadge">
                        <i class="fas fa-boxes me-1"></i> Cargando...
                    </span>
                </div>
            </div>
            <div class="card-body p-0">
                
                <!-- LOADER -->
                <div id="distribucionLoader" class="text-center py-5">
                    <div class="spinner-border text-warning mb-3" style="width: 3rem; height: 3rem;"></div>
                    <h5 class="text-muted">Cargando vendedores activos y productos...</h5>
                    <p class="text-muted small">Obteniendo asignaciones de la ruta {{ pedido.Nombre_Ruta }}</p>
                </div>
                
                <!-- CONTENIDO DE LA TABLA (SE CARGA DINMICAMENTE) -->
                <div id="distribucionContent" style="display: none;"></div>
                
            </div>
            <div class="card-footer bg-light">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="alert alert-warning mb-0 py-2">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Importante:</strong> Solo se muestran vendedores con asignaci贸n ACTIVA para HOY.
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <button type="button" class="btn btn-sm btn-outline-success" id="btnDistribuirEquitativo" onclick="calcularDistribucionEquitativa()">
                            <i class="fas fa-calculator me-1"></i> Distribuir Equitativamente
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- RESUMEN DE LA DISTRIBUCIN                  -->
        <!-- ============================================ -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-clipboard-list me-2"></i>
                    Resumen de la Distribuci贸n
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-1">Total Productos</h6>
                                <h3 id="resumenTotalProductos">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-1">Unidades a Distribuir</h6>
                                <h3 id="resumenTotalUnidades">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-1">Vendedores</h6>
                                <h3 id="resumenVendedores">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h6 class="mb-1">Valor Total</h6>
                                <h3 id="resumenValorTotal">C$0.00</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- BOTONES DE ACCIN                           -->
        <!-- ============================================ -->
        <div class="d-flex justify-content-between mb-5">
            <a href="{{ url_for('ver_pedido', id_pedido=pedido.ID_Pedido) }}" class="btn btn-secondary btn-lg">
                <i class="fas fa-times me-2"></i> Cancelar
            </a>
            <button type="button" class="btn btn-warning btn-lg" id="btnProcesarDistribucion" onclick="enviarDistribucion()">
                <i class="fas fa-check-circle me-2"></i> Procesar Carga a Ruta
            </button>
        </div>
    </form>
</div>

<!-- ============================================ -->
<!-- SCRIPT DE DISTRIBUCIN                      -->
<!-- ============================================ -->
<script>
// ============================================
// VARIABLES GLOBALES
// ============================================
let vendedoresData = [];
let productosData = [];
let idRuta = {{ pedido.ID_Ruta }};
let idPedido = {{ pedido.ID_Pedido }};
let nombreRuta = "{{ pedido.Nombre_Ruta }}";

// ============================================
// INICIALIZACIN - CARGAR DATOS
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    cargarVendedoresYProductos();
});

// ============================================
// CARGAR VENDEDORES ACTIVOS Y PRODUCTOS
// ============================================
function cargarVendedoresYProductos() {
    Promise.all([
        fetch(`/api/rutas/${idRuta}/vendedores-activos`).then(res => res.json()),
        fetch(`/api/pedidos/${idPedido}/productos-consolidados`).then(res => res.json())
    ])
    .then(([vendedores, productos]) => {
        vendedoresData = vendedores.data || [];
        productosData = productos.data || [];
        
        // Actualizar badges
        document.getElementById('totalVendedoresBadge').innerHTML = `<i class="fas fa-users me-1"></i> ${vendedoresData.length} Vendedores`;
        document.getElementById('totalProductosBadge').innerHTML = `<i class="fas fa-boxes me-1"></i> ${productosData.length} Productos`;
        
        if (vendedoresData.length === 0) {
            mostrarError('No hay vendedores activos asignados a esta ruta para hoy');
            return;
        }
        
        if (productosData.length === 0) {
            mostrarError('El pedido consolidado no tiene productos');
            return;
        }
        
        renderizarTablaDistribucion();
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarError('Error al cargar los datos');
    });
}

// ============================================
// MOSTRAR ERROR
// ============================================
function mostrarError(mensaje) {
    document.getElementById('distribucionLoader').style.display = 'none';
    document.getElementById('distribucionContent').innerHTML = `
        <div class="alert alert-danger m-4">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Error:</strong> ${mensaje}
        </div>
    `;
    document.getElementById('distribucionContent').style.display = 'block';
    document.getElementById('btnProcesarDistribucion').disabled = true;
}

// ============================================
// RENDERIZAR TABLA DE DISTRIBUCIN
// ============================================
function renderizarTablaDistribucion() {
    let html = `
        <div class="table-responsive">
            <table class="table table-bordered table-hover mb-0" id="tablaDistribucion">
                <thead class="table-dark">
                    <tr>
                        <th width="25%">Producto</th>
                        <th width="8%" class="text-center">Stock Consolidado</th>
                        <th width="8%" class="text-center">Stock Disponible</th>
    `;
    
    // Columnas por cada vendedor
    vendedoresData.forEach((v, index) => {
        html += `<th class="text-center vendedor-col" data-vendedor-id="${v.ID_Asignacion}">
                    <div class="fw-bold">${v.Nombre_Completo || v.NombreUsuario}</div>
                    <small class="text-muted">#${v.ID_Asignacion}</small>
                </th>`;
    });
    
    html += `<th width="10%" class="text-center">Total Distribuido</th></tr></thead><tbody>`;
    
    // Filas por cada producto
    productosData.forEach(p => {
        const stockTotal = parseFloat(p.Cantidad_Total);
        const precio = parseFloat(p.Precio_Venta);
        const idProducto = p.ID_Producto;
        const nombreProducto = p.Nombre_Producto;
        const codigo = p.COD_Producto || 'N/A';
        const unidad = p.Unidad_Abrev || 'UN';
        
        html += `
            <tr data-producto-id="${idProducto}" data-stock-total="${stockTotal}" data-precio="${precio}">
                <td>
                    <div class="fw-bold">${nombreProducto}</div>
                    <small class="text-muted">
                        <i class="fas fa-barcode me-1"></i>${codigo} | 
                        <i class="fas fa-box me-1"></i>${unidad} | 
                        <i class="fas fa-tag me-1"></i>C$${precio.toFixed(2)}
                    </small>
                </td>
                <td class="text-center align-middle">
                    <span class="badge bg-primary p-2">${formatNumber(stockTotal)}</span>
                </td>
                <td class="text-center align-middle">
                    <span id="stock-${idProducto}" class="badge bg-success p-2">${formatNumber(stockTotal)}</span>
                </td>
        `;
        
        // Inputs para cada vendedor
        vendedoresData.forEach(v => {
            html += `
                <td class="text-center">
                    <input type="number" 
                           class="form-control form-control-sm text-center distribucion-input"
                           data-producto-id="${idProducto}"
                           data-vendedor-id="${v.ID_Asignacion}"
                           data-producto-nombre="${nombreProducto}"
                           data-vendedor-nombre="${v.Nombre_Completo || v.NombreUsuario}"
                           data-precio="${precio}"
                           min="0"
                           max="${stockTotal}"
                           step="0.01"
                           value="0"
                           onchange="actualizarStockProducto(${idProducto}, ${stockTotal})"
                           onkeyup="actualizarStockProducto(${idProducto}, ${stockTotal})">
                </td>
            `;
        });
        
        html += `
                <td class="text-center align-middle">
                    <span id="total-distribuido-${idProducto}" class="badge bg-info p-2">0</span>
                </td>
            </tr>
        `;
    });
    
    html += `</tbody></table></div>`;
    
    // Ocultar loader y mostrar contenido
    document.getElementById('distribucionLoader').style.display = 'none';
    document.getElementById('distribucionContent').innerHTML = html;
    document.getElementById('distribucionContent').style.display = 'block';
    
    // Actualizar resumen
    actualizarResumen();
}

// ============================================
// ACTUALIZAR STOCK DISPONIBLE POR PRODUCTO
// ============================================
function actualizarStockProducto(idProducto, stockTotal) {
    const inputs = document.querySelectorAll(`.distribucion-input[data-producto-id="${idProducto}"]`);
    let totalDistribuido = 0;
    
    inputs.forEach(input => {
        const cantidad = parseFloat(input.value) || 0;
        totalDistribuido += cantidad;
    });
    
    const stockDisponible = stockTotal - totalDistribuido;
    
    // Actualizar badges
    const stockBadge = document.getElementById(`stock-${idProducto}`);
    const totalBadge = document.getElementById(`total-distribuido-${idProducto}`);
    
    stockBadge.textContent = formatNumber(stockDisponible);
    stockBadge.className = `badge p-2 ${stockDisponible >= 0 ? 'bg-success' : 'bg-danger'}`;
    totalBadge.textContent = formatNumber(totalDistribuido);
    
    // Validar inputs
    inputs.forEach(input => {
        const valor = parseFloat(input.value) || 0;
        if (valor > stockTotal) {
            input.classList.add('is-invalid');
        } else {
            input.classList.remove('is-invalid');
        }
    });
    
    // Actualizar resumen
    actualizarResumen();
}

// ============================================
// ACTUALIZAR RESUMEN DE DISTRIBUCIN
// ============================================
function actualizarResumen() {
    const inputs = document.querySelectorAll('.distribucion-input');
    let totalUnidades = 0;
    let totalValor = 0;
    let vendedoresConAsignacion = new Set();
    let productosConAsignacion = new Set();
    
    inputs.forEach(input => {
        const cantidad = parseFloat(input.value) || 0;
        if (cantidad > 0) {
            totalUnidades += cantidad;
            totalValor += cantidad * parseFloat(input.dataset.precio);
            vendedoresConAsignacion.add(input.dataset.vendedorId);
            productosConAsignacion.add(input.dataset.productoId);
        }
    });
    
    document.getElementById('resumenTotalProductos').textContent = productosConAsignacion.size;
    document.getElementById('resumenTotalUnidades').textContent = formatNumber(totalUnidades);
    document.getElementById('resumenVendedores').textContent = vendedoresConAsignacion.size;
    document.getElementById('resumenValorTotal').textContent = formatCurrency(totalValor);
}

// ============================================
// DISTRIBUIR EQUITATIVAMENTE
// ============================================
function calcularDistribucionEquitativa() {
    const filas = document.querySelectorAll('#tablaDistribucion tbody tr');
    const totalVendedores = vendedoresData.length;
    
    filas.forEach(fila => {
        const idProducto = fila.dataset.productoId;
        const stockTotal = parseFloat(fila.dataset.stockTotal);
        const cantidadPorVendedor = Math.floor(stockTotal / totalVendedores * 100) / 100;
        let cantidadAsignada = 0;
        
        const inputs = document.querySelectorAll(`.distribucion-input[data-producto-id="${idProducto}"]`);
        
        inputs.forEach((input, index) => {
            if (index === inputs.length - 1) {
                // ltimo vendedor recibe el remanente
                const remanente = stockTotal - cantidadAsignada;
                input.value = remanente.toFixed(2);
            } else {
                input.value = cantidadPorVendedor.toFixed(2);
                cantidadAsignada += cantidadPorVendedor;
            }
        });
        
        actualizarStockProducto(parseInt(idProducto), stockTotal);
    });
    
    Swal.fire({
        icon: 'success',
        title: 'Distribuci贸n equitativa',
        text: `Se ha distribuido equitativamente entre los ${totalVendedores} vendedores`,
        timer: 2000,
        showConfirmButton: false
    });
}

// ============================================
// ENVIAR DISTRIBUCIN (FORM TRADICIONAL)
// ============================================
function enviarDistribucion() {
    // Recolectar todos los inputs con valores > 0
    const inputs = document.querySelectorAll('.distribucion-input');
    const distribucion = [];
    let cantidadValida = 0;
    
    inputs.forEach(input => {
        const cantidad = parseFloat(input.value) || 0;
        if (cantidad > 0) {
            // Validar que no exceda el stock
            const maxStock = parseFloat(input.max);
            if (cantidad > maxStock) {
                input.classList.add('is-invalid');
                Swal.fire({
                    icon: 'error',
                    title: 'Stock insuficiente',
                    text: `La cantidad asignada (${cantidad}) excede el stock disponible (${maxStock})`,
                    timer: 3000,
                    showConfirmButton: false
                });
                return;
            }
            
            distribucion.push({
                id_vendedor: input.dataset.vendedorId,
                id_producto: input.dataset.productoId,
                cantidad: cantidad.toFixed(2)
            });
            cantidadValida++;
        }
    });
    
    if (cantidadValida === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Sin asignaciones',
            text: 'Debe asignar al menos un producto a un vendedor',
            timer: 2000,
            showConfirmButton: false
        });
        return;
    }
    
    // Confirmar distribuci贸n
    Swal.fire({
        title: '驴Confirmar distribuci贸n?',
        html: `
            <div class="text-start">
                <p><strong>Ruta:</strong> ${nombreRuta}</p>
                <p><strong>Vendedores a recibir carga:</strong> ${new Set(distribucion.map(d => d.id_vendedor)).size}</p>
                <p><strong>Items a distribuir:</strong> ${cantidadValida}</p>
                <p class="text-warning mb-0"><i class="fas fa-exclamation-triangle me-1"></i> Esta acci贸n descontar谩 el inventario de bodega local</p>
            </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ffc107',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'S铆, procesar carga',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            // Limpiar y llenar inputs ocultos
            const container = document.getElementById('distribucionInputs');
            container.innerHTML = '';
            
            distribucion.forEach((item, index) => {
                container.innerHTML += `
                    <input type="hidden" name="distribucion[${index}][id_vendedor]" value="${item.id_vendedor}">
                    <input type="hidden" name="distribucion[${index}][id_producto]" value="${item.id_producto}">
                    <input type="hidden" name="distribucion[${index}][cantidad]" value="${item.cantidad}">
                `;
            });
            
            // Deshabilitar bot贸n y enviar formulario
            const btn = document.getElementById('btnProcesarDistribucion');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando distribuci贸n...';
            
            document.getElementById('formDistribucion').submit();
        }
    });
}

// ============================================
// FUNCIONES DE FORMATEO
// ============================================
function formatNumber(number) {
    return new Intl.NumberFormat('es-NI', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(number);
}

function formatCurrency(amount) {
    return 'C$' + new Intl.NumberFormat('es-NI', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount);
}
</script>

<!-- ============================================ -->
<!-- ESTILOS                                     -->
<!-- ============================================ -->
<style>
.distribucion-input {
    width: 100px;
    margin: 0 auto;
    text-align: center;
    font-weight: 600;
}

.distribucion-input.is-invalid {
    border-color: #dc3545;
    background-color: #fff8f8;
    border-width: 2px;
}

.vendedor-col {
    min-width: 130px;
    vertical-align: middle;
}

#tablaDistribucion th {
    vertical-align: middle;
    text-align: center;
    background-color: #212529;
    color: white;
}

#tablaDistribucion td {
    vertical-align: middle;
}

.badge {
    font-size: 0.9rem;
}

.card-header.bg-warning {
    background-color: #ffc107 !important;
}

.btn-warning {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #000;
}

.btn-warning:hover {
    background-color: #e0a800;
    border-color: #d39e00;
    color: #000;
}

.table-hover tbody tr:hover {
    background-color: rgba(255, 193, 7, 0.05);
}
</style>
{% endblock %}