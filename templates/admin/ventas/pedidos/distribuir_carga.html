{% extends "layout.html" %}

{% block title %}Distribuir Carga #{{ pedido.ID_Pedido }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-truck-loading me-2 text-warning"></i>Distribuir Carga #{{ pedido.ID_Pedido }}</h2>
            <p class="text-muted">
                Ruta: <strong>{{ pedido.Nombre_Ruta }}</strong> | 
                Fecha: <strong>{{ pedido.Fecha.strftime('%d/%m/%Y') }}</strong>
            </p>
        </div>
        <a href="{{ url_for('ver_pedido', id_pedido=pedido.ID_Pedido) }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Volver
        </a>
    </div>

    {% if not vendedores %}
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>No hay vendedores activos hoy</strong> en la ruta {{ pedido.Nombre_Ruta }}
    </div>
    {% endif %}

    {% if not productos %}
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>El pedido no tiene productos</strong>
    </div>
    {% endif %}

    {% if vendedores and productos %}
    <!-- Detalle de la Carga -->
    <div class="card mb-4 border-warning">
        <div class="card-header bg-warning text-white">
            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Detalle de la Carga</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <h6 class="text-muted mb-1">Pedido</h6>
                    <h4>#{{ pedido.ID_Pedido }}</h4>
                </div>
                <div class="col-md-3">
                    <h6 class="text-muted mb-1">Ruta</h6>
                    <h4 class="text-warning">{{ pedido.Nombre_Ruta }}</h4>
                </div>
                <div class="col-md-3">
                    <h6 class="text-muted mb-1">Fecha</h6>
                    <h4>{{ pedido.Fecha.strftime('%d/%m/%Y') }}</h4>
                </div>
                <div class="col-md-3">
                    <h6 class="text-muted mb-1">Vendedores</h6>
                    <h4><span class="badge bg-info">{{ vendedores|length }} activos</span></h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario -->
    <form method="POST" action="{{ url_for('procesar_carga_consolidada', id_pedido=pedido.ID_Pedido) }}">
        <div id="inputsContainer"></div>
        
        <div class="card">
            <div class="card-header bg-dark text-white">
                <i class="fas fa-people-arrows me-2"></i>Distribuir a Vendedores
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Producto</th>
                                <th class="text-center">Stock</th>
                                {% for v in vendedores %}
                                <th class="text-center">{{ v.NombreUsuario }}</th>
                                {% endfor %}
                                <th class="text-center">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in productos %}
                            <tr>
                                <td>
                                    <strong>{{ p.Nombre_Producto }}</strong>
                                    <br><small class="text-muted">{{ p.COD_Producto }}</small>
                                </td>
                                <td class="text-center align-middle">
                                    <span class="badge bg-primary stock-badge" id="stock-{{ p.ID_Producto }}">
                                        {{ p.Cantidad_Total }}
                                    </span>
                                </td>
                                
                                {% for v in vendedores %}
                                <td class="text-center">
                                    <input type="number" 
                                           class="form-control form-control-sm text-center input-cantidad"
                                           data-producto="{{ p.ID_Producto }}"
                                           data-vendedor="{{ v.ID_Asignacion }}"
                                           data-max="{{ p.Cantidad_Total }}"
                                           data-precio="{{ p.Precio_Venta }}"
                                           min="0"
                                           max="{{ p.Cantidad_Total }}"
                                           step="0.01"
                                           value="0"
                                           onchange="actualizarProducto({{ p.ID_Producto }}, {{ p.Cantidad_Total }})">
                                </td>
                                {% endfor %}
                                
                                <td class="text-center align-middle">
                                    <span class="badge bg-info" id="total-{{ p.ID_Producto }}">0</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="row">
                    <div class="col-md-6">
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="distribuirTodo()">
                            <i class="fas fa-calculator me-1"></i> Distribuir equitativamente
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumen -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Productos</h6>
                        <h3 id="resumen-productos">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Unidades</h6>
                        <h3 id="resumen-unidades">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Vendedores</h6>
                        <h3 id="resumen-vendedores">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h6>Valor Total</h6>
                        <h3 id="resumen-valor">C$0.00</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones -->
        <div class="d-flex justify-content-between mt-4 mb-5">
            <a href="{{ url_for('ver_pedido', id_pedido=pedido.ID_Pedido) }}" class="btn btn-secondary">
                <i class="fas fa-times me-1"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-warning" id="btnGuardar">
                <i class="fas fa-check me-1"></i> Procesar Carga
            </button>
        </div>
    </form>
    {% endif %}
</div>

<script>
function actualizarProducto(idProducto, stockTotal) {
    const inputs = document.querySelectorAll(`.input-cantidad[data-producto="${idProducto}"]`);
    let total = 0;
    
    inputs.forEach(input => {
        total += parseFloat(input.value) || 0;
    });
    
    document.getElementById(`stock-${idProducto}`).textContent = (stockTotal - total).toFixed(2);
    document.getElementById(`total-${idProducto}`).textContent = total.toFixed(2);
    
    actualizarResumen();
}

function actualizarResumen() {
    const inputs = document.querySelectorAll('.input-cantidad');
    let totalUnidades = 0;
    let totalValor = 0;
    let vendedoresSet = new Set();
    let productosSet = new Set();
    
    inputs.forEach(input => {
        const cantidad = parseFloat(input.value) || 0;
        if (cantidad > 0) {
            totalUnidades += cantidad;
            totalValor += cantidad * parseFloat(input.dataset.precio);
            vendedoresSet.add(input.dataset.vendedor);
            productosSet.add(input.dataset.producto);
        }
    });
    
    document.getElementById('resumen-productos').textContent = productosSet.size;
    document.getElementById('resumen-unidades').textContent = totalUnidades.toFixed(2);
    document.getElementById('resumen-vendedores').textContent = vendedoresSet.size;
    document.getElementById('resumen-valor').textContent = 'C$' + totalValor.toFixed(2);
}

function distribuirTodo() {
    const filas = document.querySelectorAll('tbody tr');
    const totalVendedores = {{ vendedores|length }};
    
    filas.forEach(fila => {
        const inputs = fila.querySelectorAll('.input-cantidad');
        if (inputs.length === 0) return;
        
        const stockTotal = parseFloat(inputs[0].dataset.max);
        const cantidadBase = Math.floor((stockTotal / totalVendedores) * 100) / 100;
        let suma = 0;
        
        inputs.forEach((input, index) => {
            if (index === inputs.length - 1) {
                input.value = (stockTotal - suma).toFixed(2);
            } else {
                input.value = cantidadBase.toFixed(2);
                suma += cantidadBase;
            }
        });
        
        const idProducto = inputs[0].dataset.producto;
        actualizarProducto(idProducto, stockTotal);
    });
}

document.querySelector('form').addEventListener('submit', function(e) {
    const inputs = document.querySelectorAll('.input-cantidad');
    const container = document.getElementById('inputsContainer');
    container.innerHTML = '';
    
    let index = 0;
    let hayAsignacion = false;
    
    inputs.forEach(input => {
        const cantidad = parseFloat(input.value) || 0;
        const max = parseFloat(input.dataset.max);
        
        if (cantidad > max) {
            e.preventDefault();
            alert('Hay cantidades que exceden el stock');
            return;
        }
        
        if (cantidad > 0) {
            hayAsignacion = true;
            container.innerHTML += `
                <input type="hidden" name="distribucion[${index}][id_vendedor]" value="${input.dataset.vendedor}">
                <input type="hidden" name="distribucion[${index}][id_producto]" value="${input.dataset.producto}">
                <input type="hidden" name="distribucion[${index}][cantidad]" value="${cantidad.toFixed(2)}">
            `;
            index++;
        }
    });
    
    if (!hayAsignacion) {
        e.preventDefault();
        alert('Debe asignar al menos un producto');
    }
});
</script>

<style>
.input-cantidad {
    width: 90px;
    margin: 0 auto;
    text-align: center;
}
</style>
{% endblock %}