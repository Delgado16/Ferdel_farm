{% extends "layout.html" %}

{% block title %}Nuevo Pedido{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-plus-circle me-2"></i>Nuevo Pedido</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_pedidos_venta') }}">Pedidos</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Nuevo Pedido Individual</li>
                </ol>
            </nav>
            <div class="alert alert-primary mt-2 mb-0">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Pedido Individual:</strong> Asignado a un cliente espec√≠fico. El precio se calcula seg√∫n el perfil del cliente (Ruta, Mayorista, Mercado o Especial).
            </div>
        </div>
        <div>
            <div class="btn-group">
                <a href="{{ url_for('admin_pedidos_venta') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Cancelar
                </a>
                <a href="{{ url_for('nuevo_pedido_consolidado') }}" class="btn btn-outline-info">
                    <i class="fas fa-layer-group me-1"></i> Ir a Pedido Consolidado
                </a>
            </div>
        </div>
    </div>
    
    <!-- Formulario de Pedido -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Datos del Pedido Individual</h5>
        </div>
        <div class="card-body">
            <form id="formPedido">
                <div class="row g-3">
                    <!-- Datos del Cliente -->
                    <div class="col-md-6">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-user me-2"></i>Datos del Cliente
                        </h5>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Seleccionar Cliente:</label>
                            <select id="selectCliente" class="form-select select2" required>
                                <option value="">Seleccione un cliente...</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.ID_Cliente }}" 
                                        data-nombre="{{ cliente.Nombre }}"
                                        data-telefono="{{ cliente.Telefono or '' }}"
                                        data-direccion="{{ cliente.Direccion or '' }}"
                                        data-ruc="{{ cliente.RUC_CEDULA or '' }}"
                                        data-tipo="{{ cliente.tipo_cliente or 'Comun' }}"
                                        data-perfil="{{ cliente.perfil_cliente or 'Mercado' }}"
                                        data-ruta="{{ cliente.ID_Ruta or '' }}"
                                        {% if cliente_seleccionado and cliente_seleccionado.ID_Cliente == cliente.ID_Cliente %}selected{% endif %}>
                                    {{ cliente.Nombre }} - {{ cliente.RUC_CEDULA or 'Sin documento' }} ({{ cliente.perfil_cliente }})
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                El precio se calcular√° seg√∫n el perfil del cliente
                            </small>
                        </div>
                        
                        <div id="clienteInfo" class="p-3 bg-light rounded" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Nombre:</small>
                                        <span id="clienteNombre" class="fw-bold"></span>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Documento:</small>
                                        <span id="clienteRUC" class="badge bg-dark"></span>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Tel√©fono:</small>
                                        <span id="clienteTelefono"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Direcci√≥n:</small>
                                        <span id="clienteDireccion"></span>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Tipo Cliente:</small>
                                        <span id="clienteTipo" class="badge"></span>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Perfil / Precio:</small>
                                        <span id="clientePerfil" class="badge bg-info"></span>
                                        <span id="tipoPrecio" class="badge bg-success ms-1"></span>
                                    </div>
                                    {% if cliente_seleccionado and cliente_seleccionado.ID_Ruta %}
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Ruta asignada:</small>
                                        <span id="clienteRuta" class="badge bg-secondary"></span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- B√∫squeda r√°pida de productos -->
                        <div class="mt-3">
                            <label class="form-label fw-bold">B√∫squeda r√°pida de productos:</label>
                            <div class="input-group">
                                <input type="text" id="buscarProducto" class="form-control" 
                                       placeholder="Buscar producto por nombre o c√≥digo..."
                                       disabled>
                                <button class="btn btn-outline-secondary" type="button" 
                                        id="btnBuscarProducto" disabled>
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div id="resultadosBusqueda" class="mt-2" style="display: none;"></div>
                        </div>
                    </div>
                    
                    <!-- Datos del Pedido -->
                    <div class="col-md-6">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-info-circle me-2"></i>Informaci√≥n del Pedido
                        </h5>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Fecha:</label>
                                <input type="date" id="fechaPedido" class="form-control" required 
                                       value="{{ now.strftime('%Y-%m-%d') }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Empresa:</label>
                                <select id="selectEmpresa" class="form-select" required>
                                    <option value="">Seleccione empresa...</option>
                                    {% for empresa in empresas %}
                                    <option value="{{ empresa.ID_Empresa }}">
                                        {{ empresa.Nombre_Empresa }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Prioridad:</label>
                                <select id="selectPrioridad" class="form-select" required>
                                    {% for prioridad in prioridades %}
                                    <option value="{{ prioridad }}" {% if prioridad == 'Normal' %}selected{% endif %}>
                                        {{ prioridad }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Urgente: Entrega inmediata, Normal: Entrega est√°ndar, Bajo: Sin urgencia
                                </small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Tipo de Entrega:</label>
                                <select id="selectTipoEntrega" class="form-select" required>
                                    <option value="Retiro en local">Retiro en local</option>
                                    <option value="Entrega a domicilio">Entrega a domicilio</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">Observaciones:</label>
                                <textarea id="observacionPedido" class="form-control" rows="2" 
                                          placeholder="Agregue observaciones o notas adicionales..."></textarea>
                            </div>
                        </div>
                        
                        <!-- Indicador de prioridad -->
                        <div class="mt-3" id="indicadorPrioridad" style="display: none;">
                            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-3">
                                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="alert-heading mb-1">Pedido Urgente</h6>
                                        <p class="mb-0 small">
                                            Este pedido ser√° marcado como <strong>URGENTE</strong> y tendr√° prioridad 
                                            en el procesamiento y entrega. Aseg√∫rese de contar con el stock necesario.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Selecci√≥n de Productos -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-boxes me-2"></i>Productos del Pedido
                        </h5>
                        
                        <!-- Mensaje de error/sin cliente -->
                        <div id="mensajeSinCliente" class="alert alert-info mb-3" style="display: none;">
                            <i class="fas fa-info-circle me-2"></i>
                            Seleccione un cliente para ver las categor√≠as disponibles
                        </div>
                        
                        <!-- Categor√≠as -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Categor√≠as disponibles:</label>
                            <div id="categoriasContainer" class="d-flex flex-wrap gap-2">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>
                        
                        <!-- Productos por Categor√≠a -->
                        <div id="productosContainer" style="display: none;">
                            <h6 class="mb-3">Seleccione productos por categor√≠a:</h6>
                            <div id="productosCategoriaContainer">
                                <!-- Aqu√≠ se cargan los productos din√°micamente -->
                            </div>
                        </div>
                        
                        <!-- Tabla de Productos Seleccionados -->
                        <div class="mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Productos seleccionados:</h6>
                                <div>
                                    <span id="contadorProductos" class="badge bg-primary me-2">0 productos</span>
                                    <span id="indicadorTotal" class="badge bg-success">Total: C$ 0.00</span>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-bordered" id="tablaProductosSeleccionados">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="50">#</th>
                                            <th>Producto</th>
                                            <th width="120">Tipo Precio</th>
                                            <th width="150">Precio Unitario</th>
                                            <th width="150">Cantidad</th>
                                            <th width="150">Subtotal</th>
                                            <th width="100">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyProductos">
                                        <tr id="filaVacia">
                                            <td colspan="7" class="text-center text-muted py-4">
                                                <i class="fas fa-box-open fa-2x mb-2 d-block"></i>
                                                No hay productos seleccionados
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot id="tfootTotales" style="display: none;">
                                        <tr class="table-active">
                                            <td colspan="5" class="text-end fw-bold">TOTAL:</td>
                                            <td class="fw-bold text-success fs-5" id="totalPedido">C$ 0.00</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Botones de Acci√≥n -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                                    <i class="fas fa-times me-1"></i> Cancelar
                                </button>
                                <a href="{{ url_for('nuevo_pedido_consolidado') }}" class="btn btn-outline-info ms-2">
                                    <i class="fas fa-layer-group me-1"></i> Crear Pedido Consolidado
                                </a>
                            </div>
                            <button type="submit" class="btn btn-success" id="btnGuardar" disabled>
                                <i class="fas fa-save me-1"></i> Guardar Pedido
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para ver stock detallado -->
<div class="modal fade" id="modalStockDetalle" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Stock Disponible por Bodega</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 id="modalProductoNombre" class="mb-3"></h6>
                <div id="contenidoStock" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para confirmar -->
<div class="modal fade" id="modalConfirmacion" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-shopping-cart me-2"></i>Confirmar Pedido
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-3">
                            <i class="fas fa-info-circle fa-2x"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="alert-heading mb-1">Resumen del pedido</h6>
                            <p class="mb-0">El pedido se crear√° con estado "Pendiente" y se descontar√° del stock de bodega.</p>
                        </div>
                    </div>
                </div>
                <div id="resumenPedido"></div>
                
                <!-- Resumen de productos -->
                <div class="mt-3">
                    <h6 class="mb-3">Detalle de productos:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered" id="tablaResumenProductos">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">Precio Unit.</th>
                                    <th class="text-center">Tipo Precio</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyResumenProductos">
                                <!-- Aqu√≠ se cargar√°n los productos -->
                            </tbody>
                            <tfoot>
                                <tr class="table-active">
                                    <td colspan="4" class="text-end fw-bold">TOTAL:</td>
                                    <td class="text-end fw-bold text-success" id="totalResumen">C$ 0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnConfirmarGuardar">
                    <i class="fas fa-save me-1"></i> Confirmar y Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================
// VARIABLES GLOBALES Y CONFIGURACI√ìN
// ============================================
let productosSeleccionados = [];
let tipoClienteActual = null;
let perfilClienteActual = null;

// ============================================
// FUNCIONES DE UTILIDAD
// ============================================

// Funci√≥n para formatear n√∫meros en formato de moneda C√≥rdobas Nicarag√ºenses
function formatCurrency(amount) {
    return new Intl.NumberFormat('es-NI', {
        style: 'currency',
        currency: 'NIO',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount).replace('NIO', 'C$');
}

// Funci√≥n para formatear n√∫meros con separadores de miles
function formatNumber(number) {
    return new Intl.NumberFormat('es-NI').format(number);
}

// Obtener clase CSS para badge de prioridad
function getBadgeClassPrioridad(prioridad) {
    switch(prioridad) {
        case 'Urgente': return 'bg-danger';
        case 'Normal': return 'bg-primary';
        case 'Bajo': return 'bg-secondary';
        default: return 'bg-info';
    }
}

// Obtener icono para prioridad
function getIconoPrioridad(prioridad) {
    switch(prioridad) {
        case 'Urgente': return 'fas fa-exclamation-triangle';
        case 'Normal': return 'fas fa-bars';
        case 'Bajo': return 'fas fa-angle-down';
        default: return 'fas fa-info-circle';
    }
}

// Obtener badge y texto seg√∫n perfil
function getPerfilBadge(perfil) {
    switch(perfil) {
        case 'Ruta':
            return { clase: 'bg-info', texto: 'Precio Ruta' };
        case 'Mayorista':
            return { clase: 'bg-success', texto: 'Precio Mayorista' };
        case 'Mercado':
            return { clase: 'bg-warning text-dark', texto: 'Precio Mercado' };
        case 'Especial':
            return { clase: 'bg-secondary', texto: 'Precio Especial' };
        default:
            return { clase: 'bg-secondary', texto: 'Precio Mercado' };
    }
}

// ============================================
// INICIALIZACI√ìN CORREGIDA (SIN SELECT2)
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inicializando formulario de pedido individual');
    
    // Configurar fecha actual por defecto
    const fechaInput = document.getElementById('fechaPedido');
    if (fechaInput && !fechaInput.value) {
        fechaInput.value = new Date().toISOString().split('T')[0];
    }
    
    // Mostrar mensaje inicial
    const mensajeSinCliente = document.getElementById('mensajeSinCliente');
    if (mensajeSinCliente) {
        mensajeSinCliente.style.display = 'block';
    }
    
    console.log('‚ÑπÔ∏è Usando select nativo (sin Select2)');
    
    // Verificar si hay cliente preseleccionado
    const clienteSelect = document.getElementById('selectCliente');
    if (clienteSelect && clienteSelect.value) {
        console.log('üîç Cliente preseleccionado detectado, ID:', clienteSelect.value);
        procesarClienteSeleccionado();
    }
    
    // Evento change para el select normal
    if (clienteSelect) {
        clienteSelect.addEventListener('change', procesarClienteSeleccionado);
    }
    
    // Evento para cambio de prioridad
    const selectPrioridad = document.getElementById('selectPrioridad');
    if (selectPrioridad) {
        selectPrioridad.addEventListener('change', function() {
            mostrarIndicadorPrioridad(this.value);
            validarFormulario();
        });
    }
    
    // B√∫squeda de productos
    const btnBuscar = document.getElementById('btnBuscarProducto');
    const inputBuscar = document.getElementById('buscarProducto');
    
    if (btnBuscar) {
        btnBuscar.addEventListener('click', buscarProductos);
    }
    
    if (inputBuscar) {
        inputBuscar.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                buscarProductos();
            }
        });
    }
    
    // Eventos para validaci√≥n
    const selectEmpresa = document.getElementById('selectEmpresa');
    const fechaPedido = document.getElementById('fechaPedido');
    const selectTipoEntrega = document.getElementById('selectTipoEntrega');
    
    if (selectEmpresa) selectEmpresa.addEventListener('change', validarFormulario);
    if (fechaPedido) fechaPedido.addEventListener('change', validarFormulario);
    if (selectTipoEntrega) selectTipoEntrega.addEventListener('change', validarFormulario);
    
    // Modal de stock
    const modalStock = document.getElementById('modalStockDetalle');
    if (modalStock) {
        modalStock.addEventListener('hidden.bs.modal', function() {
            document.getElementById('contenidoStock').innerHTML = 
                '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div>';
        });
    }
    
    // Modal de confirmaci√≥n
    const modalConfirmacion = document.getElementById('modalConfirmacion');
    if (modalConfirmacion) {
        modalConfirmacion.addEventListener('hidden.bs.modal', function () {
            const btnGuardar = document.getElementById('btnConfirmarGuardar');
            if (btnGuardar) {
                btnGuardar.disabled = false;
                btnGuardar.innerHTML = '<i class="fas fa-save me-1"></i> Confirmar y Guardar';
            }
        });
    }
    
    // Verificar prioridad inicial
    if (selectPrioridad) {
        mostrarIndicadorPrioridad(selectPrioridad.value);
    }
    
    // Prevenir env√≠o del formulario
    const formPedido = document.getElementById('formPedido');
    if (formPedido) {
        formPedido.addEventListener('submit', function(e) {
            e.preventDefault();
            validarYConfirmarPedido();
        });
    }
    
    // Bot√≥n de confirmar
    const btnConfirmar = document.getElementById('btnConfirmarGuardar');
    if (btnConfirmar) {
        btnConfirmar.addEventListener('click', function() {
            guardarPedido();
        });
    }
    
    // Inicializar contador
    actualizarContadorProductos();
    validarFormulario();
});

// ============================================
// FUNCI√ìN CORREGIDA PARA PROCESAR CLIENTE
// ============================================
function procesarClienteSeleccionado() {
    console.log('üë§ Procesando selecci√≥n de cliente');
    
    const select = document.getElementById('selectCliente');
    if (!select) return;
    
    const option = select.options[select.selectedIndex];
    
    // Ocultar mensaje inicial
    const mensajeSinCliente = document.getElementById('mensajeSinCliente');
    if (mensajeSinCliente) {
        mensajeSinCliente.style.display = 'none';
    }
    
    if (!option || !option.value) {
        console.log('‚ÑπÔ∏è No hay cliente seleccionado');
        ocultarInfoCliente();
        deshabilitarBusquedaProductos();
        limpiarCategorias();
        productosSeleccionados = [];
        actualizarTablaProductos();
        validarFormulario();
        return;
    }
    
    // Obtener datos del cliente con valores por defecto
    const tipo = option.getAttribute('data-tipo') || 'Comun';
    const perfil = option.getAttribute('data-perfil') || 'Mercado';
    
    console.log('üìä Datos del cliente:', {
        id: option.value,
        nombre: option.getAttribute('data-nombre'),
        tipo: tipo,
        perfil: perfil,
        ruta: option.getAttribute('data-ruta')
    });
    
    // Validar que tengamos los datos necesarios
    if (!tipo || !perfil) {
        console.error('‚ùå Cliente sin tipo o perfil');
        showAlert('warning', 'El cliente seleccionado no tiene tipo o perfil asignado');
        ocultarInfoCliente();
        deshabilitarBusquedaProductos();
        limpiarCategorias();
        return;
    }
    
    // Asignar variables globales
    tipoClienteActual = tipo;
    perfilClienteActual = perfil;
    
    // Mostrar informaci√≥n del cliente
    mostrarInfoCliente(option);
    
    // Habilitar b√∫squeda
    habilitarBusquedaProductos();
    
    // Cargar categor√≠as
    cargarCategoriasDisponibles(tipoClienteActual);
    
    // Limpiar productos seleccionados al cambiar de cliente
    productosSeleccionados = [];
    actualizarTablaProductos();
    
    validarFormulario();
}

// ============================================
// FUNCIONES DE INTERFAZ DE CLIENTE
// ============================================

// Mostrar informaci√≥n del cliente desde option
function mostrarInfoCliente(option) {
    const infoDiv = document.getElementById('clienteInfo');
    if (!infoDiv) return;
    
    const nombre = option.getAttribute('data-nombre') || 'N/A';
    const telefono = option.getAttribute('data-telefono') || 'No especificado';
    const direccion = option.getAttribute('data-direccion') || 'No especificada';
    const ruc = option.getAttribute('data-ruc') || 'Sin documento';
    const tipo = option.getAttribute('data-tipo') || 'Comun';
    const perfil = option.getAttribute('data-perfil') || 'Mercado';
    const idRuta = option.getAttribute('data-ruta');
    
    const clienteNombre = document.getElementById('clienteNombre');
    const clienteTelefono = document.getElementById('clienteTelefono');
    const clienteDireccion = document.getElementById('clienteDireccion');
    const clienteRUC = document.getElementById('clienteRUC');
    const clienteTipo = document.getElementById('clienteTipo');
    const clientePerfil = document.getElementById('clientePerfil');
    const tipoPrecio = document.getElementById('tipoPrecio');
    const clienteRuta = document.getElementById('clienteRuta');
    
    if (clienteNombre) clienteNombre.textContent = nombre;
    if (clienteTelefono) clienteTelefono.textContent = telefono;
    if (clienteDireccion) clienteDireccion.textContent = direccion;
    if (clienteRUC) clienteRUC.textContent = ruc;
    
    if (clienteTipo) {
        clienteTipo.textContent = tipo;
        clienteTipo.className = `badge ${tipo === 'Especial' ? 'bg-primary' : 'bg-secondary'}`;
    }
    
    // Mostrar perfil y tipo de precio
    if (clientePerfil) clientePerfil.textContent = perfil;
    
    const badgeInfo = getPerfilBadge(perfil);
    if (tipoPrecio) {
        tipoPrecio.textContent = badgeInfo.texto;
        tipoPrecio.className = `badge ${badgeInfo.clase} ms-1`;
    }
    
    // Mostrar ruta si existe
    if (clienteRuta) {
        if (idRuta && idRuta !== 'None' && idRuta !== '') {
            clienteRuta.textContent = 'Ruta asignada';
            clienteRuta.style.display = 'inline';
        } else {
            clienteRuta.style.display = 'none';
        }
    }
    
    infoDiv.style.display = 'block';
}

function ocultarInfoCliente() {
    const infoDiv = document.getElementById('clienteInfo');
    if (infoDiv) infoDiv.style.display = 'none';
}

function limpiarCategorias() {
    const categoriasContainer = document.getElementById('categoriasContainer');
    const productosContainer = document.getElementById('productosContainer');
    const productosCategoria = document.getElementById('productosCategoriaContainer');
    
    if (categoriasContainer) categoriasContainer.innerHTML = '';
    if (productosContainer) productosContainer.style.display = 'none';
    if (productosCategoria) productosCategoria.innerHTML = '';
}

function mostrarIndicadorPrioridad(prioridad) {
    const indicador = document.getElementById('indicadorPrioridad');
    if (!indicador) return;
    
    if (prioridad === 'Urgente') {
        indicador.style.display = 'block';
        const alert = indicador.querySelector('.alert');
        const icono = alert.querySelector('i');
        const titulo = alert.querySelector('.alert-heading');
        const descripcion = alert.querySelector('p');
        
        if (icono) icono.className = getIconoPrioridad(prioridad) + ' fa-2x';
        if (alert) alert.className = 'alert alert-danger alert-dismissible fade show';
        if (titulo) titulo.textContent = 'Pedido Urgente';
        if (descripcion) {
            descripcion.innerHTML = `Este pedido ser√° marcado como <strong class="text-uppercase">${prioridad}</strong> y tendr√° prioridad m√°xima en el procesamiento y entrega.`;
        }
    } else {
        indicador.style.display = 'none';
    }
}

function habilitarBusquedaProductos() {
    const buscarInput = document.getElementById('buscarProducto');
    const btnBuscar = document.getElementById('btnBuscarProducto');
    
    if (buscarInput) buscarInput.disabled = false;
    if (btnBuscar) btnBuscar.disabled = false;
}

function deshabilitarBusquedaProductos() {
    const buscarInput = document.getElementById('buscarProducto');
    const btnBuscar = document.getElementById('btnBuscarProducto');
    
    if (buscarInput) buscarInput.disabled = true;
    if (btnBuscar) btnBuscar.disabled = true;
}

// ============================================
// FUNCIONES DE CATEGOR√çAS
// ============================================

function cargarCategoriasDisponibles(tipoCliente) {
    console.log('üìÇ Iniciando carga de categor√≠as para tipo:', tipoCliente);
    
    // VALIDACI√ìN CR√çTICA
    if (!tipoCliente || tipoCliente.trim() === '') {
        console.error('‚ùå ERROR: tipoCliente es inv√°lido:', tipoCliente);
        const container = document.getElementById('categoriasContainer');
        if (container) {
            container.innerHTML = `
                <div class="alert alert-danger w-100">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error: El cliente no tiene tipo asignado. Verifique la configuraci√≥n.
                </div>`;
        }
        const productosContainer = document.getElementById('productosContainer');
        if (productosContainer) productosContainer.style.display = 'none';
        return;
    }
    
    const container = document.getElementById('categoriasContainer');
    if (!container) return;
    
    container.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div>';
    
    const url = `/admin/ventas/obtener-categorias-visibles?tipo_cliente=${encodeURIComponent(tipoCliente)}`;
    console.log('üîç URL categor√≠as:', url);
    
    fetch(url)
        .then(response => {
            console.log('üì• Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('üì¶ Datos de categor√≠as recibidos:', data);
            
            if (data.error) {
                container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }
            
            const categorias = data.categorias || [];
            console.log('üìä N√∫mero de categor√≠as:', categorias.length);
            
            if (categorias.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning w-100">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No hay categor√≠as disponibles para este tipo de cliente
                    </div>`;
                const productosContainer = document.getElementById('productosContainer');
                if (productosContainer) productosContainer.style.display = 'none';
                return;
            }
            
            container.innerHTML = '';
            categorias.forEach(categoria => {
                console.log('‚ûï Creando bot√≥n para categor√≠a:', categoria);
                const boton = document.createElement('button');
                boton.type = 'button';
                boton.className = 'btn btn-outline-primary mb-2 me-2';
                boton.innerHTML = `<i class="fas fa-folder me-2"></i>${categoria.nombre}`;
                boton.onclick = () => cargarProductosCategoria(categoria.id, categoria.nombre);
                container.appendChild(boton);
            });
            
            const productosContainer = document.getElementById('productosContainer');
            if (productosContainer) productosContainer.style.display = 'block';
        })
        .catch(error => {
            console.error('‚ùå Error detallado:', error);
            container.innerHTML = `<div class="alert alert-danger">Error al cargar categor√≠as: ${error.message}</div>`;
        });
}

// ============================================
// FUNCIONES DE PRODUCTOS
// ============================================

function cargarProductosCategoria(categoriaId, categoriaNombre) {
    console.log('üì¶ Cargando productos para categor√≠a:', categoriaId, categoriaNombre);
    
    if (!categoriaId) {
        console.error('‚ùå categoriaId es inv√°lido');
        return;
    }
    
    if (!tipoClienteActual || !perfilClienteActual) {
        console.error('‚ùå No hay tipo/perfil de cliente:', {tipoClienteActual, perfilClienteActual});
        showAlert('warning', 'Seleccione un cliente v√°lido primero');
        return;
    }
    
    const container = document.getElementById('productosCategoriaContainer');
    if (!container) return;
    
    container.innerHTML = `
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                    <i class="fas fa-folder me-2"></i>${categoriaNombre}
                    <button type="button" class="btn btn-sm btn-outline-light float-end" 
                            onclick="cerrarProductosCategoria()">
                        <i class="fas fa-times"></i>
                    </button>
                </h6>
            </div>
            <div class="card-body">
                <div class="row" id="productosGrid-${categoriaId}">
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando productos...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    
    const url = `/admin/ventas/obtener-productos-categoria?categoria_id=${categoriaId}&tipo_cliente=${encodeURIComponent(tipoClienteActual)}&perfil_cliente=${encodeURIComponent(perfilClienteActual)}`;
    console.log('üîç URL productos:', url);
    
    fetch(url)
        .then(response => {
            console.log('üì• Response status productos:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üì¶ Datos de productos recibidos:', data);
            
            const grid = document.getElementById(`productosGrid-${categoriaId}`);
            if (!grid) return;
            
            if (data.error) {
                grid.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }
            
            const productos = data.productos || [];
            console.log('üìä N√∫mero de productos:', productos.length);
            
            if (productos.length === 0) {
                grid.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No hay productos disponibles en esta categor√≠a
                        </div>
                    </div>`;
                return;
            }
            
            grid.innerHTML = '';
            productos.forEach(producto => {
                const badgeInfo = getPerfilBadge(perfilClienteActual);
                
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4 mb-3';
                
                col.innerHTML = `
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title">${producto.nombre}</h6>
                            <div class="card-text small text-muted mb-2">
                                <span class="badge bg-dark">${producto.codigo || 'N/A'}</span>
                                <span class="badge bg-info">${producto.unidad_abreviatura || 'Und'}</span>
                            </div>
                            <p class="card-text small mb-2">
                                <i class="fas fa-box me-1"></i> Stock total: <span class="badge bg-success">${formatNumber(producto.stock)}</span>
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="fw-bold text-success">${formatCurrency(producto.precio)}</span>
                                    <br><span class="badge ${badgeInfo.clase} mt-1">${badgeInfo.texto}</span>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-info me-1" 
                                            onclick="verStockProducto(${producto.id}, '${producto.nombre.replace(/'/g, "\\'")}')"
                                            title="Ver stock por bodega">
                                        <i class="fas fa-warehouse"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-primary" 
                                            onclick="agregarProducto(${JSON.stringify(producto).replace(/"/g, '&quot;')})">
                                        <i class="fas fa-plus me-1"></i> Agregar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                grid.appendChild(col);
            });
        })
        .catch(error => {
            console.error('‚ùå Error en productos:', error);
            const grid = document.getElementById(`productosGrid-${categoriaId}`);
            if (grid) {
                grid.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        });
}

function cerrarProductosCategoria() {
    const container = document.getElementById('productosCategoriaContainer');
    if (container) container.innerHTML = '';
}

// ============================================
// B√öSQUEDA DE PRODUCTOS
// ============================================

function buscarProductos() {
    const inputBuscar = document.getElementById('buscarProducto');
    if (!inputBuscar) return;
    
    const termino = inputBuscar.value.trim();
    if (termino.length < 2) {
        showAlert('warning', 'Ingrese al menos 2 caracteres para buscar');
        return;
    }
    
    if (!tipoClienteActual || !perfilClienteActual) {
        showAlert('warning', 'Seleccione un cliente primero');
        return;
    }
    
    const resultadosDiv = document.getElementById('resultadosBusqueda');
    if (!resultadosDiv) return;
    
    resultadosDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Buscando...</span></div>';
    resultadosDiv.style.display = 'block';
    
    const url = `/admin/ventas/buscar-productos?q=${encodeURIComponent(termino)}&tipo_cliente=${encodeURIComponent(tipoClienteActual)}&perfil_cliente=${encodeURIComponent(perfilClienteActual)}`;
    console.log('üîç Buscando productos URL:', url);
    
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(productos => {
            console.log('üì¶ Productos encontrados:', productos);
            
            if (productos.error) {
                resultadosDiv.innerHTML = `<div class="alert alert-danger">${productos.error}</div>`;
                return;
            }
            
            if (productos.length === 0) {
                resultadosDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-search me-2"></i>
                        No se encontraron productos
                    </div>`;
                return;
            }
            
            const badgeInfo = getPerfilBadge(perfilClienteActual);
            
            let html = '<div class="list-group">';
            productos.forEach(producto => {
                html += `
                    <div class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${producto.nombre}</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted">
                                            C√≥digo: ${producto.codigo || 'N/A'} | 
                                            Stock total: <span class="badge bg-info">${formatNumber(producto.stock)}</span> |
                                            Categor√≠a: ${producto.categoria || 'N/A'}
                                        </small>
                                    </div>
                                    <div>
                                        <span class="fw-bold text-success me-3">${formatCurrency(producto.precio)}</span>
                                        <span class="badge ${badgeInfo.clase} me-2">${badgeInfo.texto}</span>
                                        <button type="button" class="btn btn-sm btn-outline-info" 
                                                onclick="verStockProducto(${producto.id}, '${producto.nombre.replace(/'/g, "\\'")}')"
                                                title="Ver stock por bodega">
                                            <i class="fas fa-warehouse"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-primary ms-1" 
                                                onclick="agregarProductoDesdeBusqueda(${JSON.stringify(producto).replace(/"/g, '&quot;')})">
                                            <i class="fas fa-plus me-1"></i> Agregar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            });
            html += '</div>';
            resultadosDiv.innerHTML = html;
        })
        .catch(error => {
            console.error('‚ùå Error en b√∫squeda:', error);
            resultadosDiv.innerHTML = `<div class="alert alert-danger">Error al buscar productos: ${error.message}</div>`;
        });
}

function agregarProductoDesdeBusqueda(producto) {
    agregarProducto(producto);
    const resultadosDiv = document.getElementById('resultadosBusqueda');
    const inputBuscar = document.getElementById('buscarProducto');
    
    if (resultadosDiv) resultadosDiv.style.display = 'none';
    if (inputBuscar) inputBuscar.value = '';
}

// ============================================
// STOCK
// ============================================

function verStockProducto(productoId, productoNombre) {
    const modalElement = document.getElementById('modalStockDetalle');
    if (!modalElement) return;
    
    const modal = new bootstrap.Modal(modalElement);
    const modalProducto = document.getElementById('modalProductoNombre');
    if (modalProducto) modalProducto.textContent = productoNombre;
    
    const url = `/admin/ventas/obtener-stock-producto/${productoId}`;
    console.log('üìä Ver stock URL:', url);
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            console.log('üì¶ Datos de stock:', data);
            
            const contenidoStock = document.getElementById('contenidoStock');
            if (!contenidoStock) return;
            
            if (data.error) {
                contenidoStock.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${data.error}
                    </div>`;
                return;
            }
            
            let html = `
                <div class="mb-3">
                    <p><strong>C√≥digo:</strong> ${data.codigo || 'N/A'}</p>
                    <p><strong>Stock Total:</strong> <span class="badge bg-success fs-6">${formatNumber(data.stock_total)}</span></p>
                </div>`;
            
            if (data.bodegas && data.bodegas.length > 0) {
                html += `
                    <h6 class="mb-3">Stock por Bodega:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Bodega</th>
                                    <th class="text-end">Existencias</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                data.bodegas.forEach(bodega => {
                    html += `
                        <tr>
                            <td>${bodega.Nombre_Bodega || `Bodega ${bodega.ID_Bodega}`}</td>
                            <td class="text-end"><span class="badge bg-primary">${formatNumber(bodega.Existencias)}</span></td>
                        </tr>`;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>`;
            } else {
                html += `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No hay stock registrado en bodegas para este producto
                    </div>`;
            }
            
            contenidoStock.innerHTML = html;
        })
        .catch(error => {
            console.error('‚ùå Error:', error);
            const contenidoStock = document.getElementById('contenidoStock');
            if (contenidoStock) {
                contenidoStock.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error al cargar el stock del producto
                    </div>`;
            }
        });
    
    modal.show();
}

// ============================================
// GESTI√ìN DE PRODUCTOS SELECCIONADOS
// ============================================

function agregarProducto(producto) {
    console.log('‚ûï Agregando producto:', producto);
    
    if (!producto.precio || producto.precio <= 0) {
        showAlert('warning', `El producto "${producto.nombre}" no tiene precio v√°lido para el perfil ${perfilClienteActual}`);
        return;
    }
    
    const index = productosSeleccionados.findIndex(p => p.id === producto.id);
    
    if (index !== -1) {
        const cantidadActual = productosSeleccionados[index].cantidad;
        const nuevaCantidad = cantidadActual + 1;
        
        if (nuevaCantidad > producto.stock) {
            showAlert('warning', `Stock insuficiente para "${producto.nombre}". Disponible: ${formatNumber(producto.stock)}`);
            return;
        }
        
        productosSeleccionados[index].cantidad = nuevaCantidad;
        productosSeleccionados[index].subtotal = producto.precio * nuevaCantidad;
        actualizarTablaProductos();
        showToast('info', 'Cantidad actualizada', `Cantidad de "${producto.nombre}" aumentada a ${formatNumber(nuevaCantidad)}`);
        return;
    }
    
    if (1 > producto.stock) {
        showAlert('warning', `Stock insuficiente para "${producto.nombre}". Disponible: ${formatNumber(producto.stock)}`);
        return;
    }
    
    const badgeInfo = getPerfilBadge(perfilClienteActual);
    
    productosSeleccionados.push({
        id: producto.id,
        nombre: producto.nombre,
        codigo: producto.codigo,
        precio: producto.precio,
        cantidad: 1,
        stock: producto.stock,
        unidad: producto.unidad_abreviatura || producto.unidad_descripcion || 'Unidad',
        subtotal: producto.precio * 1,
        tipoPrecio: badgeInfo.texto,
        tipoPrecioClase: badgeInfo.clase
    });
    
    actualizarTablaProductos();
    showToast('success', 'Producto agregado', `${producto.nombre} agregado al pedido`);
}

function actualizarTablaProductos() {
    const tbody = document.getElementById('tbodyProductos');
    const tfoot = document.getElementById('tfootTotales');
    const filaVacia = document.getElementById('filaVacia');
    
    if (productosSeleccionados.length === 0) {
        if (filaVacia) filaVacia.style.display = '';
        if (tfoot) tfoot.style.display = 'none';
        return;
    }
    
    if (filaVacia) filaVacia.style.display = 'none';
    
    productosSeleccionados.sort((a, b) => a.nombre.localeCompare(b.nombre));
    
    if (tbody) tbody.innerHTML = '';
    let total = 0;
    
    productosSeleccionados.forEach((producto, index) => {
        total += producto.subtotal;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>
                <div class="fw-bold">${producto.nombre}</div>
                <small class="text-muted">
                    C√≥digo: ${producto.codigo || 'N/A'} | 
                    Unidad: ${producto.unidad} |
                    Stock: <span class="badge bg-secondary">${formatNumber(producto.stock)}</span>
                </small>
            </td>
            <td>
                <span class="badge ${producto.tipoPrecioClase}">${producto.tipoPrecio}</span>
            </td>
            <td>
                <div class="input-group input-group-sm">
                    <span class="input-group-text">C$</span>
                    <input type="number" class="form-control precio-input" 
                           value="${producto.precio.toFixed(2)}" step="0.01" min="0.01"
                           data-index="${index}" onchange="actualizarPrecio(${index}, this.value)">
                </div>
            </td>
            <td>
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control cantidad-input" 
                           value="${producto.cantidad}" step="0.01" min="0.01" max="${producto.stock}"
                           data-index="${index}" onchange="actualizarCantidad(${index}, this.value)">
                    <button class="btn btn-outline-secondary" type="button" 
                            onclick="modificarCantidad(${index}, 1)">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-outline-secondary" type="button" 
                            onclick="modificarCantidad(${index}, -1)">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                <small class="text-muted">Disponible: ${formatNumber(producto.stock)}</small>
            </td>
            <td class="fw-bold text-success">${formatCurrency(producto.subtotal)}</td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-info me-1" 
                        onclick="verStockProducto(${producto.id}, '${producto.nombre.replace(/'/g, "\\'")}')"
                        title="Ver stock por bodega">
                    <i class="fas fa-warehouse"></i>
                </button>
                <button type="button" class="btn btn-sm btn-danger" 
                        onclick="eliminarProducto(${index})" title="Eliminar">
                    <i class="fas fa-trash"></i>
                </button>
            </td>`;
        if (tbody) tbody.appendChild(row);
    });
    
    const totalFormateado = formatCurrency(total);
    const totalPedido = document.getElementById('totalPedido');
    const indicadorTotal = document.getElementById('indicadorTotal');
    
    if (totalPedido) totalPedido.textContent = totalFormateado;
    if (indicadorTotal) indicadorTotal.textContent = `Total: ${totalFormateado}`;
    if (tfoot) tfoot.style.display = '';
    
    actualizarContadorProductos();
    validarFormulario();
}

function actualizarContadorProductos() {
    const contador = document.getElementById('contadorProductos');
    if (!contador) return;
    
    contador.textContent = `${productosSeleccionados.length} producto${productosSeleccionados.length !== 1 ? 's' : ''}`;
    contador.className = `badge ${productosSeleccionados.length > 0 ? 'bg-success' : 'bg-primary'}`;
}

function modificarCantidad(index, cambio) {
    if (index < 0 || index >= productosSeleccionados.length) return;
    
    const producto = productosSeleccionados[index];
    const nuevaCantidad = producto.cantidad + cambio;
    
    if (nuevaCantidad < 0.01) return;
    
    if (nuevaCantidad > producto.stock) {
        showAlert('warning', `Stock insuficiente. Disponible: ${formatNumber(producto.stock)}`);
        return;
    }
    
    productosSeleccionados[index].cantidad = nuevaCantidad;
    productosSeleccionados[index].subtotal = producto.precio * nuevaCantidad;
    actualizarTablaProductos();
}

function actualizarPrecio(index, nuevoPrecio) {
    if (index < 0 || index >= productosSeleccionados.length) return;
    
    nuevoPrecio = parseFloat(nuevoPrecio);
    if (isNaN(nuevoPrecio) || nuevoPrecio < 0.01) {
        nuevoPrecio = productosSeleccionados[index].precio;
    }
    
    productosSeleccionados[index].precio = nuevoPrecio;
    productosSeleccionados[index].subtotal = nuevoPrecio * productosSeleccionados[index].cantidad;
    actualizarTablaProductos();
}

function actualizarCantidad(index, nuevaCantidad) {
    if (index < 0 || index >= productosSeleccionados.length) return;
    
    nuevaCantidad = parseFloat(nuevaCantidad);
    if (isNaN(nuevaCantidad) || nuevaCantidad < 0.01) {
        nuevaCantidad = productosSeleccionados[index].cantidad;
    }
    
    if (nuevaCantidad > productosSeleccionados[index].stock) {
        showAlert('warning', `Stock insuficiente. Disponible: ${formatNumber(productosSeleccionados[index].stock)}`);
        nuevaCantidad = productosSeleccionados[index].cantidad;
    }
    
    productosSeleccionados[index].cantidad = nuevaCantidad;
    productosSeleccionados[index].subtotal = productosSeleccionados[index].precio * nuevaCantidad;
    actualizarTablaProductos();
}

function eliminarProducto(index) {
    if (index < 0 || index >= productosSeleccionados.length) return;
    
    if (confirm(`¬øEliminar "${productosSeleccionados[index].nombre}" del pedido?`)) {
        productosSeleccionados.splice(index, 1);
        actualizarTablaProductos();
        showToast('info', 'Producto eliminado', 'El producto ha sido removido del pedido');
    }
}

// ============================================
// VALIDACI√ìN Y CONFIRMACI√ìN
// ============================================

function validarFormulario() {
    const selectCliente = document.getElementById('selectCliente');
    const selectEmpresa = document.getElementById('selectEmpresa');
    const fechaPedido = document.getElementById('fechaPedido');
    const selectPrioridad = document.getElementById('selectPrioridad');
    const selectTipoEntrega = document.getElementById('selectTipoEntrega');
    const btnGuardar = document.getElementById('btnGuardar');
    
    const clienteValido = selectCliente ? selectCliente.value !== '' : false;
    const empresaValido = selectEmpresa ? selectEmpresa.value !== '' : false;
    const fechaValido = fechaPedido ? fechaPedido.value !== '' : false;
    const prioridadValido = selectPrioridad ? selectPrioridad.value !== '' : false;
    const tipoEntregaValido = selectTipoEntrega ? selectTipoEntrega.value !== '' : false;
    const productosValido = productosSeleccionados.length > 0;
    
    const formularioValido = clienteValido && empresaValido && fechaValido && prioridadValido && tipoEntregaValido && productosValido;
    if (btnGuardar) btnGuardar.disabled = !formularioValido;
    
    return formularioValido;
}

function validarPreciosProductos() {
    const productosSinPrecio = productosSeleccionados.filter(p => p.precio <= 0);
    if (productosSinPrecio.length > 0) {
        showAlert('warning', `Los siguientes productos no tienen precio v√°lido para el perfil ${perfilClienteActual}: ${productosSinPrecio.map(p => p.nombre).join(', ')}`);
        return false;
    }
    return true;
}

function validarYConfirmarPedido() {
    if (!validarFormulario()) {
        showAlert('warning', 'Complete todos los campos obligatorios y agregue al menos un producto');
        return;
    }
    
    if (!validarPreciosProductos()) {
        return;
    }
    
    const prioridad = document.getElementById('selectPrioridad').value;
    const prioridadBadgeClass = getBadgeClassPrioridad(prioridad);
    const prioridadIcono = getIconoPrioridad(prioridad);
    
    const resumen = document.getElementById('resumenPedido');
    if (!resumen) return;
    
    let html = `
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title border-bottom pb-2 mb-3">
                            <i class="fas fa-user me-2"></i>Datos del Cliente
                        </h6>
                        <p><strong>Cliente:</strong> ${document.getElementById('clienteNombre')?.textContent || ''}</p>
                        <p><strong>Documento:</strong> ${document.getElementById('clienteRUC')?.textContent || ''}</p>
                        <p><strong>Tel√©fono:</strong> ${document.getElementById('clienteTelefono')?.textContent || ''}</p>
                        <p><strong>Direcci√≥n:</strong> ${document.getElementById('clienteDireccion')?.textContent || ''}</p>
                        <p><strong>Perfil:</strong> <span class="badge ${document.getElementById('clientePerfil')?.className || ''}">${document.getElementById('clientePerfil')?.textContent || ''}</span></p>
                        <p><strong>Tipo Precio:</strong> <span class="badge ${document.getElementById('tipoPrecio')?.className || ''}">${document.getElementById('tipoPrecio')?.textContent || ''}</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title border-bottom pb-2 mb-3">
                            <i class="fas fa-info-circle me-2"></i>Informaci√≥n del Pedido
                        </h6>
                        <p><strong>Fecha:</strong> ${document.getElementById('fechaPedido')?.value || ''}</p>
                        <p><strong>Empresa:</strong> ${document.getElementById('selectEmpresa')?.options[document.getElementById('selectEmpresa')?.selectedIndex]?.text || ''}</p>
                        <p><strong>Prioridad:</strong> <span class="badge ${prioridadBadgeClass}"><i class="${prioridadIcono} me-1"></i>${prioridad}</span></p>
                        <p><strong>Tipo entrega:</strong> ${document.getElementById('selectTipoEntrega')?.value || ''}</p>
                        <p><strong>Observaciones:</strong> ${document.getElementById('observacionPedido')?.value || 'Ninguna'}</p>
                    </div>
                </div>
            </div>
        </div>`;
    resumen.innerHTML = html;
    
    const tbodyResumen = document.getElementById('tbodyResumenProductos');
    const totalResumen = document.getElementById('totalResumen');
    
    let htmlResumen = '';
    let total = 0;
    
    productosSeleccionados.forEach((producto, index) => {
        total += producto.subtotal;
        htmlResumen += `
            <tr>
                <td>${index + 1}. ${producto.nombre}<br><small class="text-muted">C√≥digo: ${producto.codigo || 'N/A'} | Unidad: ${producto.unidad}</small></td>
                <td class="text-center">${formatNumber(producto.cantidad)}</td>
                <td class="text-end">${formatCurrency(producto.precio)}</td>
                <td class="text-center"><span class="badge ${producto.tipoPrecioClase}">${producto.tipoPrecio}</span></td>
                <td class="text-end fw-bold">${formatCurrency(producto.subtotal)}</td>
            </tr>`;
    });
    
    if (tbodyResumen) tbodyResumen.innerHTML = htmlResumen;
    if (totalResumen) totalResumen.textContent = formatCurrency(total);
    
    const modalElement = document.getElementById('modalConfirmacion');
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    }
}

// ============================================
// GUARDAR PEDIDO
// ============================================
function guardarPedido() {
    const btnGuardar = document.getElementById('btnConfirmarGuardar');
    const modalElement = document.getElementById('modalConfirmacion');
    if (!modalElement || !btnGuardar) return;
    
    const modal = bootstrap.Modal.getInstance(modalElement);
    
    btnGuardar.disabled = true;
    btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';
    
    const selectCliente = document.getElementById('selectCliente');
    const selectEmpresa = document.getElementById('selectEmpresa');
    const fechaPedido = document.getElementById('fechaPedido');
    const selectTipoEntrega = document.getElementById('selectTipoEntrega');
    const selectPrioridad = document.getElementById('selectPrioridad');
    const observacionPedido = document.getElementById('observacionPedido');
    
    const datosPedido = {
        cliente_id: selectCliente ? selectCliente.value : '',
        empresa_id: selectEmpresa ? selectEmpresa.value : '',
        fecha: fechaPedido ? fechaPedido.value : '',
        tipo_entrega: selectTipoEntrega ? selectTipoEntrega.value : '',
        prioridad: selectPrioridad ? selectPrioridad.value : '',
        observacion: observacionPedido ? observacionPedido.value : '',
        productos: productosSeleccionados.map(p => ({
            id: p.id,
            nombre: p.nombre,
            precio: p.precio,
            cantidad: p.cantidad
        }))
    };
    
    console.log('üì§ Enviando pedido:', datosPedido);
    
    fetch('/admin/ventas/crear-pedido', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(datosPedido)
    })
    .then(response => response.json())
    .then(data => {
        console.log('üì• Respuesta del servidor:', data);
        
        if (modal) modal.hide();
        
        if (data.success) {
            showToast('success', 'Pedido creado', `Pedido #${data.pedido_id} creado exitosamente con perfil ${data.perfil_cliente}`);
            setTimeout(() => {
                window.location.href = `/admin/ventas/pedido-venta/${data.pedido_id}`;
            }, 1500);
        } else {
            showAlert('error', data.message || 'Error al crear el pedido');
            btnGuardar.disabled = false;
            btnGuardar.innerHTML = '<i class="fas fa-save me-1"></i> Confirmar y Guardar';
        }
    })
    .catch(error => {
        console.error('‚ùå Error:', error);
        if (modal) modal.hide();
        showAlert('error', 'Error al conectar con el servidor');
        btnGuardar.disabled = false;
        btnGuardar.innerHTML = '<i class="fas fa-save me-1"></i> Confirmar y Guardar';
    });
}

// ============================================
// NOTIFICACIONES
// ============================================
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1055; max-width: 400px;';
    alertDiv.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-exclamation-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function showToast(type, title, message) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed`;
    toast.style.cssText = 'bottom: 20px; right: 20px; z-index: 1055;';
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <strong>${title}:</strong> ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    if (typeof bootstrap !== 'undefined') {
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }
    
    toast.addEventListener('hidden.bs.toast', function() {
        if (toast.parentNode) {
            toast.remove();
        }
    });
}
</script>

<style>
.precio-input, .cantidad-input {
    text-align: right;
}
.table th {
    background-color: #f8f9fa;
    font-weight: 600;
}
.badge {
    font-size: 0.85em;
}
.card-header {
    font-weight: 600;
}
#productosCategoriaContainer .card {
    max-height: 500px;
    overflow-y: auto;
}
#resultadosBusqueda {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 10px;
    background-color: #f8f9fa;
}
.btn-group-sm > .btn {
    padding: 0.25rem 0.5rem;
}
.table-hover tbody tr:hover {
    background-color: rgba(0,123,255,0.05);
}
.input-group-sm .form-control {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}
.input-group-text {
    background-color: #f8f9fa;
    border-color: #dee2e6;
    font-weight: 600;
}
.text-success {
    color: #198754 !important;
}
.bg-danger { 
    background-color: #dc3545 !important; 
    color: white !important;
}
.bg-primary { 
    background-color: #0d6efd !important; 
    color: white !important;
}
.bg-secondary { 
    background-color: #6c757d !important; 
    color: white !important;
}
.bg-info { 
    background-color: #0dcaf0 !important; 
    color: white !important;
}
.bg-warning { 
    background-color: #ffc107 !important; 
    color: black !important;
}
#indicadorPrioridad .alert {
    border-left: 4px solid #dc3545;
}
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}
#indicadorPrioridad .alert-danger {
    animation: pulse 2s infinite;
}
#tablaResumenProductos th {
    background-color: #e9ecef;
    font-weight: 600;
}
.select2-container--default .select2-selection--single {
    height: 38px;
    border: 1px solid #ced4da;
    border-radius: 4px;
}
.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 36px;
    padding-left: 12px;
}
.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 36px;
}
</style>
{% endblock %}