{% extends "layout.html" %}

{% block title %}Nuevo Pedido{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-plus-circle me-2"></i>Nuevo Pedido</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_pedidos_venta') }}">Pedidos</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Nuevo Pedido</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="{{ url_for('admin_pedidos_venta') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Cancelar
            </a>
        </div>
    </div>
    
    <!-- Formulario de Pedido -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Datos del Pedido</h5>
        </div>
        <div class="card-body">
            <form id="formPedido">
                <div class="row g-3">
                    <!-- Datos del Cliente -->
                    <div class="col-md-6">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-user me-2"></i>Datos del Cliente
                        </h5>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Seleccionar Cliente:</label>
                            <select id="selectCliente" class="form-select" required>
                                <option value="">Seleccione un cliente...</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.ID_Cliente }}" 
                                        data-nombre="{{ cliente.Nombre }}"
                                        data-telefono="{{ cliente.Telefono or '' }}"
                                        data-direccion="{{ cliente.Direccion or '' }}"
                                        data-ruc="{{ cliente.RUC_CEDULA or '' }}"
                                        data-tipo="{{ cliente.tipo_cliente }}"
                                        {% if cliente_seleccionado and cliente_seleccionado.ID_Cliente == cliente.ID_Cliente %}selected{% endif %}>
                                    {{ cliente.Nombre }} - {{ cliente.RUC_CEDULA or 'Sin documento' }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div id="clienteInfo" class="p-3 bg-light rounded" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Nombre:</small>
                                        <span id="clienteNombre" class="fw-bold"></span>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Documento:</small>
                                        <span id="clienteRUC" class="badge bg-dark"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Teléfono:</small>
                                        <span id="clienteTelefono"></span>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Dirección:</small>
                                        <span id="clienteDireccion"></span>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Tipo:</small>
                                        <span id="clienteTipo" class="badge"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Búsqueda rápida de productos -->
                        <div class="mt-3">
                            <label class="form-label fw-bold">Búsqueda rápida de productos:</label>
                            <div class="input-group">
                                <input type="text" id="buscarProducto" class="form-control" 
                                       placeholder="Buscar producto por nombre o código..."
                                       disabled>
                                <button class="btn btn-outline-secondary" type="button" 
                                        id="btnBuscarProducto" disabled>
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div id="resultadosBusqueda" class="mt-2" style="display: none;"></div>
                        </div>
                    </div>
                    
                    <!-- Datos del Pedido -->
                    <div class="col-md-6">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-info-circle me-2"></i>Información del Pedido
                        </h5>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Fecha:</label>
                                <input type="date" id="fechaPedido" class="form-control" required 
                                       value="{{ now.strftime('%Y-%m-%d') if now else '' }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Empresa:</label>
                                <select id="selectEmpresa" class="form-select" required>
                                    <option value="">Seleccione empresa...</option>
                                    {% for empresa in empresas %}
                                    <option value="{{ empresa.ID_Empresa }}">
                                        {{ empresa.Nombre_Empresa }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Tipo de Entrega:</label>
                                <select id="selectTipoEntrega" class="form-select" required>
                                    <option value="Retiro en local">Retiro en local</option>
                                    <option value="Entrega a domicilio">Entrega a domicilio</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">Observaciones:</label>
                                <textarea id="observacionPedido" class="form-control" rows="2" 
                                          placeholder="Agregue observaciones o notas adicionales..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Selección de Productos -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-boxes me-2"></i>Productos del Pedido
                        </h5>
                        
                        <!-- Categorías -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Categorías disponibles:</label>
                            <div id="categoriasContainer" class="d-flex flex-wrap gap-2">
                                <div class="alert alert-info w-100">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Seleccione un cliente para ver las categorías disponibles
                                </div>
                            </div>
                        </div>
                        
                        <!-- Productos por Categoría -->
                        <div id="productosContainer" style="display: none;">
                            <h6 class="mb-3">Seleccione productos por categoría:</h6>
                            <div id="productosCategoriaContainer">
                                <!-- Aquí se cargan los productos dinámicamente -->
                            </div>
                        </div>
                        
                        <!-- Tabla de Productos Seleccionados -->
                        <div class="mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Productos seleccionados:</h6>
                                <span id="contadorProductos" class="badge bg-primary">0 productos</span>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-bordered" id="tablaProductosSeleccionados">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="50">#</th>
                                            <th>Producto</th>
                                            <th width="150">Precio Unitario</th>
                                            <th width="150">Cantidad</th>
                                            <th width="150">Subtotal</th>
                                            <th width="80">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyProductos">
                                        <tr id="filaVacia">
                                            <td colspan="6" class="text-center text-muted py-4">
                                                <i class="fas fa-box-open fa-2x mb-2 d-block"></i>
                                                No hay productos seleccionados
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot id="tfootTotales" style="display: none;">
                                        <tr class="table-active">
                                            <td colspan="4" class="text-end fw-bold">TOTAL:</td>
                                            <td class="fw-bold text-success fs-5" id="totalPedido">$0.00</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Botones de Acción -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                                <i class="fas fa-times me-1"></i> Cancelar
                            </button>
                            <button type="submit" class="btn btn-success" id="btnGuardar" disabled>
                                <i class="fas fa-save me-1"></i> Guardar Pedido
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para confirmar -->
<div class="modal fade" id="modalConfirmacion" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Pedido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro de crear este pedido?</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    El pedido se creará con estado "Pendiente" y se descontará del stock.
                </div>
                <div id="resumenPedido"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnConfirmarGuardar">Sí, guardar pedido</button>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales
let productosSeleccionados = [];
let tipoClienteActual = null;

document.addEventListener('DOMContentLoaded', function() {
    // Configurar fecha actual por defecto
    const fechaInput = document.getElementById('fechaPedido');
    if (fechaInput && !fechaInput.value) {
        fechaInput.value = new Date().toISOString().split('T')[0];
    }
    
    // Evento para cambio de cliente
    document.getElementById('selectCliente').addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        if (option.value) {
            mostrarInfoCliente(option);
            tipoClienteActual = option.getAttribute('data-tipo');
            habilitarBusquedaProductos();
            cargarCategoriasDisponibles(tipoClienteActual);
            validarFormulario();
        } else {
            ocultarInfoCliente();
            deshabilitarBusquedaProductos();
            productosSeleccionados = [];
            actualizarTablaProductos();
            document.getElementById('btnGuardar').disabled = true;
        }
    });
    
    // Búsqueda de productos
    document.getElementById('btnBuscarProducto').addEventListener('click', buscarProductos);
    document.getElementById('buscarProducto').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            buscarProductos();
        }
    });
    
    // Si hay cliente seleccionado al cargar la página
    const clienteSelect = document.getElementById('selectCliente');
    if (clienteSelect.value) {
        const option = clienteSelect.options[clienteSelect.selectedIndex];
        mostrarInfoCliente(option);
        tipoClienteActual = option.getAttribute('data-tipo');
        habilitarBusquedaProductos();
        cargarCategoriasDisponibles(tipoClienteActual);
        validarFormulario();
    }
    
    // Prevenir envío del formulario
    document.getElementById('formPedido').addEventListener('submit', function(e) {
        e.preventDefault();
        validarYConfirmarPedido();
    });
    
    // Inicializar
    actualizarContadorProductos();
});

function mostrarInfoCliente(option) {
    const infoDiv = document.getElementById('clienteInfo');
    const nombre = option.getAttribute('data-nombre');
    const telefono = option.getAttribute('data-telefono') || 'No especificado';
    const direccion = option.getAttribute('data-direccion') || 'No especificada';
    const ruc = option.getAttribute('data-ruc') || 'Sin documento';
    const tipo = option.getAttribute('data-tipo');
    
    document.getElementById('clienteNombre').textContent = nombre;
    document.getElementById('clienteTelefono').textContent = telefono;
    document.getElementById('clienteDireccion').textContent = direccion;
    document.getElementById('clienteRUC').textContent = ruc;
    
    const tipoBadge = document.getElementById('clienteTipo');
    tipoBadge.textContent = tipo;
    tipoBadge.className = `badge ${tipo === 'Especial' ? 'bg-primary' : 'bg-secondary'}`;
    
    infoDiv.style.display = 'block';
}

function ocultarInfoCliente() {
    document.getElementById('clienteInfo').style.display = 'none';
    document.getElementById('productosContainer').style.display = 'none';
}

function habilitarBusquedaProductos() {
    document.getElementById('buscarProducto').disabled = false;
    document.getElementById('btnBuscarProducto').disabled = false;
}

function deshabilitarBusquedaProductos() {
    document.getElementById('buscarProducto').disabled = true;
    document.getElementById('btnBuscarProducto').disabled = true;
}

function buscarProductos() {
    const termino = document.getElementById('buscarProducto').value.trim();
    if (termino.length < 2) {
        alert('Ingrese al menos 2 caracteres para buscar');
        return;
    }
    
    const resultadosDiv = document.getElementById('resultadosBusqueda');
    resultadosDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Buscando...</span></div>';
    resultadosDiv.style.display = 'block';
    
    fetch(`/admin/ventas/buscar-productos?q=${encodeURIComponent(termino)}&tipo_cliente=${tipoClienteActual}`)
        .then(response => response.json())
        .then(productos => {
            if (productos.length === 0) {
                resultadosDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-search me-2"></i>
                        No se encontraron productos
                    </div>`;
                return;
            }
            
            let html = '<div class="list-group">';
            productos.forEach(producto => {
                html += `
                    <div class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${producto.nombre}</h6>
                            <small class="text-success fw-bold">$${producto.precio.toFixed(2)}</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="text-muted">
                                    Código: ${producto.codigo || 'N/A'} | 
                                    Stock: ${producto.stock} ${producto.unidad_abreviatura || ''} |
                                    Categoría: ${producto.categoria || 'N/A'}
                                </small>
                            </div>
                            <button type="button" class="btn btn-sm btn-primary" 
                                    onclick="agregarProductoDesdeBusqueda(${JSON.stringify(producto).replace(/"/g, '&quot;')})">
                                <i class="fas fa-plus me-1"></i> Agregar
                            </button>
                        </div>
                    </div>`;
            });
            html += '</div>';
            resultadosDiv.innerHTML = html;
        })
        .catch(error => {
            console.error('Error:', error);
            resultadosDiv.innerHTML = '<div class="alert alert-danger">Error al buscar productos</div>';
        });
}

function agregarProductoDesdeBusqueda(producto) {
    agregarProducto(producto);
    document.getElementById('resultadosBusqueda').style.display = 'none';
    document.getElementById('buscarProducto').value = '';
}

function cargarCategoriasDisponibles(tipoCliente) {
    const container = document.getElementById('categoriasContainer');
    container.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div>';
    
    fetch(`/admin/ventas/obtener-categorias-visibles?tipo_cliente=${tipoCliente}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }
            
            if (data.categorias.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning w-100">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No hay categorías disponibles para este tipo de cliente
                    </div>`;
                document.getElementById('productosContainer').style.display = 'none';
                return;
            }
            
            container.innerHTML = '';
            data.categorias.forEach(categoria => {
                const boton = document.createElement('button');
                boton.type = 'button';
                boton.className = 'btn btn-outline-primary mb-2';
                boton.innerHTML = `<i class="fas fa-folder me-2"></i>${categoria.nombre}`;
                boton.onclick = () => cargarProductosCategoria(categoria.id, categoria.nombre);
                container.appendChild(boton);
            });
            
            document.getElementById('productosContainer').style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            container.innerHTML = `<div class="alert alert-danger">Error al cargar categorías</div>`;
        });
}

function cargarProductosCategoria(categoriaId, categoriaNombre) {
    const container = document.getElementById('productosCategoriaContainer');
    container.innerHTML = `
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-folder me-2"></i>${categoriaNombre}
                    <button type="button" class="btn btn-sm btn-outline-secondary float-end" 
                            onclick="cerrarProductosCategoria()">
                        <i class="fas fa-times"></i>
                    </button>
                </h6>
            </div>
            <div class="card-body">
                <div class="row" id="productosGrid-${categoriaId}">
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando productos...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    
    fetch(`/admin/ventas/obtener-productos-categoria?categoria_id=${categoriaId}&tipo_cliente=${tipoClienteActual}`)
        .then(response => response.json())
        .then(data => {
            const grid = document.getElementById(`productosGrid-${categoriaId}`);
            
            if (data.error) {
                grid.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }
            
            if (data.productos.length === 0) {
                grid.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No hay productos disponibles en esta categoría
                        </div>
                    </div>`;
                return;
            }
            
            grid.innerHTML = '';
            data.productos.forEach(producto => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4 mb-3';
                col.innerHTML = `
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title">${producto.nombre}</h6>
                            <div class="card-text small text-muted mb-2">
                                <span class="badge bg-dark">${producto.codigo || 'N/A'}</span>
                                <span class="badge bg-info">${producto.unidad_abreviatura || producto.unidad_descripcion || 'Unidad'}</span>
                            </div>
                            <p class="card-text small mb-2">
                                <i class="fas fa-box me-1"></i> Stock: ${producto.stock}
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold text-success">$${producto.precio.toFixed(2)}</span>
                                <button type="button" class="btn btn-sm btn-primary" 
                                        onclick="agregarProducto(${JSON.stringify(producto).replace(/"/g, '&quot;')})">
                                    <i class="fas fa-plus me-1"></i> Agregar
                                </button>
                            </div>
                        </div>
                    </div>`;
                grid.appendChild(col);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            const grid = document.getElementById(`productosGrid-${categoriaId}`);
            grid.innerHTML = `<div class="alert alert-danger">Error al cargar productos</div>`;
        });
}

function cerrarProductosCategoria() {
    document.getElementById('productosCategoriaContainer').innerHTML = '';
}

function agregarProducto(producto) {
    // Verificar si el producto ya está en la lista
    const index = productosSeleccionados.findIndex(p => p.id === producto.id);
    
    if (index !== -1) {
        // Si ya existe, aumentar cantidad en 1
        const cantidadActual = productosSeleccionados[index].cantidad;
        const nuevaCantidad = cantidadActual + 1;
        
        if (nuevaCantidad > producto.stock) {
            showAlert('warning', `Stock insuficiente para "${producto.nombre}". Disponible: ${producto.stock}`);
            return;
        }
        
        productosSeleccionados[index].cantidad = nuevaCantidad;
        productosSeleccionados[index].subtotal = producto.precio * nuevaCantidad;
        actualizarTablaProductos();
        showToast('info', 'Cantidad actualizada', `Cantidad de "${producto.nombre}" aumentada a ${nuevaCantidad}`);
        return;
    }
    
    // Si no existe, agregar con cantidad 1 por defecto
    if (1 > producto.stock) {
        showAlert('warning', `Stock insuficiente para "${producto.nombre}". Disponible: ${producto.stock}`);
        return;
    }
    
    productosSeleccionados.push({
        id: producto.id,
        nombre: producto.nombre,
        codigo: producto.codigo,
        precio: producto.precio,
        cantidad: 1,
        stock: producto.stock,
        unidad: producto.unidad_abreviatura || producto.unidad_descripcion || 'Unidad',
        subtotal: producto.precio * 1
    });
    
    actualizarTablaProductos();
    showToast('success', 'Producto agregado', `${producto.nombre} agregado al pedido`);
}

function actualizarTablaProductos() {
    const tbody = document.getElementById('tbodyProductos');
    const tfoot = document.getElementById('tfootTotales');
    const filaVacia = document.getElementById('filaVacia');
    
    if (productosSeleccionados.length === 0) {
        if (filaVacia) filaVacia.style.display = '';
        tfoot.style.display = 'none';
        return;
    }
    
    // Ocultar fila vacía
    if (filaVacia) filaVacia.style.display = 'none';
    
    // Ordenar por nombre
    productosSeleccionados.sort((a, b) => a.nombre.localeCompare(b.nombre));
    
    tbody.innerHTML = '';
    let total = 0;
    
    productosSeleccionados.forEach((producto, index) => {
        total += producto.subtotal;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>
                <div class="fw-bold">${producto.nombre}</div>
                <small class="text-muted">
                    Código: ${producto.codigo || 'N/A'} | 
                    Unidad: ${producto.unidad}
                </small>
            </td>
            <td>
                <div class="input-group input-group-sm">
                    <span class="input-group-text">$</span>
                    <input type="number" class="form-control precio-input" 
                           value="${producto.precio.toFixed(2)}" step="0.01" min="0.01"
                           data-index="${index}" onchange="actualizarPrecio(${index}, this.value)">
                </div>
            </td>
            <td>
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control cantidad-input" 
                           value="${producto.cantidad}" step="0.01" min="0.01" max="${producto.stock}"
                           data-index="${index}" onchange="actualizarCantidad(${index}, this.value)">
                    <button class="btn btn-outline-secondary" type="button" 
                            onclick="modificarCantidad(${index}, 1)">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-outline-secondary" type="button" 
                            onclick="modificarCantidad(${index}, -1)">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                <small class="text-muted">Disponible: ${producto.stock}</small>
            </td>
            <td class="fw-bold text-success">$${producto.subtotal.toFixed(2)}</td>
            <td>
                <button type="button" class="btn btn-sm btn-danger" 
                        onclick="eliminarProducto(${index})" title="Eliminar">
                    <i class="fas fa-trash"></i>
                </button>
            </td>`;
        tbody.appendChild(row);
    });
    
    // Actualizar total
    document.getElementById('totalPedido').textContent = `$${total.toFixed(2)}`;
    tfoot.style.display = '';
    
    actualizarContadorProductos();
    validarFormulario();
}

function actualizarContadorProductos() {
    const contador = document.getElementById('contadorProductos');
    contador.textContent = `${productosSeleccionados.length} producto${productosSeleccionados.length !== 1 ? 's' : ''}`;
    contador.className = `badge ${productosSeleccionados.length > 0 ? 'bg-success' : 'bg-primary'}`;
}

function modificarCantidad(index, cambio) {
    const producto = productosSeleccionados[index];
    const nuevaCantidad = producto.cantidad + cambio;
    
    if (nuevaCantidad < 0.01) {
        return; // No permitir cantidades negativas
    }
    
    if (nuevaCantidad > producto.stock) {
        showAlert('warning', `Stock insuficiente. Disponible: ${producto.stock}`);
        return;
    }
    
    productosSeleccionados[index].cantidad = nuevaCantidad;
    productosSeleccionados[index].subtotal = producto.precio * nuevaCantidad;
    actualizarTablaProductos();
}

function actualizarPrecio(index, nuevoPrecio) {
    nuevoPrecio = parseFloat(nuevoPrecio);
    if (isNaN(nuevoPrecio) || nuevoPrecio < 0) {
        nuevoPrecio = productosSeleccionados[index].precio;
    }
    
    productosSeleccionados[index].precio = nuevoPrecio;
    productosSeleccionados[index].subtotal = nuevoPrecio * productosSeleccionados[index].cantidad;
    actualizarTablaProductos();
}

function actualizarCantidad(index, nuevaCantidad) {
    nuevaCantidad = parseFloat(nuevaCantidad);
    if (isNaN(nuevaCantidad) || nuevaCantidad < 0.01) {
        nuevaCantidad = productosSeleccionados[index].cantidad;
    }
    
    if (nuevaCantidad > productosSeleccionados[index].stock) {
        showAlert('warning', `Stock insuficiente. Disponible: ${productosSeleccionados[index].stock}`);
        nuevaCantidad = productosSeleccionados[index].cantidad;
    }
    
    productosSeleccionados[index].cantidad = nuevaCantidad;
    productosSeleccionados[index].subtotal = productosSeleccionados[index].precio * nuevaCantidad;
    actualizarTablaProductos();
}

function eliminarProducto(index) {
    if (confirm(`¿Eliminar "${productosSeleccionados[index].nombre}" del pedido?`)) {
        productosSeleccionados.splice(index, 1);
        actualizarTablaProductos();
        showToast('info', 'Producto eliminado', 'El producto ha sido removido del pedido');
    }
}

function validarFormulario() {
    const clienteValido = document.getElementById('selectCliente').value !== '';
    const empresaValido = document.getElementById('selectEmpresa').value !== '';
    const fechaValido = document.getElementById('fechaPedido').value !== '';
    const productosValido = productosSeleccionados.length > 0;
    
    const formularioValido = clienteValido && empresaValido && fechaValido && productosValido;
    document.getElementById('btnGuardar').disabled = !formularioValido;
    
    return formularioValido;
}

function validarYConfirmarPedido() {
    if (!validarFormulario()) {
        showAlert('warning', 'Complete todos los campos obligatorios y agregue al menos un producto');
        return;
    }
    
    // Mostrar resumen
    const resumen = document.getElementById('resumenPedido');
    let html = '<div class="alert alert-light">';
    html += `<p><strong>Cliente:</strong> ${document.getElementById('clienteNombre').textContent}</p>`;
    html += `<p><strong>Fecha:</strong> ${document.getElementById('fechaPedido').value}</p>`;
    html += `<p><strong>Tipo entrega:</strong> ${document.getElementById('selectTipoEntrega').value}</p>`;
    html += `<p><strong>Total productos:</strong> ${productosSeleccionados.length}</p>`;
    html += `<p><strong>Total a pagar:</strong> <span class="fw-bold text-success">$${calcularTotal().toFixed(2)}</span></p>`;
    html += '</div>';
    resumen.innerHTML = html;
    
    // Mostrar modal de confirmación
    const modal = new bootstrap.Modal(document.getElementById('modalConfirmacion'));
    modal.show();
}

function calcularTotal() {
    return productosSeleccionados.reduce((total, producto) => total + producto.subtotal, 0);
}

document.getElementById('btnConfirmarGuardar').addEventListener('click', function() {
    guardarPedido();
});

function guardarPedido() {
    const btnGuardar = document.getElementById('btnConfirmarGuardar');
    btnGuardar.disabled = true;
    btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
    
    const datosPedido = {
        cliente_id: document.getElementById('selectCliente').value,
        empresa_id: document.getElementById('selectEmpresa').value,
        fecha: document.getElementById('fechaPedido').value,
        tipo_entrega: document.getElementById('selectTipoEntrega').value,
        observacion: document.getElementById('observacionPedido').value,
        productos: productosSeleccionados.map(p => ({
            id: p.id,
            nombre: p.nombre,
            precio: p.precio,
            cantidad: p.cantidad
        }))
    };
    
    fetch('/admin/ventas/crear-pedido', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(datosPedido)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', 'Pedido creado', `Pedido #${data.pedido_id} creado exitosamente`);
            setTimeout(() => {
                window.location.href = `/admin/ventas/pedido/${data.pedido_id}`;
            }, 1500);
        } else {
            showAlert('error', data.message || 'Error al crear el pedido');
            btnGuardar.disabled = false;
            btnGuardar.innerHTML = '<i class="fas fa-save me-1"></i> Sí, guardar pedido';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Error al conectar con el servidor');
        btnGuardar.disabled = false;
        btnGuardar.innerHTML = '<i class="fas fa-save me-1"></i> Sí, guardar pedido';
    });
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

function showToast(type, title, message) {
    // Si tienes una función de toast implementada, úsala
    // Esta es una implementación básica
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <strong>${title}:</strong> ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', function() {
        document.body.removeChild(toast);
    });
}
</script>

<style>
.precio-input, .cantidad-input {
    text-align: right;
}
.table th {
    background-color: #f8f9fa;
    font-weight: 600;
}
.badge {
    font-size: 0.85em;
}
.card-header {
    font-weight: 600;
}
#productosCategoriaContainer .card {
    max-height: 500px;
    overflow-y: auto;
}
#resultadosBusqueda {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 10px;
    background-color: #f8f9fa;
}
</style>
{% endblock %}