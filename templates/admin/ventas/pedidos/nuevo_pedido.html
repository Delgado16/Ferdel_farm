{% extends "layout.html" %}

{% block title %}Nuevo Pedido{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-plus-circle me-2"></i>Nuevo Pedido</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_pedidos_venta') }}">Pedidos</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Nuevo Pedido</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="{{ url_for('admin_pedidos_venta') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Cancelar
            </a>
        </div>
    </div>
    
    <!-- Formulario de Pedido -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Datos del Pedido</h5>
        </div>
        <div class="card-body">
            <form id="formPedido">
                <div class="row g-3">
                    <!-- Datos del Cliente -->
                    <div class="col-md-6">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-user me-2"></i>Datos del Cliente
                        </h5>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Seleccionar Cliente:</label>
                            <select id="selectCliente" class="form-select" required>
                                <option value="">Seleccione un cliente...</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.ID_Cliente }}" 
                                        data-nombre="{{ cliente.Nombre }}"
                                        data-telefono="{{ cliente.Telefono or '' }}"
                                        data-direccion="{{ cliente.Direccion or '' }}"
                                        data-ruc="{{ cliente.RUC_CEDULA or '' }}"
                                        data-tipo="{{ cliente.tipo_cliente }}"
                                        {% if cliente_seleccionado and cliente_seleccionado.ID_Cliente == cliente.ID_Cliente %}selected{% endif %}>
                                    {{ cliente.Nombre }} - {{ cliente.RUC_CEDULA or 'Sin documento' }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div id="clienteInfo" class="p-3 bg-light rounded" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Nombre:</small>
                                        <span id="clienteNombre" class="fw-bold"></span>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Documento:</small>
                                        <span id="clienteRUC" class="badge bg-dark"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Teléfono:</small>
                                        <span id="clienteTelefono"></span>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Dirección:</small>
                                        <span id="clienteDireccion"></span>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Tipo:</small>
                                        <span id="clienteTipo" class="badge"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Búsqueda rápida de productos -->
                        <div class="mt-3">
                            <label class="form-label fw-bold">Búsqueda rápida de productos:</label>
                            <div class="input-group">
                                <input type="text" id="buscarProducto" class="form-control" 
                                       placeholder="Buscar producto por nombre o código..."
                                       disabled>
                                <button class="btn btn-outline-secondary" type="button" 
                                        id="btnBuscarProducto" disabled>
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div id="resultadosBusqueda" class="mt-2" style="display: none;"></div>
                        </div>
                    </div>
                    
                    <!-- Datos del Pedido -->
                    <div class="col-md-6">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-info-circle me-2"></i>Información del Pedido
                        </h5>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Fecha:</label>
                                <input type="date" id="fechaPedido" class="form-control" required 
                                       value="{{ now.strftime('%Y-%m-%d') }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Empresa:</label>
                                <select id="selectEmpresa" class="form-select" required>
                                    <option value="">Seleccione empresa...</option>
                                    {% for empresa in empresas %}
                                    <option value="{{ empresa.ID_Empresa }}">
                                        {{ empresa.Nombre_Empresa }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Prioridad:</label>
                                <select id="selectPrioridad" class="form-select" required>
                                    {% for prioridad in prioridades %}
                                    <option value="{{ prioridad }}" {% if prioridad == 'Normal' %}selected{% endif %}>
                                        {{ prioridad }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Urgente: Entrega inmediata, Normal: Entrega estándar, Bajo: Sin urgencia
                                </small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Tipo de Entrega:</label>
                                <select id="selectTipoEntrega" class="form-select" required>
                                    <option value="Retiro en local">Retiro en local</option>
                                    <option value="Entrega a domicilio">Entrega a domicilio</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">Observaciones:</label>
                                <textarea id="observacionPedido" class="form-control" rows="2" 
                                          placeholder="Agregue observaciones o notas adicionales..."></textarea>
                            </div>
                        </div>
                        
                        <!-- Indicador de prioridad -->
                        <div class="mt-3" id="indicadorPrioridad" style="display: none;">
                            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-3">
                                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="alert-heading mb-1">Pedido Urgente</h6>
                                        <p class="mb-0 small">
                                            Este pedido será marcado como <strong>URGENTE</strong> y tendrá prioridad 
                                            en el procesamiento y entrega. Asegúrese de contar con el stock necesario.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Selección de Productos -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-boxes me-2"></i>Productos del Pedido
                        </h5>
                        
                        <!-- Categorías -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Categorías disponibles:</label>
                            <div id="categoriasContainer" class="d-flex flex-wrap gap-2">
                                <div class="alert alert-info w-100">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Seleccione un cliente para ver las categorías disponibles
                                </div>
                            </div>
                        </div>
                        
                        <!-- Productos por Categoría -->
                        <div id="productosContainer" style="display: none;">
                            <h6 class="mb-3">Seleccione productos por categoría:</h6>
                            <div id="productosCategoriaContainer">
                                <!-- Aquí se cargan los productos dinámicamente -->
                            </div>
                        </div>
                        
                        <!-- Tabla de Productos Seleccionados -->
                        <div class="mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Productos seleccionados:</h6>
                                <div>
                                    <span id="contadorProductos" class="badge bg-primary me-2">0 productos</span>
                                    <span id="indicadorTotal" class="badge bg-success">Total: C$ 0.00</span>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-bordered" id="tablaProductosSeleccionados">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="50">#</th>
                                            <th>Producto</th>
                                            <th width="150">Precio Unitario</th>
                                            <th width="150">Cantidad</th>
                                            <th width="150">Subtotal</th>
                                            <th width="100">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyProductos">
                                        <tr id="filaVacia">
                                            <td colspan="6" class="text-center text-muted py-4">
                                                <i class="fas fa-box-open fa-2x mb-2 d-block"></i>
                                                No hay productos seleccionados
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot id="tfootTotales" style="display: none;">
                                        <tr class="table-active">
                                            <td colspan="4" class="text-end fw-bold">TOTAL:</td>
                                            <td class="fw-bold text-success fs-5" id="totalPedido">C$ 0.00</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Botones de Acción -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                                <i class="fas fa-times me-1"></i> Cancelar
                            </button>
                            <button type="submit" class="btn btn-success" id="btnGuardar" disabled>
                                <i class="fas fa-save me-1"></i> Guardar Pedido
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para ver stock detallado -->
<div class="modal fade" id="modalStockDetalle" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Stock Disponible por Bodega</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 id="modalProductoNombre" class="mb-3"></h6>
                <div id="contenidoStock" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para confirmar -->
<div class="modal fade" id="modalConfirmacion" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-shopping-cart me-2"></i>Confirmar Pedido
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-3">
                            <i class="fas fa-info-circle fa-2x"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="alert-heading mb-1">Resumen del pedido</h6>
                            <p class="mb-0">El pedido se creará con estado "Pendiente" y se descontará del stock de bodega.</p>
                        </div>
                    </div>
                </div>
                <div id="resumenPedido"></div>
                
                <!-- Resumen de productos -->
                <div class="mt-3">
                    <h6 class="mb-3">Detalle de productos:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered" id="tablaResumenProductos">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">Precio Unit.</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyResumenProductos">
                                <!-- Aquí se cargarán los productos -->
                            </tbody>
                            <tfoot>
                                <tr class="table-active">
                                    <td colspan="3" class="text-end fw-bold">TOTAL:</td>
                                    <td class="text-end fw-bold text-success" id="totalResumen">C$ 0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnConfirmarGuardar">
                    <i class="fas fa-save me-1"></i> Confirmar y Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales
let productosSeleccionados = [];
let tipoClienteActual = null;

// Función para formatear números en formato de moneda Córdobas Nicaragüenses
function formatCurrency(amount) {
    return new Intl.NumberFormat('es-NI', {
        style: 'currency',
        currency: 'NIO',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount).replace('NIO', 'C$');
}

// Función para formatear números con separadores de miles
function formatNumber(number) {
    return new Intl.NumberFormat('es-NI').format(number);
}

// Obtener clase CSS para badge de prioridad
function getBadgeClassPrioridad(prioridad) {
    switch(prioridad) {
        case 'Urgente': return 'bg-danger';
        case 'Normal': return 'bg-primary';
        case 'Bajo': return 'bg-secondary';
        default: return 'bg-info';
    }
}

// Obtener icono para prioridad
function getIconoPrioridad(prioridad) {
    switch(prioridad) {
        case 'Urgente': return 'fas fa-exclamation-triangle';
        case 'Normal': return 'fas fa-bars';
        case 'Bajo': return 'fas fa-angle-down';
        default: return 'fas fa-info-circle';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Configurar fecha actual por defecto
    const fechaInput = document.getElementById('fechaPedido');
    if (fechaInput && !fechaInput.value) {
        fechaInput.value = new Date().toISOString().split('T')[0];
    }
    
    // Evento para cambio de cliente
    document.getElementById('selectCliente').addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        if (option.value) {
            mostrarInfoCliente(option);
            tipoClienteActual = option.getAttribute('data-tipo');
            habilitarBusquedaProductos();
            cargarCategoriasDisponibles(tipoClienteActual);
            validarFormulario();
        } else {
            ocultarInfoCliente();
            deshabilitarBusquedaProductos();
            productosSeleccionados = [];
            actualizarTablaProductos();
            document.getElementById('btnGuardar').disabled = true;
        }
    });
    
    // Evento para cambio de prioridad
    document.getElementById('selectPrioridad').addEventListener('change', function() {
        const prioridad = this.value;
        mostrarIndicadorPrioridad(prioridad);
    });
    
    // Búsqueda de productos
    document.getElementById('btnBuscarProducto').addEventListener('click', buscarProductos);
    document.getElementById('buscarProducto').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            buscarProductos();
        }
    });
    
    // Eventos para el modal de stock
    document.getElementById('modalStockDetalle').addEventListener('hidden.bs.modal', function() {
        document.getElementById('contenidoStock').innerHTML = 
            '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div>';
    });
    
    // Evento para restaurar botón cuando se cierra el modal de confirmación
    document.getElementById('modalConfirmacion').addEventListener('hidden.bs.modal', function () {
        const btnGuardar = document.getElementById('btnConfirmarGuardar');
        if (btnGuardar) {
            btnGuardar.disabled = false;
            btnGuardar.innerHTML = '<i class="fas fa-save me-1"></i> Confirmar y Guardar';
        }
    });
    
    // Si hay cliente seleccionado al cargar la página
    const clienteSelect = document.getElementById('selectCliente');
    if (clienteSelect.value) {
        const option = clienteSelect.options[clienteSelect.selectedIndex];
        mostrarInfoCliente(option);
        tipoClienteActual = option.getAttribute('data-tipo');
        habilitarBusquedaProductos();
        cargarCategoriasDisponibles(tipoClienteActual);
        validarFormulario();
    }
    
    // Verificar prioridad inicial
    mostrarIndicadorPrioridad(document.getElementById('selectPrioridad').value);
    
    // Prevenir envío del formulario
    document.getElementById('formPedido').addEventListener('submit', function(e) {
        e.preventDefault();
        validarYConfirmarPedido();
    });
    
    // Configurar el botón de confirmar en el modal
    document.getElementById('btnConfirmarGuardar').addEventListener('click', function() {
        guardarPedido();
    });
    
    // Inicializar
    actualizarContadorProductos();
});

function mostrarInfoCliente(option) {
    const infoDiv = document.getElementById('clienteInfo');
    const nombre = option.getAttribute('data-nombre');
    const telefono = option.getAttribute('data-telefono') || 'No especificado';
    const direccion = option.getAttribute('data-direccion') || 'No especificada';
    const ruc = option.getAttribute('data-ruc') || 'Sin documento';
    const tipo = option.getAttribute('data-tipo');
    
    document.getElementById('clienteNombre').textContent = nombre;
    document.getElementById('clienteTelefono').textContent = telefono;
    document.getElementById('clienteDireccion').textContent = direccion;
    document.getElementById('clienteRUC').textContent = ruc;
    
    const tipoBadge = document.getElementById('clienteTipo');
    tipoBadge.textContent = tipo;
    tipoBadge.className = `badge ${tipo === 'Especial' ? 'bg-primary' : 'bg-secondary'}`;
    
    infoDiv.style.display = 'block';
}

function ocultarInfoCliente() {
    document.getElementById('clienteInfo').style.display = 'none';
    document.getElementById('productosContainer').style.display = 'none';
}

function mostrarIndicadorPrioridad(prioridad) {
    const indicador = document.getElementById('indicadorPrioridad');
    if (prioridad === 'Urgente') {
        indicador.style.display = 'block';
        // Actualizar contenido del alert
        const alert = indicador.querySelector('.alert');
        const icono = alert.querySelector('i');
        const titulo = alert.querySelector('.alert-heading');
        const descripcion = alert.querySelector('p');
        
        icono.className = getIconoPrioridad(prioridad) + ' fa-2x';
        alert.className = 'alert alert-danger alert-dismissible fade show';
        titulo.textContent = 'Pedido Urgente';
        descripcion.innerHTML = `Este pedido será marcado como <strong class="text-uppercase">${prioridad}</strong> y tendrá prioridad máxima en el procesamiento y entrega.`;
    } else {
        indicador.style.display = 'none';
    }
}

function habilitarBusquedaProductos() {
    document.getElementById('buscarProducto').disabled = false;
    document.getElementById('btnBuscarProducto').disabled = false;
}

function deshabilitarBusquedaProductos() {
    document.getElementById('buscarProducto').disabled = true;
    document.getElementById('btnBuscarProducto').disabled = true;
}

function buscarProductos() {
    const termino = document.getElementById('buscarProducto').value.trim();
    if (termino.length < 2) {
        showAlert('warning', 'Ingrese al menos 2 caracteres para buscar');
        return;
    }
    
    const resultadosDiv = document.getElementById('resultadosBusqueda');
    resultadosDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Buscando...</span></div>';
    resultadosDiv.style.display = 'block';
    
    fetch(`/admin/ventas/buscar-productos?q=${encodeURIComponent(termino)}&tipo_cliente=${tipoClienteActual}`)
        .then(response => response.json())
        .then(productos => {
            if (productos.length === 0) {
                resultadosDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-search me-2"></i>
                        No se encontraron productos
                    </div>`;
                return;
            }
            
            let html = '<div class="list-group">';
            productos.forEach(producto => {
                html += `
                    <div class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${producto.nombre}</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted">
                                            Código: ${producto.codigo || 'N/A'} | 
                                            Stock total: <span class="badge bg-info">${formatNumber(producto.stock)}</span> |
                                            Categoría: ${producto.categoria || 'N/A'}
                                        </small>
                                    </div>
                                    <div>
                                        <span class="fw-bold text-success me-3">${formatCurrency(producto.precio)}</span>
                                        <button type="button" class="btn btn-sm btn-outline-info" 
                                                onclick="verStockProducto(${producto.id}, '${producto.nombre.replace(/'/g, "\\'")}')"
                                                title="Ver stock por bodega">
                                            <i class="fas fa-warehouse"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-primary ms-1" 
                                                onclick="agregarProductoDesdeBusqueda(${JSON.stringify(producto).replace(/"/g, '&quot;')})">
                                            <i class="fas fa-plus me-1"></i> Agregar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            });
            html += '</div>';
            resultadosDiv.innerHTML = html;
        })
        .catch(error => {
            console.error('Error:', error);
            resultadosDiv.innerHTML = '<div class="alert alert-danger">Error al buscar productos</div>';
        });
}

function agregarProductoDesdeBusqueda(producto) {
    agregarProducto(producto);
    document.getElementById('resultadosBusqueda').style.display = 'none';
    document.getElementById('buscarProducto').value = '';
}

function verStockProducto(productoId, productoNombre) {
    const modal = new bootstrap.Modal(document.getElementById('modalStockDetalle'));
    document.getElementById('modalProductoNombre').textContent = productoNombre;
    
    fetch(`/admin/ventas/obtener-stock-producto/${productoId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('contenidoStock').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${data.error}
                    </div>`;
                return;
            }
            
            let html = `
                <div class="mb-3">
                    <p><strong>Código:</strong> ${data.codigo || 'N/A'}</p>
                    <p><strong>Stock Total:</strong> <span class="badge bg-success fs-6">${formatNumber(data.stock_total)}</span></p>
                </div>`;
            
            if (data.bodegas && data.bodegas.length > 0) {
                html += `
                    <h6 class="mb-3">Stock por Bodega:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Bodega</th>
                                    <th class="text-end">Existencias</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                data.bodegas.forEach(bodega => {
                    html += `
                        <tr>
                            <td>${bodega.Nombre_Bodega || `Bodega ${bodega.ID_Bodega}`}</td>
                            <td class="text-end"><span class="badge bg-primary">${formatNumber(bodega.Existencias)}</span></td>
                        </tr>`;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>`;
            } else {
                html += `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No hay stock registrado en bodegas para este producto
                    </div>`;
            }
            
            document.getElementById('contenidoStock').innerHTML = html;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('contenidoStock').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error al cargar el stock del producto
                </div>`;
        });
    
    modal.show();
}

function cargarCategoriasDisponibles(tipoCliente) {
    const container = document.getElementById('categoriasContainer');
    container.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div>';
    
    fetch(`/admin/ventas/obtener-categorias-visibles?tipo_cliente=${tipoCliente}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }
            
            if (data.categorias.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning w-100">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No hay categorías disponibles para este tipo de cliente
                    </div>`;
                document.getElementById('productosContainer').style.display = 'none';
                return;
            }
            
            container.innerHTML = '';
            data.categorias.forEach(categoria => {
                const boton = document.createElement('button');
                boton.type = 'button';
                boton.className = 'btn btn-outline-primary mb-2';
                boton.innerHTML = `<i class="fas fa-folder me-2"></i>${categoria.nombre}`;
                boton.onclick = () => cargarProductosCategoria(categoria.id, categoria.nombre);
                container.appendChild(boton);
            });
            
            document.getElementById('productosContainer').style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            container.innerHTML = `<div class="alert alert-danger">Error al cargar categorías</div>`;
        });
}

function cargarProductosCategoria(categoriaId, categoriaNombre) {
    const container = document.getElementById('productosCategoriaContainer');
    container.innerHTML = `
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-folder me-2"></i>${categoriaNombre}
                    <button type="button" class="btn btn-sm btn-outline-secondary float-end" 
                            onclick="cerrarProductosCategoria()">
                        <i class="fas fa-times"></i>
                    </button>
                </h6>
            </div>
            <div class="card-body">
                <div class="row" id="productosGrid-${categoriaId}">
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando productos...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    
    fetch(`/admin/ventas/obtener-productos-categoria?categoria_id=${categoriaId}&tipo_cliente=${tipoClienteActual}`)
        .then(response => response.json())
        .then(data => {
            const grid = document.getElementById(`productosGrid-${categoriaId}`);
            
            if (data.error) {
                grid.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }
            
            if (data.productos.length === 0) {
                grid.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No hay productos disponibles en esta categoría
                        </div>
                    </div>`;
                return;
            }
            
            grid.innerHTML = '';
            data.productos.forEach(producto => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4 mb-3';
                col.innerHTML = `
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title">${producto.nombre}</h6>
                            <div class="card-text small text-muted mb-2">
                                <span class="badge bg-dark">${producto.codigo || 'N/A'}</span>
                                <span class="badge bg-info">${producto.unidad_abreviatura || producto.unidad_descripcion || 'Unidad'}</span>
                            </div>
                            <p class="card-text small mb-2">
                                <i class="fas fa-box me-1"></i> Stock total: <span class="badge bg-success">${formatNumber(producto.stock)}</span>
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold text-success">${formatCurrency(producto.precio)}</span>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-info me-1" 
                                            onclick="verStockProducto(${producto.id}, '${producto.nombre.replace(/'/g, "\\'")}')"
                                            title="Ver stock por bodega">
                                        <i class="fas fa-warehouse"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-primary" 
                                            onclick="agregarProducto(${JSON.stringify(producto).replace(/"/g, '&quot;')})">
                                        <i class="fas fa-plus me-1"></i> Agregar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                grid.appendChild(col);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            const grid = document.getElementById(`productosGrid-${categoriaId}`);
            grid.innerHTML = `<div class="alert alert-danger">Error al cargar productos</div>`;
        });
}

function cerrarProductosCategoria() {
    document.getElementById('productosCategoriaContainer').innerHTML = '';
}

function agregarProducto(producto) {
    // Verificar si el producto ya está en la lista
    const index = productosSeleccionados.findIndex(p => p.id === producto.id);
    
    if (index !== -1) {
        // Si ya existe, aumentar cantidad en 1
        const cantidadActual = productosSeleccionados[index].cantidad;
        const nuevaCantidad = cantidadActual + 1;
        
        if (nuevaCantidad > producto.stock) {
            showAlert('warning', `Stock insuficiente para "${producto.nombre}". Disponible: ${formatNumber(producto.stock)}`);
            return;
        }
        
        productosSeleccionados[index].cantidad = nuevaCantidad;
        productosSeleccionados[index].subtotal = producto.precio * nuevaCantidad;
        actualizarTablaProductos();
        showToast('info', 'Cantidad actualizada', `Cantidad de "${producto.nombre}" aumentada a ${formatNumber(nuevaCantidad)}`);
        return;
    }
    
    // Si no existe, agregar con cantidad 1 por defecto
    if (1 > producto.stock) {
        showAlert('warning', `Stock insuficiente para "${producto.nombre}". Disponible: ${formatNumber(producto.stock)}`);
        return;
    }
    
    productosSeleccionados.push({
        id: producto.id,
        nombre: producto.nombre,
        codigo: producto.codigo,
        precio: producto.precio,
        cantidad: 1,
        stock: producto.stock,
        unidad: producto.unidad_abreviatura || producto.unidad_descripcion || 'Unidad',
        subtotal: producto.precio * 1
    });
    
    actualizarTablaProductos();
    showToast('success', 'Producto agregado', `${producto.nombre} agregado al pedido`);
}

function actualizarTablaProductos() {
    const tbody = document.getElementById('tbodyProductos');
    const tfoot = document.getElementById('tfootTotales');
    const filaVacia = document.getElementById('filaVacia');
    
    if (productosSeleccionados.length === 0) {
        if (filaVacia) filaVacia.style.display = '';
        tfoot.style.display = 'none';
        return;
    }
    
    // Ocultar fila vacía
    if (filaVacia) filaVacia.style.display = 'none';
    
    // Ordenar por nombre
    productosSeleccionados.sort((a, b) => a.nombre.localeCompare(b.nombre));
    
    tbody.innerHTML = '';
    let total = 0;
    
    productosSeleccionados.forEach((producto, index) => {
        total += producto.subtotal;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>
                <div class="fw-bold">${producto.nombre}</div>
                <small class="text-muted">
                    Código: ${producto.codigo || 'N/A'} | 
                    Unidad: ${producto.unidad} |
                    Stock: <span class="badge bg-secondary">${formatNumber(producto.stock)}</span>
                </small>
            </td>
            <td>
                <div class="input-group input-group-sm">
                    <span class="input-group-text">C$</span>
                    <input type="number" class="form-control precio-input" 
                           value="${producto.precio.toFixed(2)}" step="0.01" min="0.01"
                           data-index="${index}" onchange="actualizarPrecio(${index}, this.value)">
                </div>
            </td>
            <td>
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control cantidad-input" 
                           value="${producto.cantidad}" step="0.01" min="0.01" max="${producto.stock}"
                           data-index="${index}" onchange="actualizarCantidad(${index}, this.value)">
                    <button class="btn btn-outline-secondary" type="button" 
                            onclick="modificarCantidad(${index}, 1)">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-outline-secondary" type="button" 
                            onclick="modificarCantidad(${index}, -1)">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                <small class="text-muted">Disponible: ${formatNumber(producto.stock)}</small>
            </td>
            <td class="fw-bold text-success">${formatCurrency(producto.subtotal)}</td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-info me-1" 
                        onclick="verStockProducto(${producto.id}, '${producto.nombre.replace(/'/g, "\\'")}')"
                        title="Ver stock por bodega">
                    <i class="fas fa-warehouse"></i>
                </button>
                <button type="button" class="btn btn-sm btn-danger" 
                        onclick="eliminarProducto(${index})" title="Eliminar">
                    <i class="fas fa-trash"></i>
                </button>
            </td>`;
        tbody.appendChild(row);
    });
    
    // Actualizar total
    const totalFormateado = formatCurrency(total);
    document.getElementById('totalPedido').textContent = totalFormateado;
    document.getElementById('indicadorTotal').textContent = `Total: ${totalFormateado}`;
    tfoot.style.display = '';
    
    actualizarContadorProductos();
    validarFormulario();
}

function actualizarContadorProductos() {
    const contador = document.getElementById('contadorProductos');
    contador.textContent = `${productosSeleccionados.length} producto${productosSeleccionados.length !== 1 ? 's' : ''}`;
    contador.className = `badge ${productosSeleccionados.length > 0 ? 'bg-success' : 'bg-primary'}`;
}

function modificarCantidad(index, cambio) {
    const producto = productosSeleccionados[index];
    const nuevaCantidad = producto.cantidad + cambio;
    
    if (nuevaCantidad < 0.01) {
        return; // No permitir cantidades negativas
    }
    
    if (nuevaCantidad > producto.stock) {
        showAlert('warning', `Stock insuficiente. Disponible: ${formatNumber(producto.stock)}`);
        return;
    }
    
    productosSeleccionados[index].cantidad = nuevaCantidad;
    productosSeleccionados[index].subtotal = producto.precio * nuevaCantidad;
    actualizarTablaProductos();
}

function actualizarPrecio(index, nuevoPrecio) {
    nuevoPrecio = parseFloat(nuevoPrecio);
    if (isNaN(nuevoPrecio) || nuevoPrecio < 0.01) {
        nuevoPrecio = productosSeleccionados[index].precio;
    }
    
    productosSeleccionados[index].precio = nuevoPrecio;
    productosSeleccionados[index].subtotal = nuevoPrecio * productosSeleccionados[index].cantidad;
    actualizarTablaProductos();
}

function actualizarCantidad(index, nuevaCantidad) {
    nuevaCantidad = parseFloat(nuevaCantidad);
    if (isNaN(nuevaCantidad) || nuevaCantidad < 0.01) {
        nuevaCantidad = productosSeleccionados[index].cantidad;
    }
    
    if (nuevaCantidad > productosSeleccionados[index].stock) {
        showAlert('warning', `Stock insuficiente. Disponible: ${formatNumber(productosSeleccionados[index].stock)}`);
        nuevaCantidad = productosSeleccionados[index].cantidad;
    }
    
    productosSeleccionados[index].cantidad = nuevaCantidad;
    productosSeleccionados[index].subtotal = productosSeleccionados[index].precio * nuevaCantidad;
    actualizarTablaProductos();
}

function eliminarProducto(index) {
    if (confirm(`¿Eliminar "${productosSeleccionados[index].nombre}" del pedido?`)) {
        productosSeleccionados.splice(index, 1);
        actualizarTablaProductos();
        showToast('info', 'Producto eliminado', 'El producto ha sido removido del pedido');
    }
}

function validarFormulario() {
    const clienteValido = document.getElementById('selectCliente').value !== '';
    const empresaValido = document.getElementById('selectEmpresa').value !== '';
    const fechaValido = document.getElementById('fechaPedido').value !== '';
    const prioridadValido = document.getElementById('selectPrioridad').value !== '';
    const productosValido = productosSeleccionados.length > 0;
    
    const formularioValido = clienteValido && empresaValido && fechaValido && prioridadValido && productosValido;
    document.getElementById('btnGuardar').disabled = !formularioValido;
    
    return formularioValido;
}

function validarYConfirmarPedido() {
    if (!validarFormulario()) {
        showAlert('warning', 'Complete todos los campos obligatorios y agregue al menos un producto');
        return;
    }
    
    // Preparar resumen del pedido
    const prioridad = document.getElementById('selectPrioridad').value;
    const prioridadBadgeClass = getBadgeClassPrioridad(prioridad);
    const prioridadIcono = getIconoPrioridad(prioridad);
    
    const resumen = document.getElementById('resumenPedido');
    let html = `
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title border-bottom pb-2 mb-3">
                            <i class="fas fa-user me-2"></i>Datos del Cliente
                        </h6>
                        <p><strong>Cliente:</strong> ${document.getElementById('clienteNombre').textContent}</p>
                        <p><strong>Documento:</strong> ${document.getElementById('clienteRUC').textContent}</p>
                        <p><strong>Teléfono:</strong> ${document.getElementById('clienteTelefono').textContent}</p>
                        <p><strong>Dirección:</strong> ${document.getElementById('clienteDireccion').textContent}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title border-bottom pb-2 mb-3">
                            <i class="fas fa-info-circle me-2"></i>Información del Pedido
                        </h6>
                        <p><strong>Fecha:</strong> ${document.getElementById('fechaPedido').value}</p>
                        <p><strong>Empresa:</strong> ${document.getElementById('selectEmpresa').options[document.getElementById('selectEmpresa').selectedIndex].text}</p>
                        <p><strong>Prioridad:</strong> <span class="badge ${prioridadBadgeClass}"><i class="${prioridadIcono} me-1"></i>${prioridad}</span></p>
                        <p><strong>Tipo entrega:</strong> ${document.getElementById('selectTipoEntrega').value}</p>
                        <p><strong>Observaciones:</strong> ${document.getElementById('observacionPedido').value || 'Ninguna'}</p>
                    </div>
                </div>
            </div>
        </div>`;
    resumen.innerHTML = html;
    
    // Preparar tabla de resumen de productos
    const tbodyResumen = document.getElementById('tbodyResumenProductos');
    const totalResumen = document.getElementById('totalResumen');
    
    let htmlResumen = '';
    let total = 0;
    
    productosSeleccionados.forEach((producto, index) => {
        total += producto.subtotal;
        htmlResumen += `
            <tr>
                <td>${index + 1}. ${producto.nombre}<br><small class="text-muted">Código: ${producto.codigo || 'N/A'} | Unidad: ${producto.unidad}</small></td>
                <td class="text-center">${formatNumber(producto.cantidad)}</td>
                <td class="text-end">${formatCurrency(producto.precio)}</td>
                <td class="text-end fw-bold">${formatCurrency(producto.subtotal)}</td>
            </tr>`;
    });
    
    tbodyResumen.innerHTML = htmlResumen;
    totalResumen.textContent = formatCurrency(total);
    
    // Mostrar modal de confirmación
    const modal = new bootstrap.Modal(document.getElementById('modalConfirmacion'));
    modal.show();
}

function guardarPedido() {
    const btnGuardar = document.getElementById('btnConfirmarGuardar');
    const modalElement = document.getElementById('modalConfirmacion');
    
    // Obtener la instancia del modal de Bootstrap
    const modal = bootstrap.Modal.getInstance(modalElement);
    
    btnGuardar.disabled = true;
    btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';
    
    const datosPedido = {
        cliente_id: document.getElementById('selectCliente').value,
        empresa_id: document.getElementById('selectEmpresa').value,
        fecha: document.getElementById('fechaPedido').value,
        tipo_entrega: document.getElementById('selectTipoEntrega').value,
        prioridad: document.getElementById('selectPrioridad').value,
        observacion: document.getElementById('observacionPedido').value,
        productos: productosSeleccionados.map(p => ({
            id: p.id,
            nombre: p.nombre,
            precio: p.precio,
            cantidad: p.cantidad
        }))
    };
    
    fetch('/admin/ventas/crear-pedido', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(datosPedido)
    })
    .then(response => response.json())
    .then(data => {
        // Cerrar el modal inmediatamente
        modal.hide();
        
        if (data.success) {
            showToast('success', 'Pedido creado', `Pedido #${data.pedido_id} creado exitosamente`);
            setTimeout(() => {
                // ✅ CORREGIDO: Redirigir a la ruta correcta que existe
                window.location.href = `/admin/ventas/pedido-venta/${data.pedido_id}`;
                // O mejor aún, si el servidor envía redirect_url:
                // window.location.href = data.redirect_url;
            }, 1500);
        } else {
            showAlert('error', data.message || 'Error al crear el pedido');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        modal.hide();
        showAlert('error', 'Error al conectar con el servidor');
    });
}

function showAlert(type, message) {
    // Crear elemento de alerta
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1055; max-width: 400px;';
    alertDiv.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-exclamation-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Agregar al body
    document.body.appendChild(alertDiv);
    
    // Auto eliminar después de 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function showToast(type, title, message) {
    // Crear elemento toast
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed`;
    toast.style.cssText = 'bottom: 20px; right: 20px; z-index: 1055;';
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <strong>${title}:</strong> ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    // Agregar al body
    document.body.appendChild(toast);
    
    // Inicializar toast de Bootstrap
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remover del DOM después de que se oculte
    toast.addEventListener('hidden.bs.toast', function() {
        if (toast.parentNode) {
            toast.remove();
        }
    });
}
</script>

<style>
.precio-input, .cantidad-input {
    text-align: right;
}
.table th {
    background-color: #f8f9fa;
    font-weight: 600;
}
.badge {
    font-size: 0.85em;
}
.card-header {
    font-weight: 600;
}
#productosCategoriaContainer .card {
    max-height: 500px;
    overflow-y: auto;
}
#resultadosBusqueda {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 10px;
    background-color: #f8f9fa;
}
.btn-group-sm > .btn {
    padding: 0.25rem 0.5rem;
}
.table-hover tbody tr:hover {
    background-color: rgba(0,123,255,0.05);
}
.input-group-sm .form-control {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}
.input-group-text {
    background-color: #f8f9fa;
    border-color: #dee2e6;
    font-weight: 600;
}
.text-success {
    color: #198754 !important;
}
/* Estilos para badges de prioridad */
.bg-danger { 
    background-color: #dc3545 !important; 
    color: white !important;
}
.bg-primary { 
    background-color: #0d6efd !important; 
    color: white !important;
}
.bg-secondary { 
    background-color: #6c757d !important; 
    color: white !important;
}
.bg-info { 
    background-color: #0dcaf0 !important; 
    color: white !important;
}
.bg-warning { 
    background-color: #ffc107 !important; 
    color: black !important;
}

/* Indicador de prioridad */
#indicadorPrioridad .alert {
    border-left: 4px solid #dc3545;
}

/* Animación para indicador urgente */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

#indicadorPrioridad .alert-danger {
    animation: pulse 2s infinite;
}

/* Mejorar contraste para campos de entrada */
.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Estilos para la tabla de resumen */
#tablaResumenProductos th {
    background-color: #e9ecef;
    font-weight: 600;
}
</style>
{% endblock %}