{% extends "layout.html" %}

{% block title %}Pedidos de Venta{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-shopping-cart me-2"></i>Pedidos de Venta</h2>
        <div>
            <!-- Mostrar botones solo si NO es rol bodega -->
            {% if not current_user.rol == 'Bodega' %}
            <div class="btn-group">
                <button class="btn btn-success" onclick="nuevoPedido('individual')">
                    <i class="fas fa-plus me-1"></i> Nuevo Pedido Individual
                </button>
                <button class="btn btn-info" onclick="nuevoPedido('consolidado')">
                    <i class="fas fa-layer-group me-1"></i> Pedido Consolidado
                </button>
            </div>
            {% endif %}
            <a href="{{ url_for('admin_pedidos_venta') }}" class="btn btn-secondary ms-2">
                <i class="fas fa-sync-alt me-1"></i> Refrescar
            </a>
        </div>
    </div>
    
    <!-- Filtros Avanzados -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros de B칰squeda</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('filtrar_pedidos') }}" id="formFiltros">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Estado:</label>
                        <select name="estado" class="form-select">
                            <option value="todos">Todos los estados</option>
                            {% for estado in estados %}
                            <option value="{{ estado }}" {% if filtros_aplicados and filtros_aplicados.estado==estado %}selected{% endif %}>
                                {{ estado }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Prioridad:</label>
                        <select name="prioridad" class="form-select">
                            <option value="todos">Todas las prioridades</option>
                            {% for prioridad in prioridades %}
                            <option value="{{ prioridad }}" {% if filtros_aplicados and filtros_aplicados.prioridad==prioridad %}selected{% endif %}>
                                {{ prioridad }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Tipo Pedido:</label>
                        <select name="tipo_pedido" class="form-select">
                            <option value="todos">Todos los tipos</option>
                            {% for tipo in tipos_pedido %}
                            <option value="{{ tipo }}" {% if filtros_aplicados and filtros_aplicados.tipo_pedido==tipo %}selected{% endif %}>
                                {{ tipo }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Tipo Cliente:</label>
                        <select name="tipo_cliente" class="form-select">
                            <option value="todos">Todos los tipos</option>
                            {% for tipo in tipos_cliente %}
                            <option value="{{ tipo }}" {% if filtros_aplicados and filtros_aplicados.tipo_cliente==tipo %}selected{% endif %}>
                                {{ tipo }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Tipo Entrega:</label>
                        <select name="tipo_entrega" class="form-select">
                            <option value="todos">Todos los tipos</option>
                            {% for tipo in tipos_entrega %}
                            <option value="{{ tipo }}" {% if filtros_aplicados and filtros_aplicados.tipo_entrega==tipo %}selected{% endif %}>
                                {{ tipo }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Pedido Ruta:</label>
                        <select name="es_pedido_ruta" class="form-select">
                            <option value="todos">Todos</option>
                            {% for opcion in opciones_ruta %}
                            <option value="{{ opcion }}" {% if filtros_aplicados and filtros_aplicados.es_pedido_ruta==opcion %}selected{% endif %}>
                                {{ opcion }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Ruta:</label>
                        <select name="id_ruta" class="form-select">
                            <option value="todos">Todas las rutas</option>
                            {% if rutas %}
                                {% for ruta in rutas %}
                                <option value="{{ ruta.ID_Ruta }}" {% if filtros_aplicados and filtros_aplicados.id_ruta == ruta.ID_Ruta|string %}selected{% endif %}>
                                    {{ ruta.Nombre_Ruta }}
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Fecha Inicio:</label>
                        <input type="date" name="fecha_inicio" class="form-control"
                            value="{{ filtros_aplicados.fecha_inicio if filtros_aplicados }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Fecha Fin:</label>
                        <input type="date" name="fecha_fin" class="form-control"
                            value="{{ filtros_aplicados.fecha_fin if filtros_aplicados }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Documento Cliente:</label>
                        <input type="text" name="documento_cliente" class="form-control" placeholder="RUC/C칠dula"
                            value="{{ filtros_aplicados.documento_cliente if filtros_aplicados }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Nombre Cliente:</label>
                        <input type="text" name="nombre_cliente" class="form-control" placeholder="Nombre del cliente"
                            value="{{ filtros_aplicados.nombre_cliente if filtros_aplicados }}">
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i> Buscar
                        </button>
                        <a href="{{ url_for('admin_pedidos_venta') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i> Limpiar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Resumen Estad칤stico -->
    {% if pedidos %}
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h6 class="card-title"><i class="fas fa-shopping-cart me-2"></i>Total Pedidos</h6>
                    <h3 class="card-text">{{ pedidos|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            {% set total_ventas = pedidos|sum(attribute='Total_Pedido') or 0 %}
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h6 class="card-title"><i class="fas fa-dollar-sign me-2"></i>Total Ventas</h6>
                    <h3 class="card-text">C${{ "{:,.2f}".format(total_ventas) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            {% set pendientes = pedidos|selectattr('Estado', 'equalto', 'Pendiente')|list %}
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h6 class="card-title"><i class="fas fa-clock me-2"></i>Pendientes</h6>
                    <h3 class="card-text">{{ pendientes|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            {% set urgentes = pedidos|selectattr('Prioridad', 'equalto', 'Urgente')|list %}
            <div class="card text-white bg-danger">
                <div class="card-body">
                    <h6 class="card-title"><i class="fas fa-exclamation-triangle me-2"></i>Urgentes</h6>
                    <h3 class="card-text">{{ urgentes|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            {% set consolidados = pedidos|selectattr('Tipo_Pedido', 'equalto', 'Consolidado')|list %}
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h6 class="card-title"><i class="fas fa-layer-group me-2"></i>Consolidados</h6>
                    <h3 class="card-text">{{ consolidados|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            {% set ruta_pedidos = pedidos|selectattr('Es_Pedido_Ruta', 'equalto', 'SI')|list %}
            <div class="card text-white bg-secondary">
                <div class="card-body">
                    <h6 class="card-title"><i class="fas fa-route me-2"></i>Ruta</h6>
                    <h3 class="card-text">{{ ruta_pedidos|length }}</h3>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Lista de Pedidos -->
    <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Listado de Pedidos</h5>
            <div>
                <span class="badge bg-dark">{{ pedidos|length }} registros</span>
                {% if es_rol_bodega %}
                <span class="badge bg-info ms-2">Vista Bodega</span>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            {% if pedidos %}
            <div class="table-responsive">
                <table class="table table-hover table-striped" id="tablaPedidos">
                    <thead class="table-dark">
                        <tr>
                            <th width="80">ID</th>
                            <th width="100">Fecha</th>
                            <th>Cliente / Consolidado</th>
                            <th width="120">Documento</th>
                            <th width="100">Tipo</th>
                            <th width="100">Tipo Pedido</th>
                            <th width="80">Ruta</th>
                            <th width="100">Prioridad</th>
                            <th width="120">Estado</th>
                            <th width="150">Entrega</th>
                            <th width="120">Total</th>
                            <th width="80">Items</th>
                            <th width="250">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pedido in pedidos %}
                        <tr>
                            <td>
                                <strong>#{{ pedido.ID_Pedido }}</strong>
                                {% if pedido.Prioridad == 'Urgente' %}
                                <span class="badge bg-danger float-end" title="Urgente">
                                    <i class="fas fa-exclamation"></i>
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if pedido.Fecha %}
                                {{ pedido.Fecha.strftime('%d/%m/%Y') }}
                                {% else %}
                                N/A
                                {% endif %}
                                {% if pedido.Es_Pedido_Ruta == 'SI' %}
                                <span class="badge bg-info" title="Pedido de ruta">
                                    <i class="fas fa-route"></i>
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if pedido.Tipo_Pedido == 'Consolidado' %}
                                <div class="fw-bold">
                                    <i class="fas fa-layer-group me-1 text-info"></i>
                                    Pedido Consolidado
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-building me-1"></i> {{ pedido.Nombre_Empresa or 'N/A' }}
                                </small>
                                {% else %}
                                <div class="fw-bold">{{ pedido.Nombre_Cliente or 'Sin nombre' }}</div>
                                <small class="text-muted">
                                    <i class="fas fa-phone-alt"></i> {{ pedido.Telefono_Cliente or 'Sin tel칠fono' }}
                                </small>
                                {% endif %}
                                {% if pedido.Nombre_Ruta %}
                                <span class="badge bg-light text-dark d-block mt-1">
                                    <i class="fas fa-route me-1"></i> {{ pedido.Nombre_Ruta }}
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if pedido.Tipo_Pedido != 'Consolidado' %}
                                    {% if pedido.Documento_Cliente %}
                                    <span class="badge bg-secondary">{{ pedido.Documento_Cliente }}</span>
                                    {% else %}
                                    <span class="badge bg-light text-dark">Sin doc</span>
                                    {% endif %}
                                {% else %}
                                <span class="badge bg-info">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if pedido.Tipo_Pedido != 'Consolidado' %}
                                <span class="badge 
                                    {% if pedido.Tipo_Cliente == 'Especial' %}bg-primary
                                    {% else %}bg-light text-dark{% endif %}">
                                    {{ pedido.Tipo_Cliente }}
                                </span>
                                {% else %}
                                <span class="badge bg-secondary">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge 
                                    {% if pedido.Tipo_Pedido == 'Consolidado' %}bg-info
                                    {% else %}bg-secondary{% endif %}">
                                    {{ pedido.Tipo_Pedido }}
                                </span>
                            </td>
                            <td>
                                {% if pedido.Es_Pedido_Ruta == 'SI' %}
                                <span class="badge bg-success">SI</span>
                                {% else %}
                                <span class="badge bg-secondary">NO</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge 
                                    {% if pedido.Prioridad == 'Urgente' %}bg-danger
                                    {% elif pedido.Prioridad == 'Normal' %}bg-primary
                                    {% elif pedido.Prioridad == 'Bajo' %}bg-secondary
                                    {% else %}bg-light text-dark{% endif %} p-2">
                                    <i class="fas 
                                        {% if pedido.Prioridad == 'Urgente' %}fa-exclamation-triangle
                                        {% elif pedido.Prioridad == 'Bajo' %}fa-angle-down
                                        {% else %}fa-bars{% endif %} me-1"></i>
                                    {{ pedido.Prioridad }}
                                </span>
                            </td>
                            <td>
                                <span class="badge 
                                    {% if pedido.Estado == 'Pendiente' %}bg-warning text-dark
                                    {% elif pedido.Estado == 'Aprobado' %}bg-info
                                    {% elif pedido.Estado == 'En Proceso' %}bg-primary
                                    {% elif pedido.Estado == 'Entregado' %}bg-success
                                    {% elif pedido.Estado == 'Cancelado' %}bg-danger
                                    {% else %}bg-secondary{% endif %} p-2">
                                    <i class="fas 
                                        {% if pedido.Estado == 'Pendiente' %}fa-clock
                                        {% elif pedido.Estado == 'Aprobado' %}fa-check-circle
                                        {% elif pedido.Estado == 'En Proceso' %}fa-cogs
                                        {% elif pedido.Estado == 'Entregado' %}fa-truck
                                        {% elif pedido.Estado == 'Cancelado' %}fa-times-circle
                                        {% endif %} me-1"></i>
                                    {{ pedido.Estado }}
                                </span>
                            </td>
                            <td>
                                <span class="badge 
                                    {% if pedido.Tipo_Entrega == 'Entrega a domicilio' %}bg-primary
                                    {% else %}bg-light text-dark{% endif %} p-2">
                                    <i class="fas 
                                        {% if pedido.Tipo_Entrega == 'Entrega a domicilio' %}fa-truck
                                        {% else %}fa-store{% endif %} me-1"></i>
                                    {{ pedido.Tipo_Entrega }}
                                </span>
                            </td>
                            <td class="fw-bold text-success">C${{ "{:,.2f}".format(pedido.Total_Pedido or 0) }}</td>
                            <td>
                                <span class="badge bg-dark rounded-circle">
                                    {{ pedido.Total_Items|default(0, true) }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <!-- ============================================ -->
                                    <!-- BOT칍N DETALLE - SIEMPRE VISIBLE            -->
                                    <!-- ============================================ -->
                                    <a href="{{ url_for('ver_pedido', id_pedido=pedido.ID_Pedido) }}"
                                        class="btn btn-outline-info" title="Ver detalle" data-bs-toggle="tooltip">
                                        <i class="fas fa-eye"></i> Detalle
                                    </a>

                                    <!-- ============================================ -->
                                    <!-- USUARIO: BODEGA                             -->
                                    <!-- ============================================ -->
                                    {% if current_user.rol == 'Bodega' %}
                                        
                                        <!-- 游댠 CASO 1: PEDIDO CONSOLIDADO - PENDIENTE - PROCESAR CARGA 游댠 -->
                                        {% if pedido.Tipo_Pedido == 'Consolidado' and pedido.Estado == 'Pendiente' %}
                                        <a href="{{ url_for('distribuir_carga', id_pedido=pedido.ID_Pedido) }}"
                                            class="btn btn-warning" title="Procesar carga a ruta" data-bs-toggle="tooltip">
                                            <i class="fas fa-truck-loading"></i> Carga
                                        </a>
                                        
                                        <!-- CASO 2: PEDIDO INDIVIDUAL - APROBADO - PROCESAR VENTA -->
                                        {% elif pedido.Tipo_Pedido != 'Consolidado' and pedido.Estado == 'Aprobado' %}
                                        <a href="{{ url_for('admin_procesar_venta_pedido', id_pedido=pedido.ID_Pedido) }}"
                                            class="btn btn-outline-primary" title="Procesar como venta" data-bs-toggle="tooltip">
                                            <i class="fas fa-cash-register"></i> Venta
                                        </a>
                                        {% endif %}
                                        
                                        <!-- CASO 3: PEDIDO PENDIENTE - APROBAR (excepto consolidados pendientes que ya tienen bot칩n de carga) -->
                                        {% if pedido.Estado == 'Pendiente' and not (pedido.Tipo_Pedido == 'Consolidado') %}
                                        <button type="button" class="btn btn-outline-success" title="Aprobar pedido"
                                            data-bs-toggle="tooltip"
                                            onclick="cambiarEstado({{ pedido.ID_Pedido }}, 'Aprobado')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        {% endif %}
                                        
                                        <!-- CASO 4: PEDIDO NO CANCELADO NI ENTREGADO - CANCELAR -->
                                        {% if pedido.Estado != 'Cancelado' and pedido.Estado != 'Entregado' %}
                                        <button type="button" class="btn btn-outline-danger" title="Cancelar pedido"
                                            data-bs-toggle="tooltip" onclick="cancelarPedido({{ pedido.ID_Pedido }})">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        {% endif %}

                                    <!-- ============================================ -->
                                    <!-- USUARIO: OTROS ROLES (ADMIN, VENTAS, ETC)   -->
                                    <!-- ============================================ -->
                                    {% else %}
                                        
                                        <!-- CASO 1: PEDIDO PENDIENTE - APROBAR -->
                                        {% if pedido.Estado == 'Pendiente' %}
                                        <button type="button" class="btn btn-outline-success" title="Aprobar pedido"
                                            data-bs-toggle="tooltip"
                                            onclick="cambiarEstado({{ pedido.ID_Pedido }}, 'Aprobado')">
                                            <i class="fas fa-check"></i> Aprobar
                                        </button>
                                        {% endif %}
                                        
                                        <!-- CASO 2: PEDIDO NO CANCELADO NI ENTREGADO - CAMBIAR ESTADO -->
                                        {% if pedido.Estado != 'Cancelado' and pedido.Estado != 'Entregado' %}
                                        <button type="button" class="btn btn-outline-warning" title="Cambiar estado"
                                            data-bs-toggle="tooltip" onclick="cambiarEstado({{ pedido.ID_Pedido }})">
                                            <i class="fas fa-exchange-alt"></i> Estado
                                        </button>
                                        {% endif %}
                                        
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="table-active">
                            <td colspan="10" class="text-end fw-bold">TOTAL GENERAL:</td>
                            <td class="fw-bold text-primary fs-5">C${{ "{:,.2f}".format(pedidos|sum(attribute='Total_Pedido') or 0) }}</td>
                            <td class="text-center fw-bold">{{ pedidos|sum(attribute='Total_Items') or 0 }}</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No hay pedidos registrados</h4>
                <p class="text-muted">
                    {% if filtros_aplicados %}
                    No se encontraron pedidos con los filtros aplicados
                    {% else %}
                    Comienza creando tu primer pedido
                    {% endif %}
                </p>
                {% if filtros_aplicados %}
                <a href="{{ url_for('admin_pedidos_venta') }}" class="btn btn-primary mt-2">
                    <i class="fas fa-redo me-1"></i> Ver todos los pedidos
                </a>
                {% else %}
                {% if not es_rol_bodega %}
                <div class="mt-3">
                    <button class="btn btn-success mt-2" onclick="nuevoPedido('individual')">
                        <i class="fas fa-plus me-1"></i> Crear pedido individual
                    </button>
                    <button class="btn btn-info mt-2 ms-2" onclick="nuevoPedido('consolidado')">
                        <i class="fas fa-layer-group me-1"></i> Crear pedido consolidado
                    </button>
                </div>
                {% endif %}
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% if pedidos %}
        <div class="card-footer bg-light">
            <div class="row">
                <div class="col-md-6">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Mostrando {{ pedidos|length }} pedido(s)
                        {% if es_rol_bodega %}
                        <span class="badge bg-info ms-2">Solo pedidos del d칤a</span>
                        {% endif %}
                    </small>
                </div>
                <div class="col-md-6 text-end">
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                        칔ltima actualizaci칩n: {{ now.strftime('%d/%m/%Y %H:%M:%S') if now else '' }}
                    </small>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal para cambiar estado -->
<div class="modal fade" id="modalEstado" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cambiar Estado del Pedido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Seleccione el nuevo estado para el pedido:</p>
                <select id="selectEstado" class="form-select">
                    <option value="Pendiente">Pendiente</option>
                    <option value="Aprobado">Aprobado</option>
                    {% if current_user.rol == 'Bodega' %}
                    <option value="En Proceso">En Proceso</option>
                    {% endif %}
                    <option value="Entregado">Entregado</option>
                    <option value="Cancelado">Cancelado</option>
                </select>
                <div class="mt-3">
                    <label>Observaci칩n (opcional):</label>
                    <textarea id="observacionEstado" class="form-control" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarCambioEstado()">Cambiar Estado</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Variables globales
    let pedidoActual = null;
    let estadoActual = null;

    document.addEventListener('DOMContentLoaded', function () {
        // Inicializar tooltips de Bootstrap
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Configurar fechas por defecto
        const today = new Date().toISOString().split('T')[0];
        const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];

        const fechaInicio = document.querySelector('input[name="fecha_inicio"]');
        const fechaFin = document.querySelector('input[name="fecha_fin"]');

        if (fechaInicio && !fechaInicio.value) {
            fechaInicio.value = firstDay;
        }
        if (fechaFin && !fechaFin.value) {
            fechaFin.value = today;
        }

        // Inicializar DataTables si existe la tabla
        if (typeof $.fn.DataTable !== 'undefined' && document.getElementById('tablaPedidos')) {
            $('#tablaPedidos').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json"
                },
                "order": [[0, 'desc']],
                "pageLength": 25,
                "responsive": true,
                "columnDefs": [
                    { "orderable": false, "targets": [12] }
                ]
            });
        }
    });

    function nuevoPedido(tipo) {
        if (tipo === 'individual') {
            window.location.href = "/admin/ventas/nuevo-pedido";
        } else if (tipo === 'consolidado') {
            window.location.href = "/admin/ventas/nuevo-pedido-consolidado";
        }
    }

    function cambiarEstado(idPedido, nuevoEstado) {
        pedidoActual = idPedido;

        if (nuevoEstado) {
            confirmarCambioEstadoDirecto(idPedido, nuevoEstado);
        } else {
            const modal = new bootstrap.Modal(document.getElementById('modalEstado'));
            modal.show();
        }
    }

    function confirmarCambioEstadoDirecto(idPedido, nuevoEstado) {
        if (confirm(`쮼st치 seguro de cambiar el estado del pedido #${idPedido} a "${nuevoEstado}"?`)) {
            realizarCambioEstado(idPedido, nuevoEstado, '');
        }
    }

    function confirmarCambioEstado() {
        const nuevoEstado = document.getElementById('selectEstado').value;
        const observacion = document.getElementById('observacionEstado').value;

        if (pedidoActual) {
            if (confirm(`쮼st치 seguro de cambiar el estado del pedido #${pedidoActual} a "${nuevoEstado}"?`)) {
                realizarCambioEstado(pedidoActual, nuevoEstado, observacion);
            }
        }
    }

    function realizarCambioEstado(idPedido, nuevoEstado, observacion) {
        fetch(`/admin/ventas/cambiar-estado/${idPedido}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                estado: nuevoEstado,
                observacion: observacion
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('success', 'Estado actualizado', 'El estado del pedido ha sido actualizado correctamente.');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showToast('error', 'Error', data.message || 'Error al cambiar el estado');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', 'Error', 'Error al conectar con el servidor');
            });
    }

    function cancelarPedido(idPedido) {
        const razon = prompt('Ingrese la raz칩n de la cancelaci칩n:');
        if (razon !== null && razon.trim() !== '') {
            if (confirm(`쮼st치 seguro de cancelar el pedido #${idPedido}?`)) {
                fetch(`/admin/ventas/cancelar-pedido/${idPedido}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        accion: 'cancelar',
                        razon: razon
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('success', 'Pedido cancelado', 'El pedido ha sido cancelado correctamente.');
                            setTimeout(() => {
                                location.reload();
                            }, 1500);
                        } else {
                            showToast('error', 'Error', data.message || 'Error al cancelar el pedido');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('error', 'Error', 'Error al conectar con el servidor');
                    });
            }
        } else if (razon !== null) {
            alert('Debe ingresar una raz칩n para cancelar el pedido.');
        }
    }

    function showToast(type, title, message) {
        if (typeof Toast !== 'undefined') {
            Toast.fire({
                icon: type,
                title: title,
                text: message
            });
        } else {
            const toastEl = document.createElement('div');
            toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
            toastEl.setAttribute('role', 'alert');
            toastEl.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <strong>${title}:</strong> ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;

            document.body.appendChild(toastEl);
            const toast = new bootstrap.Toast(toastEl);
            toast.show();

            toastEl.addEventListener('hidden.bs.toast', function () {
                document.body.removeChild(toastEl);
            });
        }
    }
</script>

<style>
    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }

    .badge {
        font-size: 0.85em;
    }

    .btn-group-sm>.btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }

    .card-header {
        border-bottom: 2px solid rgba(0, 0, 0, .125);
    }

    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }

    #tablaPedidos tbody tr {
        cursor: pointer;
    }

    #tablaPedidos tbody tr:hover td {
        background-color: rgba(0, 123, 255, 0.05);
    }

    .bg-danger {
        background-color: #dc3545 !important;
    }

    tr .bg-danger {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            opacity: 1;
        }
        50% {
            opacity: 0.7;
        }
        100% {
            opacity: 1;
        }
    }

    .btn-outline-primary:hover {
        background-color: #0d6efd;
        color: white;
    }

    .btn-outline-warning:hover {
        background-color: #ffc107;
        color: #000;
    }

    .btn-outline-danger:hover {
        background-color: #dc3545;
        color: white;
    }

    .btn-warning {
        background-color: #ffc107;
        border-color: #ffc107;
        color: #000;
    }

    .btn-warning:hover {
        background-color: #e0a800;
        border-color: #d39e00;
        color: #000;
    }

    .bg-light .bg-primary,
    .bg-light .bg-success,
    .bg-light .bg-warning,
    .bg-light .bg-danger {
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .bg-primary.badge {
        background-color: #0d6efd !important;
    }
    
    @media (max-width: 768px) {
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
        }
        
        .btn-group .btn {
            flex: 1;
            min-width: 32px;
            font-size: 0.7rem;
            padding: 0.2rem 0.3rem;
        }
        
        .btn-group .btn i {
            margin-right: 0;
        }
    }
</style>
{% endblock %}