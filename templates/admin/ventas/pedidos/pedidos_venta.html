{% extends "layout.html" %}

{% block title %}Pedidos de Venta{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-shopping-cart me-2"></i>Pedidos de Venta</h2>
        <div>
            <button class="btn btn-success" onclick="nuevoPedido()">
                <i class="fas fa-plus me-1"></i> Nuevo Pedido
            </button>
            <a href="{{ url_for('admin_pedidos_venta') }}" class="btn btn-secondary">
                <i class="fas fa-sync-alt me-1"></i> Refrescar
            </a>
        </div>
    </div>
    
    <!-- Filtros Avanzados -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros de Búsqueda</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('filtrar_pedidos') }}" id="formFiltros">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Estado:</label>
                        <select name="estado" class="form-select">
                            <option value="todos">Todos los estados</option>
                            {% for estado in estados %}
                            <option value="{{ estado }}" 
                                {% if filtros_aplicados and filtros_aplicados.estado == estado %}selected{% endif %}>
                                {{ estado }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Tipo Cliente:</label>
                        <select name="tipo_cliente" class="form-select">
                            <option value="todos">Todos los tipos</option>
                            {% for tipo in tipos_cliente %}
                            <option value="{{ tipo }}" 
                                {% if filtros_aplicados and filtros_aplicados.tipo_cliente == tipo %}selected{% endif %}>
                                {{ tipo }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Tipo Entrega:</label>
                        <select name="tipo_entrega" class="form-select">
                            <option value="todos">Todos los tipos</option>
                            {% for tipo in tipos_entrega %}
                            <option value="{{ tipo }}" 
                                {% if filtros_aplicados and filtros_aplicados.tipo_entrega == tipo %}selected{% endif %}>
                                {{ tipo }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Fecha Inicio:</label>
                        <input type="date" name="fecha_inicio" class="form-control" 
                               value="{{ filtros_aplicados.fecha_inicio if filtros_aplicados }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Fecha Fin:</label>
                        <input type="date" name="fecha_fin" class="form-control"
                               value="{{ filtros_aplicados.fecha_fin if filtros_aplicados }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Documento Cliente:</label>
                        <input type="text" name="documento_cliente" class="form-control"
                               placeholder="RUC/Cédula"
                               value="{{ filtros_aplicados.documento_cliente if filtros_aplicados }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Nombre Cliente:</label>
                        <input type="text" name="nombre_cliente" class="form-control"
                               placeholder="Nombre del cliente"
                               value="{{ filtros_aplicados.nombre_cliente if filtros_aplicados }}">
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i> Buscar
                        </button>
                        <a href="{{ url_for('admin_pedidos_venta') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i> Limpiar
                        </a>
                        <button type="button" class="btn btn-outline-success float-end" onclick="exportarExcel()">
                            <i class="fas fa-file-excel me-1"></i> Exportar Excel
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Resumen Estadístico -->
    {% if pedidos %}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h6 class="card-title"><i class="fas fa-shopping-cart me-2"></i>Total Pedidos</h6>
                    <h3 class="card-text">{{ pedidos|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            {% set total_ventas = pedidos|sum(attribute='Total_Pedido') or 0 %}
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h6 class="card-title"><i class="fas fa-dollar-sign me-2"></i>Total Ventas</h6>
                    <h3 class="card-text">${{ "{:,.2f}".format(total_ventas) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            {% set pendientes = pedidos|selectattr('Estado', 'equalto', 'Pendiente')|list %}
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h6 class="card-title"><i class="fas fa-clock me-2"></i>Pendientes</h6>
                    <h3 class="card-text">{{ pendientes|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            {% set entregados = pedidos|selectattr('Estado', 'equalto', 'Entregado')|list %}
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h6 class="card-title"><i class="fas fa-check-circle me-2"></i>Entregados</h6>
                    <h3 class="card-text">{{ entregados|length }}</h3>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Lista de Pedidos -->
    <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Listado de Pedidos</h5>
            <div>
                <span class="badge bg-dark">{{ pedidos|length }} registros</span>
            </div>
        </div>
        <div class="card-body">
            {% if pedidos %}
            <div class="table-responsive">
                <table class="table table-hover table-striped" id="tablaPedidos">
                    <thead class="table-dark">
                        <tr>
                            <th width="80">ID</th>
                            <th width="100">Fecha</th>
                            <th>Cliente</th>
                            <th width="120">Documento</th>
                            <th width="100">Tipo</th>
                            <th width="120">Estado</th>
                            <th width="150">Entrega</th>
                            <th width="120">Total</th>
                            <th width="80">Items</th>
                            <th width="120">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pedido in pedidos %}
                        <tr>
                            <td><strong>#{{ pedido.ID_Pedido }}</strong></td>
                            <td>
                                {% if pedido.Fecha %}
                                {{ pedido.Fecha.strftime('%d/%m/%Y') }}
                                {% else %}
                                N/A
                                {% endif %}
                            </td>
                            <td>
                                <div class="fw-bold">{{ pedido.Nombre_Cliente or 'Sin nombre' }}</div>
                                <small class="text-muted">
                                    <i class="fas fa-phone-alt"></i> {{ pedido.Telefono_Cliente or 'Sin teléfono' }}
                                </small>
                            </td>
                            <td>
                                {% if pedido.Documento_Cliente %}
                                <span class="badge bg-secondary">{{ pedido.Documento_Cliente }}</span>
                                {% else %}
                                <span class="badge bg-light text-dark">Sin doc</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge 
                                    {% if pedido.Tipo_Cliente == 'Especial' %}bg-primary
                                    {% else %}bg-light text-dark{% endif %}">
                                    {{ pedido.Tipo_Cliente }}
                                </span>
                            </td>
                            <td>
                                <span class="badge 
                                    {% if pedido.Estado == 'Pendiente' %}bg-warning text-dark
                                    {% elif pedido.Estado == 'Aprobado' %}bg-info
                                    {% elif pedido.Estado == 'Entregado' %}bg-success
                                    {% elif pedido.Estado == 'Cancelado' %}bg-danger
                                    {% else %}bg-secondary{% endif %} p-2">
                                    <i class="fas 
                                        {% if pedido.Estado == 'Pendiente' %}fa-clock
                                        {% elif pedido.Estado == 'Aprobado' %}fa-check-circle
                                        {% elif pedido.Estado == 'Entregado' %}fa-truck
                                        {% elif pedido.Estado == 'Cancelado' %}fa-times-circle
                                        {% endif %} me-1"></i>
                                    {{ pedido.Estado }}
                                </span>
                            </td>
                            <td>
                                <span class="badge 
                                    {% if pedido.Tipo_Entrega == 'Entrega a domicilio' %}bg-primary
                                    {% else %}bg-light text-dark{% endif %} p-2">
                                    <i class="fas 
                                        {% if pedido.Tipo_Entrega == 'Entrega a domicilio' %}fa-truck
                                        {% else %}fa-store{% endif %} me-1"></i>
                                    {{ pedido.Tipo_Entrega }}
                                </span>
                            </td>
                            <td class="fw-bold text-success">${{ "{:,.2f}".format(pedido.Total_Pedido or 0) }}</td>
                            <td>
                                <span class="badge bg-dark rounded-circle">{{ pedido.Total_Items or 0 }}</span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{ url_for('ver_pedido', id_pedido=pedido.ID_Pedido) }}" 
                                       class="btn btn-outline-info" 
                                       title="Ver detalle"
                                       data-bs-toggle="tooltip">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="/admin/ventas/editar-pedido/{{ pedido.ID_Pedido }}" 
                                       class="btn btn-outline-primary"
                                       title="Editar"
                                       data-bs-toggle="tooltip">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% if pedido.Estado == 'Pendiente' %}
                                    <button type="button" class="btn btn-outline-success"
                                            title="Aprobar pedido"
                                            data-bs-toggle="tooltip"
                                            onclick="cambiarEstado({{ pedido.ID_Pedido }}, 'Aprobado')">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="table-active">
                            <td colspan="7" class="text-end fw-bold">TOTAL GENERAL:</td>
                            <td class="fw-bold text-primary fs-5">${{ "{:,.2f}".format(pedidos|sum(attribute='Total_Pedido') or 0) }}</td>
                            <td class="text-center fw-bold">{{ pedidos|sum(attribute='Total_Items') or 0 }}</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No hay pedidos registrados</h4>
                <p class="text-muted">
                    {% if filtros_aplicados %}
                    No se encontraron pedidos con los filtros aplicados
                    {% else %}
                    Comienza creando tu primer pedido
                    {% endif %}
                </p>
                {% if filtros_aplicados %}
                <a href="{{ url_for('admin_pedidos_venta') }}" class="btn btn-primary mt-2">
                    <i class="fas fa-redo me-1"></i> Ver todos los pedidos
                </a>
                {% else %}
                <button class="btn btn-success mt-2" onclick="nuevoPedido()">
                    <i class="fas fa-plus me-1"></i> Crear primer pedido
                </button>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% if pedidos %}
        <div class="card-footer bg-light">
            <div class="row">
                <div class="col-md-6">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Mostrando {{ pedidos|length }} pedido(s)
                    </small>
                </div>
                <div class="col-md-6 text-end">
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                        Última actualización: {{ now.strftime('%d/%m/%Y %H:%M:%S') if now else '' }}
                    </small>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal para cambiar estado -->
<div class="modal fade" id="modalEstado" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cambiar Estado del Pedido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Seleccione el nuevo estado para el pedido:</p>
                <select id="selectEstado" class="form-select">
                    <option value="Pendiente">Pendiente</option>
                    <option value="Aprobado">Aprobado</option>
                    <option value="Entregado">Entregado</option>
                    <option value="Cancelado">Cancelado</option>
                </select>
                <div class="mt-3">
                    <label>Observación (opcional):</label>
                    <textarea id="observacionEstado" class="form-control" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarCambioEstado()">Cambiar Estado</button>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales
let pedidoActual = null;
let estadoActual = null;

document.addEventListener('DOMContentLoaded', function() {
    // Inicializar tooltips de Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Configurar fechas por defecto
    const today = new Date().toISOString().split('T')[0];
    const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
    
    const fechaInicio = document.querySelector('input[name="fecha_inicio"]');
    const fechaFin = document.querySelector('input[name="fecha_fin"]');
    
    if (fechaInicio && !fechaInicio.value) {
        fechaInicio.value = firstDay;
    }
    if (fechaFin && !fechaFin.value) {
        fechaFin.value = today;
    }
    
    // Inicializar DataTables si existe la tabla
    if (typeof $.fn.DataTable !== 'undefined' && document.getElementById('tablaPedidos')) {
        $('#tablaPedidos').DataTable({
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json"
            },
            "order": [[1, 'desc']],
            "pageLength": 25,
            "responsive": true
        });
    }
});

function nuevoPedido() {
    window.location.href = "/admin/ventas/nuevo-pedido";
}

function cambiarEstado(idPedido, nuevoEstado) {
    pedidoActual = idPedido;
    estadoActual = nuevoEstado;
    
    if (nuevoEstado) {
        // Cambio directo
        confirmarCambioEstadoDirecto(idPedido, nuevoEstado);
    } else {
        // Mostrar modal para selección
        const modal = new bootstrap.Modal(document.getElementById('modalEstado'));
        modal.show();
    }
}

function confirmarCambioEstadoDirecto(idPedido, nuevoEstado) {
    if (confirm(`¿Está seguro de cambiar el estado del pedido #${idPedido} a "${nuevoEstado}"?`)) {
        realizarCambioEstado(idPedido, nuevoEstado, '');
    }
}

function confirmarCambioEstado() {
    const nuevoEstado = document.getElementById('selectEstado').value;
    const observacion = document.getElementById('observacionEstado').value;
    
    if (pedidoActual) {
        if (confirm(`¿Está seguro de cambiar el estado del pedido #${pedidoActual} a "${nuevoEstado}"?`)) {
            realizarCambioEstado(pedidoActual, nuevoEstado, observacion);
        }
    }
}

function realizarCambioEstado(idPedido, nuevoEstado, observacion) {
    fetch(`/admin/ventas/cambiar-estado/${idPedido}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            estado: nuevoEstado,
            observacion: observacion
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', 'Estado actualizado', 'El estado del pedido ha sido actualizado correctamente.');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showToast('error', 'Error', data.message || 'Error al cambiar el estado');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Error', 'Error al conectar con el servidor');
    });
}

function exportarExcel() {
    // Obtener los datos del formulario
    const formData = new FormData(document.getElementById('formFiltros'));
    const params = new URLSearchParams();
    
    for (let [key, value] of formData.entries()) {
        if (value) params.append(key, value);
    }
    
    window.open(`/admin/ventas/exportar-excel?${params.toString()}`, '_blank');
}

function showToast(type, title, message) {
    // Si tienes una función de toast implementada, úsala
    if (typeof Toast !== 'undefined') {
        Toast.fire({
            icon: type,
            title: title,
            text: message
        });
    } else {
        // Toast simple de Bootstrap
        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
        toastEl.setAttribute('role', 'alert');
        toastEl.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <strong>${title}:</strong> ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        document.body.appendChild(toastEl);
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
        
        // Remover después de mostrar
        toastEl.addEventListener('hidden.bs.toast', function () {
            document.body.removeChild(toastEl);
        });
    }
}

// Función para imprimir pedido
function imprimirPedido(idPedido) {
    window.open(`/admin/ventas/pedido/${idPedido}/imprimir`, '_blank');
}
</script>

<style>
.table th {
    background-color: #f8f9fa;
    font-weight: 600;
}
.badge {
    font-size: 0.85em;
}
.btn-group-sm > .btn {
    padding: 0.25rem 0.5rem;
}
.card-header {
    border-bottom: 2px solid rgba(0,0,0,.125);
}
.table-hover tbody tr:hover {
    background-color: rgba(0,123,255,0.05);
}
#tablaPedidos tbody tr {
    cursor: pointer;
}
#tablaPedidos tbody tr:hover td {
    background-color: rgba(0,123,255,0.05);
}
</style>
{% endblock %}