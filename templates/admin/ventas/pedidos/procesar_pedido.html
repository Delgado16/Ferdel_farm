{% extends "layout.html" %}

{% block title %}Procesar Venta - Pedido #{{ pedido.ID_Pedido }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="card bg-primary text-white mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2">
                        <i class="fas fa-cash-register me-2"></i>Procesar Venta
                    </h1>
                    <p class="mb-0">Pedido #{{ pedido.ID_Pedido }} - Cliente: {{ pedido.Nombre_Cliente }}</p>
                </div>
                <a href="{{ url_for('admin_pedidos_venta') }}" class="btn btn-light">
                    <i class="fas fa-arrow-left me-1"></i> Volver a Pedidos
                </a>
            </div>
        </div>
    </div>

    <!-- Alertas de stock insuficiente -->
    {% if productos_sin_stock %}
    <div class="alert alert-danger mb-4">
        <div class="d-flex align-items-center">
            <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
            <div>
                <h5 class="alert-heading mb-2">Stock Insuficiente</h5>
                <p class="mb-2">Los siguientes productos no tienen suficiente stock disponible:</p>
                <ul class="mb-0">
                    {% for producto in productos_sin_stock %}
                    <li>
                        <strong>{{ producto.producto }}</strong>: 
                        Solicitado: {{ producto.cantidad_solicitada }}, 
                        Disponible: {{ producto.stock_actual }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <hr>
        <p class="mb-0">
            <small>Debe reponer el inventario antes de procesar esta venta.</small>
        </p>
    </div>
    {% endif %}

    <div class="row">
        <!-- Columna izquierda: Información del pedido -->
        <div class="col-lg-8 mb-4">
            <!-- Información del pedido -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Información del Pedido
                    </h5>
                    <span class="badge bg-light text-dark">#{{ pedido.ID_Pedido }}</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label text-muted mb-1">Fecha del Pedido</label>
                                <p class="mb-0">
                                    <i class="fas fa-calendar me-2"></i>
                                    {{ pedido.Fecha.strftime('%d/%m/%Y %H:%M') if pedido.Fecha else 'N/A' }}
                                </p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-muted mb-1">Prioridad</label>
                                <p class="mb-0">
                                    <span class="badge 
                                        {% if pedido.Prioridad == 'Urgente' %}bg-danger
                                        {% elif pedido.Prioridad == 'Normal' %}bg-warning text-dark
                                        {% else %}bg-secondary{% endif %}">
                                        <i class="fas 
                                            {% if pedido.Prioridad == 'Urgente' %}fa-exclamation-circle
                                            {% elif pedido.Prioridad == 'Normal' %}fa-clock
                                            {% else %}fa-calendar{% endif %} me-1"></i>
                                        {{ pedido.Prioridad }}
                                    </span>
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label text-muted mb-1">Tipo de Entrega</label>
                                <p class="mb-0">
                                    <i class="fas {% if pedido.Tipo_Entrega == 'Entrega a domicilio' %}fa-truck{% else %}fa-store{% endif %} me-2"></i>
                                    {{ pedido.Tipo_Entrega }}
                                </p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-muted mb-1">Observación</label>
                                <p class="mb-0">
                                    <i class="fas fa-sticky-note me-2"></i>
                                    {{ pedido.Observacion or 'Ninguna' }}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label text-muted mb-1">Cliente</label>
                                <p class="mb-0">
                                    <i class="fas fa-user me-2"></i>
                                    {{ pedido.Nombre_Cliente }}
                                </p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-muted mb-1">Tipo de Cliente</label>
                                <p class="mb-0">
                                    <span class="badge {% if pedido.Tipo_Cliente == 'Especial' %}bg-warning text-dark{% else %}bg-primary{% endif %}">
                                        {{ pedido.Tipo_Cliente }}
                                    </span>
                                </p>
                            </div>
                            <!-- NUEVO: Información de Perfil y Precio -->
                            <div class="mb-3">
                                <label class="form-label text-muted mb-1">Perfil / Precio Aplicado</label>
                                <p class="mb-0">
                                    {% if pedido.Tipo_Pedido == 'Consolidado' %}
                                        <span class="badge bg-primary">
                                            <i class="fas fa-tag me-1"></i>Precio Ruta (Consolidado)
                                        </span>
                                    {% else %}
                                        {% if pedido.Perfil_Cliente %}
                                            <span class="badge 
                                                {% if pedido.Perfil_Cliente == 'Ruta' %}bg-info
                                                {% elif pedido.Perfil_Cliente == 'Mayorista' %}bg-success
                                                {% elif pedido.Perfil_Cliente == 'Mercado' %}bg-warning text-dark
                                                {% else %}bg-secondary{% endif %}">
                                                {{ pedido.Perfil_Cliente }}
                                            </span>
                                            <span class="badge 
                                                {% if pedido.Perfil_Cliente == 'Ruta' %}bg-info
                                                {% elif pedido.Perfil_Cliente == 'Mayorista' %}bg-success
                                                {% elif pedido.Perfil_Cliente == 'Mercado' %}bg-warning text-dark
                                                {% else %}bg-secondary{% endif %} ms-1">
                                                {% if pedido.Perfil_Cliente == 'Ruta' %}
                                                    Precio Ruta
                                                {% elif pedido.Perfil_Cliente == 'Mayorista' %}
                                                    Precio Mayorista
                                                {% elif pedido.Perfil_Cliente == 'Mercado' %}
                                                    Precio Mercado
                                                {% else %}
                                                    Precio Especial
                                                {% endif %}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">Sin perfil</span>
                                        {% endif %}
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label text-muted mb-1">Documento</label>
                                <p class="mb-0">
                                    <i class="fas fa-id-card me-2"></i>
                                    {{ pedido.Documento_Cliente }}
                                </p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-muted mb-1">Teléfono</label>
                                <p class="mb-0">
                                    <i class="fas fa-phone me-2"></i>
                                    {{ pedido.Telefono_Cliente or 'N/A' }}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    {% if pedido.Direccion_Cliente %}
                    <div class="row">
                        <div class="col-12">
                            <label class="form-label text-muted mb-1">Dirección de Entrega</label>
                            <p class="mb-0">
                                <i class="fas fa-map-marker-alt me-2"></i>
                                {{ pedido.Direccion_Cliente }}
                            </p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Productos del pedido -->
            <div class="card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-boxes me-2"></i>Productos del Pedido
                    </h5>
                    <span class="badge bg-light text-dark">{{ detalles_pedido|length }} productos</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="5%">#</th>
                                    <th width="35%">Producto</th>
                                    <th width="15%">Categoría</th>
                                    <th width="15%">Tipo Precio</th> <!-- NUEVA COLUMNA -->
                                    <th width="10%" class="text-center">Cantidad</th>
                                    <th width="10%" class="text-end">Precio Unit.</th>
                                    <th width="10%" class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for detalle in detalles_pedido %}
                                <tr class="{% if loop.index is even %}table-active{% endif %}">
                                    <td class="text-center">{{ loop.index }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                <i class="fas fa-box text-primary"></i>
                                            </div>
                                            <div>
                                                <strong>{{ detalle.Descripcion }}</strong><br>
                                                <small class="text-muted">COD: {{ detalle.COD_Producto }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ detalle.Categoria }}</span>
                                    </td>
                                    <td>
                                        {% if pedido.Tipo_Pedido == 'Consolidado' %}
                                            <span class="badge bg-primary">Precio Ruta</span>
                                        {% else %}
                                            {% if pedido.Perfil_Cliente == 'Ruta' %}
                                                <span class="badge bg-info">Precio Ruta</span>
                                            {% elif pedido.Perfil_Cliente == 'Mayorista' %}
                                                <span class="badge bg-success">Precio Mayorista</span>
                                            {% elif pedido.Perfil_Cliente == 'Mercado' %}
                                                <span class="badge bg-warning text-dark">Precio Mercado</span>
                                            {% elif pedido.Perfil_Cliente == 'Especial' %}
                                                <span class="badge bg-secondary">Precio Especial</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Precio Mercado</span>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-primary rounded-pill">{{ detalle.Cantidad }}</span>
                                    </td>
                                    <td class="text-end">C$ {{ "%.2f"|format(detalle.Precio_Unitario) }}</td>
                                    <td class="text-end">
                                        <strong>C$ {{ "%.2f"|format(detalle.Subtotal) }}</strong>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="6" class="text-end"><h5 class="mb-0">Total Pedido:</h5></td>
                                    <td class="text-end"><h5 class="mb-0">C$ {{ "%.2f"|format(total_pedido) }}</h5></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna derecha: Procesar venta -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 20px; border: 2px solid #ffc107;">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cash-register me-2"></i>Procesar Venta
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin_procesar_venta_pedido', id_pedido=pedido.ID_Pedido) }}" 
                          id="formProcesarVenta">
                        
                        <!-- Información del Perfil (Resumen) -->
                        <div class="alert 
                            {% if pedido.Tipo_Pedido == 'Consolidado' %}
                                alert-primary
                            {% else %}
                                {% if pedido.Perfil_Cliente == 'Ruta' %}alert-info
                                {% elif pedido.Perfil_Cliente == 'Mayorista' %}alert-success
                                {% elif pedido.Perfil_Cliente == 'Mercado' %}alert-warning
                                {% else %}alert-secondary{% endif %}
                            {% endif %} mb-4">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-tag fa-2x me-3"></i>
                                <div>
                                    <h6 class="alert-heading mb-1">Tipo de Precio Aplicado</h6>
                                    <p class="mb-0">
                                        {% if pedido.Tipo_Pedido == 'Consolidado' %}
                                            <strong>PRECIO RUTA</strong> (Pedido Consolidado)
                                        {% else %}
                                            <strong>{{ pedido.Perfil_Cliente or 'Mercado' }}</strong> - 
                                            {% if pedido.Perfil_Cliente == 'Ruta' %}
                                                Precio Ruta
                                            {% elif pedido.Perfil_Cliente == 'Mayorista' %}
                                                Precio Mayorista
                                            {% elif pedido.Perfil_Cliente == 'Mercado' %}
                                                Precio Mercado
                                            {% else %}
                                                Precio Especial
                                            {% endif %}
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tipo de Venta -->
                        <div class="mb-4">
                            <label class="form-label"><strong>Tipo de Venta:</strong></label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="tipo_venta" id="contado" value="contado" checked>
                                <label class="btn btn-outline-success" for="contado">
                                    <i class="fas fa-money-bill-wave me-1"></i> Contado
                                </label>
                                <input type="radio" class="btn-check" name="tipo_venta" id="credito" value="credito">
                                <label class="btn btn-outline-warning" for="credito">
                                    <i class="fas fa-credit-card me-1"></i> Crédito
                                </label>
                            </div>
                            <div class="form-text">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    <span id="tipoContadoInfo">Pago inmediato, se registra entrada en caja</span>
                                    <span id="tipoCreditoInfo" class="d-none">Pago diferido, se crea cuenta por cobrar (30 días)</span>
                                </small>
                            </div>
                        </div>

                        <!-- Observación adicional -->
                        <div class="mb-4">
                            <label for="observacion_adicional" class="form-label">
                                <strong>Observación Adicional:</strong>
                            </label>
                            <textarea class="form-control" id="observacion_adicional" 
                                     name="observacion_adicional" rows="3" 
                                     placeholder="Agregar observaciones adicionales para la factura..."></textarea>
                            <div class="form-text">
                                <small>Esta observación se agregará a la factura generada</small>
                            </div>
                        </div>

                        <!-- Resumen (estático dentro del formulario) -->
                        <div class="card mb-4">
                            <div class="card-header bg-info text-white d-flex align-items-center">
                                <i class="fas fa-clipboard-check me-2"></i>
                                <h6 class="mb-0">Resumen de Venta</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3 d-flex justify-content-between">
                                    <label class="mb-0">Total Pedido:</label>
                                    <div class="text-end">
                                        <strong>C$ {{ "%.2f"|format(total_pedido) }}</strong>
                                    </div>
                                </div>
                                
                                <!-- Información de Perfil en Resumen -->
                                <div class="mb-3 d-flex justify-content-between">
                                    <label class="mb-0"><i class="fas fa-tag me-1"></i>Tipo Precio:</label>
                                    <div>
                                        {% if pedido.Tipo_Pedido == 'Consolidado' %}
                                            <span class="badge bg-primary">Precio Ruta</span>
                                        {% else %}
                                            {% if pedido.Perfil_Cliente == 'Ruta' %}
                                                <span class="badge bg-info">Precio Ruta</span>
                                            {% elif pedido.Perfil_Cliente == 'Mayorista' %}
                                                <span class="badge bg-success">Precio Mayorista</span>
                                            {% elif pedido.Perfil_Cliente == 'Mercado' %}
                                                <span class="badge bg-warning text-dark">Precio Mercado</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Precio Especial</span>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                                
                                {% if total_cajillas_huevos > 0 %}
                                <div class="mb-3 d-flex justify-content-between">
                                    <label class="mb-0"><i class="fas fa-egg me-1"></i>Cajillas de Huevos:</label>
                                    <div><strong>{{ total_cajillas_huevos }} unid.</strong></div>
                                </div>
                                <div class="mb-3 d-flex justify-content-between">
                                    <label class="mb-0"><i class="fas fa-layer-group me-1"></i>Separadores necesarios:</label>
                                    <div><strong>{{ total_cajillas_huevos + (total_cajillas_huevos // 10) }}</strong></div>
                                </div>
                                {% endif %}
                                
                                <hr class="my-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold">Total Factura:</span>
                                    <h5 class="mb-0">C$ {{ "%.2f"|format(total_pedido) }}</h5>
                                </div>

                                <!-- Hidden inputs to include summary values in the POST -->
                                <input type="hidden" name="total_pedido" value="{{ "%.2f"|format(total_pedido) }}">
                                <input type="hidden" name="total_cajillas_huevos" value="{{ total_cajillas_huevos }}">
                                <input type="hidden" name="separadores_necesarios" value="{{ total_cajillas_huevos + (total_cajillas_huevos // 10) }}">
                                <input type="hidden" name="perfil_cliente" value="{{ pedido.Perfil_Cliente or 'Mercado' }}">
                                <input type="hidden" name="tipo_pedido" value="{{ pedido.Tipo_Pedido }}">
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="d-grid gap-2">
                            {% if productos_sin_stock %}
                            <button type="button" class="btn btn-danger btn-lg" disabled>
                                <i class="fas fa-ban me-1"></i> Stock Insuficiente
                            </button>
                            <div class="alert alert-warning text-center py-2">
                                <small>
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    No se puede procesar por falta de stock
                                </small>
                            </div>
                            {% else %}
                            <button type="submit" class="btn btn-success btn-lg" id="btnProcesar">
                                <i class="fas fa-check-circle me-1"></i> Confirmar y Procesar Venta
                            </button>
                            {% endif %}
                            <a href="{{ url_for('admin_pedidos_venta') }}" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
                <div class="card-footer bg-light">
                    <div class="row text-center">
                        <div class="col-6">
                            <small class="text-muted">
                                <i class="fas fa-user me-1"></i>
                                {{ current_user.nombre_usuario if current_user else 'Usuario' }}
                            </small>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>
                                {% if now %}
                                {{ now.strftime('%d/%m/%Y') }}
                                {% else %}
                                {{ datetime.now().strftime('%d/%m/%Y') }}
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Cambiar información según tipo de venta seleccionado
        const tipoContadoInfo = document.getElementById('tipoContadoInfo');
        const tipoCreditoInfo = document.getElementById('tipoCreditoInfo');
        
        document.querySelectorAll('input[name="tipo_venta"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                if (this.value === 'contado') {
                    tipoContadoInfo.classList.remove('d-none');
                    tipoCreditoInfo.classList.add('d-none');
                } else {
                    tipoContadoInfo.classList.add('d-none');
                    tipoCreditoInfo.classList.remove('d-none');
                }
            });
        });

        // Manejar envío del formulario
        const formProcesarVenta = document.getElementById('formProcesarVenta');
        const btnProcesar = document.getElementById('btnProcesar');
        
        if (formProcesarVenta && btnProcesar) {
            formProcesarVenta.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const tipoVenta = document.querySelector('input[name="tipo_venta"]:checked').value;
                const tipoVentaTexto = tipoVenta === 'contado' ? 'CONTADO' : 'CRÉDITO';
                
                // Obtener información del perfil para mostrar en confirmación
                const perfilInfo = document.querySelector('.alert-info, .alert-primary, .alert-success, .alert-warning, .alert-secondary')?.querySelector('strong')?.textContent || 'desconocido';
                
                if (confirm(`¿Está seguro de procesar esta venta como ${tipoVentaTexto}?\n\nTipo de precio aplicado: ${perfilInfo}\n\nEsta acción:\n• Creará una factura\n• Descontará el inventario\n• Actualizará el pedido a "Entregado"\n• Registrará el movimiento de inventario`)) {
                    // Mostrar indicador de carga
                    const originalText = btnProcesar.innerHTML;
                    btnProcesar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Procesando...';
                    btnProcesar.disabled = true;
                    
                    // Deshabilitar todos los campos del formulario
                    const formInputs = formProcesarVenta.querySelectorAll('input, textarea, button, select');
                    formInputs.forEach(input => {
                        if (input !== btnProcesar) {
                            input.disabled = true;
                        }
                    });
                    
                    // Enviar formulario (POST normal)
                    this.submit();
                }
            });
        }
    });
</script>

<style>
    .card-header.bg-warning {
        background-color: #ffc107 !important;
    }
    
    .card {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: box-shadow 0.3s ease;
    }
    
    .card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    
    .badge {
        font-size: 0.85em;
        padding: 0.35em 0.65em;
    }
    
    .btn-outline-success:hover {
        background-color: #198754;
        color: white;
    }
    
    .btn-outline-warning:hover {
        background-color: #ffc107;
        color: #000;
    }
    
    .sticky-top {
        z-index: 1020;
    }
    
    @media (max-width: 991.98px) {
        .sticky-top {
            position: static !important;
        }
    }
    
    /* Animación para el botón de procesar */
    #btnProcesar {
        transition: all 0.3s ease;
    }
    
    #btnProcesar:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    #btnProcesar:disabled {
        transform: none;
        box-shadow: none;
        opacity: 0.8;
    }
    
    .fa-spinner {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Estilos para los diferentes tipos de alertas de perfil */
    .alert-info {
        background-color: #cff4fc;
        border-color: #b6effb;
        color: #055160;
    }
    
    .alert-success {
        background-color: #d1e7dd;
        border-color: #badbcc;
        color: #0a3622;
    }
    
    .alert-warning {
        background-color: #fff3cd;
        border-color: #ffecb5;
        color: #664d03;
    }
    
    .alert-primary {
        background-color: #cfe2ff;
        border-color: #b6d4fe;
        color: #084298;
    }
    
    .alert-secondary {
        background-color: #e2e3e5;
        border-color: #d3d6d8;
        color: #41464b;
    }
</style>
{% endblock %}