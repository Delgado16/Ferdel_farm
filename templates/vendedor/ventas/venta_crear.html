<!-- templates/vendedor/ventas/venta_crear.html -->
{% extends "layout.html" %}

{% block title %}Nueva Venta - {{ asignacion.Nombre_Ruta }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Encabezado con breadcrumb similar al de pedidos -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-shopping-cart me-2"></i>Nueva Venta en Ruta</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('vendedor_dashboard') }}">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('vendedor_ventas') }}">Ventas</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Nueva Venta - {{ asignacion.Nombre_Ruta }}</li>
                </ol>
            </nav>
            <div class="alert alert-primary mt-2 mb-0">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Venta en Ruta:</strong> Fecha: {{ fecha_actual }} | La venta afectar√° el inventario de la ruta asignada.
            </div>
        </div>
        <div>
            <div class="btn-group">
                <a href="{{ url_for('vendedor_ventas') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Cancelar
                </a>
            </div>
        </div>
    </div>

    <!-- Formulario Principal -->
    <form id="ventaForm" method="POST" action="{{ url_for('vendedor_venta_crear') }}">
        <div class="row">
            <!-- Columna Izquierda - Datos de la Venta -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Datos de la Venta</h5>
                    </div>
                    <div class="card-body">
                        <!-- Cliente con dise√±o similar al de pedidos -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Seleccionar Cliente:</label>
                            <select class="form-select" id="cliente" name="cliente" required>
                                <option value="">Seleccione un cliente...</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.ID_Cliente }}" 
                                        data-nombre="{{ cliente.Nombre }}"
                                        data-telefono="{{ cliente.Telefono or '' }}"
                                        data-direccion="{{ cliente.Direccion or '' }}"
                                        data-ruc="{{ cliente.RUC_CEDULA or '' }}"
                                        data-tipo="{{ cliente.tipo_cliente }}"
                                        data-perfil="{{ cliente.perfil_cliente }}">
                                    {{ cliente.Nombre }} - {{ cliente.RUC_CEDULA }} ({{ cliente.perfil_cliente }})
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                El precio se muestra seg√∫n el inventario de ruta
                            </small>
                            <div class="mt-2">
                                <a href="#" class="text-primary" data-bs-toggle="modal" data-bs-target="#nuevoClienteModal">
                                    <i class="fas fa-plus-circle me-1"></i> Registrar nuevo cliente
                                </a>
                            </div>
                        </div>

                        <!-- Informaci√≥n del cliente (al seleccionar) -->
                        <div id="clienteInfo" class="p-3 bg-light rounded mb-3" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Nombre:</small>
                                        <span id="clienteNombre" class="fw-bold"></span>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Documento:</small>
                                        <span id="clienteRUC" class="badge bg-dark"></span>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Tel√©fono:</small>
                                        <span id="clienteTelefono"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Direcci√≥n:</small>
                                        <span id="clienteDireccion"></span>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Perfil:</small>
                                        <span id="clientePerfil" class="badge bg-info"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tipo de Venta con badges -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tipo de Venta:</label>
                            <div class="row">
                                <div class="col-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="tipo_venta" 
                                               id="tipo_contado" value="1" checked>
                                        <label class="form-check-label" for="tipo_contado">
                                            <span class="badge bg-success p-2">
                                                <i class="fas fa-money-bill-wave me-1"></i>Contado
                                            </span>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="tipo_venta" 
                                               id="tipo_credito" value="2">
                                        <label class="form-check-label" for="tipo_credito">
                                            <span class="badge bg-warning text-dark p-2">
                                                <i class="fas fa-credit-card me-1"></i>Cr√©dito
                                            </span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Observaci√≥n -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Observaciones:</label>
                            <textarea class="form-control" id="observacion" name="observacion" 
                                      rows="3" placeholder="Agregue notas adicionales..."></textarea>
                        </div>

                        <!-- Indicador de cr√©dito -->
                        <div id="indicadorCredito" class="alert alert-warning mb-3" style="display: none;">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 me-3">
                                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-1">Venta a Cr√©dito</h6>
                                    <p class="mb-0 small">
                                        Se generar√° un comprobante de cr√©dito y se actualizar√° la cuenta del cliente.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Resumen de la Venta (similar al de pedidos) -->
                        <div class="bg-light p-3 rounded">
                            <h6 class="mb-3">Resumen de la Venta</h6>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <span class="fw-bold" id="resumen_subtotal">C$ 0.00</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-3">
                                <span class="h6">Total:</span>
                                <span class="h5 text-success" id="resumen_total">C$ 0.00</span>
                            </div>
                            <div class="d-grid">
                                <button type="button" class="btn btn-primary btn-lg" id="btnMostrarConfirmacion">
                                    <i class="fas fa-check-circle me-2"></i>Revisar y Confirmar Venta
                                </button>
                            </div>
                        </div>

                        <!-- Campo oculto para productos -->
                        <input type="hidden" id="productos" name="productos" value="[]">
                    </div>
                </div>
            </div>

            <!-- Columna Derecha - Productos -->
            <div class="col-md-8">
                <!-- B√∫squeda r√°pida de productos (similar a pedidos) -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-search me-2"></i>B√∫squeda R√°pida de Productos</h5>
                    </div>
                    <div class="card-body">
                        <div class="input-group">
                            <input type="text" id="buscarProducto" class="form-control" 
                                   placeholder="Buscar producto por nombre o c√≥digo..."
                                   disabled>
                            <button class="btn btn-outline-primary" type="button" 
                                    id="btnBuscarProducto" disabled>
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div id="resultadosBusqueda" class="mt-2" style="display: none;"></div>
                        <small class="text-muted mt-2 d-block">
                            <i class="fas fa-info-circle me-1"></i>
                            Seleccione un cliente primero para habilitar la b√∫squeda
                        </small>
                    </div>
                </div>

                <!-- Selector de Productos Manual -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-box me-2"></i>Agregar Productos Manualmente</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Producto</label>
                                <select class="form-select" id="producto_select">
                                    <option value="">Seleccione un producto</option>
                                    {% for prod in inventario %}
                                    <option value="{{ prod.ID_Producto }}" 
                                            data-nombre="{{ prod.Nombre }}"
                                            data-codigo="{{ prod.COD_Producto }}"
                                            data-precio="{{ prod.Precio_Ruta }}"
                                            data-stock="{{ prod.Stock_Disponible }}"
                                            data-unidad="{{ prod.Descripcion }}">
                                        {{ prod.Nombre }} - Stock: {{ prod.Stock_Disponible }} {{ prod.Descripcion }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Cantidad</label>
                                <input type="number" class="form-control" id="cantidad" 
                                       min="1" value="1">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Precio Unit.</label>
                                <div class="input-group">
                                    <span class="input-group-text">C$</span>
                                    <input type="number" class="form-control" id="precio" 
                                           step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col-12">
                                <button type="button" class="btn btn-primary" id="btnAgregarProducto">
                                    <i class="fas fa-plus-circle me-2"></i>Agregar Producto
                                </button>
                                <button type="button" class="btn btn-outline-info" id="btnVerInventario">
                                    <i class="fas fa-warehouse me-2"></i>Ver Inventario
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Productos Agregados (similar a pedidos) -->
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Productos en la Venta</h5>
                            <div>
                                <span id="contadorProductos" class="badge bg-primary me-2">0 productos</span>
                                <span id="indicadorTotal" class="badge bg-success">Total: C$ 0.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="tablaProductos">
                                <thead class="table-light">
                                    <tr>
                                        <th width="50">#</th>
                                        <th>Producto</th>
                                        <th width="120">C√≥digo</th>
                                        <th width="200" class="text-center">Cantidad</th>
                                        <th width="150" class="text-end">Precio Unit.</th>
                                        <th width="150" class="text-end">Subtotal</th>
                                        <th width="100" class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="productos_tbody">
                                    <tr id="fila_vacia">
                                        <td colspan="7" class="text-center text-muted py-4">
                                            <i class="fas fa-box-open fa-3x mb-3"></i>
                                            <p>No hay productos agregados a la venta</p>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot id="tfootTotales" style="display: none;">
                                    <tr class="table-active">
                                        <td colspan="5" class="text-end fw-bold">TOTAL:</td>
                                        <td class="fw-bold text-success fs-5" id="total_tabla">C$ 0.00</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Modal Nuevo Cliente -->
<div class="modal fade" id="nuevoClienteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>Registrar Nuevo Cliente
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formNuevoCliente">
                    <div class="mb-3">
                        <label class="form-label fw-bold required">Nombre/Raz√≥n Social</label>
                        <input type="text" class="form-control" id="cliente_nombre" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold required">RUC/C√©dula</label>
                        <input type="text" class="form-control" id="cliente_ruc" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tel√©fono</label>
                        <input type="text" class="form-control" id="cliente_telefono">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Direcci√≥n</label>
                        <textarea class="form-control" id="cliente_direccion" rows="2"></textarea>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        El cliente se crear√° con perfil por defecto "Mercado". Puede modificarlo despu√©s.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnGuardarCliente">
                    <i class="fas fa-save me-2"></i>Guardar Cliente
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmaci√≥n de Venta -->
<div class="modal fade" id="modalConfirmacionVenta" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Confirmar Venta
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-3">
                            <i class="fas fa-info-circle fa-2x"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="alert-heading mb-1">Resumen de la venta</h6>
                            <p class="mb-0">La venta se registrar√° y se descontar√° del inventario disponible en ruta.</p>
                        </div>
                    </div>
                </div>

                <div id="resumenVenta"></div>
                
                <div class="mt-3">
                    <h6 class="mb-3">Detalle de productos:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered" id="tablaResumenProductos">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Producto</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">Precio Unit.</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyResumenProductos">
                                <!-- Se llenar√° con JavaScript -->
                            </tbody>
                            <tfoot>
                                <tr class="table-active">
                                    <td colspan="4" class="text-end fw-bold">TOTAL:</td>
                                    <td class="text-end fw-bold text-success fs-5" id="totalResumen">C$ 0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div id="infoCreditoModal" class="alert alert-warning mt-3" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Venta a Cr√©dito:</strong> Se generar√° un comprobante de cr√©dito y se actualizar√° la cuenta del cliente.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnConfirmarGuardar">
                    <i class="fas fa-check me-2"></i>Confirmar y Facturar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Inventario -->
<div class="modal fade" id="modalInventario" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-warehouse me-2"></i>Inventario de Ruta
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Producto</th>
                                <th>C√≥digo</th>
                                <th class="text-center">Stock Disponible</th>
                                <th class="text-end">Precio Ruta</th>
                                <th class="text-center">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for prod in inventario %}
                            <tr>
                                <td>{{ prod.Nombre }}</td>
                                <td>{{ prod.COD_Producto }}</td>
                                <td class="text-center">
                                    <span class="badge bg-{{ 'success' if prod.Stock_Disponible > 10 else 'warning' if prod.Stock_Disponible > 0 else 'danger' }}">
                                        {{ prod.Stock_Disponible }} {{ prod.Descripcion }}
                                    </span>
                                </td>
                                <td class="text-end">C$ {{ "%.2f"|format(prod.Precio_Ruta) }}</td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-primary" 
                                            onclick="agregarDesdeInventario('{{ prod.ID_Producto }}', '{{ prod.Nombre }}', '{{ prod.COD_Producto }}', {{ prod.Precio_Ruta }}, {{ prod.Stock_Disponible }}, '{{ prod.Descripcion }}')">
                                        <i class="fas fa-plus me-1"></i>Agregar
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SweetAlert2 y Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inicializando formulario de venta en ruta con nuevo dise√±o');
    
    // ============================================
    // VARIABLES GLOBALES
    // ============================================
    let productos = [];
    const productosInput = document.getElementById('productos');
    const tablaBody = document.getElementById('productos_tbody');
    const filaVacia = document.getElementById('fila_vacia');
    const tfootTotales = document.getElementById('tfootTotales');
    
    // Elementos del formulario
    const productoSelect = document.getElementById('producto_select');
    const cantidadInput = document.getElementById('cantidad');
    const precioInput = document.getElementById('precio');
    const btnAgregar = document.getElementById('btnAgregarProducto');
    const clienteSelect = document.getElementById('cliente');
    const btnVerInventario = document.getElementById('btnVerInventario');
    const btnBuscar = document.getElementById('btnBuscarProducto');
    const inputBuscar = document.getElementById('buscarProducto');
    
    // Radios de tipo de venta
    const tipoContado = document.getElementById('tipo_contado');
    const tipoCredito = document.getElementById('tipo_credito');
    const indicadorCredito = document.getElementById('indicadorCredito');
    
    // ============================================
    // FUNCIONES DE UTILIDAD
    // ============================================
    
    function formatoCordoba(valor) {
        return new Intl.NumberFormat('es-NI', {
            style: 'currency',
            currency: 'NIO',
            minimumFractionDigits: 2
        }).format(valor).replace('NIO', 'C$');
    }
    
    function formatNumber(number) {
        return new Intl.NumberFormat('es-NI').format(number);
    }
    
    function showToast(type, title, message) {
        Swal.fire({
            icon: type,
            title: title,
            text: message,
            timer: 3000,
            showConfirmButton: false,
            position: 'top-end',
            toast: true
        });
    }
    
    function showAlert(type, message) {
        Swal.fire({
            icon: type,
            title: type === 'success' ? '√âxito' : type === 'warning' ? 'Advertencia' : 'Error',
            text: message,
            timer: 3000,
            showConfirmButton: false
        });
    }
    
    // ============================================
    // EVENTOS PRINCIPALES
    // ============================================
    
    // Mostrar informaci√≥n del cliente al seleccionar
    clienteSelect.addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        const infoDiv = document.getElementById('clienteInfo');
        const mensajeSinCliente = document.getElementById('mensajeSinCliente');
        
        if (option && option.value) {
            document.getElementById('clienteNombre').textContent = option.dataset.nombre || '';
            document.getElementById('clienteRUC').textContent = option.dataset.ruc || '';
            document.getElementById('clienteTelefono').textContent = option.dataset.telefono || 'No especificado';
            document.getElementById('clienteDireccion').textContent = option.dataset.direccion || 'No especificada';
            document.getElementById('clientePerfil').textContent = option.dataset.perfil || 'Mercado';
            infoDiv.style.display = 'block';
            
            // Habilitar b√∫squeda
            if (inputBuscar) inputBuscar.disabled = false;
            if (btnBuscar) btnBuscar.disabled = false;
        } else {
            infoDiv.style.display = 'none';
            
            // Deshabilitar b√∫squeda
            if (inputBuscar) {
                inputBuscar.disabled = true;
                inputBuscar.value = '';
            }
            if (btnBuscar) btnBuscar.disabled = true;
            document.getElementById('resultadosBusqueda').style.display = 'none';
        }
    });
    
    // Mostrar indicador de cr√©dito
    function actualizarIndicadorCredito() {
        if (tipoCredito && tipoCredito.checked) {
            indicadorCredito.style.display = 'block';
        } else {
            indicadorCredito.style.display = 'none';
        }
    }
    
    if (tipoContado) tipoContado.addEventListener('change', actualizarIndicadorCredito);
    if (tipoCredito) tipoCredito.addEventListener('change', actualizarIndicadorCredito);
    
    // Actualizar precio cuando se selecciona producto
    productoSelect.addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        if (option.value) {
            precioInput.value = option.dataset.precio;
        } else {
            precioInput.value = '';
        }
    });
    
    // Agregar producto manualmente
    btnAgregar.addEventListener('click', function() {
        const option = productoSelect.options[productoSelect.selectedIndex];
        
        if (!option.value) {
            showAlert('warning', 'Debe seleccionar un producto');
            return;
        }
        
        const cantidad = parseFloat(cantidadInput.value);
        if (!cantidad || cantidad <= 0) {
            showAlert('warning', 'Ingrese una cantidad v√°lida');
            return;
        }
        
        const precio = parseFloat(precioInput.value);
        if (!precio || precio <= 0) {
            showAlert('warning', 'Ingrese un precio v√°lido');
            return;
        }
        
        const stock = parseInt(option.dataset.stock);
        if (cantidad > stock) {
            showAlert('warning', `Stock insuficiente. Disponible: ${formatNumber(stock)} ${option.dataset.unidad || ''}`);
            return;
        }
        
        agregarProductoALista({
            id: parseInt(option.value),
            codigo: option.dataset.codigo,
            nombre: option.dataset.nombre,
            cantidad: cantidad,
            precio: precio,
            stock: stock,
            unidad: option.dataset.unidad
        });
        
        // Limpiar selecci√≥n
        productoSelect.value = '';
        cantidadInput.value = 1;
        precioInput.value = '';
    });
    
    // Ver inventario modal
    if (btnVerInventario) {
        btnVerInventario.addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('modalInventario'));
            modal.show();
        });
    }
    
    // B√∫squeda de productos
    if (btnBuscar) {
        btnBuscar.addEventListener('click', buscarProductos);
    }
    
    if (inputBuscar) {
        inputBuscar.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                buscarProductos();
            }
        });
    }
    
    // ============================================
    // FUNCIONES DE PRODUCTOS
    // ============================================
    
    function agregarProductoALista(producto) {
        const index = productos.findIndex(p => p.id === producto.id);
        
        if (index !== -1) {
            const nuevaCantidad = productos[index].cantidad + producto.cantidad;
            if (nuevaCantidad > productos[index].stock) {
                showAlert('warning', `Stock insuficiente. Disponible: ${formatNumber(productos[index].stock)}`);
                return;
            }
            productos[index].cantidad = nuevaCantidad;
            productos[index].subtotal = productos[index].precio * nuevaCantidad;
            showToast('info', 'Cantidad actualizada', `Cantidad de "${producto.nombre}" actualizada a ${formatNumber(nuevaCantidad)}`);
        } else {
            productos.push({
                id: producto.id,
                codigo: producto.codigo,
                nombre: producto.nombre,
                cantidad: producto.cantidad,
                precio: producto.precio,
                stock: producto.stock,
                unidad: producto.unidad,
                subtotal: producto.precio * producto.cantidad
            });
            showToast('success', 'Producto agregado', `"${producto.nombre}" agregado a la venta`);
        }
        
        actualizarTabla();
        actualizarResumen();
        actualizarInputProductos();
    }
    
    // Funci√≥n para agregar desde inventario modal
    window.agregarDesdeInventario = function(id, nombre, codigo, precio, stock, unidad) {
        const cantidad = 1; // Por defecto 1
        if (cantidad > stock) {
            showAlert('warning', `Stock insuficiente. Disponible: ${stock}`);
            return;
        }
        
        agregarProductoALista({
            id: parseInt(id),
            codigo: codigo,
            nombre: nombre,
            cantidad: cantidad,
            precio: parseFloat(precio),
            stock: stock,
            unidad: unidad
        });
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalInventario'));
        if (modal) modal.hide();
    };
    
    // B√∫squeda de productos
    function buscarProductos() {
        const termino = inputBuscar.value.trim();
        if (termino.length < 2) {
            showAlert('warning', 'Ingrese al menos 2 caracteres para buscar');
            return;
        }
        
        const resultadosDiv = document.getElementById('resultadosBusqueda');
        resultadosDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Buscando...</span></div>';
        resultadosDiv.style.display = 'block';
        
        // Simular b√∫squeda en el inventario actual (en producci√≥n ser√≠a AJAX)
        const productosEncontrados = Array.from(document.querySelectorAll('#producto_select option')).filter(opt => {
            if (!opt.value) return false;
            const texto = opt.text.toLowerCase();
            return texto.includes(termino.toLowerCase());
        }).slice(0, 5);
        
        if (productosEncontrados.length === 0) {
            resultadosDiv.innerHTML = '<div class="alert alert-warning">No se encontraron productos</div>';
            return;
        }
        
        let html = '<div class="list-group">';
        productosEncontrados.forEach(opt => {
            html += `
                <div class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${opt.dataset.nombre}</h6>
                            <small class="text-muted">
                                C√≥digo: ${opt.dataset.codigo} | 
                                Stock: <span class="badge bg-info">${formatNumber(opt.dataset.stock)}</span>
                            </small>
                        </div>
                        <div>
                            <span class="fw-bold text-success me-3">${formatoCordoba(parseFloat(opt.dataset.precio))}</span>
                            <button type="button" class="btn btn-sm btn-primary" 
                                    onclick="agregarProductoBusqueda('${opt.value}')">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
        });
        html += '</div>';
        resultadosDiv.innerHTML = html;
    }
    
    // Agregar producto desde b√∫squeda
    window.agregarProductoBusqueda = function(productoId) {
        const option = document.querySelector(`#producto_select option[value="${productoId}"]`);
        if (option) {
            productoSelect.value = productoId;
            cantidadInput.value = 1;
            precioInput.value = option.dataset.precio;
            btnAgregar.click();
            
            // Limpiar b√∫squeda
            document.getElementById('resultadosBusqueda').style.display = 'none';
            inputBuscar.value = '';
        }
    };
    
    // ============================================
    // FUNCIONES DE TABLA
    // ============================================
    
    function actualizarTabla() {
        const contador = document.getElementById('contadorProductos');
        const indicadorTotal = document.getElementById('indicadorTotal');
        
        if (contador) {
            contador.textContent = `${productos.length} producto${productos.length !== 1 ? 's' : ''}`;
            contador.className = `badge ${productos.length > 0 ? 'bg-success' : 'bg-primary'} me-2`;
        }
        
        if (productos.length === 0) {
            filaVacia.style.display = '';
            tablaBody.innerHTML = '';
            tablaBody.appendChild(filaVacia);
            if (tfootTotales) tfootTotales.style.display = 'none';
            if (indicadorTotal) indicadorTotal.textContent = 'Total: C$ 0.00';
            return;
        }
        
        filaVacia.style.display = 'none';
        let html = '';
        let total = 0;
        
        productos.sort((a, b) => a.nombre.localeCompare(b.nombre));
        
        productos.forEach((prod, index) => {
            const subtotal = prod.cantidad * prod.precio;
            total += subtotal;
            
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td>
                        <div class="fw-bold">${prod.nombre}</div>
                        <small class="text-muted">Unidad: ${prod.unidad}</small>
                    </td>
                    <td>${prod.codigo}</td>
                    <td class="text-center">
                        <div class="input-group input-group-sm mx-auto" style="width: 150px;">
                            <button class="btn btn-outline-secondary" type="button" 
                                    onclick="modificarCantidad(${index}, -1)">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" class="form-control text-center" 
                                   value="${prod.cantidad}" min="0.01" max="${prod.stock}" step="0.01"
                                   onchange="actualizarCantidad(${index}, this.value)">
                            <button class="btn btn-outline-secondary" type="button" 
                                    onclick="modificarCantidad(${index}, 1)">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <small class="text-muted">Stock: ${formatNumber(prod.stock)}</small>
                    </td>
                    <td class="text-end">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">C$</span>
                            <input type="number" class="form-control text-end" 
                                   value="${prod.precio.toFixed(2)}" min="0.01" step="0.01"
                                   onchange="actualizarPrecio(${index}, this.value)">
                        </div>
                    </td>
                    <td class="text-end fw-bold text-success">${formatoCordoba(subtotal)}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-outline-info me-1" 
                                onclick="verStockDetalle(${prod.id})" title="Ver stock">
                            <i class="fas fa-warehouse"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-danger" 
                                onclick="eliminarProducto(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tablaBody.innerHTML = html;
        if (tfootTotales) {
            tfootTotales.style.display = '';
            document.getElementById('total_tabla').textContent = formatoCordoba(total);
        }
        if (indicadorTotal) indicadorTotal.textContent = `Total: ${formatoCordoba(total)}`;
    }
    
    // Funciones de modificaci√≥n
    window.modificarCantidad = function(index, cambio) {
        if (index < 0 || index >= productos.length) return;
        
        const producto = productos[index];
        const nuevaCantidad = producto.cantidad + cambio;
        
        if (nuevaCantidad < 0.01) return;
        
        if (nuevaCantidad > producto.stock) {
            showAlert('warning', `Stock insuficiente. Disponible: ${formatNumber(producto.stock)}`);
            return;
        }
        
        productos[index].cantidad = nuevaCantidad;
        productos[index].subtotal = producto.precio * nuevaCantidad;
        actualizarTabla();
        actualizarResumen();
        actualizarInputProductos();
    };
    
    window.actualizarCantidad = function(index, nuevaCantidad) {
        if (index < 0 || index >= productos.length) return;
        
        nuevaCantidad = parseFloat(nuevaCantidad);
        if (isNaN(nuevaCantidad) || nuevaCantidad < 0.01) {
            nuevaCantidad = productos[index].cantidad;
        }
        
        if (nuevaCantidad > productos[index].stock) {
            showAlert('warning', `Stock insuficiente. Disponible: ${formatNumber(productos[index].stock)}`);
            nuevaCantidad = productos[index].cantidad;
        }
        
        productos[index].cantidad = nuevaCantidad;
        productos[index].subtotal = productos[index].precio * nuevaCantidad;
        actualizarTabla();
        actualizarResumen();
        actualizarInputProductos();
    };
    
    window.actualizarPrecio = function(index, nuevoPrecio) {
        if (index < 0 || index >= productos.length) return;
        
        nuevoPrecio = parseFloat(nuevoPrecio);
        if (isNaN(nuevoPrecio) || nuevoPrecio < 0.01) {
            nuevoPrecio = productos[index].precio;
        }
        
        productos[index].precio = nuevoPrecio;
        productos[index].subtotal = nuevoPrecio * productos[index].cantidad;
        actualizarTabla();
        actualizarResumen();
        actualizarInputProductos();
    };
    
    window.eliminarProducto = function(index) {
        Swal.fire({
            title: '¬øEliminar producto?',
            text: `¬øEst√° seguro de eliminar ${productos[index].nombre} de la venta?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'S√≠, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                productos.splice(index, 1);
                actualizarTabla();
                actualizarResumen();
                actualizarInputProductos();
                showToast('success', 'Eliminado', 'Producto eliminado de la venta');
            }
        });
    };
    
    window.verStockDetalle = function(productoId) {
        // En producci√≥n, aqu√≠ se mostrar√≠a el detalle de stock por bodega
        showAlert('info', 'Stock detallado', 'Funcionalidad en desarrollo');
    };
    
    // Actualizar resumen
    function actualizarResumen() {
        let subtotal = 0;
        productos.forEach(prod => {
            subtotal += prod.cantidad * prod.precio;
        });
        document.getElementById('resumen_subtotal').textContent = formatoCordoba(subtotal);
        document.getElementById('resumen_total').textContent = formatoCordoba(subtotal);
    }
    
    // Actualizar campo oculto
    function actualizarInputProductos() {
        productosInput.value = JSON.stringify(productos);
    }
    
    // ============================================
    // MODAL DE CONFIRMACI√ìN
    // ============================================
    
    const btnMostrarConfirmacion = document.getElementById('btnMostrarConfirmacion');
    const modalConfirmacion = new bootstrap.Modal(document.getElementById('modalConfirmacionVenta'));
    const btnConfirmarGuardar = document.getElementById('btnConfirmarGuardar');
    
    btnMostrarConfirmacion.addEventListener('click', function() {
        // Validaciones
        if (productos.length === 0) {
            showAlert('warning', 'Debe agregar al menos un producto a la venta');
            return;
        }
        
        if (!clienteSelect.value) {
            showAlert('warning', 'Debe seleccionar un cliente');
            return;
        }
        
        // Verificar precios v√°lidos
        const productosSinPrecio = productos.filter(p => p.precio <= 0);
        if (productosSinPrecio.length > 0) {
            showAlert('warning', `Los siguientes productos tienen precio inv√°lido: ${productosSinPrecio.map(p => p.nombre).join(', ')}`);
            return;
        }
        
        llenarResumenConfirmacion();
        modalConfirmacion.show();
    });
    
    function llenarResumenConfirmacion() {
        const resumenVenta = document.getElementById('resumenVenta');
        const tbodyResumen = document.getElementById('tbodyResumenProductos');
        const totalResumen = document.getElementById('totalResumen');
        const infoCreditoModal = document.getElementById('infoCreditoModal');
        
        const tipoVenta = document.querySelector('input[name="tipo_venta"]:checked');
        const tipoVentaText = tipoVenta.value === '1' ? 'Contado' : 'Cr√©dito';
        
        if (tipoVenta.value === '2') {
            infoCreditoModal.style.display = 'block';
        } else {
            infoCreditoModal.style.display = 'none';
        }
        
        const clienteNombre = document.getElementById('clienteNombre').textContent;
        const clienteRUC = document.getElementById('clienteRUC').textContent;
        const clientePerfil = document.getElementById('clientePerfil').textContent;
        
        resumenVenta.innerHTML = `
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title border-bottom pb-2 mb-3">
                                <i class="fas fa-user me-2"></i>Datos del Cliente
                            </h6>
                            <p><strong>Cliente:</strong> ${clienteNombre}</p>
                            <p><strong>Documento:</strong> ${clienteRUC}</p>
                            <p><strong>Perfil:</strong> <span class="badge bg-info">${clientePerfil}</span></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title border-bottom pb-2 mb-3">
                                <i class="fas fa-info-circle me-2"></i>Informaci√≥n de la Venta
                            </h6>
                            <p><strong>Ruta:</strong> {{ asignacion.Nombre_Ruta }}</p>
                            <p><strong>Fecha:</strong> {{ fecha_actual }}</p>
                            <p><strong>Tipo:</strong> <span class="badge ${tipoVenta.value === '1' ? 'bg-success' : 'bg-warning text-dark'}">${tipoVentaText}</span></p>
                            <p><strong>Observaciones:</strong> ${document.getElementById('observacion').value || 'Ninguna'}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        let htmlResumen = '';
        let total = 0;
        
        productos.forEach((prod, index) => {
            total += prod.subtotal;
            htmlResumen += `
                <tr>
                    <td>${index + 1}</td>
                    <td>
                        ${prod.nombre}
                        <br><small class="text-muted">C√≥digo: ${prod.codigo}</small>
                    </td>
                    <td class="text-center">${formatNumber(prod.cantidad)}</td>
                    <td class="text-end">${formatoCordoba(prod.precio)}</td>
                    <td class="text-end fw-bold">${formatoCordoba(prod.subtotal)}</td>
                </tr>
            `;
        });
        
        tbodyResumen.innerHTML = htmlResumen;
        totalResumen.textContent = formatoCordoba(total);
    }
    
    btnConfirmarGuardar.addEventListener('click', function() {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';
        
        modalConfirmacion.hide();
        
        Swal.fire({
            title: 'Procesando venta...',
            text: 'Por favor espere',
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        setTimeout(() => {
            document.getElementById('ventaForm').submit();
        }, 500);
    });
    
    // ============================================
    // NUEVO CLIENTE R√ÅPIDO
    // ============================================
    
    document.getElementById('btnGuardarCliente').addEventListener('click', function() {
        const nombre = document.getElementById('cliente_nombre').value.trim();
        const ruc = document.getElementById('cliente_ruc').value.trim();
        
        if (!nombre || !ruc) {
            showAlert('warning', 'Nombre y RUC son obligatorios');
            return;
        }
        
        showAlert('success', 'Cliente registrado correctamente');
        $('#nuevoClienteModal').modal('hide');
        document.getElementById('formNuevoCliente').reset();
    });
    
    // ============================================
    // INICIALIZACI√ìN
    // ============================================
    
    actualizarTabla();
    actualizarResumen();
    actualizarIndicadorCredito();
});
</script>

<style>
/* Estilos heredados del formulario de pedidos */
.required:after {
    content: " *";
    color: red;
}

.card {
    border: none;
    box-shadow: 0 0 20px rgba(0,0,0,0.08);
    margin-bottom: 20px;
}

.card-header {
    font-weight: 600;
    padding: 1rem 1.5rem;
}

.card-header.bg-primary {
    background: linear-gradient(45deg, #667eea, #764ba2);
}

.card-header.bg-info {
    background: linear-gradient(45deg, #17a2b8, #138496);
}

.card-header.bg-success {
    background: linear-gradient(45deg, #28a745, #20c997);
}

.card-header.bg-dark {
    background: linear-gradient(45deg, #343a40, #23272b);
}

/* Estilos de tabla */
.table th {
    background-color: #f8f9fa;
    font-weight: 600;
}

.table-hover tbody tr:hover {
    background-color: rgba(102, 126, 234, 0.05);
}

/* Badges y etiquetas */
.badge {
    font-size: 0.85em;
    padding: 0.35em 0.65em;
}

.badge.bg-success { 
    background: linear-gradient(45deg, #28a745, #20c997) !important; 
}
.badge.bg-primary { 
    background: linear-gradient(45deg, #667eea, #764ba2) !important; 
}
.badge.bg-info { 
    background: linear-gradient(45deg, #17a2b8, #138496) !important; 
}
.badge.bg-warning { 
    background: linear-gradient(45deg, #ffc107, #e0a800) !important; 
}

/* Input groups */
.input-group-sm .form-control {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.input-group-text {
    background-color: #f8f9fa;
    border-color: #dee2e6;
    font-weight: 600;
}

/* Tabla de productos */
#tablaProductos .input-group-sm {
    width: 150px;
    margin: 0 auto;
}

#tablaProductos .input-group-sm input {
    text-align: center;
}

/* Informaci√≥n del cliente */
#clienteInfo {
    border-left: 3px solid #667eea;
    background-color: #f8f9fa !important;
}

/* Botones */
.btn-primary {
    background: linear-gradient(45deg, #667eea, #764ba2);
    border: none;
}

.btn-primary:hover {
    background: linear-gradient(45deg, #5a6fd6, #6a4392);
    transform: translateY(-1px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
}

.btn-success {
    background: linear-gradient(45deg, #28a745, #20c997);
    border: none;
}

.btn-success:hover {
    background: linear-gradient(45deg, #218838, #1ba87e);
    transform: translateY(-1px);
    box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
}

.btn-info {
    background: linear-gradient(45deg, #17a2b8, #138496);
    border: none;
    color: white;
}

.btn-info:hover {
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 5px 15px rgba(23, 162, 184, 0.3);
}

/* Alertas */
.alert-primary {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    border: none;
}

.alert-info {
    background: linear-gradient(45deg, #17a2b8, #138496);
    color: white;
    border: none;
}

.alert-warning {
    background: linear-gradient(45deg, #ffc107, #e0a800);
    color: #212529;
    border: none;
}

/* Indicador de cr√©dito */
#indicadorCredito {
    border-left: 4px solid #ffc107;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.8; }
    100% { opacity: 1; }
}

/* Resultados de b√∫squeda */
#resultadosBusqueda {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 10px;
    background-color: #f8f9fa;
}

#resultadosBusqueda .list-group-item {
    border-left: none;
    border-right: none;
}

#resultadosBusqueda .list-group-item:first-child {
    border-top: none;
}

#resultadosBusqueda .list-group-item:last-child {
    border-bottom: none;
}

/* Modal de confirmaci√≥n */
.modal-header.bg-primary {
    background: linear-gradient(45deg, #667eea, #764ba2);
}

#tablaResumenProductos th {
    background-color: #e9ecef;
    font-weight: 600;
}

.modal.fade .modal-dialog {
    transform: scale(0.8);
    transition: transform 0.2s ease-out;
}

.modal.show .modal-dialog {
    transform: scale(1);
}

/* Breadcrumb */
.breadcrumb {
    background-color: transparent;
    padding: 0.5rem 0;
    margin-bottom: 0;
}

.breadcrumb-item a {
    color: #667eea;
    text-decoration: none;
}

.breadcrumb-item.active {
    color: #6c757d;
}

/* Contadores */
#contadorProductos, #indicadorTotal {
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
}

/* Transiciones suaves */
.btn, .card, .badge, .alert {
    transition: all 0.3s ease;
}

/* Scrollbar personalizado */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(45deg, #667eea, #764ba2);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(45deg, #5a6fd6, #6a4392);
}

/* Responsive */
@media (max-width: 768px) {
    #tablaProductos .input-group-sm {
        width: 120px;
    }
    
    .btn-group {
        display: flex;
        flex-direction: column;
    }
    
    .btn-group .btn {
        margin-bottom: 0.5rem;
    }
}
</style>
{% endblock %}