{% extends "layout.html" %}

{% block title %}Reportes Avanzados de Inventario{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">游늵 Reportes Avanzados de Inventario</h1>

    <!-- Formulario de Filtros -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 bg-primary text-white">
            <h6 class="m-0 font-weight-bold">Filtros de Reportes</h6>
        </div>
        <div class="card-body">
            <form method="POST" id="filtroForm">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="fecha_inicio"><strong>Fecha Inicio:</strong></label>
                            <input type="date" class="form-control" id="fecha_inicio" name="fecha_inicio" 
                                   value="{{ fecha_inicio }}" required>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="fecha_fin"><strong>Fecha Fin:</strong></label>
                            <input type="date" class="form-control" id="fecha_fin" name="fecha_fin" 
                                   value="{{ fecha_fin }}" required>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="categoria_id"><strong>Categor칤a:</strong></label>
                            <select class="form-control" id="categoria_id" name="categoria_id">
                                <option value="todas">Todas las Categor칤as</option>
                                {% for cat in categorias %}
                                <option value="{{ cat.ID_Categoria }}" 
                                        {% if categoria_seleccionada == cat.ID_Categoria|string %}selected{% endif %}>
                                    {{ cat.Descripcion }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="tipo_reporte"><strong>Tipo de Reporte:</strong></label>
                            <select class="form-control" id="tipo_reporte" name="tipo_reporte">
                                <option value="resumen_diario" {% if tipo_reporte == 'resumen_diario' %}selected{% endif %}>Resumen Diario</option>
                                <option value="detallado" {% if tipo_reporte == 'detallado' %}selected{% endif %}>Detallado por Producto</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter"></i> Aplicar Filtros
                        </button>
                        <button type="button" class="btn btn-success ml-2" onclick="exportarExcel()">
                            <i class="fas fa-file-excel"></i> Exportar a Excel
                        </button>
                        <button type="button" class="btn btn-secondary ml-2" onclick="resetearFiltros()">
                            <i class="fas fa-redo"></i> Resetear
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Resumen Estad칤stico -->
    {% if resumen %}
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Productos Activos</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ resumen.total_productos or 0 }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-boxes fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Bajo Stock</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ resumen.productos_bajo_stock or 0 }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Agotados</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ resumen.productos_agotados or 0 }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Per칤odo</div>
                            <div class="h6 mb-0 font-weight-bold text-gray-800">
                                {{ fecha_inicio }}<br>a {{ fecha_fin }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Sistema de Pesta침as Mejorado -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <ul class="nav nav-pills" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="inventario-tab" data-bs-toggle="tab" 
                            data-bs-target="#inventario" type="button" role="tab" aria-controls="inventario" 
                            aria-selected="true">
                        <i class="fas fa-boxes me-1"></i> Inventario
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="ventas-tab" data-bs-toggle="tab" 
                            data-bs-target="#ventas" type="button" role="tab" aria-controls="ventas" 
                            aria-selected="false">
                        <i class="fas fa-chart-line me-1"></i> Ventas
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="stock-tab" data-bs-toggle="tab" 
                            data-bs-target="#stock" type="button" role="tab" aria-controls="stock" 
                            aria-selected="false">
                        <i class="fas fa-exclamation-triangle me-1"></i> Bajo Stock
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pagos-tab" data-bs-toggle="tab" 
                            data-bs-target="#pagos" type="button" role="tab" aria-controls="pagos" 
                            aria-selected="false">
                        <i class="fas fa-credit-card me-1"></i> Contado vs Cr칠dito
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sinventas-tab" data-bs-toggle="tab" 
                            data-bs-target="#sinventas" type="button" role="tab" aria-controls="sinventas" 
                            aria-selected="false">
                        <i class="fas fa-clock me-1"></i> Sin Ventas
                    </button>
                </li>
            </ul>
        </div>
        
        <div class="card-body">
            <div class="tab-content" id="myTabContent">
                
                <!-- Pesta침a 1: Inventario -->
                <div class="tab-pane fade show active" id="inventario" role="tabpanel" aria-labelledby="inventario-tab">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-boxes text-primary me-2"></i>Control de Inventario por Bodega
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped table-hover" id="tablaInventario">
                            <thead class="table-dark">
                                <tr>
                                    <th>C칩digo</th>
                                    <th>Producto</th>
                                    <th>Categor칤a</th>
                                    <th>Bodega</th>
                                    <th>Stock Actual</th>
                                    <th>Stock M칤nimo</th>
                                    <th>Estado</th>
                                    <th>Precio Venta</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if inventario %}
                                    {% for item in inventario %}
                                    <tr>
                                        <td>{{ item.COD_Producto or 'N/A' }}</td>
                                        <td>{{ item.Producto }}</td>
                                        <td>{{ item.Categoria or 'Sin categor칤a' }}</td>
                                        <td>{{ item.Bodega }}</td>
                                        <td class="text-center">
                                            <span class="badge bg-primary rounded-pill">{{ item.Stock_Actual }}</span>
                                        </td>
                                        <td class="text-center">{{ item.Stock_Minimo }}</td>
                                        <td class="text-center">
                                            {% if item.Estado_Stock == 'BAJO STOCK' %}
                                            <span class="badge bg-warning text-dark">{{ item.Estado_Stock }}</span>
                                            {% elif item.Estado_Stock == 'AGOTADO' %}
                                            <span class="badge bg-danger">{{ item.Estado_Stock }}</span>
                                            {% else %}
                                            <span class="badge bg-success">{{ item.Estado_Stock }}</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">${{ "%.2f"|format(item.Precio_Venta or 0) }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">No hay datos de inventario</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Pesta침a 2: Ventas -->
                <div class="tab-pane fade" id="ventas" role="tabpanel" aria-labelledby="ventas-tab">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-chart-line text-success me-2"></i>An치lisis de Ventas
                    </h5>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">Top 10 Productos M치s Vendidos</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Producto</th>
                                                    <th>Cantidad</th>
                                                    <th>Ingresos</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% if mas_vendidos %}
                                                    {% for item in mas_vendidos %}
                                                    <tr>
                                                        <td>{{ loop.index }}</td>
                                                        <td>{{ item.Producto }}</td>
                                                        <td class="text-end">{{ item.Total_Vendido|round(2) if item.Total_Vendido else 0 }}</td>
                                                        <td class="text-end">${{ "%.2f"|format(item.Total_Ingresos or 0) }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                {% else %}
                                                    <tr>
                                                        <td colspan="4" class="text-center text-muted">No hay datos de ventas</td>
                                                    </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">Ventas por Categor칤a</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Categor칤a</th>
                                                    <th>Fecha</th>
                                                    <th>Tipo</th>
                                                    <th>Ventas</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% if ventas_categorias %}
                                                    {% for item in ventas_categorias %}
                                                    <tr>
                                                        <td>{{ item.Categoria }}</td>
                                                        <td>{{ item.Fecha_Venta.strftime('%d/%m/%Y') if item.Fecha_Venta else 'N/A' }}</td>
                                                        <td>
                                                            {% if item.Tipo_Compra == 'CONTADO' %}
                                                            <span class="badge bg-success">Contado</span>
                                                            {% else %}
                                                            <span class="badge bg-info">Cr칠dito</span>
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-end">${{ "%.2f"|format(item.Total_Ventas or 0) }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                {% else %}
                                                    <tr>
                                                        <td colspan="4" class="text-center text-muted">No hay datos por categor칤a</td>
                                                    </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Pesta침a 3: Bajo Stock -->
                <div class="tab-pane fade" id="stock" role="tabpanel" aria-labelledby="stock-tab">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>Productos con Bajo Stock o Agotados
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-warning">
                                <tr>
                                    <th>C칩digo</th>
                                    <th>Producto</th>
                                    <th>Categor칤a</th>
                                    <th>Bodega</th>
                                    <th>Stock Actual</th>
                                    <th>Stock M칤nimo</th>
                                    <th>% Stock</th>
                                    <th>Alerta</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if bajo_stock %}
                                    {% for item in bajo_stock %}
                                    <tr>
                                        <td>{{ item.COD_Producto or 'N/A' }}</td>
                                        <td>{{ item.Producto }}</td>
                                        <td>{{ item.Categoria or 'Sin categor칤a' }}</td>
                                        <td>{{ item.Bodega }}</td>
                                        <td class="text-center">
                                            <strong>{{ item.Stock_Actual }}</strong>
                                        </td>
                                        <td class="text-center">{{ item.Stock_Minimo }}</td>
                                        <td class="text-center">
                                            {% if item.Porcentaje_Stock %}
                                                {% set porcentaje = item.Porcentaje_Stock|float %}
                                                {% set ancho_barra = porcentaje if porcentaje <= 100 else 100 %}
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar 
                                                        {% if porcentaje == 0 %}bg-danger
                                                        {% elif porcentaje < 50 %}bg-warning
                                                        {% else %}bg-success{% endif %}" 
                                                        role="progressbar" 
                                                        style="width: {{ ancho_barra }}%"
                                                        aria-valuenow="{{ porcentaje }}" 
                                                        aria-valuemin="0" 
                                                        aria-valuemax="100">
                                                        {{ "%.1f"|format(porcentaje) }}%
                                                    </div>
                                                </div>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if item.Alerta == 'AGOTADO' %}
                                            <span class="badge bg-danger p-2">{{ item.Alerta }}</span>
                                            {% elif item.Alerta == 'BAJO STOCK' %}
                                            <span class="badge bg-warning text-dark p-2">{{ item.Alerta }}</span>
                                            {% else %}
                                            <span class="badge bg-secondary p-2">{{ item.Alerta or 'N/A' }}</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                            춰Excelente! No hay productos con bajo stock
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Pesta침a 4: Contado vs Cr칠dito -->
                <div class="tab-pane fade" id="pagos" role="tabpanel" aria-labelledby="pagos-tab">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-credit-card text-info me-2"></i>Ventas por Tipo de Pago (Detallado por Producto)
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="tablaPagos">
                            <thead class="table-info">
                                <tr>
                                    <th>Fecha</th>
                                    <th>C칩digo</th>
                                    <th>Producto</th>
                                    <th>Categor칤a</th>
                                    <th>Tipo Pago</th>
                                    <th>Cantidad Vendida</th>
                                    <th>Total Venta</th>
                                    <th>Detalle</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if ventas_contado_credito %}
                                    {% for item in ventas_contado_credito %}
                                    <tr>
                                        <td>{{ item.Fecha.strftime('%d/%m/%Y') if item.Fecha else 'N/A' }}</td>
                                        <td>{{ item.COD_Producto or 'N/A' }}</td>
                                        <td>{{ item.Producto }}</td>
                                        <td>{{ item.Categoria or 'Sin categor칤a' }}</td>
                                        <td class="text-center">
                                            {% if item.Tipo_Compra == 'CONTADO' %}
                                            <span class="badge bg-success p-2">CONTADO</span>
                                            {% else %}
                                            <span class="badge bg-info p-2">CR칄DITO</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-primary rounded-pill">{{ item.Cantidad_Vendida|round(2) if item.Cantidad_Vendida else 0 }}</span>
                                        </td>
                                        <td class="text-end">
                                            <strong>${{ "%.2f"|format(item.Total_Venta or 0) }}</strong>
                                        </td>
                                        <td class="small">
                                            {% if item.Detalle_Ventas %}
                                            <button type="button" class="btn btn-sm btn-outline-info" 
                                                    data-bs-toggle="popover" 
                                                    title="Detalle de Ventas" 
                                                    data-bs-content="{{ item.Detalle_Ventas }}">
                                                <i class="fas fa-eye"></i> Ver Detalle
                                            </button>
                                            {% else %}
                                            <span class="text-muted">Sin detalle</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">No hay datos de ventas por tipo de pago</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                            <tfoot class="table-secondary">
                                <tr>
                                    <td colspan="5" class="text-end"><strong>Totales:</strong></td>
                                    <td class="text-center">
                                        <strong>
                                            {% set total_cantidad = 0 %}
                                            {% for item in ventas_contado_credito %}
                                                {% set total_cantidad = total_cantidad + (item.Cantidad_Vendida or 0) %}
                                            {% endfor %}
                                            {{ "%.2f"|format(total_cantidad) }}
                                        </strong>
                                    </td>
                                    <td class="text-end">
                                        <strong>
                                            {% set total_venta = 0 %}
                                            {% for item in ventas_contado_credito %}
                                                {% set total_venta = total_venta + (item.Total_Venta or 0) %}
                                            {% endfor %}
                                            ${{ "%.2f"|format(total_venta) }}
                                        </strong>
                                    </td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <!-- Pesta침a 5: Sin Ventas -->
                <div class="tab-pane fade" id="sinventas" role="tabpanel" aria-labelledby="sinventas-tab">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-clock text-secondary me-2"></i>Productos Sin Ventas en m치s de 4 D칤as
                    </h5>
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle me-2"></i>
                        Estos productos no han tenido movimiento de ventas en los 칰ltimos 4 d칤as. Considera revisar su stock o estrategia de ventas.
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-secondary">
                                <tr>
                                    <th>C칩digo</th>
                                    <th>Producto</th>
                                    <th>Categor칤a</th>
                                    <th>칔ltima Venta</th>
                                    <th>D칤as Sin Venta</th>
                                    <th>Stock Actual</th>
                                    <th>Acci칩n</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if sin_ventas %}
                                    {% for item in sin_ventas %}
                                    <tr>
                                        <td>{{ item.COD_Producto or 'N/A' }}</td>
                                        <td>{{ item.Producto }}</td>
                                        <td>{{ item.Categoria or 'Sin categor칤a' }}</td>
                                        <td>
                                            {% if item.Ultima_Venta %}
                                                {{ item.Ultima_Venta.strftime('%d/%m/%Y') }}
                                            {% else %}
                                                <span class="text-muted">Nunca vendido</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if item.Ultima_Venta %}
                                                {% if item.Dias_Sin_Venta > 10 %}
                                                <span class="badge bg-danger p-2">{{ item.Dias_Sin_Venta }} d칤as</span>
                                                {% elif item.Dias_Sin_Venta > 5 %}
                                                <span class="badge bg-warning text-dark p-2">{{ item.Dias_Sin_Venta }} d칤as</span>
                                                {% else %}
                                                <span class="badge bg-info p-2">{{ item.Dias_Sin_Venta }} d칤as</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-secondary p-2">Nunca</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">{{ item.Stock_Actual or 0 }}</td>
                                        <td class="text-center">
                                            <button class="btn btn-sm btn-outline-primary" onclick="verHistorial('{{ item.ID_Producto }}')">
                                                <i class="fas fa-chart-line"></i> Ver Historial
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                            춰Todos los productos han tenido ventas recientemente!
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts para funcionalidad mejorada -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar popovers de Bootstrap si est치 disponible
    if (typeof bootstrap !== 'undefined' && bootstrap.Popover) {
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl);
        });
    }
    
    // Configurar fechas por defecto (칰ltimos 7 d칤as)
    function setDefaultDates() {
        const today = new Date();
        const lastWeek = new Date(today);
        lastWeek.setDate(today.getDate() - 7);
        
        const formatDate = (date) => {
            return date.toISOString().split('T')[0];
        };
        
        document.getElementById('fecha_inicio').value = formatDate(lastWeek);
        document.getElementById('fecha_fin').value = formatDate(today);
    }
    
    // Verificar si los campos de fecha est치n vac칤os
    if (!document.getElementById('fecha_inicio').value || 
        !document.getElementById('fecha_fin').value) {
        setDefaultDates();
    }
});

// Funci칩n para exportar a Excel
function exportarExcel() {
    // Verificar si la librer칤a est치 cargada
    if (typeof XLSX === 'undefined') {
        alert('La librer칤a de Excel no est치 cargada. Por favor, intente nuevamente.');
        return;
    }
    
    const tabName = document.querySelector('.tab-pane.active').id;
    let table;
    
    switch(tabName) {
        case 'inventario':
            table = document.getElementById('tablaInventario');
            break;
        case 'pagos':
            table = document.getElementById('tablaPagos');
            break;
        default:
            table = document.querySelector('.tab-pane.active table');
    }
    
    if (table) {
        try {
            // Crear un libro de Excel
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.table_to_sheet(table);
            
            XLSX.utils.book_append_sheet(wb, ws, "Reporte");
            
            // Generar nombre del archivo
            const fecha = new Date().toISOString().slice(0,10);
            const filename = `reporte_inventario_${fecha}_${tabName}.xlsx`;
            
            // Descargar el archivo
            XLSX.writeFile(wb, filename);
        } catch (error) {
            console.error('Error al exportar a Excel:', error);
            alert('Error al exportar a Excel. Verifique la consola para m치s detalles.');
        }
    } else {
        alert('No se encontr칩 ninguna tabla para exportar.');
    }
}

// Funci칩n para resetear filtros
function resetearFiltros() {
    const today = new Date();
    const lastWeek = new Date(today);
    lastWeek.setDate(today.getDate() - 7);
    
    const formatDate = (date) => {
        return date.toISOString().split('T')[0];
    };
    
    document.getElementById('fecha_inicio').value = formatDate(lastWeek);
    document.getElementById('fecha_fin').value = formatDate(today);
    document.getElementById('categoria_id').value = 'todas';
    document.getElementById('tipo_reporte').value = 'resumen_diario';
    
    // Enviar el formulario autom치ticamente
    document.getElementById('filtroForm').submit();
}

// Funci칩n para ver historial de producto
function verHistorial(productoId) {
    alert('Funci칩n para ver historial del producto ID: ' + productoId + '\nEsta funcionalidad se implementar치 pr칩ximamente.');
}

// Funci칩n simple para alternar entre pesta침as (compatibilidad)
function mostrarTab(tabId) {
    // Ocultar todas las pesta침as
    const tabs = document.querySelectorAll('.tab-pane');
    tabs.forEach(tab => {
        tab.classList.remove('show', 'active');
    });
    
    // Quitar activo de todos los botones
    const buttons = document.querySelectorAll('.nav-link');
    buttons.forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Mostrar la pesta침a seleccionada
    const targetTab = document.getElementById(tabId);
    if (targetTab) {
        targetTab.classList.add('show', 'active');
        
        // Activar el bot칩n correspondiente
        const targetButton = document.getElementById(tabId + '-tab');
        if (targetButton) {
            targetButton.classList.add('active');
        }
    }
}

// Cargar librer칤as si es necesario
function cargarLibrerias() {
    // Cargar SheetJS si no est치 disponible
    if (typeof XLSX === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js';
        script.onload = function() {
            console.log('XLSX cargado exitosamente');
        };
        document.head.appendChild(script);
    }
}

// Inicializar cuando el DOM est칠 listo
cargarLibrerias();
</script>

<!-- Incluir Bootstrap JS para las pesta침as -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Opcional: DataTables para tablas -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>

<style>
/* Estilos personalizados para las pesta침as */
.nav-pills .nav-link {
    color: #495057;
    border-radius: 0.375rem;
    margin-right: 5px;
    transition: all 0.3s;
    border: 1px solid #dee2e6;
}

.nav-pills .nav-link:hover {
    background-color: #e9ecef;
    border-color: #adb5bd;
}

.nav-pills .nav-link.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

.badge {
    font-size: 0.85em;
}

.progress {
    margin-bottom: 0;
    min-width: 100px;
}

.tab-pane {
    padding-top: 20px;
}

/* Estilos para botones de acci칩n */
.btn-outline-info:hover {
    background-color: #0dcaf0;
    color: white;
}

/* Estilos para tablas */
.table th {
    background-color: #f8f9fa;
    font-weight: 600;
}

/* Responsive */
@media (max-width: 768px) {
    .nav-pills {
        flex-wrap: wrap;
    }
    
    .nav-pills .nav-link {
        margin-bottom: 5px;
        font-size: 0.9rem;
    }
    
    .card-body {
        padding: 10px;
    }
}
</style>
{% endblock %}